System.register(["./bits-b8bc8b22.js","./buffer-barrier-17698e09.js","./scene-asset-10397f71.js","./math-base-02e87bf8.js","./pipeline-state-manager-f4a950fe.js"],(function(e){"use strict";var t,i,r,s,n,a,o,h,u,l,d,c,_,p,f,g,m,S,v,w,y,E,T,A,O,b,F,I,R,D,B,P,N,L,C,M,x,U,H,G,z,V,W,k,Q,q,X,j,Y,K,J,Z,$,ee,te,ie,re,se,ne,ae,oe,he,ue,le,de,ce,_e,pe,fe,ge,me,Se,ve,we,ye,Ee,Te,Ae,Oe,be,Fe,Ie,Re,De,Be,Pe,Ne,Le,Ce,Me,xe,Ue,He,Ge,ze,Ve,We,ke,Qe,qe,Xe,je,Ye,Ke,Je,Ze,$e,et,tt,it,rt,st,nt,at,ot,ht,ut,lt,dt,ct,_t,pt,ft,gt,mt,St,vt,wt,yt,Et,Tt,At,Ot,bt,Ft,It,Rt,Dt,Bt,Pt,Nt,Lt,Ct,Mt,xt,Ut,Ht,Gt;return{setters:[function(e){t=e.l,i=e.A,r=e.f,s=e.F,n=e.i,a=e.G,o=e.H,h=e.I,u=e.J,l=e.y,d=e.m,c=e.s,_=e.g,p=e.d,f=e.c,g=e.K,m=e.L,S=e.z,v=e.S,w=e.M,y=e.e},function(e){E=e.ah,T=e.h,A=e.i,O=e.c,b=e.aj,F=e.m,I=e.n,R=e.F,D=e.aT,B=e.at,P=e.b0,N=e.aH,L=e.ac,C=e.e,M=e.g,x=e.P,U=e.aG,H=e.bq,G=e.aw,z=e.ax,V=e.u,W=e.U,k=e.L,Q=e.aB,q=e.v,X=e.aA,j=e.bm,Y=e.aE,K=e.b,J=e.av,Z=e.k,$=e.bt,ee=e.bu,te=e.a0,ie=e.a7,re=e.R,se=e.C,ne=e.ad,ae=e.a8,oe=e.A,he=e.bv,ue=e.bn,le=e.bw,de=e.br},function(e){ce=e.L,_e=e.aj,pe=e.aZ,fe=e.aM,ge=e.at,me=e.A,Se=e.P,ve=e.r,we=e.t,ye=e.u,Ee=e.a_,Te=e.a$,Ae=e.b0,Oe=e.a4,be=e.aI,Fe=e.b1,Ie=e.b2,Re=e.b3,De=e.b4,Be=e.q,Pe=e.S,Ne=e.n,Le=e.b5,Ce=e.b6,Me=e.a2,xe=e.ae,Ue=e.ad,He=e.b7,Ge=e.b8,ze=e.v,Ve=e.o,We=e.b9,ke=e.aF,Qe=e.a6,qe=e.ap,Xe=e.ao,je=e.aV,Ye=e.ba,Ke=e.ar},function(e){Je=e.e,Ze=e.c,$e=e.a,et=e.Q,tt=e.P,it=e.L,rt=e.C,st=e.t,nt=e.O,at=e.y,ot=e.V,ht=e.S,ut=e.R,lt=e.N},function(e){dt=e.d,ct=e.e,_t=e.U,pt=e.f,ft=e.I,gt=e.c,mt=e.g,St=e.h,vt=e.i,wt=e.j,yt=e.k,Et=e.l,Tt=e.m,At=e.n,Ot=e.o,bt=e.p,Ft=e.q,It=e.r,Rt=e.t,Dt=e.P,Bt=e.S,Pt=e.u,Nt=e.v,Lt=e.w,Ct=e.x,Mt=e.y,xt=e.z,Ut=e.A,Ht=e.s,Gt=e.a}],execute:function(){e({C:Jt,E:void 0,L:void 0,M:void 0,W:mi,f:Si,l:Go});var zt,Vt=new N(null),Wt=e("S",function(){function e(){this._device=null,this._passes=null,this._shaders=null,this._subMesh=null,this._patches=null,this._priority=ct.DEFAULT,this._inputAssembler=null,this._descriptorSet=null,this._worldBoundDescriptorSet=null,this._planarInstanceShader=null,this._planarShader=null,this._reflectionTex=null,this._reflectionSampler=null,this._instancedAttributeBlock={buffer:null,views:[],attributes:[]},this._instancedWorldMatrixIndex=-1}var s=e.prototype;return s.initialize=function(e,i,r){void 0===r&&(r=null);var s=t.director.root;this._device=dt.gfxDevice,Vt.layout=i[0].localSetLayout,this._inputAssembler=this._device.createInputAssembler(e.iaInfo),this._descriptorSet=this._device.createDescriptorSet(Vt);var n=t.director.root.pipeline.pipelineSceneData.getOcclusionQueryPass();if(n){var a=new N(null);a.layout=n.localSetLayout,this._worldBoundDescriptorSet=this._device.createDescriptorSet(a)}if(this._subMesh=e,this._patches=r,this._passes=i,this._flushPassInfo(),i[0].batchingScheme===ce.VB_MERGING&&this.subMesh.genFlatBuffers(),this.priority=ct.DEFAULT,i[0].phase===_e("reflection")){var o=s.mainWindow.width,h=s.mainWindow.height,u=512;h<o?(o=u*o/h,h=u):h=u*h/(o=u),this._reflectionTex=this._device.createTexture(new E(T.TEX2D,A.STORAGE|A.TRANSFER_SRC|A.SAMPLED,O.RGBA8,o,h)),this.descriptorSet.bindTexture(_t,this._reflectionTex),this._reflectionSampler=this._device.getSampler(new b(F.LINEAR,F.LINEAR,F.NONE,I.CLAMP,I.CLAMP,I.CLAMP)),this.descriptorSet.bindSampler(_t,this._reflectionSampler),this.descriptorSet.bindTexture(pt,this._reflectionTex)}},s.initPlanarShadowShader=function(){var e=t.director.root.pipeline.pipelineSceneData.shadows;this._planarShader=e.getPlanarShader(this._patches)},s.initPlanarShadowInstanceShader=function(){var e=t.director.root.pipeline.pipelineSceneData.shadows;this._planarInstanceShader=e.getPlanarInstanceShader(this._patches)},s.destroy=function(){var e;this._descriptorSet.destroy(),this._descriptorSet=null,this._inputAssembler.destroy(),this._inputAssembler=null,null===(e=this._worldBoundDescriptorSet)||void 0===e||e.destroy(),this._worldBoundDescriptorSet=null,this.priority=ct.DEFAULT,this._patches=null,this._subMesh=null,this._passes=null,this._shaders=null,this._reflectionTex&&this._reflectionTex.destroy(),this._reflectionTex=null,this._reflectionSampler=null},s.update=function(){for(var e,t=0;t<this._passes.length;++t)this._passes[t].update();this._descriptorSet.update(),null===(e=this._worldBoundDescriptorSet)||void 0===e||e.update()},s.onPipelineStateChanged=function(){var e=this._passes;if(e){for(var t=0;t<e.length;t++){var i=e[t];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}},s.onMacroPatchesStateChanged=function(e){this._patches=e;var t=this._passes;if(t){for(var i=0;i<t.length;i++){var r=t[i];r.beginChangeStatesSilently(),r.tryCompile(),r.endChangeStatesSilently()}this._flushPassInfo()}},s.onGeometryChanged=function(){if(this._subMesh){var e=this._subMesh.drawInfo;if(this._inputAssembler&&e){var t=this._inputAssembler.drawInfo;Object.keys(e).forEach((function(i){t[i]=e[i]})),this._inputAssembler.drawInfo=t}}},s.getInstancedAttributeIndex=function(e){for(var t=this.instancedAttributeBlock.attributes,i=0;i<t.length;i++)if(t[i].name===e)return i;return-1},s.updateInstancedWorldMatrix=function(e,t){var i=this.instancedAttributeBlock.views,r=i[t],s=i[t+1],n=i[t+2];r[0]=e.m00,r[1]=e.m01,r[2]=e.m02,r[3]=e.m12,s[0]=e.m04,s[1]=e.m05,s[2]=e.m06,s[3]=e.m13,n[0]=e.m08,n[1]=e.m09,n[2]=e.m10,n[3]=e.m14},s.UpdateInstancedAttributes=function(e){this.instancedWorldMatrixIndex=-1;var t=this.passes[0];if(t.device.hasFeature(R.INSTANCED_ARRAYS)){for(var i=0,r=0;r<e.length;r++){var s=e[r];s.isInstanced&&(i+=D[s.format].size)}var n=this.instancedAttributeBlock;n.buffer=new Uint8Array(i),n.views.length=n.attributes.length=0;for(var a=0,o=0;o<e.length;o++){var h=e[o];if(h.isInstanced){var u=new B;u.format=h.format,u.name=h.name,u.isNormalized=h.isNormalized,u.location=h.location,n.attributes.push(u);var l=D[h.format],d=new(P(l))(n.buffer.buffer,a,l.count);n.views.push(d),a+=l.size}}t.batchingScheme===ce.INSTANCING&&t.getInstancedBuffer().destroy(),this.instancedWorldMatrixIndex=this.getInstancedAttributeIndex(ft)}},s._flushPassInfo=function(){var e=this._passes;if(e){this._shaders||(this._shaders=[]),this._shaders.length=e.length;for(var t=0,i=e.length;t<i;t++)this._shaders[t]=e[t].getShaderVariant(this.patches)}},i(e,[{key:"passes",get:function(){return this._passes},set:function(e){e.length>8?r(12004,8):(this._passes=e,this._flushPassInfo(),this._passes[0].batchingScheme===ce.VB_MERGING&&this.subMesh.genFlatBuffers(),this._descriptorSet&&(this._descriptorSet.destroy(),Vt.layout=e[0].localSetLayout,this._descriptorSet=this._device.createDescriptorSet(Vt)))}},{key:"shaders",get:function(){return this._shaders}},{key:"subMesh",get:function(){return this._subMesh},set:function(e){this._inputAssembler.destroy(),this._inputAssembler=this._device.createInputAssembler(e.iaInfo),this._passes[0].batchingScheme===ce.VB_MERGING&&this.subMesh.genFlatBuffers(),this._subMesh=e}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"worldBoundDescriptorSet",get:function(){return this._worldBoundDescriptorSet}},{key:"patches",get:function(){return this._patches}},{key:"planarInstanceShader",get:function(){return this._planarInstanceShader}},{key:"planarShader",get:function(){return this._planarShader}},{key:"instancedAttributeBlock",get:function(){return this._instancedAttributeBlock}},{key:"instancedWorldMatrixIndex",get:function(){return this._instancedWorldMatrixIndex},set:function(e){this._instancedWorldMatrixIndex=e}}]),e}()),kt=new Je,Qt=[{name:"CC_RECEIVE_SHADOW",value:!0}],qt=[{name:"CC_USE_LIGHTMAP",value:!0}];!function(e){e[e.DEFAULT=0]="DEFAULT",e[e.SKINNING=1]="SKINNING",e[e.BAKED_SKINNING=2]="BAKED_SKINNING",e[e.BATCH_2D=3]="BATCH_2D",e[e.PARTICLE_BATCH=4]="PARTICLE_BATCH",e[e.LINE=5]="LINE"}(zt||(zt=e("M",{})));var Xt,jt=new b(F.LINEAR,F.LINEAR,F.NONE,I.CLAMP,I.CLAMP,I.CLAMP),Yt=new b(F.LINEAR,F.LINEAR,F.LINEAR,I.CLAMP,I.CLAMP,I.CLAMP),Kt=(e("a",function(){function e(){this.type=zt.DEFAULT,this.scene=null,this.isDynamicBatching=!1,this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._node=null,this._transform=null,this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._localDataUpdated=!0,this._localData=new Float32Array(mt.COUNT),this._localBuffer=null,this._lightmap=null,this._lightmapUVParam=new Ze,this._worldBoundBuffer=null,this._receiveShadow=!1,this._castShadow=!1,this._shadowBias=0,this._shadowNormalBias=0,this._enabled=!0,this._visFlags=gt.Enum.NONE,this._priority=0,this._device=dt.gfxDevice}var t=e.prototype;return t.initialize=function(){this._inited||(this._receiveShadow=!0,this.castShadow=!1,this.enabled=!0,this.visFlags=gt.Enum.NONE,this._inited=!0)},t.destroy=function(){for(var e=this._subModels,t=0;t<e.length;t++)this._subModels[t].destroy();this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._worldBoundBuffer&&(this._worldBoundBuffer.destroy(),this._worldBoundBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._localDataUpdated=!0,this._transform=null,this._node=null,this.isDynamicBatching=!1},t.attachToScene=function(e){this.scene=e,this._localDataUpdated=!0},t.detachFromScene=function(){this.scene=null},t.updateTransform=function(){var e=this.transform;if(e.hasChangedFlags||e._dirtyFlags){e.updateWorldTransform(),this._localDataUpdated=!0;var t=this._worldBounds;this._modelBounds&&t&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t)}},t.updateWorldBound=function(){var e=this.transform;if(null!==e){e.updateWorldTransform(),this._localDataUpdated=!0;var t=this._worldBounds;this._modelBounds&&t&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t)}},t.updateUBOs=function(e){for(var t=this._subModels,i=0;i<t.length;i++)t[i].update();if(this._updateStamp=e,this._localDataUpdated){this._localDataUpdated=!1;for(var r=this.transform._mat,s=!1,n=0;n<t.length;n++){var a=t[n],o=a.instancedWorldMatrixIndex;o>=0?a.updateInstancedWorldMatrix(r,o):s=!0}s&&this._localBuffer&&(Je.toArray(this._localData,r,mt.MAT_WORLD_OFFSET),Je.inverseTranspose(kt,r),Je.toArray(this._localData,kt,mt.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData))}},t.createBoundingShape=function(e,t){e&&t&&(this._modelBounds=pe.fromPoints(pe.create(),e,t),this._worldBounds=pe.clone(this._modelBounds))},t._createSubModel=function(){return new Wt},t.initSubModel=function(e,t,i){this.initialize(),null==this._subModels[e]?this._subModels[e]=this._createSubModel():this._subModels[e].destroy(),this._subModels[e].initialize(t,i.passes,this.getMacroPatches(e)),this._subModels[e].initPlanarShadowShader(),this._subModels[e].initPlanarShadowInstanceShader(),this._updateAttributesAndBinding(e)},t.setSubModelMesh=function(e,t){this._subModels[e]&&(this._subModels[e].subMesh=t)},t.setSubModelMaterial=function(e,t){this._subModels[e]&&(this._subModels[e].passes=t.passes,this._updateAttributesAndBinding(e))},t.onGlobalPipelineStateChanged=function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onPipelineStateChanged()},t.onMacroPatchesStateChanged=function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onMacroPatchesStateChanged(this.getMacroPatches(t))},t.onGeometryChanged=function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onGeometryChanged()},t.initLightingmap=function(e,t){this._lightmap=e,this._lightmapUVParam=t},t.updateLightingmap=function(e,t){Ze.toArray(this._localData,t,mt.LIGHTINGMAP_UVPARAM),this._localDataUpdated=!0,this._lightmap=e,this._lightmapUVParam=t,this.onMacroPatchesStateChanged(),e||(e=fe.get("empty-texture"));var i=e.getGFXTexture();if(i)for(var r=this._device.getSampler(e.mipmaps.length>1?Yt:jt),s=this._subModels,n=0;n<s.length;n++){var a=s[n].descriptorSet;a.bindTexture(St,i),a.bindSampler(St,r),a.update()}},t.updateLocalShadowBias=function(){var e=this._localData;e[mt.LOCAL_SHADOW_BIAS+0]=this._shadowBias,e[mt.LOCAL_SHADOW_BIAS+1]=this._shadowNormalBias,e[mt.LOCAL_SHADOW_BIAS+2]=0,e[mt.LOCAL_SHADOW_BIAS+3]=0,this._localDataUpdated=!0},t.getMacroPatches=function(){var e=this.receiveShadow?Qt:null;return null!=this._lightmap&&(e=e?e.concat(qt):qt),e},t._updateAttributesAndBinding=function(e){var t=this._subModels[e];if(t){this._initLocalDescriptors(e),this._updateLocalDescriptors(e,t.descriptorSet),this._initWorldBoundDescriptors(e),t.worldBoundDescriptorSet&&this._updateWorldBoundDescriptors(e,t.worldBoundDescriptorSet);var i=t.passes[0].getShaderVariant(t.patches);this._updateInstancedAttributes(i.attributes,t)}},t._updateInstancedAttributes=function(e,t){t.UpdateInstancedAttributes(e),this._localDataUpdated=!0},t._initLocalDescriptors=function(){this._localBuffer||(this._localBuffer=this._device.createBuffer(new L(C.UNIFORM|C.TRANSFER_DST,M.DEVICE,mt.SIZE,mt.SIZE)))},t._initWorldBoundDescriptors=function(){this._worldBoundBuffer||(this._worldBoundBuffer=this._device.createBuffer(new L(C.UNIFORM|C.TRANSFER_DST,M.DEVICE,vt.SIZE,vt.SIZE)))},t._updateLocalDescriptors=function(e,t){this._localBuffer&&t.bindBuffer(mt.BINDING,this._localBuffer)},t._updateWorldBoundDescriptors=function(e,t){this._worldBoundBuffer&&t.bindBuffer(vt.BINDING,this._worldBoundBuffer)},i(e,[{key:"subModels",get:function(){return this._subModels}},{key:"inited",get:function(){return this._inited}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"localBuffer",get:function(){return this._localBuffer}},{key:"worldBoundBuffer",get:function(){return this._worldBoundBuffer}},{key:"updateStamp",get:function(){return this._updateStamp}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias=e}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._receiveShadow=e,this.onMacroPatchesStateChanged()}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"transform",get:function(){return this._transform},set:function(e){this._transform=e}},{key:"visFlags",get:function(){return this._visFlags},set:function(e){this._visFlags=e}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}}]),e}()),e("O",function(){function e(){this._enabled=!1,this._minPos=new $e(0,0,0),this._maxPos=new $e(0,0,0),this._depth=0}return e.prototype.initialize=function(e){this._enabled=e.enabled,this._minPos=e.minPos,this._maxPos=e.maxPos,this._depth=e.depth},i(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"minPos",get:function(){return this._minPos},set:function(e){this._minPos=e}},{key:"maxPos",get:function(){return this._maxPos},set:function(e){this._maxPos=e}},{key:"depth",get:function(){return this._depth},set:function(e){this._depth=e}}]),e}()));function Jt(e,t){t<1e3?t=1e3:t>15e3&&(t=15e3);var i=t*t,r=(.860117757+.000154118254*t+1.28641212e-7*i)/(1+.000842420235*t+7.08145163e-7*i),s=(.317398726+422806245e-13*t+4.20481691e-8*i)/(1-289741816e-13*t+1.61456053e-7*i),n=2*r-8*s+4,a=3*r/n,o=2*s/n,h=1/o*a,u=1/o*(1-a-o);e.x=3.2404542*h-1.5371385+-.4985314*u,e.y=-.969266*h+1.8760108+.041556*u,e.z=.0556434*h-.2040259+1.0572252*u}!function(e){e[e.DIRECTIONAL=0]="DIRECTIONAL",e[e.SPHERE=1]="SPHERE",e[e.SPOT=2]="SPOT",e[e.UNKNOWN=3]="UNKNOWN"}(Xt||(Xt=e("L",{})));var Zt,$t,ei,ti,ii,ri,si,ni=e("n",(function(e){return 4*Math.PI*Math.PI*e*e})),ai=e("b",function(){function e(){this._baked=!1,this._color=new $e(1,1,1),this._colorTemp=6550,this._colorTempRGB=new $e(1,1,1),this._scene=null,this._node=null,this._name=null,this._useColorTemperature=!1,this._type=Xt.UNKNOWN}var t=e.prototype;return t.initialize=function(){this.color=new $e(1,1,1),this.colorTemperature=6550},t.attachToScene=function(e){this._scene=e},t.detachFromScene=function(){this._scene=null},t.destroy=function(){this._name=null,this._node=null},t.update=function(){},i(e,[{key:"baked",get:function(){return this._baked},set:function(e){this._baked=e}},{key:"color",get:function(){return this._color},set:function(e){this._color.set(e)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(e){this._useColorTemperature=e}},{key:"colorTemperature",get:function(){return this._colorTemp},set:function(e){this._colorTemp=e,Jt(this._colorTempRGB,this._colorTemp)}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"node",get:function(){return this._node},set:function(e){this._node=e,this._node&&(this._node.hasChangedFlags|=ge.ROTATION)}},{key:"type",get:function(){return this._type}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"scene",get:function(){return this._scene}}]),e}()),oi=new $e(0,0,-1),hi=new $e,ui=(e("D",function(e){function r(){var t;return(t=e.call(this)||this)._dir=new $e(1,-1,-1),t._illuminanceHDR=me.SUN_ILLUM,t._illuminanceLDR=1,t._shadowEnabled=!1,t._shadowPcf=Se.HARD,t._shadowBias=1e-5,t._shadowNormalBias=0,t._shadowSaturation=1,t._shadowDistance=50,t._shadowInvisibleOcclusionRange=200,t._csmLevel=ve.LEVEL_4,t._csmNeedUpdate=!1,t._csmLayerLambda=.75,t._csmOptimizationMode=we.DisableRotationFix,t._shadowFixedArea=!1,t._shadowNear=.1,t._shadowFar=10,t._shadowOrthoSize=5,t._type=Xt.DIRECTIONAL,t}s(r,e);var n=r.prototype;return n.initialize=function(){e.prototype.initialize.call(this),this.illuminance=me.SUN_ILLUM,this.direction=new $e(1,-1,-1)},n.update=function(){this._node&&this._node.hasChangedFlags&&(this.direction=$e.transformQuat(hi,oi,this._node.worldRotation))},n._activate=function(){var e=t.director.root,i=e.pipeline;this._shadowEnabled?(this._shadowFixedArea||!i.pipelineSceneData.csmSupported?i.macros.CC_DIR_LIGHT_SHADOW_TYPE=1:i.macros.CC_DIR_LIGHT_SHADOW_TYPE=this.csmLevel>1?2:1,i.macros.CC_DIR_SHADOW_PCF_TYPE=this._shadowPcf):i.macros.CC_DIR_LIGHT_SHADOW_TYPE=0,e.onGlobalPipelineStateChanged()},i(r,[{key:"direction",get:function(){return this._dir},set:function(e){$e.normalize(this._dir,e)}},{key:"illuminance",get:function(){return t.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(e){t.director.root.pipeline.pipelineSceneData.isHDR?this.illuminanceHDR=e:this.illuminanceLDR=e}},{key:"illuminanceHDR",get:function(){return this._illuminanceHDR},set:function(e){this._illuminanceHDR=e}},{key:"illuminanceLDR",get:function(){return this._illuminanceLDR},set:function(e){this._illuminanceLDR=e}},{key:"shadowEnabled",get:function(){return this._shadowEnabled},set:function(e){this._shadowEnabled=e,this._activate()}},{key:"shadowPcf",get:function(){return this._shadowPcf},set:function(e){this._shadowPcf=e,this._activate()}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias=e}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e}},{key:"shadowSaturation",get:function(){return this._shadowSaturation},set:function(e){this._shadowSaturation=e}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(e){this._shadowDistance=Math.min(e,ye.MAX_FAR)}},{key:"shadowInvisibleOcclusionRange",get:function(){return this._shadowInvisibleOcclusionRange},set:function(e){this._shadowInvisibleOcclusionRange=Math.min(e,ye.MAX_FAR)}},{key:"csmLevel",get:function(){return this._csmLevel},set:function(e){this._csmLevel=e,this._activate()}},{key:"csmNeedUpdate",get:function(){return this._csmNeedUpdate},set:function(e){this._csmNeedUpdate=e}},{key:"csmLayerLambda",get:function(){return this._csmLayerLambda},set:function(e){this._csmLayerLambda=e}},{key:"csmOptimizationMode",get:function(){return this._csmOptimizationMode},set:function(e){this._csmOptimizationMode=e}},{key:"shadowFixedArea",get:function(){return this._shadowFixedArea},set:function(e){this._shadowFixedArea=e,this._activate()}},{key:"shadowNear",get:function(){return this._shadowNear},set:function(e){this._shadowNear=e}},{key:"shadowFar",get:function(){return this._shadowFar},set:function(e){this._shadowFar=Math.min(e,ye.MAX_FAR)}},{key:"shadowOrthoSize",get:function(){return this._shadowOrthoSize},set:function(e){this._shadowOrthoSize=e}}]),r}(ai)),e("c",function(e){function r(){var t;return(t=e.call(this)||this)._needUpdate=!1,t._size=.15,t._range=1,t._luminanceHDR=0,t._luminanceLDR=0,t._pos=void 0,t._aabb=void 0,t._aabb=pe.create(),t._pos=new $e,t._type=Xt.SPHERE,t}s(r,e);var n=r.prototype;return n.initialize=function(){e.prototype.initialize.call(this),this.size=.15,this.range=1,this.luminanceHDR=1700/ni(.15),this.luminanceLDR=1},n.update=function(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);var e=this._range;pe.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,e,e,e),this._needUpdate=!1}},i(r,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(e){this._size=e}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._needUpdate=!0}},{key:"luminance",get:function(){return t.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){t.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=e:this.luminanceLDR=e}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(e){this._luminanceHDR=e}},{key:"luminanceLDR",set:function(e){this._luminanceLDR=e}},{key:"aabb",get:function(){return this._aabb}}]),r}(ai)),new $e(0,0,-1)),li=new et,di=new Je,ci=new Je,_i=new Je,pi=new Je,fi=(e("d",function(e){function r(){var t;return(t=e.call(this)||this)._dir=new $e(1,-1,-1),t._range=5,t._spotAngle=Math.cos(Math.PI/6),t._pos=void 0,t._aabb=void 0,t._frustum=void 0,t._angle=0,t._needUpdate=!1,t._size=.15,t._luminanceHDR=0,t._luminanceLDR=0,t._shadowEnabled=!1,t._shadowPcf=Se.HARD,t._shadowBias=1e-5,t._shadowNormalBias=0,t._aabb=pe.create(),t._frustum=Ee.create(),t._pos=new $e,t._type=Xt.SPOT,t}s(r,e);var n=r.prototype;return n.initialize=function(){e.prototype.initialize.call(this),this.size=.15,this.luminanceHDR=1700/ni(.15),this.luminanceLDR=1,this.range=Math.cos(Math.PI/6),this._dir.set(new $e(1,-1,-1))},n.update=function(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),$e.transformQuat(this._dir,ui,this._node.getWorldRotation(li)),$e.normalize(this._dir,this._dir),pe.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(di),Je.invert(di,di),Je.perspective(ci,this._angle,1,.001,this._range),Je.multiply(_i,ci,di),this._frustum.update(_i,pi),this._needUpdate=!1)},i(r,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(e){this._size=e}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._needUpdate=!0}},{key:"luminance",get:function(){return t.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){t.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=e:this.luminanceLDR=e}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(e){this._luminanceHDR=e}},{key:"luminanceLDR",get:function(){return this._luminanceLDR},set:function(e){this._luminanceLDR=e}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._angle=e,this._spotAngle=Math.cos(.5*e),this._needUpdate=!0}},{key:"angle",get:function(){return this._angle}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}},{key:"shadowEnabled",get:function(){return this._shadowEnabled},set:function(e){this._shadowEnabled=e}},{key:"shadowPcf",get:function(){return this._shadowPcf},set:function(e){this._shadowPcf=e}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias=e}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e}}]),r}(ai)),e("R",function(){function e(e){this._root=void 0,this._name="",this._cameras=[],this._models=[],this._batches=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._root=e}e.registerCreateFunc=function(t){t._createSceneFun=function(t){return new e(t)}};var t=e.prototype;return t.initialize=function(e){return this._name=e.name,!0},t.update=function(e){var t=this._mainLight;t&&t.update();for(var i=this._sphereLights,r=0;r<i.length;r++)i[r].update();for(var s=this._spotLights,n=0;n<s.length;n++)s[n].update();for(var a=this._models,o=0;o<a.length;o++){var h=a[o];h.enabled&&(h.updateTransform(e),h.updateUBOs(e))}},t.destroy=function(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels()},t.addCamera=function(e){e.attachToScene(this),this._cameras.push(e)},t.removeCamera=function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return this._cameras.splice(t,1),void e.detachFromScene()},t.removeCameras=function(){for(var e,t=n(this._cameras);!(e=t()).done;)e.value.detachFromScene();this._cameras.splice(0)},t.setMainLight=function(e){this._mainLight=e},t.unsetMainLight=function(e){if(this._mainLight===e){var t=this._directionalLights;if(t.length)return this.setMainLight(t[t.length-1]),void(this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=ge.ROTATION));this.setMainLight(null)}},t.addDirectionalLight=function(e){e.attachToScene(this),this._directionalLights.push(e)},t.removeDirectionalLight=function(e){for(var t=0;t<this._directionalLights.length;++t)if(this._directionalLights[t]===e)return e.detachFromScene(),void this._directionalLights.splice(t,1)},t.addSphereLight=function(e){e.attachToScene(this),this._sphereLights.push(e)},t.removeSphereLight=function(e){for(var t=0;t<this._sphereLights.length;++t)if(this._sphereLights[t]===e)return e.detachFromScene(),void this._sphereLights.splice(t,1)},t.addSpotLight=function(e){e.attachToScene(this),this._spotLights.push(e)},t.removeSpotLight=function(e){for(var t=0;t<this._spotLights.length;++t)if(this._spotLights[t]===e)return e.detachFromScene(),void this._spotLights.splice(t,1)},t.removeSphereLights=function(){for(var e=0;e<this._sphereLights.length;++e)this._sphereLights[e].detachFromScene();this._sphereLights.length=0},t.removeSpotLights=function(){for(var e=0;e<this._spotLights.length;++e)this._spotLights[e].detachFromScene();this._spotLights=[]},t.addModel=function(e){e.attachToScene(this),this._models.push(e)},t.removeModel=function(e){for(var t=0;t<this._models.length;++t)if(this._models[t]===e)return e.detachFromScene(),void this._models.splice(t,1)},t.removeModels=function(){for(var e,t=n(this._models);!(e=t()).done;){var i=e.value;i.detachFromScene(),i.destroy()}this._models.length=0},t.addBatch=function(e){this._batches.push(e)},t.removeBatch=function(e){for(var t=0;t<this._batches.length;++t)if(this._batches[t]===e)return void this._batches.splice(t,1)},t.removeBatches=function(){this._batches.length=0},t.onGlobalPipelineStateChanged=function(){for(var e,t=n(this._models);!(e=t()).done;)e.value.onGlobalPipelineStateChanged()},t.generateModelId=function(){return this._modelId++},i(e,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}},{key:"batches",get:function(){return this._batches}}]),e}()));tt({replaceProperty:{since:"3.6.0",removed:!1},removeProperty:{since:"3.6.0",removed:!1},markAsWarning:{since:"3.6.0",removed:!1},setDefaultLogTimes:{since:"3.6.0",removed:!1}}),e("P",(Zt=Te("cc.PrefabLink"),$t=Ae(Oe),ei=Ie(),Zt((si=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),s=0;s<i;s++)r[s]=arguments[s];return t=e.call.apply(e,[this].concat(r))||this,o(t,"prefab",ri,h(t)),t}return s(t,e),t}(be),ri=a((ii=si).prototype,"prefab",[$t,Fe,ei],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ti=ii))||ti));var gi=new $e;function mi(e,t,i,r){r||(r=new $e),e.convertToUINode(t,i,r);var s=i.position;return r.add(s),r}function Si(e,i,r){return r||(r=new $e),e.worldToScreen(i,r),r.x/=t.view.getScaleX(),r.y/=t.view.getScaleY(),r}var vi=e("g",{WorldNode3DToLocalNodeUI:mi,WorldNode3DToWorldNodeUI:Si});t.pipelineUtils=vi,it(t.pipelineUtils,"cc.pipelineUtils",[{name:"WorldNode3DToLocalNodeUI",newName:"convertToUINode",targetName:"cc.Camera.prototype",customFunction:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var r=t[0],s=t[3]||gi;return r.convertToUINode(t[1],t[2],s),s.add(t[2].position),t[3]||s.clone()}}]);var wi=new $e,yi=Re.create(0,0,0,1),Ei=new x((function(){return{model:null,depth:0}}),128);function Ti(e,t){var i=0;e.node&&($e.subtract(wi,e.node.worldPosition,t.position),i=$e.dot(wi,t.forward));var r=Ei.alloc();return r.model=e,r.depth=i,r}function Ai(e,t){var i=e.pipelineSceneData.validPunctualLights;i.length=0;for(var r=t.scene.spotLights,s=0;s<r.length;s++){var n=r[s];n.baked||(Re.set(yi,n.position.x,n.position.y,n.position.z,n.range),De.sphereFrustum(yi,t.frustum)&&i.push(n))}for(var a=t.scene.sphereLights,o=0;o<a.length;o++){var h=a[o];h.baked||(Re.set(yi,h.position.x,h.position.y,h.position.z,h.range),De.sphereFrustum(yi,t.frustum)&&i.push(h))}}function Oi(e,i){var r=i.scene,s=r.mainLight,n=e.pipelineSceneData,a=n.shadows,o=n.skybox,h=n.csmLayers,l=n.renderObjects;Ei.freeArray(l),l.length=0;var d=h.castShadowObjects;d.length=0;var c=h.layerObjects;c.clear(),a.enabled&&(e.pipelineUBO.updateShadowUBORange(wt.SHADOW_COLOR_OFFSET,a.shadowColor),a.type===Be.ShadowMap&&s&&s.node&&h.update(n,i)),i.clearFlag&Pe&&(o.enabled&&o.model?l.push(Ti(o.model,i)):i.clearFlag!==Pe||u||t.warnID(15100,i.name));for(var _=r.models,p=i.visibility,f=0;f<_.length;f++){var g=_[f];if(g.enabled&&(g.castShadow&&(d.push(Ti(g,i)),c.push(Ti(g,i))),g.node&&(p&g.node.layer)===g.node.layer||p&g.visFlags)){if(g.worldBounds&&!De.aabbFrustum(g.worldBounds,i.frustum))continue;l.push(Ti(g,i))}}}var bi,Fi,Ii,Ri,Di,Bi,Pi,Ni,Li,Ci,Mi=new b(F.LINEAR,F.LINEAR,F.NONE,I.CLAMP,I.CLAMP,I.CLAMP),xi=new b(F.POINT,F.POINT,F.NONE,I.CLAMP,I.CLAMP,I.CLAMP),Ui=e("U",function(){function e(e){this._device=void 0,this._descriptorSetMap=new Map,this._globalDescriptorSet=void 0,this._descriptorSetLayout=void 0,this._linearSampler=void 0,this._pointSampler=void 0,this._device=e,this._linearSampler=this._device.getSampler(Mi),this._pointSampler=this._device.getSampler(xi);var t=new U(Et.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(t),this._globalDescriptorSet=this._device.createDescriptorSet(new N(this._descriptorSetLayout))}var t=e.prototype;return t.regenLayout=function(){var e=new U(Et.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(e),this._globalDescriptorSet=this._device.createDescriptorSet(new N(this._descriptorSetLayout))},t.bindBuffer=function(e,t){this._globalDescriptorSet.bindBuffer(e,t);for(var i=this._descriptorSetMap.values(),r=i.next();!r.done;)r.value.bindBuffer(e,t),r=i.next()},t.bindSampler=function(e,t){this._globalDescriptorSet.bindSampler(e,t);for(var i=this._descriptorSetMap.values(),r=i.next();!r.done;)r.value.bindSampler(e,t),r=i.next()},t.bindTexture=function(e,t){this._globalDescriptorSet.bindTexture(e,t);for(var i=this._descriptorSetMap.values(),r=i.next();!r.done;)r.value.bindTexture(e,t),r=i.next()},t.update=function(){this._globalDescriptorSet.update();for(var e=this._descriptorSetMap.values(),t=e.next();!t.done;)t.value.update(),t=e.next()},t.getOrCreateDescriptorSet=function(e){var t=this._device;if(!this._descriptorSetMap.has(e)){var i=this._globalDescriptorSet,r=t.createDescriptorSet(new N(this._descriptorSetLayout));this._descriptorSetMap.set(e,r);for(var s=yt.UBO_GLOBAL;s<yt.COUNT;s++)r.bindBuffer(s,i.getBuffer(s)),r.bindSampler(s,i.getSampler(s)),r.bindTexture(s,i.getTexture(s));var n=t.createBuffer(new L(C.UNIFORM|C.TRANSFER_DST,M.HOST|M.DEVICE,wt.SIZE,wt.SIZE));r.bindBuffer(wt.BINDING,n),r.update()}return this._descriptorSetMap.get(e)},t.destroy=function(){this._descriptorSetLayout.destroy()},i(e,[{key:"descriptorSetMap",get:function(){return this._descriptorSetMap}},{key:"linearSampler",get:function(){return this._linearSampler}},{key:"pointSampler",get:function(){return this._pointSampler}},{key:"descriptorSetLayout",get:function(){return this._descriptorSetLayout}},{key:"globalDescriptorSet",get:function(){return this._globalDescriptorSet}}]),e}()),Hi=e("H",function(){function e(){this._singleMode=0,this._compositeModeValue=0,this._lightingWithAlbedo=!0,this._csmLayerColoration=!1,this._nativeConfig=null,this._activate()}var r=e.prototype;return r.isCompositeModeEnabled=function(e){return 0!=(this._compositeModeValue&1<<e)},r.enableCompositeMode=function(e,t){this._enableCompositeMode(e,t),this._updatePipeline()},r.enableAllCompositeMode=function(e){this._enableAllCompositeMode(e),this._updatePipeline()},r.isEnabled=function(){return 0!==this._getType()},r.reset=function(){this._activate(),this._updatePipeline()},r._activate=function(){this._singleMode=0,this._enableAllCompositeMode(!0),this._lightingWithAlbedo=!0,this._csmLayerColoration=!1},r._updatePipeline=function(){var e=t.director.root,i=e.pipeline,r=this._getType();i.macros.CC_USE_DEBUG_VIEW!==r&&(i.macros.CC_USE_DEBUG_VIEW=r,e.onGlobalPipelineStateChanged())},r._enableCompositeMode=function(e,t){t?this._compositeModeValue|=1<<e:this._compositeModeValue&=~(1<<e)},r._enableAllCompositeMode=function(e){for(var t=0;t<12;t++)e?this._compositeModeValue|=1<<t:this._compositeModeValue&=~(1<<t)},r._getType=function(){if(0!==this._singleMode)return 1;if(!0!==this._lightingWithAlbedo||!1!==this._csmLayerColoration)return 2;for(var e=0;e<12;e++)if(!this.isCompositeModeEnabled(e))return 2;return 0},i(e,[{key:"singleMode",get:function(){return this._singleMode},set:function(e){this._singleMode=e,this._updatePipeline()}},{key:"lightingWithAlbedo",get:function(){return this._lightingWithAlbedo},set:function(e){this._lightingWithAlbedo=e,this._updatePipeline()}},{key:"csmLayerColoration",get:function(){return this._csmLayerColoration},set:function(e){this._csmLayerColoration=e,this._updatePipeline()}}]),e}()),Gi=new Je,zi=new Je,Vi=new Je,Wi=new Ze,ki=new Ze(0,0,1,0),Qi=new $e,qi=e("X",function(){function e(){this._globalUBO=new Float32Array(Tt.COUNT),this._cameraUBO=new Float32Array(At.COUNT),this._shadowUBO=new Float32Array(wt.COUNT),this._csmUBO=new Float32Array(Ot.COUNT)}e.updateGlobalUBOView=function(e,i){var r=t.director,s=r.root,n=i,a=Math.floor(e.width),o=Math.floor(e.height);n[Tt.TIME_OFFSET]=s.cumulativeTime,n[Tt.TIME_OFFSET+1]=s.frameTime,n[Tt.TIME_OFFSET+2]=r.getTotalFrames(),n[Tt.SCREEN_SIZE_OFFSET]=a,n[Tt.SCREEN_SIZE_OFFSET+1]=o,n[Tt.SCREEN_SIZE_OFFSET+2]=1/a,n[Tt.SCREEN_SIZE_OFFSET+3]=1/o,n[Tt.NATIVE_SIZE_OFFSET]=a,n[Tt.NATIVE_SIZE_OFFSET+1]=o,n[Tt.NATIVE_SIZE_OFFSET+2]=1/n[Tt.NATIVE_SIZE_OFFSET],n[Tt.NATIVE_SIZE_OFFSET+3]=1/n[Tt.NATIVE_SIZE_OFFSET+1];var h=s.debugView;if(h){n[Tt.DEBUG_VIEW_MODE_OFFSET]=h.singleMode,n[Tt.DEBUG_VIEW_MODE_OFFSET+1]=h.lightingWithAlbedo?1:0,n[Tt.DEBUG_VIEW_MODE_OFFSET+2]=h.csmLayerColoration?1:0;for(var u=0;u<12;u++)n[Tt.DEBUG_VIEW_COMPOSITE_PACK_1_OFFSET+u]=h.isCompositeModeEnabled(u)?1:0}else{n[Tt.DEBUG_VIEW_MODE_OFFSET]=0,n[Tt.DEBUG_VIEW_MODE_OFFSET+1]=1,n[Tt.DEBUG_VIEW_MODE_OFFSET+2]=0;for(var l=0;l<12;l++)n[Tt.DEBUG_VIEW_COMPOSITE_PACK_1_OFFSET+l]=1}},e.updateCameraUBOView=function(e,i,r){var s,n=(r.scene?r.scene:t.director.getScene().renderScene).mainLight,a=e.pipelineSceneData,o=a.ambient,h=a.skybox,u=a.fog,l=a.shadows,d=i,c=r.exposure,_=a.isHDR;if(d[At.SCREEN_SCALE_OFFSET]=a.shadingScale,d[At.SCREEN_SCALE_OFFSET+1]=a.shadingScale,d[At.SCREEN_SCALE_OFFSET+2]=1/d[At.SCREEN_SCALE_OFFSET],d[At.SCREEN_SCALE_OFFSET+3]=1/d[At.SCREEN_SCALE_OFFSET+1],d[At.EXPOSURE_OFFSET]=c,d[At.EXPOSURE_OFFSET+1]=1/c,d[At.EXPOSURE_OFFSET+2]=_?1:0,d[At.EXPOSURE_OFFSET+3]=1/Ne.standardExposureValue,n){var p=n.shadowEnabled&&l.type===Be.ShadowMap?1:0,f=n.direction;if(ki.set(f.x,f.y,f.z,p),Ze.toArray(d,ki,At.MAIN_LIT_DIR_OFFSET),$e.toArray(d,n.color,At.MAIN_LIT_COLOR_OFFSET),n.useColorTemperature){var g=n.colorTemperatureRGB;d[At.MAIN_LIT_COLOR_OFFSET]*=g.x,d[At.MAIN_LIT_COLOR_OFFSET+1]*=g.y,d[At.MAIN_LIT_COLOR_OFFSET+2]*=g.z}d[At.MAIN_LIT_COLOR_OFFSET+3]=_?n.illuminance*c:n.illuminance}else ki.set(0,0,1,0),Ze.toArray(d,ki,At.MAIN_LIT_DIR_OFFSET),Ze.toArray(d,Ze.ZERO,At.MAIN_LIT_COLOR_OFFSET);var m=o.skyColor;m.w=_?o.skyIllum*c:o.skyIllum,d[At.AMBIENT_SKY_OFFSET+0]=m.x,d[At.AMBIENT_SKY_OFFSET+1]=m.y,d[At.AMBIENT_SKY_OFFSET+2]=m.z,d[At.AMBIENT_SKY_OFFSET+3]=m.w,d[At.AMBIENT_GROUND_OFFSET+0]=o.groundAlbedo.x,d[At.AMBIENT_GROUND_OFFSET+1]=o.groundAlbedo.y,d[At.AMBIENT_GROUND_OFFSET+2]=o.groundAlbedo.z,d[At.AMBIENT_GROUND_OFFSET+3]=h.envmap?null===(s=h.envmap)||void 0===s?void 0:s.mipmapLevel:1,Je.toArray(d,r.matView,At.MAT_VIEW_OFFSET),Je.toArray(d,r.node.worldMatrix,At.MAT_VIEW_INV_OFFSET),$e.toArray(d,r.position,At.CAMERA_POS_OFFSET),Je.toArray(d,r.matProj,At.MAT_PROJ_OFFSET),Je.toArray(d,r.matProjInv,At.MAT_PROJ_INV_OFFSET),Je.toArray(d,r.matViewProj,At.MAT_VIEW_PROJ_OFFSET),Je.toArray(d,r.matViewProjInv,At.MAT_VIEW_PROJ_INV_OFFSET),d[At.CAMERA_POS_OFFSET+3]=this.getCombineSignY(),d[At.SURFACE_TRANSFORM_OFFSET]=r.surfaceTransform,d[At.SURFACE_TRANSFORM_OFFSET+2]=Math.cos(st(a.skybox.getRotationAngle())),d[At.SURFACE_TRANSFORM_OFFSET+3]=Math.sin(st(a.skybox.getRotationAngle()));var S=u.colorArray;d[At.GLOBAL_FOG_COLOR_OFFSET]=S.x,d[At.GLOBAL_FOG_COLOR_OFFSET+1]=S.y,d[At.GLOBAL_FOG_COLOR_OFFSET+2]=S.z,d[At.GLOBAL_FOG_COLOR_OFFSET+3]=S.z,d[At.GLOBAL_FOG_BASE_OFFSET]=u.fogStart,d[At.GLOBAL_FOG_BASE_OFFSET+1]=u.fogEnd,d[At.GLOBAL_FOG_BASE_OFFSET+2]=u.fogDensity,d[At.GLOBAL_FOG_ADD_OFFSET]=u.fogTop,d[At.GLOBAL_FOG_ADD_OFFSET+1]=u.fogRange,d[At.GLOBAL_FOG_ADD_OFFSET+2]=u.fogAtten,d[At.NEAR_FAR_OFFSET]=r.nearClip,d[At.NEAR_FAR_OFFSET+1]=r.farClip,d[At.VIEW_PORT_OFFSET]=a.shadingScale*r.window.width*r.viewport.x,d[At.VIEW_PORT_OFFSET+1]=a.shadingScale*r.window.height*r.viewport.y,d[At.VIEW_PORT_OFFSET+2]=a.shadingScale*r.window.width*r.viewport.z,d[At.VIEW_PORT_OFFSET+3]=a.shadingScale*r.window.height*r.viewport.w},e.getPCFRadius=function(e,t){var i=e.size.x;switch(t.shadowPcf){case Se.HARD:return 0;case Se.SOFT:return 1/(.5*i);case Se.SOFT_2X:return 2/(.5*i);case Se.SOFT_4X:return 3/(.5*i)}return 0},e.updatePlanarNormalAndDistance=function(e,t){$e.normalize(Qi,e.normal),t[wt.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+0]=Qi.x,t[wt.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+1]=Qi.y,t[wt.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+2]=Qi.z,t[wt.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+3]=-e.distance},e.updateShadowUBOView=function(t,i,r,s){var n=t.device,a=s.scene.mainLight,o=t.pipelineSceneData,h=o.shadows,u=o.csmLayers,l=i,d=r,c=o.csmSupported,_=It(n)?0:1;if(a&&h.enabled){if(h.type===Be.ShadowMap){if(a.shadowEnabled){if(a.shadowFixedArea||a.csmLevel===ve.LEVEL_1||!c){var p=u.specialLayer.matShadowView,f=u.specialLayer.matShadowProj,g=u.specialLayer.matShadowViewProj,m=a.shadowNear,S=a.shadowFar;Je.toArray(l,p,wt.MAT_LIGHT_VIEW_OFFSET),l[wt.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=f.m10,l[wt.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=f.m14,l[wt.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=f.m11,l[wt.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=f.m15,l[wt.SHADOW_PROJ_INFO_OFFSET+0]=f.m00,l[wt.SHADOW_PROJ_INFO_OFFSET+1]=f.m05,l[wt.SHADOW_PROJ_INFO_OFFSET+2]=1/f.m00,l[wt.SHADOW_PROJ_INFO_OFFSET+3]=1/f.m05,Je.toArray(l,g,wt.MAT_LIGHT_VIEW_PROJ_OFFSET),Wi.set(m,S,0,1-a.shadowSaturation),Ze.toArray(l,Wi,wt.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),Wi.set(0,_,a.shadowNormalBias,0),Ze.toArray(l,Wi,wt.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET)}else{for(var v=this.getPCFRadius(h,a),w=0;w<a.csmLevel;w++){var y=u.layers[w].matShadowView;Wi.set(y.m00,y.m04,y.m08,v),Ze.toArray(d,Wi,Ot.CSM_VIEW_DIR_0_OFFSET+4*w),Wi.set(y.m01,y.m05,y.m09,0),Ze.toArray(d,Wi,Ot.CSM_VIEW_DIR_1_OFFSET+4*w),Wi.set(y.m02,y.m06,y.m10,0),Ze.toArray(d,Wi,Ot.CSM_VIEW_DIR_2_OFFSET+4*w);var E=u.layers[w].csmAtlas;Ze.toArray(d,E,Ot.CSM_ATLAS_OFFSET+4*w),d[Ot.CSM_SPLITS_INFO_OFFSET+w]=u.layers[w].splitCameraFar/a.shadowDistance;var T=u.layers[w].matShadowViewProj;Je.toArray(d,T,Ot.MAT_CSM_VIEW_PROJ_OFFSET+16*w);var A=u.layers[w].matShadowProj;d[Ot.CSM_PROJ_DEPTH_INFO_OFFSET+0+4*w]=A.m10,d[Ot.CSM_PROJ_DEPTH_INFO_OFFSET+1+4*w]=A.m14,d[Ot.CSM_PROJ_DEPTH_INFO_OFFSET+2+4*w]=A.m11,d[Ot.CSM_PROJ_DEPTH_INFO_OFFSET+3+4*w]=A.m15,d[Ot.CSM_PROJ_INFO_OFFSET+0+4*w]=A.m00,d[Ot.CSM_PROJ_INFO_OFFSET+1+4*w]=A.m05,d[Ot.CSM_PROJ_INFO_OFFSET+2+4*w]=1/A.m00,d[Ot.CSM_PROJ_INFO_OFFSET+3+4*w]=1/A.m05}Wi.set(0,0,0,1-a.shadowSaturation),Ze.toArray(l,Wi,wt.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),Wi.set(0,_,a.shadowNormalBias,a.csmLevel),Ze.toArray(l,Wi,wt.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET)}Wi.set(h.size.x,h.size.y,a.shadowPcf,a.shadowBias),Ze.toArray(l,Wi,wt.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET)}}else e.updatePlanarNormalAndDistance(h,l);rt.toArray(l,h.shadowColor,wt.SHADOW_COLOR_OFFSET)}},e.updateShadowUBOLightView=function(e,t,i,r){var s=e.device,n=e.pipelineSceneData,a=n.shadows,o=n.csmLayers,h=t,u=It(s)?0:1,l=e.device.capabilities,d=n.csmSupported;switch(i.type){case Xt.DIRECTIONAL:var c=i;if(a.enabled&&c&&c.shadowEnabled&&a.type===Be.ShadowMap){var _,p,f,g=.1,m=0,S=0;if(c.shadowFixedArea||c.csmLevel===ve.LEVEL_1||!d)_=o.specialLayer.matShadowView,p=o.specialLayer.matShadowProj,f=o.specialLayer.matShadowViewProj,c.shadowFixedArea?(g=c.shadowNear,m=c.shadowFar,S=0):(g=.1,m=o.specialLayer.shadowCameraFar,S=1),Wi.set(0,u,c.shadowNormalBias,0),Ze.toArray(h,Wi,wt.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET);else{var v=o.layers[r];_=v.matShadowView,p=v.matShadowProj,f=v.matShadowViewProj,g=v.splitCameraNear,m=v.splitCameraFar,S=c.csmLevel}Je.toArray(h,_,wt.MAT_LIGHT_VIEW_OFFSET),h[wt.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=p.m10,h[wt.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=p.m14,h[wt.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=p.m11,h[wt.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=p.m15,h[wt.SHADOW_PROJ_INFO_OFFSET+0]=p.m00,h[wt.SHADOW_PROJ_INFO_OFFSET+1]=p.m05,h[wt.SHADOW_PROJ_INFO_OFFSET+2]=1/p.m00,h[wt.SHADOW_PROJ_INFO_OFFSET+3]=1/p.m05,Je.toArray(h,f,wt.MAT_LIGHT_VIEW_PROJ_OFFSET),Wi.set(g,m,0,1-c.shadowSaturation),Ze.toArray(h,Wi,wt.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),Wi.set(0,u,c.shadowNormalBias,S),Ze.toArray(h,Wi,wt.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET),Wi.set(a.size.x,a.size.y,c.shadowPcf,c.shadowBias),Ze.toArray(h,Wi,wt.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET)}break;case Xt.SPOT:var w=i;a.enabled&&w&&w.shadowEnabled&&(Je.invert(Gi,i.node.getWorldMatrix()),Je.toArray(h,Gi,wt.MAT_LIGHT_VIEW_OFFSET),Je.perspective(zi,i.angle,1,.001,i.range,!0,l.clipSpaceMinZ,l.clipSpaceSignY,0),Je.multiply(Vi,zi,Gi),Je.toArray(h,Vi,wt.MAT_LIGHT_VIEW_PROJ_OFFSET),Wi.set(.01,i.range,0,0),Ze.toArray(h,Wi,wt.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),Wi.set(a.size.x,a.size.y,w.shadowPcf,w.shadowBias),Ze.toArray(h,Wi,wt.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET),Wi.set(1,u,w.shadowNormalBias,0),Ze.toArray(h,Wi,wt.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET))}rt.toArray(h,a.shadowColor,wt.SHADOW_COLOR_OFFSET)},e.getCombineSignY=function(){return e._combineSignY};var i=e.prototype;return i._initCombineSignY=function(){var t=this._device;e._combineSignY=.5*t.capabilities.screenSpaceSignY+.5<<1|.5*t.capabilities.clipSpaceSignY+.5},i.activate=function(e,t){this._device=e,this._pipeline=t;var i=this._pipeline.descriptorSet;this._initCombineSignY();var r=e.createBuffer(new L(C.UNIFORM|C.TRANSFER_DST,M.HOST|M.DEVICE,Tt.SIZE,Tt.SIZE));i.bindBuffer(Tt.BINDING,r);var s=e.createBuffer(new L(C.UNIFORM|C.TRANSFER_DST,M.HOST|M.DEVICE,At.SIZE,At.SIZE));i.bindBuffer(At.BINDING,s);var n=e.createBuffer(new L(C.UNIFORM|C.TRANSFER_DST,M.HOST|M.DEVICE,wt.SIZE,wt.SIZE));i.bindBuffer(wt.BINDING,n);var a=e.createBuffer(new L(C.UNIFORM|C.TRANSFER_DST,M.HOST|M.DEVICE,Ot.SIZE,Ot.SIZE));i.bindBuffer(Ot.BINDING,a)},i.updateGlobalUBO=function(t){var i=this._pipeline.globalDSManager,r=this._pipeline.descriptorSet,s=this._pipeline.commandBuffers;r.update(),e.updateGlobalUBOView(t,this._globalUBO),s[0].updateBuffer(r.getBuffer(Tt.BINDING),this._globalUBO),i.bindBuffer(Tt.BINDING,r.getBuffer(Tt.BINDING)),i.update()},i.updateCameraUBO=function(t){var i=this._pipeline.globalDSManager,r=this._pipeline.descriptorSet,s=this._pipeline.commandBuffers;e.updateCameraUBOView(this._pipeline,this._cameraUBO,t),s[0].updateBuffer(r.getBuffer(At.BINDING),this._cameraUBO),i.bindBuffer(At.BINDING,r.getBuffer(At.BINDING)),i.update()},i.updateShadowUBO=function(t){var i=this._pipeline.pipelineSceneData;if(i.shadows.enabled){var r=this._pipeline.descriptorSet,s=this._pipeline.commandBuffers,n=i.shadowFrameBufferMap,a=t.scene.mainLight;a&&n.has(a)&&r.bindTexture(bt,n.get(a).colorTextures[0]),e.updateShadowUBOView(this._pipeline,this._shadowUBO,this._csmUBO,t),r.update(),s[0].updateBuffer(r.getBuffer(wt.BINDING),this._shadowUBO),s[0].updateBuffer(r.getBuffer(Ot.BINDING),this._csmUBO)}},i.updateShadowUBOLight=function(t,i,r){void 0===r&&(r=0),e.updateShadowUBOLightView(this._pipeline,this._shadowUBO,i,r),t.bindTexture(bt,fe.get("default-texture").getGFXTexture()),t.bindTexture(Ft,fe.get("default-texture").getGFXTexture()),t.update(),this._pipeline.commandBuffers[0].updateBuffer(t.getBuffer(wt.BINDING),this._shadowUBO)},i.updateShadowUBORange=function(e,t){t instanceof Je?Je.toArray(this._shadowUBO,t,e):t instanceof rt&&rt.toArray(this._shadowUBO,t,e)},i.destroy=function(){},e}());qi._combineSignY=0;var Xi,ji,Yi,Ki,Ji,Zi,$i,er,tr,ir,rr,sr,nr,ar=e("p",(bi=Te("RenderStage"),Fi=Le(),Ii=Le(),Ri=Le(),bi((Ci=function(){function e(){o(this,"_name",Pi,this),o(this,"_priority",Ni,this),this._enabled=!0,o(this,"_tag",Li,this)}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,e.tag&&(this._tag=e.tag),!0},t.activate=function(e,t){this._pipeline=e,this._flow=t},i(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}}]),e}(),Pi=a((Bi=Ci).prototype,"_name",[Fi,Fe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Ni=a(Bi.prototype,"_priority",[Ii,Fe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Li=a(Bi.prototype,"_tag",[Ri,Fe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Di=Bi))||Di));t.RenderStage=ar;var or,hr=e("o",(Xi=Te("RenderFlow"),ji=Le(),Yi=Le(),Ki=Le(),Ji=Le(),Zi=Ae([ar]),Xi((nr=function(){function e(){o(this,"_name",tr,this),o(this,"_priority",ir,this),o(this,"_tag",rr,this),o(this,"_stages",sr,this)}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,this._stages=e.stages,e.tag&&(this._tag=e.tag),!0},t.activate=function(e){this._pipeline=e,this._stages.sort((function(e,t){return e.priority-t.priority}));for(var t=0,i=this._stages.length;t<i;t++)this._stages[t].activate(e,this)},t.render=function(e){for(var t=0,i=this._stages.length;t<i;t++)this._stages[t].enabled&&this._stages[t].render(e)},t.destroy=function(){for(var e=0,t=this._stages.length;e<t;e++)this._stages[e].destroy();this._stages.length=0},i(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"stages",get:function(){return this._stages}},{key:"pipeline",get:function(){return this._pipeline}}]),e}(),tr=a((er=nr).prototype,"_name",[ji,Fe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ir=a(er.prototype,"_priority",[Yi,Fe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),rr=a(er.prototype,"_tag",[Ki,Fe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),sr=a(er.prototype,"_stages",[Ji,Zi,Fe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),$i=er))||$i));t.RenderFlow=hr,function(e){e.RENDER_FRAME_BEGIN="render-frame-begin",e.RENDER_FRAME_END="render-frame-end",e.RENDER_CAMERA_BEGIN="render-camera-begin",e.RENDER_CAMERA_END="render-camera-end",e.ATTACHMENT_SCALE_CAHNGED="attachment-scale-changed"}(or||(or=e("E",{})));var ur,lr,dr,cr,_r,pr,fr,gr,mr,Sr,vr,wr,yr,Er,Tr,Ar,Or,br,Fr,Ir,Rr,Dr,Br,Pr,Nr,Lr,Cr,Mr,xr,Ur,Hr,Gr,zr,Vr,Wr,kr,Qr,qr,Xr,jr,Yr,Kr,Jr,Zr,$r,es,ts,is,rs,ss,ns,as,os,hs,us,ls,ds,cs,_s,ps,fs,gs,ms,Ss,vs,ws,ys,Es,Ts,As,Os,bs,Fs,Is,Rs,Ds,Bs,Ps,Ns,Ls,Cs,Ms,xs,Us,Hs,Gs,zs,Vs,Ws,ks,Qs,qs,Xs,js=e("A",function(e){function t(){for(var t,i=arguments.length,r=new Array(i),s=0;s<i;s++)r[s]=arguments[s];return(t=e.call.apply(e,[this].concat(r))||this).eventTargetOn=e.prototype.on,t.eventTargetOnce=e.prototype.once,t}s(t,e);var i=t.prototype;return i.on=function(e,t,i,r){return this.eventTargetOn(e,t,i,r)},i.once=function(e,t,i){return this.eventTargetOnce(e,t,i)},t}(H)),Ys=new te,Ks=new ie,Js=function(){this.renderPass=null,this.sampler=null,this.prefiterTex=null,this.downsampleTexs=[],this.upsampleTexs=[],this.combineTex=null,this.prefilterFramebuffer=null,this.downsampleFramebuffers=[],this.upsampleFramebuffers=[],this.combineFramebuffer=null},Zs=e("T",(function(){this.quadIB=null,this.quadVB=null,this.quadIA=null})),$s=e("m",(ur=Te("cc.RenderPipeline"),lr=Le(),dr=Le(),cr=Ae([hr]),ur((mr=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),s=0;s<i;s++)r[s]=arguments[s];return t=e.call.apply(e,[this].concat(r))||this,o(t,"_tag",fr,h(t)),o(t,"_flows",gr,h(t)),t._quadIB=null,t._quadVBOnscreen=null,t._quadVBOffscreen=null,t._quadIAOnscreen=null,t._quadIAOffscreen=null,t._eventProcessor=new js,t._commandBuffers=[],t._pipelineUBO=new qi,t._macros={},t._constantMacros="",t._profiler=null,t._geometryRenderer=null,t._pipelineRenderData=null,t._renderPasses=new Map,t._width=0,t._height=0,t._lastUsedRenderArea=new te,t._clusterEnabled=!1,t._bloomEnabled=!1,t}s(t,e);var r=t.prototype;return r.getPipelineRenderData=function(){return this._pipelineRenderData},r.initialize=function(e){return this._flows=e.flows,e.tag&&(this._tag=e.tag),!0},r.createRenderPass=function(e,t,i){var r=this._device,s=new G,n=new z;s.format=t,n.format=i,n.stencilStoreOp=V.DISCARD,n.depthStoreOp=V.DISCARD,e&W.COLOR||(e&Pe?s.loadOp=k.CLEAR:(s.loadOp=k.LOAD,s.barrier=r.getGeneralBarrier(new Q(q.COLOR_ATTACHMENT_WRITE,q.COLOR_ATTACHMENT_WRITE)))),(e&W.DEPTH_STENCIL)!==W.DEPTH_STENCIL&&(e&W.DEPTH||(n.depthLoadOp=k.LOAD),e&W.STENCIL||(n.stencilLoadOp=k.LOAD)),n.barrier=r.getGeneralBarrier(new Q(q.DEPTH_STENCIL_ATTACHMENT_WRITE,q.DEPTH_STENCIL_ATTACHMENT_WRITE));var a=new X([s],n);return r.createRenderPass(a)},r.getRenderPass=function(e,t){var i=function(e){for(var t,i=666,r=n(e.colorTextures);!(t=r()).done;){var s=t.value,a=null==s?void 0:s.info,o=a.type+"_"+a.usage+"_"+a.format+"_"+a.width+"_"+a.height+"_"+a.flags+"_\n            "+a.layerCount+"_"+a.levelCount+"_"+a.samples+"_"+a.depth+"_"+a.externalRes;i=j(o,i)}if(e.depthStencilTexture){var h=e.depthStencilTexture.info,u=h.type+"_"+h.usage+"_"+h.format+"_"+h.width+"_"+h.height+"_"+h.flags+"_\n            "+h.layerCount+"_"+h.levelCount+"_"+h.samples+"_"+h.depth+"_"+h.externalRes;i=j(u,i)}return i}(t),r=j(i+"_"+e,666),s=this._renderPasses.get(r);return s||(s=this.createRenderPass(e,t.colorTextures[0].format,t.depthStencilTexture.format),this._renderPasses.set(r,s),s)},r.newFramebufferByRatio=function(e){for(var t=this.pipelineSceneData,i=this._width*t.shadingScale,r=this._height*t.shadingScale,s=e.colorTextures,n=0;n<s.length;n++)s[n].resize(i,r);e.depthStencilTexture&&e.depthStencilTexture.resize(i,r);var a=this._device.createFramebuffer(new Y(e.renderPass,s,e.depthStencilTexture));return e.destroy(),a},r.generateRenderArea=function(e,t){var i=e.viewport,r=e.window.width,s=e.window.height;t.x=i.x*r,t.y=i.y*s,t.width=i.width*r,t.height=i.height*s},r.generateViewport=function(e,t){this.generateRenderArea(e,Ys),t||(t=Ks);var i=this.pipelineSceneData.shadingScale;return t.left=Ys.x*i,t.top=Ys.y*i,t.width=Ys.width*i,t.height=Ys.height*i,t},r.generateScissor=function(e,t){t||(t=Ys),this.generateRenderArea(e,t);var i=this.pipelineSceneData.shadingScale;return t.x*=i,t.y*=i,t.width*=i,t.height*=i,t},r.getMacroString=function(e){var t=this._macros[e];return void 0===t?"":t},r.getMacroInt=function(e){var t=this._macros[e];return void 0===t?0:t},r.getMacroBool=function(e){var t=this._macros[e];return void 0!==t&&t},r.setMacroString=function(e,t){this._macros[e]=t},r.setMacroInt=function(e,t){this._macros[e]=t},r.setMacroBool=function(e,t){this._macros[e]=t},r.activate=function(){this._device=dt.gfxDevice,this._generateConstantMacros(),this._globalDSManager=new Ui(this._device),this._descriptorSet=this._globalDSManager.globalDescriptorSet,this._pipelineUBO.activate(this._device,this),this._macros.CC_USE_HDR=this._pipelineSceneData.isHDR,this._macros.CC_USE_DEBUG_VIEW=0,this._generateConstantMacros(),this._pipelineSceneData.activate(this._device);for(var e=0;e<this._flows.length;e++)this._flows[e].activate(this);return!0},r._ensureEnoughSize=function(){},r.render=function(e){if(0!==e.length){this.updateGeometryRenderer(e),this._commandBuffers[0].begin(),this.emit(or.RENDER_FRAME_BEGIN,e),this._ensureEnoughSize(e),Ce(e);for(var t=0;t<e.length;t++){var i=e[t];if(i.scene){this.emit(or.RENDER_CAMERA_BEGIN,i),Ai(this,i),Oi(this,i),this._pipelineUBO.updateGlobalUBO(i.window),this._pipelineUBO.updateCameraUBO(i);for(var r=0;r<this._flows.length;r++)this._flows[r].render(i);this.emit(or.RENDER_CAMERA_END,i)}}this.emit(or.RENDER_FRAME_END,e),this._commandBuffers[0].end(),this._device.queue.submit(this._commandBuffers)}},r._destroyQuadInputAssembler=function(){this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadVBOnscreen&&(this._quadVBOnscreen.destroy(),this._quadVBOnscreen=null),this._quadVBOffscreen&&(this._quadVBOffscreen.destroy(),this._quadVBOffscreen=null),this._quadIAOnscreen&&(this._quadIAOnscreen.destroy(),this._quadIAOnscreen=null),this._quadIAOffscreen&&(this._quadIAOffscreen.destroy(),this._quadIAOffscreen=null)},r._destroyBloomData=function(){var e,t=this._pipelineRenderData.bloom;if(null!==t){t.prefiterTex&&t.prefiterTex.destroy(),t.prefilterFramebuffer&&t.prefilterFramebuffer.destroy();for(var i=0;i<t.downsampleTexs.length;++i)t.downsampleTexs[i].destroy(),t.downsampleFramebuffers[i].destroy();t.downsampleTexs.length=0,t.downsampleFramebuffers.length=0;for(var r=0;r<t.upsampleTexs.length;++r)t.upsampleTexs[r].destroy(),t.upsampleFramebuffers[r].destroy();t.upsampleTexs.length=0,t.upsampleFramebuffers.length=0,t.combineTex&&t.combineTex.destroy(),t.combineFramebuffer&&t.combineFramebuffer.destroy(),null===(e=t.renderPass)||void 0===e||e.destroy(),this._pipelineRenderData.bloom=null}},r._genQuadVertexData=function(e,t){var i=new Float32Array(16),r=t.x/this._width,s=(t.x+t.width)/this._width,n=t.y/this._height,a=(t.y+t.height)/this._height;if(this.device.capabilities.screenSpaceSignY>0){var o=a;a=n,n=o}var h=0;switch(e){case K.IDENTITY:h=0,i[h++]=-1,i[h++]=-1,i[h++]=r,i[h++]=a,i[h++]=1,i[h++]=-1,i[h++]=s,i[h++]=a,i[h++]=-1,i[h++]=1,i[h++]=r,i[h++]=n,i[h++]=1,i[h++]=1,i[h++]=s,i[h++]=n;break;case K.ROTATE_90:h=0,i[h++]=-1,i[h++]=-1,i[h++]=s,i[h++]=a,i[h++]=1,i[h++]=-1,i[h++]=s,i[h++]=n,i[h++]=-1,i[h++]=1,i[h++]=r,i[h++]=a,i[h++]=1,i[h++]=1,i[h++]=r,i[h++]=n;break;case K.ROTATE_180:h=0,i[h++]=-1,i[h++]=-1,i[h++]=r,i[h++]=n,i[h++]=1,i[h++]=-1,i[h++]=s,i[h++]=n,i[h++]=-1,i[h++]=1,i[h++]=r,i[h++]=a,i[h++]=1,i[h++]=1,i[h++]=s,i[h++]=a;break;case K.ROTATE_270:h=0,i[h++]=-1,i[h++]=-1,i[h++]=r,i[h++]=n,i[h++]=1,i[h++]=-1,i[h++]=r,i[h++]=a,i[h++]=-1,i[h++]=1,i[h++]=s,i[h++]=n,i[h++]=1,i[h++]=1,i[h++]=s,i[h++]=a}return i},r._createQuadInputAssembler=function(){var e=new Zs,t=4*Float32Array.BYTES_PER_ELEMENT,i=4*t,r=this._device.createBuffer(new L(C.VERTEX|C.TRANSFER_DST,M.DEVICE|M.HOST,i,t));if(!r)return e;var s=Uint8Array.BYTES_PER_ELEMENT,n=6*s,a=this._device.createBuffer(new L(C.INDEX|C.TRANSFER_DST,M.DEVICE,n,s));if(!a)return e;var o=new Uint8Array(6);o[0]=0,o[1]=1,o[2]=2,o[3]=1,o[4]=3,o[5]=2,a.update(o);var h=new Array(2);h[0]=new B("a_position",O.RG32F),h[1]=new B("a_texCoord",O.RG32F);var u=this._device.createInputAssembler(new J(h,[r],a));return e.quadIB=a,e.quadVB=r,e.quadIA=u,e},r.updateQuadVertexData=function(e,t){var i=this._lastUsedRenderArea;if(i.x!==e.x||i.y!==e.y||i.width!==e.width||i.height!==e.height){var r=this._genQuadVertexData(K.IDENTITY,e);this._quadVBOffscreen.update(r);var s=this._genQuadVertexData(t.swapchain&&t.swapchain.surfaceTransform||K.IDENTITY,e);this._quadVBOnscreen.update(s),i.copy(e)}},r.destroy=function(){for(var t,i,r=0;r<this._flows.length;r++)this._flows[r].destroy();this._flows.length=0,this._descriptorSet&&this._descriptorSet.destroy(),null===(t=this._globalDSManager)||void 0===t||t.destroy();for(var s=0;s<this._commandBuffers.length;s++)this._commandBuffers[s].destroy();return this._commandBuffers.length=0,this._pipelineUBO.destroy(),null===(i=this._pipelineSceneData)||void 0===i||i.destroy(),e.prototype.destroy.call(this)},r.onGlobalPipelineStateChanged=function(){},r._generateConstantMacros=function(){var e="";e+="#define CC_DEVICE_SUPPORT_FLOAT_TEXTURE "+(this.device.getFormatFeatures(O.RGBA32F)&(Z.RENDER_TARGET|Z.SAMPLED_TEXTURE)?1:0)+"\n",e+="#define CC_ENABLE_CLUSTERED_LIGHT_CULLING "+(this._clusterEnabled?1:0)+"\n",e+="#define CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS "+this.device.capabilities.maxVertexUniformVectors+"\n",e+="#define CC_DEVICE_MAX_FRAGMENT_UNIFORM_VECTORS "+this.device.capabilities.maxFragmentUniformVectors+"\n",e+="#define CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT "+(this.device.hasFeature(R.INPUT_ATTACHMENT_BENEFIT)?1:0)+"\n",e+="#define CC_PLATFORM_ANDROID_AND_WEBGL "+($.os===ee.ANDROID&&$.isBrowser?1:0)+"\n",e+="#define CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES "+(l.ENABLE_WEBGL_HIGHP_STRUCT_VALUES?1:0)+"\n",e+="#define CC_JOINT_UNIFORM_CAPACITY "+Rt.JOINT_UNIFORM_CAPACITY+"\n",this._constantMacros=e},r.updateGeometryRenderer=function(e){if(!this._geometryRenderer)for(var t=0;t<e.length;t++){var i=e[t];if(i&&i.window&&i.window.swapchain)return i.initGeometryRenderer(),void(this._geometryRenderer=i.geometryRenderer)}},r.generateBloomRenderData=function(){if(null==this._pipelineRenderData.bloom){var e=this._pipelineRenderData.bloom=new Js,t=this.device,i=new G;i.format=O.RGBA8,i.loadOp=k.CLEAR,i.storeOp=V.STORE,i.barrier=t.getGeneralBarrier(new Q(q.NONE,q.COLOR_ATTACHMENT_WRITE)),e.renderPass=t.createRenderPass(new X([i]));var r=this._width,s=this._height;e.prefiterTex=t.createTexture(new E(T.TEX2D,A.COLOR_ATTACHMENT|A.SAMPLED,O.RGBA8,r>>1,s>>1)),e.prefilterFramebuffer=t.createFramebuffer(new Y(e.renderPass,[e.prefiterTex])),r>>=1,s>>=1;for(var n=0;n<6;++n)e.downsampleTexs.push(t.createTexture(new E(T.TEX2D,A.COLOR_ATTACHMENT|A.SAMPLED,O.RGBA8,r>>1,s>>1))),e.downsampleFramebuffers[n]=t.createFramebuffer(new Y(e.renderPass,[e.downsampleTexs[n]])),e.upsampleTexs.push(t.createTexture(new E(T.TEX2D,A.COLOR_ATTACHMENT|A.SAMPLED,O.RGBA8,r,s))),e.upsampleFramebuffers[n]=t.createFramebuffer(new Y(e.renderPass,[e.upsampleTexs[n]])),r>>=1,s>>=1;e.combineTex=t.createTexture(new E(T.TEX2D,A.COLOR_ATTACHMENT|A.SAMPLED,O.RGBA8,this._width,this._height)),e.combineFramebuffer=t.createFramebuffer(new Y(e.renderPass,[e.combineTex])),e.sampler=this.globalDSManager.linearSampler}},r.on=function(e,t,i,r){return this._eventProcessor.on(e,t,i,r)},r.once=function(e,t,i){return this._eventProcessor.once(e,t,i)},r.off=function(e,t,i){this._eventProcessor.off(e,t,i)},r.emit=function(e,t,i,r,s,n){this._eventProcessor.emit(e,t,i,r,s,n)},r.targetOff=function(e){this._eventProcessor.targetOff(e)},r.removeAll=function(e){this._eventProcessor.removeAll(e)},r.hasEventListener=function(e,t,i){return this._eventProcessor.hasEventListener(e,t,i)},i(t,[{key:"tag",get:function(){return this._tag}},{key:"flows",get:function(){return this._flows}},{key:"quadIAOnscreen",get:function(){return this._quadIAOnscreen}},{key:"quadIAOffscreen",get:function(){return this._quadIAOffscreen}},{key:"constantMacros",get:function(){return this._constantMacros}},{key:"macros",get:function(){return this._macros}},{key:"device",get:function(){return this._device}},{key:"globalDSManager",get:function(){return this._globalDSManager}},{key:"descriptorSetLayout",get:function(){return this._globalDSManager.descriptorSetLayout}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"commandBuffers",get:function(){return this._commandBuffers}},{key:"pipelineUBO",get:function(){return this._pipelineUBO}},{key:"pipelineSceneData",get:function(){return this._pipelineSceneData}},{key:"profiler",get:function(){return this._profiler},set:function(e){this._profiler=e}},{key:"geometryRenderer",get:function(){return this._geometryRenderer}},{key:"clusterEnabled",get:function(){return this._clusterEnabled},set:function(e){this._clusterEnabled=e}},{key:"bloomEnabled",get:function(){return this._bloomEnabled},set:function(e){this._bloomEnabled=e}},{key:"shadingScale",get:function(){return this._pipelineSceneData.shadingScale},set:function(e){this._pipelineSceneData.shadingScale!==e&&(this._pipelineSceneData.shadingScale=e,this.emit(or.ATTACHMENT_SCALE_CAHNGED,e))}}]),t}(Me),fr=a((pr=mr).prototype,"_tag",[lr,Fe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),gr=a(pr.prototype,"_flows",[dr,cr,Fe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_r=pr))||_r));t.RenderPipeline=$s,nt($s.prototype,"RenderPipeline.prototype",[{name:"geometryRenderer",suggest:"please use camera.geometryRenderer instead."}]),function(e){e[e.BLOOM=18]="BLOOM",e[e.POST_PROCESS=19]="POST_PROCESS",e[e.UI=20]="UI"}(Sr||(Sr={})),function(e){e[e.FORWARD=10]="FORWARD"}(vr||(vr={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.FORWARD=1]="FORWARD",e[e.UI=10]="UI"}(wr||(wr={})),function(e){e[e.GBUFFER=10]="GBUFFER",e[e.LIGHTING=15]="LIGHTING",e[e.TRANSPARENT=18]="TRANSPARENT"}(yr||(yr={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.MAIN=1]="MAIN",e[e.UI=10]="UI"}(Er||(Er={})),d(T),d(A),d(V),d(k),d(q),d(O),function(e){e[e.SCENE=0]="SCENE",e[e.POSTPROCESS=1]="POSTPROCESS",e[e.UI=2]="UI"}(Xs||(Xs={})),d(Xs),Tr=Te("RenderTextureDesc"),Ar=Ae(T),Or=Ae(A),br=Ae(O),Tr((Ir=a((Fr=function(){o(this,"name",Ir,this),o(this,"type",Rr,this),o(this,"usage",Dr,this),o(this,"format",Br,this),o(this,"width",Pr,this),o(this,"height",Nr,this)}).prototype,"name",[Fe,He],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Rr=a(Fr.prototype,"type",[Ar],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return T.TEX2D}}),Dr=a(Fr.prototype,"usage",[Or],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return A.COLOR_ATTACHMENT}}),Br=a(Fr.prototype,"format",[br],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return O.UNKNOWN}}),Pr=a(Fr.prototype,"width",[Fe,He],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Nr=a(Fr.prototype,"height",[Fe,He],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Fr));var en,tn=(Lr=Te("RenderTextureConfig"),Cr=Ae(xe),Lr((Ur=a((xr=function(){o(this,"name",Ur,this),o(this,"texture",Hr,this)}).prototype,"name",[Fe,He],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Hr=a(xr.prototype,"texture",[Cr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Mr=xr))||Mr),rn=(Gr=Te("MaterialConfig"),zr=Ae(Ue),Gr((Wr=a((Vr=function(){o(this,"name",Wr,this),o(this,"material",kr,this)}).prototype,"name",[Fe,He],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),kr=a(Vr.prototype,"material",[zr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Vr)),Qr=Te("FrameBufferDesc"),qr=Ae([c]),Xr=Ae(xe),Qr((Yr=a((jr=function(){o(this,"name",Yr,this),o(this,"renderPass",Kr,this),o(this,"colorTextures",Jr,this),o(this,"depthStencilTexture",Zr,this),o(this,"texture",$r,this)}).prototype,"name",[Fe,He],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Kr=a(jr.prototype,"renderPass",[Fe,He],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Jr=a(jr.prototype,"colorTextures",[qr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Zr=a(jr.prototype,"depthStencilTexture",[Fe,He],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),$r=a(jr.prototype,"texture",[Xr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jr)),es=Te("ColorDesc"),ts=Ae(O),is=Ae(k),rs=Ae(V),ss=Ae([q]),ns=Ae([q]),es((hs=a((os=function(){o(this,"format",hs,this),o(this,"loadOp",us,this),o(this,"storeOp",ls,this),o(this,"sampleCount",ds,this),o(this,"beginAccesses",cs,this),o(this,"endAccesses",_s,this)}).prototype,"format",[ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return O.UNKNOWN}}),us=a(os.prototype,"loadOp",[is],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return k.CLEAR}}),ls=a(os.prototype,"storeOp",[rs],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return V.STORE}}),ds=a(os.prototype,"sampleCount",[Fe,He],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),cs=a(os.prototype,"beginAccesses",[ss],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return q.NONE}}),_s=a(os.prototype,"endAccesses",[ns],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return q.COLOR_ATTACHMENT_WRITE}}),as=os))||as),sn=(ps=Te("DepthStencilDesc"),fs=Ae(O),gs=Ae(k),ms=Ae(V),Ss=Ae(k),vs=Ae(V),ws=Ae(q),ys=Ae(q),ps((As=a((Ts=function(){o(this,"format",As,this),o(this,"depthLoadOp",Os,this),o(this,"depthStoreOp",bs,this),o(this,"stencilLoadOp",Fs,this),o(this,"stencilStoreOp",Is,this),o(this,"sampleCount",Rs,this),o(this,"beginAccesses",Ds,this),o(this,"endAccesses",Bs,this)}).prototype,"format",[fs],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return O.UNKNOWN}}),Os=a(Ts.prototype,"depthLoadOp",[gs],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return k.CLEAR}}),bs=a(Ts.prototype,"depthStoreOp",[ms],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return V.STORE}}),Fs=a(Ts.prototype,"stencilLoadOp",[Ss],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return k.CLEAR}}),Is=a(Ts.prototype,"stencilStoreOp",[vs],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return V.STORE}}),Rs=a(Ts.prototype,"sampleCount",[Fe,He],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Ds=a(Ts.prototype,"beginAccesses",[ws],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return q.NONE}}),Bs=a(Ts.prototype,"endAccesses",[ys],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return q.DEPTH_STENCIL_ATTACHMENT_WRITE}}),Es=Ts))||Es);Ps=Te("RenderPassDesc"),Ns=Ae([rn]),Ls=Ae(sn),Ps((Ms=a((Cs=function(){o(this,"index",Ms,this),o(this,"colorAttachments",xs,this),o(this,"depthStencilAttachment",Us,this)}).prototype,"index",[Fe,He],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),xs=a(Cs.prototype,"colorAttachments",[Ns],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Us=a(Cs.prototype,"depthStencilAttachment",[Ls],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new sn}}),Cs)),function(e){e[e.FRONT_TO_BACK=0]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=1]="BACK_TO_FRONT"}(en||(en={})),d(en);var nn=(Hs=Te("RenderQueueDesc"),Gs=Ae(en),zs=Ae([c]),Hs((ks=a((Ws=function(){o(this,"isTransparent",ks,this),o(this,"sortMode",Qs,this),o(this,"stages",qs,this)}).prototype,"isTransparent",[Fe,He],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Qs=a(Ws.prototype,"sortMode",[Gs],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return en.FRONT_TO_BACK}}),qs=a(Ws.prototype,"stages",[zs],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Vs=Ws))||Vs);function an(e,t){return e.hash-t.hash||e.depth-t.depth||e.shaderId-t.shaderId}function on(e,t){return e.priority-t.priority||e.hash-t.hash||t.depth-e.depth||e.shaderId-t.shaderId}var hn=function(){function e(e){this.queue=void 0,this._passDesc=void 0,this._passPool=void 0,this._passDesc=e,this._passPool=new re((function(){return{priority:0,hash:0,depth:0,shaderId:0,subModel:null,passIdx:0}}),64),this.queue=new se(64,this._passDesc.sortFunc)}var t=e.prototype;return t.clear=function(){this.queue.clear(),this._passPool.reset()},t.insertRenderPass=function(e,t,i){var r=e.model.subModels[t],s=r.passes[i],n=r.shaders[i];if(s.blendState.targets[0].blend!==this._passDesc.isTransparent||!(s.phase&this._passDesc.phases))return!1;var a=0|s.priority<<16|r.priority<<8|i,o=this._passPool.add();return o.priority=e.model.priority,o.hash=a,o.depth=e.depth||0,o.shaderId=n.typedID,o.subModel=r,o.passIdx=i,this.queue.push(o),!0},t.sort=function(){this.queue.sort()},t.recordCommandBuffer=function(e,t,i){for(var r=0;r<this.queue.length;++r){var s=this.queue.array[r],n=s.subModel,a=s.passIdx,o=n.inputAssembler,h=n.passes[a],u=n.shaders[a],l=Dt.getOrCreatePipelineState(e,h,u,t,o);i.bindPipelineState(l),i.bindDescriptorSet(Bt.MATERIAL,h.descriptorSet),i.bindDescriptorSet(Bt.LOCAL,n.descriptorSet),i.bindInputAssembler(o),i.draw(o)}},e}();function un(e){for(var t=0,i=0;i<e.stages.length;i++)t|=_e(e.stages[i]);var r=an;switch(e.sortMode){case en.BACK_TO_FRONT:r=on;break;case en.FRONT_TO_BACK:r=an}return new hn({isTransparent:e.isTransparent,phases:t,sortFunc:r})}function ln(e){e.clear()}function dn(e){e.sort()}var cn=function(){function e(){this.queue=new Set}var t=e.prototype;return t.clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()},t.uploadBuffers=function(e){for(var t=this.queue.values(),i=t.next();!i.done;){for(var r=0;r<i.value.batches.length;++r){var s=i.value.batches[r];if(s.mergeCount){for(var n=0;n<s.vbs.length;++n)s.vbs[n].update(s.vbDatas[n]);e.updateBuffer(s.vbIdx,s.vbIdxData.buffer),e.updateBuffer(s.ubo,s.uboData)}}i=t.next()}},t.recordCommandBuffer=function(e,t,i,r,s){void 0===r&&(r=null);for(var n=this.queue.values(),a=n.next();!a.done;){for(var o=!1,h=0;h<a.value.batches.length;++h){var u=a.value.batches[h];if(u.mergeCount){if(!o){var l=u.shader,d=Dt.getOrCreatePipelineState(e,u.pass,l,t,u.ia);i.bindPipelineState(d),i.bindDescriptorSet(Bt.MATERIAL,u.pass.descriptorSet),o=!0}r&&i.bindDescriptorSet(Bt.GLOBAL,r),s?i.bindDescriptorSet(Bt.LOCAL,u.descriptorSet,s):i.bindDescriptorSet(Bt.LOCAL,u.descriptorSet,a.value.dynamicOffsets),i.bindInputAssembler(u.ia),i.draw(u.ia)}}a=n.next()}},e}(),_n=function(){function e(){this.queue=new Set,this._renderQueue=[]}var t=e.prototype;return t.clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this._renderQueue=[],this.queue.clear()},t.sort=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.pass.blendState.targets[0].blend||this._renderQueue.push(t.value),t=e.next();for(t=(e=this.queue.values()).next();!t.done;)t.value.pass.blendState.targets[0].blend&&this._renderQueue.push(t.value),t=e.next()},t.uploadBuffers=function(e){for(var t=this.queue.values(),i=t.next();!i.done;)i.value.hasPendingModels&&i.value.uploadBuffers(e),i=t.next()},t.recordCommandBuffer=function(e,t,i,r,s){void 0===r&&(r=null);for(var n=0===this._renderQueue.length?this.queue.values():this._renderQueue.values(),a=n.next();!a.done;){var o=a.value,h=o.instances,u=o.pass;if(o.hasPendingModels){i.bindDescriptorSet(Bt.MATERIAL,u.descriptorSet);for(var l=null,d=0;d<h.length;++d){var c=h[d];if(c.count){var _=c.shader,p=Dt.getOrCreatePipelineState(e,u,_,t,c.ia);l!==p&&(i.bindPipelineState(p),l=p),r&&i.bindDescriptorSet(Bt.GLOBAL,r),s?i.bindDescriptorSet(Bt.LOCAL,c.descriptorSet,s):i.bindDescriptorSet(Bt.LOCAL,c.descriptorSet,a.value.dynamicOffsets),i.bindInputAssembler(c.ia),i.draw(c.ia)}}}a=n.next()}},e}(),pn=new x((function(){return{subModel:null,passIdx:-1,dynamicOffsets:[],lights:[]}}),16),fn=new Float32Array(4),gn=[],mn=[],Sn=new Je,vn=new Je;function wn(e,t){return!(!t.worldBounds||De.aabbWithAABB(t.worldBounds,e.aabb))}function yn(e,t){return!(!t.worldBounds||De.aabbWithAABB(t.worldBounds,e.aabb)&&De.aabbFrustum(t.worldBounds,e.frustum))}var En=_e("forward-add"),Tn=[];function An(e,t){t.length=0;for(var i=!1,r=0;r<e.length;r++){for(var s=e[r].passes,n=-1,a=0;a<s.length;a++)if(s[a].phase===En){n=a,i=!0;break}t.push(n)}return i}var On,bn,Fn,In,Rn,Dn,Bn,Pn,Nn,Ln,Cn,Mn=e("N",function(){function e(e){this._pipeline=void 0,this._device=void 0,this._lightPasses=[],this._instancedLightPassPool=pn.alloc(),this._batchedLightPassPool=pn.alloc(),this._shadowUBO=new Float32Array(wt.COUNT),this._lightBufferCount=16,this._lightBufferStride=void 0,this._lightBufferElementCount=void 0,this._lightBuffer=void 0,this._firstLightBufferView=void 0,this._lightBufferData=void 0,this._instancedQueue=void 0,this._batchedQueue=void 0,this._lightMeterScale=1e4,this._pipeline=e,this._device=e.device,this._instancedQueue=new _n,this._batchedQueue=new cn;var t=this._device.capabilities.uboOffsetAlignment;this._lightBufferStride=Math.ceil(Pt.SIZE/t)*t,this._lightBufferElementCount=this._lightBufferStride/Float32Array.BYTES_PER_ELEMENT,this._lightBuffer=this._device.createBuffer(new L(C.UNIFORM|C.TRANSFER_DST,M.HOST|M.DEVICE,this._lightBufferStride*this._lightBufferCount,this._lightBufferStride)),this._firstLightBufferView=this._device.createBuffer(new ne(this._lightBuffer,0,Pt.SIZE)),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount)}var t=e.prototype;return t.clear=function(){this._instancedQueue.clear(),this._batchedQueue.clear();for(var e=0;e<this._lightPasses.length;e++){var t=this._lightPasses[e];t.dynamicOffsets.length=0,t.lights.length=0}pn.freeArray(this._lightPasses),this._lightPasses.length=0,this._instancedLightPassPool.dynamicOffsets.length=0,this._instancedLightPassPool.lights.length=0,this._batchedLightPassPool.dynamicOffsets.length=0,this._batchedLightPassPool.lights.length=0},t.destroy=function(){for(var e=this._pipeline.globalDSManager.descriptorSetMap,t=e.keys,i=0;i<t.length;i++){var r=t[i],s=e.get(r);s&&(s.getBuffer(wt.BINDING).destroy(),s.getTexture(bt).destroy(),s.getTexture(Ft).destroy(),s.destroy()),e.delete(r)}},t.gatherLightPasses=function(e,t){this.clear();var i=this._pipeline.pipelineSceneData.validPunctualLights;if(i.length){this._updateUBOs(e,t),this._updateLightDescriptorSet(e,t);for(var r=this._pipeline.pipelineSceneData.renderObjects,s=0;s<r.length;s++){var n=r[s].model,a=n.subModels;if(An(a,Tn)&&(mn.length=0,this._lightCulling(n,i),mn.length))for(var o=0;o<a.length;o++){var h=Tn[o];if(!(h<0)){var u=a[o],l=u.passes[h];u.passes[0].blendState.targets[0].blend||(u.descriptorSet.bindBuffer(Pt.BINDING,this._firstLightBufferView),u.descriptorSet.update(),this._addRenderQueue(l,u,n,h))}}}for(var d=0;d<i.length;d++){var c=i[d];this._instancedLightPassPool.lights.push(c),this._instancedLightPassPool.dynamicOffsets.push(this._lightBufferStride*d),this._batchedLightPassPool.lights.push(c),this._batchedLightPassPool.dynamicOffsets.push(this._lightBufferStride*d)}this._instancedQueue.uploadBuffers(t),this._batchedQueue.uploadBuffers(t)}},t.recordCommandBuffer=function(e,t,i){for(var r=this._pipeline.globalDSManager,s=0;s<this._instancedLightPassPool.lights.length;++s){var n=this._instancedLightPassPool.lights[s];gn[0]=this._instancedLightPassPool.dynamicOffsets[s];var a=r.getOrCreateDescriptorSet(n);this._instancedQueue.recordCommandBuffer(e,t,i,a,gn)}for(var o=0;o<this._batchedLightPassPool.lights.length;++o){var h=this._batchedLightPassPool.lights[o];gn[0]=this._batchedLightPassPool.dynamicOffsets[o];var u=r.getOrCreateDescriptorSet(h);this._batchedQueue.recordCommandBuffer(e,t,i,u,gn)}for(var l=0;l<this._lightPasses.length;l++){var d=this._lightPasses[l],c=d.subModel,_=d.passIdx,p=d.dynamicOffsets,f=d.lights,g=c.passes[_],m=c.shaders[_],S=c.inputAssembler,v=Dt.getOrCreatePipelineState(e,g,m,t,S),w=g.descriptorSet,y=c.descriptorSet;i.bindPipelineState(v),i.bindDescriptorSet(Bt.MATERIAL,w),i.bindInputAssembler(S);for(var E=0;E<p.length;++E){var T=f[E],A=r.getOrCreateDescriptorSet(T);gn[0]=p[E],i.bindDescriptorSet(Bt.GLOBAL,A),i.bindDescriptorSet(Bt.LOCAL,y,gn),i.draw(S)}}},t._lightCulling=function(e,t){for(var i=!1,r=!function(e){for(var t=e.subModels,i=0;i<t.length;++i)for(var r=t[i].passes,s=0;s<r.length;++s){var n=r[s].batchingScheme;if(n===ce.INSTANCING)return!0;if(n===ce.VB_MERGING)return!0}return!1}(e),s=0;s<t.length;s++){var n=t[s];switch(n.type){case Xt.SPHERE:r&&(i=wn(n,e));break;case Xt.SPOT:r&&(i=yn(n,e))}i||mn.push(s)}},t._addRenderQueue=function(e,t,i,r){var s=this._pipeline.pipelineSceneData.validPunctualLights,n=e.batchingScheme;if(n===ce.INSTANCING){var a=e.getInstancedBuffer();a.merge(t,r),a.dynamicOffsets[0]=this._lightBufferStride,this._instancedQueue.queue.add(a)}else if(n===ce.VB_MERGING){var o=e.getBatchedBuffer();o.merge(t,r,i),o.dynamicOffsets[0]=this._lightBufferStride,this._batchedQueue.queue.add(o)}else{var h=pn.alloc();h.subModel=t,h.passIdx=r;for(var u=0;u<mn.length;u++){var l=mn[u],d=s[l];h.lights.push(d),h.dynamicOffsets.push(this._lightBufferStride*l)}this._lightPasses.push(h)}},t._updateLightDescriptorSet=function(e,t){for(var i=this._pipeline.device,r=this._pipeline.pipelineSceneData,s=r.shadows,n=r.shadowFrameBufferMap,a=e.scene.mainLight,o=It(i)?0:1,h=this._pipeline.globalDSManager,u=r.validPunctualLights,l=this._pipeline.device.capabilities,d=0;d<u.length;d++){var c=u[d],_=h.getOrCreateDescriptorSet(c);if(_){var p=void 0,f=void 0;switch(c.type){case Xt.SPHERE:a&&qi.updatePlanarNormalAndDistance(s,this._shadowUBO),this._shadowUBO[wt.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=s.size.x,this._shadowUBO[wt.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=s.size.y,this._shadowUBO[wt.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=1,this._shadowUBO[wt.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=0,this._shadowUBO[wt.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=2,this._shadowUBO[wt.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=o,this._shadowUBO[wt.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=0,this._shadowUBO[wt.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,rt.toArray(this._shadowUBO,s.shadowColor,wt.SHADOW_COLOR_OFFSET);break;case Xt.SPOT:var g=c;if(a&&qi.updatePlanarNormalAndDistance(s,this._shadowUBO),Je.invert(Sn,c.node.getWorldMatrix()),Je.perspective(vn,c.angle,1,.001,c.range,!0,l.clipSpaceMinZ,l.clipSpaceSignY,0),p=vn.clone(),f=vn.clone().invert(),Je.multiply(vn,vn,Sn),Je.toArray(this._shadowUBO,Sn,wt.MAT_LIGHT_VIEW_OFFSET),Je.toArray(this._shadowUBO,vn,wt.MAT_LIGHT_VIEW_PROJ_OFFSET),this._shadowUBO[wt.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=.01,this._shadowUBO[wt.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=c.range,this._shadowUBO[wt.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,this._shadowUBO[wt.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=0,this._shadowUBO[wt.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=s.size.x,this._shadowUBO[wt.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=s.size.y,this._shadowUBO[wt.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=g.shadowPcf,this._shadowUBO[wt.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=g.shadowBias,this._shadowUBO[wt.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=1,this._shadowUBO[wt.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=o,this._shadowUBO[wt.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=g.shadowNormalBias,this._shadowUBO[wt.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,this._shadowUBO[wt.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=p.m10,this._shadowUBO[wt.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=p.m14,this._shadowUBO[wt.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=p.m11,this._shadowUBO[wt.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=p.m15,this._shadowUBO[wt.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+0]=f.m10,this._shadowUBO[wt.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+1]=f.m14,this._shadowUBO[wt.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+2]=f.m11,this._shadowUBO[wt.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+3]=f.m15,this._shadowUBO[wt.SHADOW_PROJ_INFO_OFFSET+0]=p.m00,this._shadowUBO[wt.SHADOW_PROJ_INFO_OFFSET+1]=p.m05,this._shadowUBO[wt.SHADOW_PROJ_INFO_OFFSET+2]=1/p.m00,this._shadowUBO[wt.SHADOW_PROJ_INFO_OFFSET+3]=1/p.m05,rt.toArray(this._shadowUBO,s.shadowColor,wt.SHADOW_COLOR_OFFSET),n.has(c)){var m,S=null===(m=n.get(c))||void 0===m?void 0:m.colorTextures[0];S&&_.bindTexture(Ft,S)}}_.update(),t.updateBuffer(_.getBuffer(wt.BINDING),this._shadowUBO)}}},t._updateUBOs=function(e,t){var i=e.exposure,r=this._pipeline.pipelineSceneData,s=r.isHDR,n=r.shadows,a=r.validPunctualLights;a.length>this._lightBufferCount&&(this._firstLightBufferView.destroy(),this._lightBufferCount=at(a.length),this._lightBuffer.resize(this._lightBufferStride*this._lightBufferCount),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount),this._firstLightBufferView.initialize(new ne(this._lightBuffer,0,Pt.SIZE)));for(var o=0,h=0;o<a.length;o++,h+=this._lightBufferElementCount){var u=a[o];switch(u.type){case Xt.SPHERE:if($e.toArray(fn,u.position),fn[3]=0,this._lightBufferData.set(fn,h+Pt.LIGHT_POS_OFFSET),fn[0]=u.size,fn[1]=u.range,fn[2]=0,fn[3]=0,this._lightBufferData.set(fn,h+Pt.LIGHT_SIZE_RANGE_ANGLE_OFFSET),$e.toArray(fn,u.color),u.useColorTemperature){var l=u.colorTemperatureRGB;fn[0]*=l.x,fn[1]*=l.y,fn[2]*=l.z}fn[3]=s?u.luminance*i*this._lightMeterScale:u.luminance,this._lightBufferData.set(fn,h+Pt.LIGHT_COLOR_OFFSET);break;case Xt.SPOT:if($e.toArray(fn,u.position),fn[3]=1,this._lightBufferData.set(fn,h+Pt.LIGHT_POS_OFFSET),fn[0]=u.size,fn[1]=u.range,fn[2]=u.spotAngle,fn[3]=n.enabled&&u.shadowEnabled&&n.type===Be.ShadowMap?1:0,this._lightBufferData.set(fn,h+Pt.LIGHT_SIZE_RANGE_ANGLE_OFFSET),$e.toArray(fn,u.direction),this._lightBufferData.set(fn,h+Pt.LIGHT_DIR_OFFSET),$e.toArray(fn,u.color),u.useColorTemperature){var d=u.colorTemperatureRGB;fn[0]*=d.x,fn[1]*=d.y,fn[2]*=d.z}fn[3]=s?u.luminance*i*this._lightMeterScale:u.luminance,this._lightBufferData.set(fn,h+Pt.LIGHT_COLOR_OFFSET)}}t.updateBuffer(this._lightBuffer,this._lightBufferData)},e}()),xn=new pe,Un=e("Q",function(){function e(e){this._pendingSubModels=[],this._castModels=[],this._instancedQueue=new _n,this._pipeline=void 0,this._pipeline=e}var t=e.prototype;return t.gatherShadowPasses=function(e,t){var i=this._pipeline.pipelineSceneData.shadows;if(this._instancedQueue.clear(),this._pendingSubModels.length=0,this._castModels.length=0,i.enabled&&i.type===Be.Planar&&!(i.normal.length()<1e-6)){var r=e.scene,s=e.frustum,n=0!=(e.visibility&gt.BitMask.DEFAULT);if(r.mainLight&&n){for(var a=r.models,o=0;o<a.length;o++){var h=a[o];h.enabled&&h.node&&h.castShadow&&this._castModels.push(h)}var u=i.instancingMaterial.passes[0].getInstancedBuffer();this._instancedQueue.queue.add(u);for(var l=0;l<this._castModels.length;l++){var d=this._castModels[l];if(!d.worldBounds||(pe.transform(xn,d.worldBounds,i.matLight),De.aabbFrustum(xn,s)))for(var c=d.subModels,_=0;_<c.length;_++)for(var p=c[_],f=p.passes,g=0;g<f.length;g++)f[g].batchingScheme===ce.INSTANCING?(u.merge(p,g,p.planarShader),this._instancedQueue.queue.add(u)):this._pendingSubModels.push(p)}this._instancedQueue.uploadBuffers(t)}}},t.recordCommandBuffer=function(e,t,i){var r=this._pipeline.pipelineSceneData.shadows;if(r.enabled&&r.type===Be.Planar&&(this._instancedQueue.recordCommandBuffer(e,t,i),this._pendingSubModels.length)){var s=r.material.passes[0],n=s.descriptorSet;i.bindDescriptorSet(Bt.MATERIAL,n);for(var a=this._pendingSubModels,o=0;o<a.length;o++){var h=a[o],u=h.planarShader,l=h.inputAssembler,d=Dt.getOrCreatePipelineState(e,s,u,t,l);i.bindPipelineState(d),i.bindDescriptorSet(Bt.LOCAL,h.descriptorSet),i.bindInputAssembler(l),i.draw(l)}}},e}()),Hn=function(){function e(){this._phaseID=_e("default")}var t=e.prototype;return t.activate=function(e){this._pipeline=e},t.render=function(e,t){for(var i=this._pipeline,r=i.device,s=i.commandBuffers[0],n=e.scene.batches,a=0;a<n.length;a++){var o=n[a],h=!1;if(e.visibility&o.visFlags&&(h=!0),h)for(var u=o.shaders.length,l=0;l<u;l++){var d=o.passes[l];if(d.phase===this._phaseID){var c=o.shaders[l],_=o.inputAssembler,p=Dt.getOrCreatePipelineState(r,d,c,t,_);s.bindPipelineState(p),s.bindDescriptorSet(Bt.MATERIAL,d.descriptorSet);var f=o.descriptorSet;s.bindDescriptorSet(Bt.LOCAL,f),s.bindInputAssembler(_),s.draw(_)}}}},e}(),Gn=[new ae(0,0,0,1)],zn=e("s",(On=Te("ForwardStage"),bn=Ae([nn]),Fn=Le(),On((Pn=Bn=function(e){function t(){var t;return t=e.call(this)||this,o(t,"renderQueues",Dn,h(t)),t._renderQueues=[],t._renderArea=new te,t._batchedQueue=void 0,t._instancedQueue=void 0,t._phaseID=_e("default"),t._clearFlag=4294967295,t.additiveInstanceQueues=[],t._batchedQueue=new cn,t._instancedQueue=new _n,t._uiPhase=new Hn,t}s(t,e);var i=t.prototype;return i.addRenderInstancedQueue=function(e){this.additiveInstanceQueues.includes(e)||this.additiveInstanceQueues.push(e)},i.removeRenderInstancedQueue=function(e){var t=this.additiveInstanceQueues.indexOf(e);t>-1&&this.additiveInstanceQueues.splice(t,1)},i.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},i.activate=function(t,i){e.prototype.activate.call(this,t,i);for(var r=0;r<this.renderQueues.length;r++)this._renderQueues[r]=un(this.renderQueues[r]);this._additiveLightQueue=new Mn(this._pipeline),this._planarQueue=new Un(this._pipeline),this._uiPhase.activate(t)},i.destroy=function(){},i.render=function(e){var t;this._instancedQueue.clear(),this._batchedQueue.clear();var i=this._pipeline,r=i.device;this._renderQueues.forEach(ln);for(var s=i.pipelineSceneData.renderObjects,n=0,a=0,o=0,h=0;h<s.length;++h){var u=s[h],l=u.model.subModels;for(n=0;n<l.length;++n){var d=l[n],c=d.passes;for(a=0;a<c.length;++a){var _=c[a];if(_.phase===this._phaseID){var p=_.batchingScheme;if(p===ce.INSTANCING){var f=_.getInstancedBuffer();f.merge(d,a),this._instancedQueue.queue.add(f)}else if(p===ce.VB_MERGING){var g=_.getBatchedBuffer();g.merge(d,a,u.model),this._batchedQueue.queue.add(g)}else for(o=0;o<this._renderQueues.length;o++)this._renderQueues[o].insertRenderPass(u,n,a)}}}}this._instancedQueue.sort(),this._renderQueues.forEach(dn);var m=i.commandBuffers[0];i.pipelineUBO.updateShadowUBO(e);for(var S=0;S<this.additiveInstanceQueues.length;S++)this.additiveInstanceQueues[S].uploadBuffers(m);this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),this._additiveLightQueue.gatherLightPasses(e,m),this._planarQueue.gatherShadowPasses(e,m),e.clearFlag&W.COLOR&&(Gn[0].x=e.clearColor.x,Gn[0].y=e.clearColor.y,Gn[0].z=e.clearColor.z,Gn[0].w=e.clearColor.w),i.generateRenderArea(e,this._renderArea);var v=e.window.framebuffer,w=i.getRenderPass(e.clearFlag&this._clearFlag,v);m.beginRenderPass(w,v,this._renderArea,Gn,e.clearDepth,e.clearStencil),m.bindDescriptorSet(Bt.GLOBAL,i.descriptorSet),this._renderQueues[0].recordCommandBuffer(r,w,m);for(var y=0;y<this.additiveInstanceQueues.length;y++)this.additiveInstanceQueues[y].recordCommandBuffer(r,w,m);this._instancedQueue.recordCommandBuffer(r,w,m),this._batchedQueue.recordCommandBuffer(r,w,m),this._additiveLightQueue.recordCommandBuffer(r,w,m),m.bindDescriptorSet(Bt.GLOBAL,i.descriptorSet),this._planarQueue.recordCommandBuffer(r,w,m),this._renderQueues[1].recordCommandBuffer(r,w,m),null===(t=e.geometryRenderer)||void 0===t||t.render(w,m,i.pipelineSceneData),this._uiPhase.render(e,w),Ge(r,w,m,i.profiler,e),m.endRenderPass()},t}(ar),Bn.initInfo={name:"ForwardStage",priority:vr.FORWARD,tag:0,renderQueues:[{isTransparent:!1,sortMode:en.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:en.BACK_TO_FRONT,stages:["default","planarShadow"]}]},Dn=a((Rn=Pn).prototype,"renderQueues",[bn,Fe,Fn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),In=Rn))||In)),Vn=e("r",Te("ForwardFlow")((Cn=Ln=function(e){function t(){return e.apply(this,arguments)||this}s(t,e);var i=t.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var i=new zn;i.initialize(zn.initInfo),this._stages.push(i)}return!0},i.activate=function(t){e.prototype.activate.call(this,t)},i.render=function(t){e.prototype.render.call(this,t)},i.destroy=function(){e.prototype.destroy.call(this)},t}(hr),Ln.initInfo={name:Nt,priority:wr.FORWARD,stages:[]},Nn=Cn))||Nn),Wn=_e("shadow-caster");function kn(e){for(var t=e.passes,i=0;i<t.length;i++)if(t[i].phase===Wn)return i;return-1}var Qn,qn,Xn,jn,Yn,Kn,Jn,Zn,$n,ea,ta,ia,ra,sa,na,aa,oa,ha,ua,la,da,ca,_a,pa,fa,ga,ma,Sa,va,wa,ya,Ea,Ta,Aa,Oa,ba,Fa,Ia,Ra,Da,Ba,Pa,Na,La,Ca=e("K",function(){function e(e){this._pipeline=void 0,this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._instancedQueue=void 0,this._batchedQueue=void 0,this._pipeline=e,this._instancedQueue=new _n,this._batchedQueue=new cn}var t=e.prototype;return t.gatherLightPasses=function(e,t,i,r){void 0===r&&(r=0),this.clear();var s=this._pipeline.pipelineSceneData,n=s.shadows;if(t&&n.enabled&&n.type===Be.ShadowMap){switch(t.type){case Xt.DIRECTIONAL:var a=t;if(a.shadowEnabled){var o,h=s.csmLayers;!function(e,t,i){var r=e.scene.mainLight,s=t.csmLayers.layerObjects,n=i.validFrustum,a=i.shadowObjects;a.length=0;for(var o=e.visibility,h=s.length-1;h>=0;h--){var u=s.array[h];if(u){var l=u.model;l.enabled&&l.node&&(o&l.node.layer)===l.node.layer&&null!=a&&l.castShadow&&l.worldBounds&&De.aabbFrustum(l.worldBounds,n)&&(a.push(u),i.level<r.csmLevel&&r.csmOptimizationMode===we.RemoveDuplicates&&De.aabbFrustumCompletelyInside(l.worldBounds,n)&&s.fastRemove(h))}}}(e,s,o=a.shadowFixedArea?h.specialLayer:h.layers[r]);for(var u=o.shadowObjects,l=0;l<u.length;l++){var d=u[l].model;this.add(d)}}break;case Xt.SPOT:var c=t;if(c.shadowEnabled)for(var _=s.csmLayers.castShadowObjects,p=0;p<_.length;p++){var f=_[p].model;f.worldBounds&&!De.aabbFrustum(f.worldBounds,c.frustum)||this.add(f)}}this._instancedQueue.uploadBuffers(i),this._batchedQueue.uploadBuffers(i)}},t.clear=function(){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._batchedQueue.clear()},t.add=function(e){for(var t=e.subModels,i=0;i<t.length;i++){var r=t[i],s=kn(r);if(!(s<0)){var n=r.passes[s];if(n.batchingScheme===ce.INSTANCING){var a=n.getInstancedBuffer();a.merge(r,s),this._instancedQueue.queue.add(a)}else if(n.batchingScheme===ce.VB_MERGING){var o=n.getBatchedBuffer();o.merge(r,s,e),this._batchedQueue.queue.add(o)}else{var h=r.shaders[s];this._subModelsArray.push(r),h&&this._shaderArray.push(h),this._passArray.push(n)}}}},t.recordCommandBuffer=function(e,t,i){this._instancedQueue.recordCommandBuffer(e,t,i),this._batchedQueue.recordCommandBuffer(e,t,i);for(var r=0;r<this._subModelsArray.length;++r){var s=this._subModelsArray[r],n=this._shaderArray[r],a=this._passArray[r],o=s.inputAssembler,h=Dt.getOrCreatePipelineState(e,a,n,t,o),u=a.descriptorSet;i.bindPipelineState(h),i.bindDescriptorSet(Bt.MATERIAL,u),i.bindDescriptorSet(Bt.LOCAL,s.descriptorSet),i.bindInputAssembler(o),i.draw(o)}},e}()),Ma=[new ae(1,1,1,1)],xa=e("z",Te("ShadowStage")((Xn=qn=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),s=0;s<i;s++)r[s]=arguments[s];return(t=e.call.apply(e,[this].concat(r))||this)._shadowFrameBuffer=null,t._renderArea=new te,t._light=null,t._globalDS=null,t._level=0,t}s(t,e);var i=t.prototype;return i.setUsage=function(e,t,i,r){void 0===r&&(r=0),this._globalDS=e,this._light=t,this._shadowFrameBuffer=i,this._level=r},i.destroy=function(){var e;this._shadowFrameBuffer=null,this._globalDS=null,this._light=null,null===(e=this._additiveShadowQueue)||void 0===e||e.clear()},i.clearFramebuffer=function(e){if(this._light&&this._shadowFrameBuffer){Ma[0].w=e.clearColor.w;var t=this._pipeline,i=t.pipelineSceneData,r=i.shadingScale,s=i.shadows,n=e.viewport,a=s.size;this._renderArea.x=n.x*a.x,this._renderArea.y=n.y*a.y,this._renderArea.width=n.width*a.x*r,this._renderArea.height=n.height*a.y*r;var o=t.commandBuffers[0],h=this._shadowFrameBuffer.renderPass;o.beginRenderPass(h,this._shadowFrameBuffer,this._renderArea,Ma,e.clearDepth,e.clearStencil),o.endRenderPass()}},i.render=function(e){var t=this._pipeline,i=t.pipelineSceneData,r=i.shadows,s=this._globalDS,n=t.commandBuffers[0],a=this._level,o=t.device;if(this._light&&this._shadowFrameBuffer){this._pipeline.pipelineUBO.updateShadowUBOLight(s,this._light,a),this._additiveShadowQueue.gatherLightPasses(e,this._light,n,a);var h=r.size;switch(this._light.type){case Xt.DIRECTIONAL:var u=this._light;if(u.shadowFixedArea||u.csmLevel===ve.LEVEL_1||!i.csmSupported)this._renderArea.x=0,this._renderArea.y=0,this._renderArea.width=h.x,this._renderArea.height=h.y;else{var l=o.capabilities.screenSpaceSignY;this._renderArea.x=a%2*.5*h.x,this._renderArea.y=l>0?.5*(1-Math.floor(a/2))*h.y:.5*Math.floor(a/2)*h.y,this._renderArea.width=.5*h.x,this._renderArea.height=.5*h.y}break;case Xt.SPOT:this._renderArea.x=0,this._renderArea.y=0,this._renderArea.width=h.x,this._renderArea.height=h.y}var d=this._shadowFrameBuffer.renderPass;n.beginRenderPass(d,this._shadowFrameBuffer,this._renderArea,Ma,e.clearDepth,e.clearStencil),n.bindDescriptorSet(Bt.GLOBAL,s),this._additiveShadowQueue.recordCommandBuffer(o,d,n),n.endRenderPass()}},i.activate=function(t,i){e.prototype.activate.call(this,t,i),this._additiveShadowQueue=new Ca(t)},t}(ar),qn.initInfo={name:"ShadowStage",priority:vr.FORWARD,tag:0},Qn=Xn))||Qn),Ua=[],Ha=e("y",Te("ShadowFlow")((Kn=Yn=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),s=0;s<i;s++)r[s]=arguments[s];return(t=e.call.apply(e,[this].concat(r))||this)._shadowRenderPass=null,t}s(t,e);var i=t.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var i=new xa;i.initialize(xa.initInfo),this._stages.push(i)}return!0},i.activate=function(t){e.prototype.activate.call(this,t);var i=It(t.device)?0:1;t.macros.CC_SHADOWMAP_FORMAT=i;var r=t.device.gfxAPI===oe.WEBGL?1:0;t.macros.CC_SHADOWMAP_USE_LINEAR_DEPTH=r,t.pipelineSceneData.csmSupported=t.device.capabilities.maxFragmentUniformVectors>=(Tt.COUNT+At.COUNT+wt.COUNT+Ot.COUNT)/4,t.macros.CC_SUPPORT_CASCADED_SHADOW_MAP=t.pipelineSceneData.csmSupported,t.macros.CC_SHADOW_TYPE=0,t.macros.CC_DIR_SHADOW_PCF_TYPE=Se.HARD,t.macros.CC_DIR_LIGHT_SHADOW_TYPE=0,t.onGlobalPipelineStateChanged()},i.render=function(e){var t=this._pipeline,i=t.pipelineSceneData.shadows,r=t.pipelineSceneData.csmLayers,s=t.pipelineSceneData.shadowFrameBufferMap,n=r.castShadowObjects,a=this._pipeline.pipelineSceneData.validPunctualLights;if(i.enabled&&i.type===Be.ShadowMap){for(var o=0,h=0;o<i.maxReceived&&h<a.length;){var u=a[h];u.type===Xt.SPOT&&u.shadowEnabled&&(Ua.push(u),o++),h++}if(0!==n.length){i.shadowMapDirty&&this.resizeShadowMap();var l=e.scene.mainLight;if(l&&l.shadowEnabled){var d=t.descriptorSet;s.has(l)||this._initShadowFrameBuffer(t,l,e.window.swapchain);var c=s.get(l);if(l.shadowFixedArea)this._renderStage(e,l,c,d);else for(var _=t.pipelineSceneData.csmSupported?l.csmLevel:1,p=0;p<_;p++)this._renderStage(e,l,c,d,p)}for(var f=0;f<Ua.length;f++){var g=Ua[f],m=t.globalDSManager.getOrCreateDescriptorSet(g);s.has(g)||this._initShadowFrameBuffer(t,g,e.window.swapchain);var S=s.get(g);this._renderStage(e,g,S,m)}Ua.length=0}else this.clearShadowMap(Ua,e)}},i.destroy=function(){if(e.prototype.destroy.call(this),this._pipeline){for(var t=this._pipeline.pipelineSceneData.shadowFrameBufferMap,i=Array.from(t.values()),r=0;r<i.length;r++){var s=i[r];if(s){for(var n=s.colorTextures,a=0;a<n.length;a++){var o=n[a];o&&o.destroy()}n.length=0;var h=s.depthStencilTexture;h&&h.destroy(),s.destroy()}}t.clear()}this._shadowRenderPass&&this._shadowRenderPass.destroy()},i._initShadowFrameBuffer=function(e,t){var i=e.device,r=e.pipelineSceneData.shadows.size,s=e.pipelineSceneData.shadowFrameBufferMap,n=It(i)?O.R32F:O.RGBA8;if(!this._shadowRenderPass){var a=new G;a.format=n,a.loadOp=k.CLEAR,a.storeOp=V.STORE,a.sampleCount=1;var o=new z;o.format=O.DEPTH_STENCIL,o.depthLoadOp=k.CLEAR,o.depthStoreOp=V.DISCARD,o.stencilLoadOp=k.CLEAR,o.stencilStoreOp=V.DISCARD,o.sampleCount=1;var h=new X([a],o);this._shadowRenderPass=i.createRenderPass(h)}var u=[];u.push(i.createTexture(new E(T.TEX2D,A.COLOR_ATTACHMENT|A.SAMPLED,n,r.x,r.y)));var l=i.createTexture(new E(T.TEX2D,A.DEPTH_STENCIL_ATTACHMENT,O.DEPTH_STENCIL,r.x,r.y)),d=i.createFramebuffer(new Y(this._shadowRenderPass,u,l));s.set(t,d)},i._renderStage=function(e,t,i,r,s){void 0===s&&(s=0);for(var n=0;n<this._stages.length;n++){var a=this._stages[n];a.setUsage(r,t,i,s),a.render(e)}},i.clearShadowMap=function(e,t){var i=this._pipeline,r=i.pipelineSceneData,s=t.scene.mainLight;if(s){var n=this._pipeline.descriptorSet;r.shadowFrameBufferMap.has(s)||this._initShadowFrameBuffer(this._pipeline,s,t.window.swapchain);for(var a=r.shadowFrameBufferMap.get(s),o=0;o<this._stages.length;o++){var h=this._stages[o];h.setUsage(n,s,a),h.clearFramebuffer(t)}}for(var u=0;u<e.length;u++){var l=e[u],d=i.globalDSManager.getOrCreateDescriptorSet(l);r.shadowFrameBufferMap.has(l)||this._initShadowFrameBuffer(this._pipeline,l,t.window.swapchain);for(var c=r.shadowFrameBufferMap.get(l),_=0;_<this._stages.length;_++){var p=this._stages[_];p.setUsage(d,l,c),p.clearFramebuffer(t)}}},i.resizeShadowMap=function(){for(var e,t=this._pipeline.pipelineSceneData.shadows,i=t.size,r=this._pipeline,s=r.device,a=r.pipelineSceneData.shadowFrameBufferMap,o=It(s)?O.R32F:O.RGBA8,h=n(a.keys());!(e=h()).done;){var u=e.value,l=a.get(u);if(l){var d=[];d.push(r.device.createTexture(new E(T.TEX2D,A.COLOR_ATTACHMENT|A.SAMPLED,o,i.x,i.y)));var c=l.depthStencilTexture;c&&c.resize(i.x,i.y);var _=l.renderPass;l.destroy();var p=s.createFramebuffer(new Y(_,d,c));a.set(u,p)}}t.shadowMapDirty=!1},t}(hr),Yn.initInfo={name:Lt,priority:wr.SHADOW,tag:Xs.SCENE,stages:[]},jn=Kn))||jn),Ga=new Je,za=new Je,Va=new Je,Wa=new Je,ka=new Je,Qa=new Je,qa=new Je,Xa=new $e(0,0,0),ja=new $e,Ya=new ot,Ka=new $e,Ja=new $e,Za=new $e(1e7,1e7,1e7),$a=new $e(-1e7,-1e7,-1e7),eo=new $e,to=0,io=0,ro=function(){function e(e){this._shadowObjects=[],this._shadowCameraFar=0,this._level=void 0,this._matShadowView=new Je,this._matShadowProj=new Je,this._matShadowViewProj=new Je,this._validFrustum=new Ee,this._splitFrustum=new Ee,this._lightViewFrustum=new Ee,this._castLightViewBoundingBox=new pe,this._level=e,this._validFrustum.accurate=!0,this._splitFrustum.accurate=!0,this._lightViewFrustum.accurate=!0}var r=e.prototype;return r.copyToValidFrustum=function(e){Ee.copy(this._validFrustum,e)},r.calculateValidFrustumOrtho=function(e,t,i,r,s){Ee.createOrtho(this._validFrustum,e,t,i,r,s)},r.calculateSplitFrustum=function(e,t,i,r){Ee.split(this._splitFrustum,e,t,i,r)},r.destroy=function(){this._shadowObjects.length=0},r.createMatrix=function(e,i,r){var s=t.director.root.device,n=e.shadowInvisibleOcclusionRange;Ee.copy(this._lightViewFrustum,this._splitFrustum),Je.fromRT(za,e.node.rotation,Xa),Je.invert(Va,za);var a,o,h=Va.clone();this._lightViewFrustum.transform(Va),pe.fromPoints(this._castLightViewBoundingBox,Za,$a),this._castLightViewBoundingBox.mergeFrustum(this._lightViewFrustum),e.csmOptimizationMode===we.DisableRotationFix?(a=2*this._castLightViewBoundingBox.halfExtents.x,o=2*this._castLightViewBoundingBox.halfExtents.y):a=o=$e.distance(this._lightViewFrustum.vertices[0],this._lightViewFrustum.vertices[6]);var u=t.director.root.pipeline.pipelineSceneData.csmSupported?e.csmLevel:1;if(u>1&&e.csmOptimizationMode===we.RemoveDuplicates)if(this._level>=u-1)io=this._castLightViewBoundingBox.halfExtents.z,to=this._castLightViewBoundingBox.center.z;else{var l=Math.abs(this._castLightViewBoundingBox.center.z-to)+io;this._castLightViewBoundingBox.halfExtents.z=Math.max(this._castLightViewBoundingBox.center.z,l)}var d=this._castLightViewBoundingBox.halfExtents.z;this._shadowCameraFar=2*d+n;var c=this._castLightViewBoundingBox.center;if(eo.set(c.x,c.y,c.z+d+n),$e.transformMat4(eo,eo,za),Je.fromRT(za,e.node.rotation,eo),Je.invert(Va,za),!r){var _=.5*a,p=.5*o;Je.ortho(Wa,-_,_,-p,p,.1,this._shadowCameraFar,s.capabilities.clipSpaceMinZ,s.capabilities.clipSpaceSignY),Je.multiply(Qa,Wa,h),$e.transformMat4(ja,eo,Qa);var f=2/i;Ya.set(f,f);var g=ja.x%Ya.x,m=ja.y%Ya.y;Ka.set(ja.x-g,ja.y-m,ja.z),Je.invert(qa,Qa),$e.transformMat4(Ja,Ka,qa),Je.fromRT(za,e.node.rotation,Ja),Je.invert(Va,za),Je.multiply(ka,Wa,Va),Je.copy(this._matShadowView,Va),Je.copy(this._matShadowProj,Wa),Je.copy(this._matShadowViewProj,ka)}Ee.createOrtho(this._validFrustum,a,o,.1,this._shadowCameraFar,za)},i(e,[{key:"level",get:function(){return this._level}},{key:"shadowObjects",get:function(){return this._shadowObjects}},{key:"shadowCameraFar",get:function(){return this._shadowCameraFar},set:function(e){this._shadowCameraFar=e}},{key:"matShadowView",get:function(){return this._matShadowView},set:function(e){this._matShadowView=e}},{key:"matShadowProj",get:function(){return this._matShadowProj},set:function(e){this._matShadowProj=e}},{key:"matShadowViewProj",get:function(){return this._matShadowViewProj},set:function(e){this._matShadowViewProj=e}},{key:"validFrustum",get:function(){return this._validFrustum}},{key:"splitFrustum",get:function(){return this._splitFrustum}},{key:"lightViewFrustum",get:function(){return this._lightViewFrustum}},{key:"castLightViewBoundingBox",get:function(){return this._castLightViewBoundingBox}}]),e}(),so=function(e){function r(t){var i;return(i=e.call(this,t)||this)._splitCameraNear=0,i._splitCameraFar=0,i._csmAtlas=new Ze,i._calculateAtlas(t),i}s(r,e);var n=r.prototype;return n.destroy=function(){e.prototype.destroy.call(this)},n._calculateAtlas=function(e){var i=t.director.root.device.capabilities.clipSpaceSignY,r=e%2-.5,s=(.5-Math.floor(e/2))*i;this._csmAtlas.set(.5,.5,r,s)},i(r,[{key:"splitCameraNear",get:function(){return this._splitCameraNear},set:function(e){this._splitCameraNear=e}},{key:"splitCameraFar",get:function(){return this._splitCameraFar},set:function(e){this._splitCameraFar=e}},{key:"csmAtlas",get:function(){return this._csmAtlas},set:function(e){this._csmAtlas=e}}]),r}(ro),no=function(){function e(){this._castShadowObjects=[],this._layerObjects=new se(64),this._layers=[],this._levelCount=0,this._specialLayer=new ro(1),this._shadowDistance=0;for(var e=0;e<ve.LEVEL_4;e++)this._layers[e]=new so(e)}var r=e.prototype;return r.update=function(e,i){var r=i.scene.mainLight;if(null!==r){var s=e.shadows,n=t.director.root.pipeline.pipelineSceneData.csmSupported?r.csmLevel:1,a=r.shadowDistance;s.enabled&&r.shadowEnabled&&(r.shadowFixedArea?this._updateFixedArea(r):((r.csmNeedUpdate||this._levelCount!==n||this._shadowDistance!==a)&&(this._splitFrustumLevels(r),this._levelCount=n,this._shadowDistance=a),this._calculateCSM(i,r,s)))}},r.destroy=function(){this._castShadowObjects.length=0;for(var e=0;e<this._layers.length;e++)this._layers[e].destroy();this._layers.length=0},r._updateFixedArea=function(e){var i=t.director.root.device,r=e.shadowOrthoSize,s=e.shadowOrthoSize,n=e.shadowNear,a=e.shadowFar;Je.fromRT(za,e.node.getWorldRotation(),e.node.getWorldPosition()),Je.invert(Va,za),Je.ortho(Wa,-r,r,-s,s,n,a,i.capabilities.clipSpaceMinZ,i.capabilities.clipSpaceSignY),Je.multiply(ka,Wa,Va),this._specialLayer.matShadowView=Va,this._specialLayer.matShadowProj=Wa,this._specialLayer.matShadowViewProj=ka,this._specialLayer.calculateValidFrustumOrtho(2*r,2*s,n,a,za)},r._splitFrustumLevels=function(e){var i=.1,r=e.shadowDistance,s=r/i,n=t.director.root.pipeline.pipelineSceneData.csmSupported?e.csmLevel:1,a=e.csmLayerLambda;this._layers[0].splitCameraNear=i;for(var o=1;o<n;o++){var h=o/n,u=a*i*Math.pow(s,h)+(1-a)*(i+(r-i)*h),l=1.005*u;this._layers[o].splitCameraNear=u,this._layers[o-1].splitCameraFar=l}this._layers[n-1].splitCameraFar=r,e.csmNeedUpdate=!1},r._calculateCSM=function(e,i,r){var s=t.director.root.pipeline.pipelineSceneData.csmSupported?i.csmLevel:1,n=s>1?.5*r.size.x:r.size.x;if(!(n<0)){this._getCameraWorldMatrix(Ga,e);for(var a=s-1;a>=0;a--){var o=this._layers[a],h=o.splitCameraNear,u=o.splitCameraFar;o.calculateSplitFrustum(e,Ga,h,u),o.createMatrix(i,n,!1)}s===ve.LEVEL_1?(this._specialLayer.shadowCameraFar=this._layers[0].shadowCameraFar,Je.copy(this._specialLayer.matShadowView,this._layers[0].matShadowView),Je.copy(this._specialLayer.matShadowProj,this._layers[0].matShadowProj),Je.copy(this._specialLayer.matShadowViewProj,this._layers[0].matShadowViewProj),this._specialLayer.copyToValidFrustum(this._layers[0].validFrustum)):(this._specialLayer.calculateSplitFrustum(e,Ga,.1,i.shadowDistance),this._specialLayer.createMatrix(i,n,!0))}},r._getCameraWorldMatrix=function(e,t){if(t.node){var i=t.node,r=i.getWorldPosition(),s=i.getWorldRotation();Je.fromRT(e,s,r),e.m08*=-1,e.m09*=-1,e.m10*=-1}},i(e,[{key:"castShadowObjects",get:function(){return this._castShadowObjects}},{key:"layerObjects",get:function(){return this._layerObjects}},{key:"layers",get:function(){return this._layers}},{key:"specialLayer",get:function(){return this._specialLayer}}]),e}(),ao=e("q",function(){function e(){this.fog=new ze,this.ambient=new me,this.skybox=new Ve,this.shadows=new ye,this.csmLayers=new no,this.octree=new Kt,this.validPunctualLights=[],this.renderObjects=[],this.shadowFrameBufferMap=new Map,this._geometryRendererMaterials=[],this._geometryRendererPasses=[],this._geometryRendererShaders=[],this._occlusionQueryVertexBuffer=null,this._occlusionQueryIndicesBuffer=null,this._occlusionQueryInputAssembler=null,this._occlusionQueryMaterial=null,this._occlusionQueryShader=null,this._isHDR=!0,this._shadingScale=1,this._csmSupported=!0,this._shadingScale=1}var t=e.prototype;return t.activate=function(e){return this._device=e,this.initGeometryRendererMaterials(),this.initOcclusionQuery(),!0},t.initGeometryRendererMaterials=function(){for(var e=0,t=0;t<6;t++){this._geometryRendererMaterials[t]=new Ue,this._geometryRendererMaterials[t]._uuid="geometry-renderer-material-"+t,this._geometryRendererMaterials[t].initialize({effectName:"builtin-geometry-renderer",technique:t});for(var i=0;i<this._geometryRendererMaterials[t].passes.length;++i)this._geometryRendererPasses[e]=this._geometryRendererMaterials[t].passes[i],this._geometryRendererShaders[e]=this._geometryRendererMaterials[t].passes[i].getShaderVariant(),e++}},t.initOcclusionQuery=function(){if(this._occlusionQueryInputAssembler||(this._occlusionQueryInputAssembler=this._createOcclusionQueryIA()),!this._occlusionQueryMaterial){var e=new Ue;e._uuid="default-occlusion-query-material",e.initialize({effectName:"builtin-occlusion-query"}),this._occlusionQueryMaterial=e,e.passes.length>0&&(this._occlusionQueryShader=e.passes[0].getShaderVariant())}},t.getOcclusionQueryPass=function(){return this._occlusionQueryMaterial&&this._occlusionQueryMaterial.passes.length>0?this._occlusionQueryMaterial.passes[0]:null},t.updatePipelineSceneData=function(){},t.destroy=function(){var e,t,i;this.shadows.destroy(),this.csmLayers.destroy(),this.validPunctualLights.length=0,null===(e=this._occlusionQueryInputAssembler)||void 0===e||e.destroy(),this._occlusionQueryInputAssembler=null,null===(t=this._occlusionQueryVertexBuffer)||void 0===t||t.destroy(),this._occlusionQueryVertexBuffer=null,null===(i=this._occlusionQueryIndicesBuffer)||void 0===i||i.destroy(),this._occlusionQueryIndicesBuffer=null},t._createOcclusionQueryIA=function(){var e=this._device,t=new Float32Array([-1,-1,-1,1,-1,-1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,1,1,1,1,1]),i=3*Float32Array.BYTES_PER_ELEMENT,r=8*i;this._occlusionQueryVertexBuffer=e.createBuffer(new L(C.VERTEX|C.TRANSFER_DST,M.DEVICE,r,i)),this._occlusionQueryVertexBuffer.update(t);var s=new Uint16Array([0,2,1,1,2,3,4,5,6,5,7,6,1,3,7,1,7,5,0,4,6,0,6,2,0,1,5,0,5,4,2,6,7,2,7,3]),n=Uint16Array.BYTES_PER_ELEMENT,a=36*n;this._occlusionQueryIndicesBuffer=e.createBuffer(new L(C.INDEX|C.TRANSFER_DST,M.DEVICE,a,n)),this._occlusionQueryIndicesBuffer.update(s);var o=[new B("a_position",O.RGB32F)],h=new J(o,[this._occlusionQueryVertexBuffer],this._occlusionQueryIndicesBuffer);return e.createInputAssembler(h)},i(e,[{key:"isHDR",get:function(){return this._isHDR},set:function(e){this._isHDR=e}},{key:"shadingScale",get:function(){return this._shadingScale},set:function(e){this._shadingScale=e}},{key:"csmSupported",get:function(){return this._csmSupported},set:function(e){this._csmSupported=e}},{key:"geometryRendererPasses",get:function(){return this._geometryRendererPasses}},{key:"geometryRendererShaders",get:function(){return this._geometryRendererShaders}}]),e}()),oo=e("F",(Jn=Te("ForwardPipeline"),Zn=Ae([tn]),$n=Le(),Jn((ra=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),s=0;s<i;s++)r[s]=arguments[s];return t=e.call.apply(e,[this].concat(r))||this,o(t,"renderTextures",ia,h(t)),t._postRenderPass=null,t}s(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var i=new Ha;i.initialize(Ha.initInfo),this._flows.push(i);var r=new Vn;r.initialize(Vn.initInfo),this._flows.push(r)}return!0},n.activate=function(t){return this._macros={CC_PIPELINE_TYPE:0},this._pipelineSceneData=new ao,!(!e.prototype.activate.call(this,t)||!this._activeRenderer(t)&&(r(2402),1))},n._ensureEnoughSize=function(e){for(var t=this._width,i=this._height,r=0;r<e.length;++r){var s=e[r].window;t=Math.max(s.width,t),i=Math.max(s.height,i)}t===this._width&&i===this._height||(this._width=t,this._height=i)},n.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler();for(var t=this._renderPasses.values(),i=t.next();!i.done;)i.value.destroy(),i=t.next();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},n._activeRenderer=function(){var e=this.device;this._commandBuffers.push(e.commandBuffer);var t=this.globalDSManager.pointSampler;return this._descriptorSet.bindSampler(bt,t),this._descriptorSet.bindTexture(bt,fe.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(Ft,t),this._descriptorSet.bindTexture(Ft,fe.get("default-texture").getGFXTexture()),this._descriptorSet.update(),!0},n._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(Tt.BINDING).destroy(),this._descriptorSet.getBuffer(wt.BINDING).destroy(),this._descriptorSet.getBuffer(At.BINDING).destroy(),this._descriptorSet.getTexture(bt).destroy(),this._descriptorSet.getTexture(Ft).destroy())},i(t,[{key:"postRenderPass",get:function(){return this._postRenderPass}}]),t}($s),ia=a((ta=ra).prototype,"renderTextures",[Zn,Fe,$n],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ea=ta))||ea)),ho=[new ae(0,0,0,0),new ae(0,0,0,0),new ae(0,0,0,0)],uo=e("G",(sa=Te("GbufferStage"),na=Ae([nn]),aa=Le(),sa((da=la=function(e){function t(){var t;return t=e.call(this)||this,o(t,"renderQueues",ua,h(t)),t._renderQueues=[],t._renderArea=new te,t._batchedQueue=void 0,t._instancedQueue=void 0,t._phaseID=_e("default"),t._batchedQueue=new cn,t._instancedQueue=new _n,t}s(t,e);var i=t.prototype;return i.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},i.activate=function(t,i){e.prototype.activate.call(this,t,i);for(var r=0;r<this.renderQueues.length;r++)this._renderQueues[r]=un(this.renderQueues[r])},i.destroy=function(){},i.render=function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,i=t.device;this._renderQueues.forEach(ln),t.generateRenderArea(e,this._renderArea),t.updateQuadVertexData(this._renderArea,e.window);for(var r=t.pipelineSceneData.renderObjects,s=0,n=0,a=0,o=0;o<r.length;++o){var h=r[o],u=h.model.subModels;for(s=0;s<u.length;++s){var l=u[s],d=l.passes;for(n=0;n<d.length;++n){var c=d[n];if(c.phase===this._phaseID){var _=c.batchingScheme;if(_===ce.INSTANCING){var p=c.getInstancedBuffer();p.merge(l,n),this._instancedQueue.queue.add(p)}else if(_===ce.VB_MERGING){var f=c.getBatchedBuffer();f.merge(l,n,h.model),this._batchedQueue.queue.add(f)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(h,s,n)}}}}this._renderQueues.forEach(dn);var g=t.commandBuffers[0];this._instancedQueue.uploadBuffers(g),this._batchedQueue.uploadBuffers(g),e.clearFlag&W.COLOR&&(t.pipelineSceneData.isHDR?We(ho[0],e.clearColor):(ho[0].x=e.clearColor.x,ho[0].y=e.clearColor.y,ho[0].z=e.clearColor.z)),ho[0].w=e.clearColor.w;var m=t.getPipelineRenderData().gbufferFrameBuffer,S=m.renderPass;g.beginRenderPass(S,m,this._renderArea,ho,e.clearDepth,e.clearStencil),g.setScissor(t.generateScissor(e)),g.setViewport(t.generateViewport(e)),g.bindDescriptorSet(Bt.GLOBAL,t.descriptorSet);for(var v=0;v<this.renderQueues.length;v++)this._renderQueues[v].recordCommandBuffer(i,S,g);this._instancedQueue.recordCommandBuffer(i,S,g),this._batchedQueue.recordCommandBuffer(i,S,g),g.endRenderPass()},t}(ar),la.initInfo={name:"GbufferStage",priority:yr.GBUFFER,tag:0,renderQueues:[{isTransparent:!1,sortMode:en.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:en.BACK_TO_FRONT,stages:["default"]}]},ua=a((ha=da).prototype,"renderQueues",[na,Fe,aa],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),oa=ha))||oa)),lo=[new ae(0,0,0,1)],co=e("w",(ca=Te("LightingStage"),_a=Ae(Ue),pa=Le(),fa=Ae([nn]),ga=Le(),ca((Ea=ya=function(e){function t(){var t;return(t=e.call(this)||this)._deferredLitsBufs=null,t._maxDeferredLights=Ct.LIGHTS_PER_PASS,t._lightMeterScale=1e4,t._descriptorSet=null,t._renderArea=new te,t._uiPhase=void 0,o(t,"_deferredMaterial",va,h(t)),o(t,"renderQueues",wa,h(t)),t._phaseID=_e("default"),t._renderQueues=[],t._uiPhase=new Hn,t}s(t,e);var i=t.prototype;return i.initialize=function(t){return e.prototype.initialize.call(this,t),!0},i.gatherLights=function(e){for(var t=this._pipeline,i=t.commandBuffers[0],r=e.scene.sphereLights,s=e.scene.spotLights,n=Re.create(0,0,0,1),a=new Float32Array(4),o=e.exposure,h=0,u=Ze.length,l=u*this._maxDeferredLights,d=0;d<r.length&&h<this._maxDeferredLights;d++,++h){var c=r[d];if(Re.set(n,c.position.x,c.position.y,c.position.z,c.range),De.sphereFrustum(n,e.frustum)){if($e.toArray(a,c.position),a[3]=0,this._lightBufferData.set(a,h*u),$e.toArray(a,c.color),c.useColorTemperature){var _=c.colorTemperatureRGB;a[0]*=_.x,a[1]*=_.y,a[2]*=_.z}t.pipelineSceneData.isHDR?a[3]=c.luminance*o*this._lightMeterScale:a[3]=c.luminance,this._lightBufferData.set(a,h*u+1*l),a[0]=c.size,a[1]=c.range,a[2]=0,this._lightBufferData.set(a,h*u+2*l)}}for(var p=0;p<s.length&&h<this._maxDeferredLights;p++,++h){var f=s[p];if(Re.set(n,f.position.x,f.position.y,f.position.z,f.range),De.sphereFrustum(n,e.frustum)){if($e.toArray(a,f.position),a[3]=1,this._lightBufferData.set(a,h*u+0*l),$e.toArray(a,f.color),f.useColorTemperature){var g=f.colorTemperatureRGB;a[0]*=g.x,a[1]*=g.y,a[2]*=g.z}t.pipelineSceneData.isHDR?a[3]=f.luminance*o*this._lightMeterScale:a[3]=f.luminance,this._lightBufferData.set(a,h*u+1*l),a[0]=f.size,a[1]=f.range,a[2]=f.spotAngle,this._lightBufferData.set(a,h*u+2*l),$e.toArray(a,f.direction),this._lightBufferData.set(a,h*u+3*l)}}var m=3*l+3;this._lightBufferData.set([h],m),i.updateBuffer(this._deferredLitsBufs,this._lightBufferData)},i._createStageDescriptor=function(e){var t=this._pipeline.device,i=16*Float32Array.BYTES_PER_ELEMENT*this._maxDeferredLights;i=Math.ceil(i/t.capabilities.uboOffsetAlignment)*t.capabilities.uboOffsetAlignment,this._deferredLitsBufs=t.createBuffer(new L(C.UNIFORM|C.TRANSFER_DST,M.HOST|M.DEVICE,i,t.capabilities.uboOffsetAlignment));var r=t.createBuffer(new ne(this._deferredLitsBufs,0,i));this._lightBufferData=new Float32Array(i/Float32Array.BYTES_PER_ELEMENT),this._descriptorSet=t.createDescriptorSet(new N(e.localSetLayout)),this._descriptorSet.bindBuffer(Pt.BINDING,r);var s=t.createBuffer(new L(C.UNIFORM|C.TRANSFER_DST,M.DEVICE,mt.SIZE,mt.SIZE));this._descriptorSet.bindBuffer(mt.BINDING,s)},i.activate=function(t,i){e.prototype.activate.call(this,t,i),this._uiPhase.activate(t);for(var r=0;r<this.renderQueues.length;r++)this._renderQueues[r]=un(this.renderQueues[r]);this._planarQueue=new Un(this._pipeline),this._deferredMaterial&&(t.pipelineSceneData.deferredLightingMaterial=this._deferredMaterial)},i.destroy=function(){var e;null===(e=this._deferredLitsBufs)||void 0===e||e.destroy(),this._deferredLitsBufs=null,this._descriptorSet=null},i.render=function(e){var t,i=this._pipeline,r=i.device,s=i.commandBuffers[0],n=i.pipelineSceneData,a=n.renderObjects;this._planarQueue.gatherShadowPasses(e,s),i.generateRenderArea(e,this._renderArea);for(var o=i.getPipelineRenderData(),h=n.deferredLightingMaterial.passes[0],u=h.getShaderVariant(),l=0;l<3;++l)h.descriptorSet.bindTexture(l,o.gbufferRenderTargets[l]),h.descriptorSet.bindSampler(l,o.sampler);h.descriptorSet.bindTexture(3,o.outputDepth),h.descriptorSet.bindSampler(3,o.sampler),h.descriptorSet.update(),this._descriptorSet||this._createStageDescriptor(h),this.gatherLights(e),e.clearFlag&W.COLOR&&(lo[0].x=e.clearColor.x,lo[0].y=e.clearColor.y,lo[0].z=e.clearColor.z),lo[0].w=0;var d=o.outputFrameBuffer,c=d.renderPass;i.pipelineUBO.updateShadowUBO(e),s.beginRenderPass(c,d,this._renderArea,lo,e.clearDepth,e.clearStencil),s.setScissor(i.generateScissor(e)),s.setViewport(i.generateViewport(e)),s.bindDescriptorSet(Bt.GLOBAL,i.descriptorSet);var _=i.quadIAOffscreen,p=null;null!=h&&null!=u&&null!=_&&(p=Dt.getOrCreatePipelineState(r,h,u,c,_)),null!=p&&(this._descriptorSet.update(),s.bindPipelineState(p),s.bindDescriptorSet(Bt.MATERIAL,h.descriptorSet),s.bindDescriptorSet(Bt.LOCAL,this._descriptorSet),s.bindInputAssembler(_),s.draw(_)),this._renderQueues.forEach(ln);for(var f=0,g=0,m=0,S=0;S<a.length;++S){var v=a[S],w=v.model.subModels;for(f=0;f<w.length;++f){var y=w[f].passes;for(g=0;g<y.length;++g)if(y[g].phase===this._phaseID)for(m=0;m<this._renderQueues.length;m++)this._renderQueues[m].insertRenderPass(v,f,g)}}if(a.length>0){this._renderQueues.forEach(dn);for(var E=0;E<this._renderQueues.length;E++)this._renderQueues[E].recordCommandBuffer(r,c,s);this._planarQueue.recordCommandBuffer(r,c,s)}null===(t=e.geometryRenderer)||void 0===t||t.render(c,s,i.pipelineSceneData),this._uiPhase.render(e,c),s.endRenderPass()},t}(ar),ya.initInfo={name:"LightingStage",priority:yr.LIGHTING,tag:0},va=a((Sa=Ea).prototype,"_deferredMaterial",[_a,Fe,pa],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wa=a(Sa.prototype,"renderQueues",[fa,Fe,ga],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ma=Sa))||ma)),_o=[new ae(0,0,0,1)],po=e("x",(Ta=Te("PostProcessStage"),Aa=Ae(Ue),Oa=Le(),ba=Ae([nn]),Fa=Le(),Ta((Na=Pa=function(e){function t(){var t;return t=e.call(this)||this,o(t,"_postProcessMaterial",Da,h(t)),o(t,"renderQueues",Ba,h(t)),t._renderArea=new te,t._stageDesc=void 0,t._localUBO=void 0,t._uiPhase=new Hn,t}s(t,e);var i=t.prototype;return i.initialize=function(t){return e.prototype.initialize.call(this,t),!0},i.activate=function(t,i){e.prototype.activate.call(this,t,i),this._postProcessMaterial&&(t.pipelineSceneData.postprocessMaterial=this._postProcessMaterial),this._uiPhase.activate(t)},i.destroy=function(){},i.render=function(e){var t=this._pipeline,i=t.device,r=t.pipelineSceneData,s=t.commandBuffers[0];t.pipelineUBO.updateCameraUBO(e);var n=e.viewport;this._renderArea.x=n.x*e.window.width,this._renderArea.y=n.y*e.window.height,this._renderArea.width=n.width*e.window.width,this._renderArea.height=n.height*e.window.height;var a=t.getPipelineRenderData(),o=e.window.framebuffer,h=t.getRenderPass(e.clearFlag,o);e.clearFlag&W.COLOR&&(_o[0].x=e.clearColor.x,_o[0].y=e.clearColor.y,_o[0].z=e.clearColor.z),_o[0].w=e.clearColor.w,s.beginRenderPass(h,o,this._renderArea,_o,e.clearDepth,e.clearStencil),s.bindDescriptorSet(Bt.GLOBAL,t.descriptorSet);var u=r.postprocessMaterial.passes[0],l=u.getShaderVariant();t.bloomEnabled?u.descriptorSet.bindTexture(0,a.bloom.combineTex):u.descriptorSet.bindTexture(0,a.outputRenderTargets[0]),u.descriptorSet.bindSampler(0,a.sampler),u.descriptorSet.update();var d=e.window.swapchain?t.quadIAOnscreen:t.quadIAOffscreen,c=null;null!=u&&null!=l&&null!=d&&(c=Dt.getOrCreatePipelineState(i,u,l,h,d));var _=t.pipelineSceneData.renderObjects;null!=c&&_.length>0&&(this._stageDesc||(this._stageDesc=i.createDescriptorSet(new N(u.localSetLayout)),this._localUBO=i.createBuffer(new L(C.UNIFORM|C.TRANSFER_DST,M.DEVICE,mt.SIZE,mt.SIZE)),this._stageDesc.bindBuffer(mt.BINDING,this._localUBO)),this._stageDesc.update(),s.bindPipelineState(c),s.bindDescriptorSet(Bt.MATERIAL,u.descriptorSet),s.bindDescriptorSet(Bt.LOCAL,this._stageDesc),s.bindInputAssembler(d),s.draw(d)),this._uiPhase.render(e,h),Ge(i,h,s,t.profiler,e),s.endRenderPass()},t}(ar),Pa.initInfo={name:"PostProcessStage",priority:Sr.POST_PROCESS,tag:0},Da=a((Ra=Na).prototype,"_postProcessMaterial",[Aa,Fe,Oa],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ba=a(Ra.prototype,"renderQueues",[ba,Fe,Fa],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ia=Ra))||Ia));!function(e){e[e.NONE=0]="NONE",e[e.FXAA=1]="FXAA"}(La||(La={}));var fo,go,mo,So,vo,wo,yo,Eo,To=function(e){function r(){for(var t,i=arguments.length,r=new Array(i),s=0;s<i;s++)r[s]=arguments[s];return(t=e.call.apply(e,[this].concat(r))||this)._antiAliasing=La.NONE,t}s(r,e);var n=r.prototype;return n.updatePipelineSceneData=function(){this.updatePipelinePassInfo()},n.updateBloomPass=function(){if(this._bloomMaterial){var e=this._bloomMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently();for(var t=0;t<6;++t){var i=this._bloomMaterial.passes[1+t];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently();var r=this._bloomMaterial.passes[7+t];r.beginChangeStatesSilently(),r.tryCompile(),r.endChangeStatesSilently()}var s=this._bloomMaterial.passes[13];s.beginChangeStatesSilently(),s.tryCompile(),s.endChangeStatesSilently()}},n.updatePostProcessPass=function(){if(this.postprocessMaterial){var e=this.postprocessMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}},n.initPipelinePassInfo=function(){var e=new Ue;e._uuid="builtin-deferred-material",e.initialize({effectName:"pipeline/deferred-lighting"});for(var t=0;t<e.passes.length;++t)e.passes[t].tryCompile();this._deferredLightingMaterial=e;var i=new Ue;i._uuid="builtin-bloom-material",i.initialize({effectName:"pipeline/bloom"});for(var r=0;r<i.passes.length;++r)i.passes[r].tryCompile();this._bloomMaterial=i;var s=new Ue;s._uuid="builtin-post-process-material",l.ENABLE_ANTIALIAS_FXAA&&(this._antiAliasing=La.FXAA),s.initialize({effectName:"pipeline/post-process",defines:{ANTIALIAS_TYPE:this._antiAliasing}});for(var n=0;n<s.passes.length;++n)s.passes[n].tryCompile();this._postprocessMaterial=s,this.updatePipelinePassInfo()},n.updatePipelinePassInfo=function(){this.updateBloomPass(),this.updatePostProcessPass(),this.updateDeferredPassInfo()},n.activate=function(t){return e.prototype.activate.call(this,t),this.initPipelinePassInfo(),!0},n.updateDeferredPassInfo=function(){this.updateDeferredLightPass()},n.updateDeferredLightPass=function(){if(this._deferredLightingMaterial){t.director.root.pipeline.macros.CC_RECEIVE_SHADOW=1;var e=this._deferredLightingMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}},i(r,[{key:"antiAliasing",get:function(){return this._antiAliasing},set:function(e){if(this._antiAliasing=e,this._postprocessMaterial){var t=this._postprocessMaterial.passes[0].defines;Object.assign(t,{ANTIALIAS_TYPE:e});var i=new Ue;i.initialize({effectAsset:this._postprocessMaterial.effectAsset,defines:t});for(var r=0;r<i.passes.length;++r)i.passes[r].tryCompile();this._postprocessMaterial=i}}},{key:"bloomMaterial",get:function(){return this._bloomMaterial},set:function(e){this._bloomMaterial!==e&&e&&(this._bloomMaterial=e,this.updatePipelinePassInfo())}},{key:"postprocessMaterial",get:function(){return this._postprocessMaterial},set:function(e){this._postprocessMaterial!==e&&e&&(this._postprocessMaterial=e,this.updatePipelinePassInfo())}},{key:"deferredLightingMaterial",get:function(){return this._deferredLightingMaterial},set:function(e){this._deferredLightingMaterial!==e&&e&&(this._deferredLightingMaterial=e,this.updatePipelinePassInfo())}}]),r}(ao),Ao=[new ae(0,0,0,1)],Oo=function(){};Oo.SIZE=4*(Oo.COUNT=4+(Oo.TEXTURE_SIZE_OFFSET=0));var bo,Fo,Io,Ro,Do,Bo,Po,No,Lo,Co,Mo=e("B",(fo=Te("BloomStage"),go=Ae(Ue),mo=Le(),fo((Eo=yo=function(e){function t(){var t;return(t=e.call(this)||this).threshold=1,t.intensity=.8,t.iterations=2,o(t,"_bloomMaterial",wo,h(t)),t._renderArea=new te,t._bloomUBO=[],t}s(t,e);var i=t.prototype;return i.initialize=function(t){return e.prototype.initialize.call(this,t),!0},i.activate=function(t,i){e.prototype.activate.call(this,t,i),this._bloomMaterial&&(t.pipelineSceneData.bloomMaterial=this._bloomMaterial)},i.destroy=function(){},i.render=function(e){var t,i=this._pipeline;if(i.generateBloomRenderData(),((null===(t=e.window)||void 0===t?void 0:t.swapchain)||i.macros.CC_PIPELINE_TYPE)&&i.bloomEnabled&&0!==i.pipelineSceneData.renderObjects.length){if(0===this._bloomUBO.length)for(var r=0;r<14;++r)this._bloomUBO[r]=i.device.createBuffer(new L(C.UNIFORM|C.TRANSFER_DST,M.HOST|M.DEVICE,Oo.SIZE,Oo.SIZE));e.clearFlag&W.COLOR&&(Ao[0].x=e.clearColor.x,Ao[0].y=e.clearColor.y,Ao[0].z=e.clearColor.z),Ao[0].w=e.clearColor.w,this._prefilterPass(e,i),this._downsamplePass(e,i),this._upsamplePass(e,i),this._combinePass(e,i)}},i._prefilterPass=function(e,t){t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;var i=t.commandBuffers[0],r=t.pipelineSceneData.bloomMaterial.passes[0],s=t.getPipelineRenderData(),n=s.bloom,a=new Float32Array(Oo.COUNT);a[Oo.TEXTURE_SIZE_OFFSET+2]=this.threshold,i.updateBuffer(this._bloomUBO[0],a),i.beginRenderPass(n.renderPass,n.prefilterFramebuffer,this._renderArea,Ao,0,0),i.bindDescriptorSet(Bt.GLOBAL,t.descriptorSet),r.descriptorSet.bindBuffer(0,this._bloomUBO[0]),r.descriptorSet.bindTexture(1,s.outputRenderTargets[0]),r.descriptorSet.bindSampler(1,n.sampler),r.descriptorSet.update(),i.bindDescriptorSet(Bt.MATERIAL,r.descriptorSet);var o=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,h=null,u=r.getShaderVariant();null!=r&&null!=u&&null!=o&&(h=Dt.getOrCreatePipelineState(t.device,r,u,n.renderPass,o)),null!=h&&(i.bindPipelineState(h),i.bindInputAssembler(o),i.draw(o)),i.endRenderPass()},i._downsamplePass=function(e,t){t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;for(var i=t.commandBuffers[0],r=t.pipelineSceneData.bloomMaterial,s=t.getPipelineRenderData().bloom,n=new Float32Array(Oo.COUNT),a=0;a<this.iterations;++a){n[Oo.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,n[Oo.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,i.updateBuffer(this._bloomUBO[a+1],n),this._renderArea.width>>=1,this._renderArea.height>>=1,i.beginRenderPass(s.renderPass,s.downsampleFramebuffers[a],this._renderArea,Ao,0,0);var o=r.passes[1+a],h=o.getShaderVariant();o.descriptorSet.bindBuffer(0,this._bloomUBO[a+1]),0===a?o.descriptorSet.bindTexture(1,s.prefiterTex):o.descriptorSet.bindTexture(1,s.downsampleTexs[a-1]),o.descriptorSet.bindSampler(1,s.sampler),o.descriptorSet.update(),i.bindDescriptorSet(Bt.MATERIAL,o.descriptorSet);var u=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,l=null;null!=o&&null!=h&&null!=u&&(l=Dt.getOrCreatePipelineState(t.device,o,h,s.renderPass,u)),null!=l&&(i.bindPipelineState(l),i.bindInputAssembler(u),i.draw(u)),i.endRenderPass()}},i._upsamplePass=function(e,t){var i=t.getPipelineRenderData().bloom;t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=this.iterations+1,this._renderArea.height>>=this.iterations+1;for(var r=t.commandBuffers[0],s=t.pipelineSceneData.bloomMaterial,n=new Float32Array(Oo.COUNT),a=0;a<this.iterations;++a){var o=a+6+1;n[Oo.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,n[Oo.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,r.updateBuffer(this._bloomUBO[o],n),this._renderArea.width<<=1,this._renderArea.height<<=1,r.beginRenderPass(i.renderPass,i.upsampleFramebuffers[this.iterations-1-a],this._renderArea,Ao,0,0);var h=s.passes[7+a],u=h.getShaderVariant();h.descriptorSet.bindBuffer(0,this._bloomUBO[o]),0===a?h.descriptorSet.bindTexture(1,i.downsampleTexs[this.iterations-1]):h.descriptorSet.bindTexture(1,i.upsampleTexs[this.iterations-a]),h.descriptorSet.bindSampler(1,i.sampler),h.descriptorSet.update(),r.bindDescriptorSet(Bt.MATERIAL,h.descriptorSet);var l=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,d=null;null!=h&&null!=u&&null!=l&&(d=Dt.getOrCreatePipelineState(t.device,h,u,i.renderPass,l)),null!=d&&(r.bindPipelineState(d),r.bindInputAssembler(l),r.draw(l)),r.endRenderPass()}},i._combinePass=function(e,t){t.generateRenderArea(e,this._renderArea);var i=t.commandBuffers[0],r=t.pipelineSceneData.bloomMaterial,s=t.getPipelineRenderData(),n=s.bloom,a=new Float32Array(Oo.COUNT);a[Oo.TEXTURE_SIZE_OFFSET+3]=this.intensity,i.updateBuffer(this._bloomUBO[13],a),i.beginRenderPass(n.renderPass,n.combineFramebuffer,this._renderArea,Ao,0,0),i.bindDescriptorSet(Bt.GLOBAL,t.descriptorSet);var o=r.passes[13];o.descriptorSet.bindBuffer(0,this._bloomUBO[13]),o.descriptorSet.bindTexture(1,s.outputRenderTargets[0]),o.descriptorSet.bindTexture(2,n.upsampleTexs[0]),o.descriptorSet.bindSampler(1,n.sampler),o.descriptorSet.bindSampler(2,n.sampler),o.descriptorSet.update(),i.bindDescriptorSet(Bt.MATERIAL,o.descriptorSet);var h=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,u=null,l=o.getShaderVariant();null!=o&&null!=l&&null!=h&&(u=Dt.getOrCreatePipelineState(t.device,o,l,n.renderPass,h)),null!=u&&(i.bindPipelineState(u),i.bindInputAssembler(h),i.draw(h)),i.endRenderPass()},t}(ar),yo.initInfo={name:"BloomStage",priority:Sr.BLOOM,tag:0},wo=a((vo=Eo).prototype,"_bloomMaterial",[go,Fe,mo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),So=vo))||So)),xo=e("u",Te("MainFlow")((Io=Fo=function(e){function t(){return e.apply(this,arguments)||this}s(t,e);var i=t.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var i=new uo;i.initialize(uo.initInfo),this._stages.push(i);var r=new co;r.initialize(co.initInfo),this._stages.push(r);var s=new Mo;s.initialize(Mo.initInfo),this._stages.push(s);var n=new po;n.initialize(po.initInfo),this._stages.push(n)}return!0},i.activate=function(t){e.prototype.activate.call(this,t)},i.render=function(t){e.prototype.render.call(this,t)},i.destroy=function(){e.prototype.destroy.call(this)},t}(hr),Fo.initInfo={name:Mt,priority:Er.MAIN,stages:[]},bo=Io))||bo),Uo=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),s=0;s<i;s++)r[s]=arguments[s];return(t=e.call.apply(e,[this].concat(r))||this).gbufferFrameBuffer=null,t.gbufferRenderTargets=[],t}return s(t,e),t}((function(){this.outputFrameBuffer=null,this.outputRenderTargets=[],this.outputDepth=null,this.sampler=null,this.bloom=null})),Ho=e("t",(Ro=Te("DeferredPipeline"),Do=Ae([tn]),Bo=Le(),Ro((Co=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),s=0;s<i;s++)r[s]=arguments[s];return(t=e.call.apply(e,[this].concat(r))||this)._gbufferRenderPass=null,t._lightingRenderPass=null,o(t,"renderTextures",Lo,h(t)),t}s(t,e);var i=t.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var i=new Ha;i.initialize(Ha.initInfo),this._flows.push(i);var r=new xo;r.initialize(xo.initInfo),this._flows.push(r)}return!0},i.activate=function(t){return this._macros={CC_PIPELINE_TYPE:1},this._pipelineSceneData=new To,!(!e.prototype.activate.call(this,t)||!this._activeRenderer(t)&&(r(2402),1))},i.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler(),this._destroyDeferredData();for(var t=this._renderPasses.values(),i=t.next();!i.done;)i.value.destroy(),i=t.next();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},i.onGlobalPipelineStateChanged=function(){this.pipelineSceneData.updatePipelineSceneData()},i.getPipelineRenderData=function(){return this._pipelineRenderData||this._generateDeferredRenderData(),this._pipelineRenderData},i._activeRenderer=function(e){var t=this.device;this._commandBuffers.push(t.commandBuffer);var i=this.globalDSManager.pointSampler;this._descriptorSet.bindSampler(bt,i),this._descriptorSet.bindTexture(bt,fe.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(Ft,i),this._descriptorSet.bindTexture(Ft,fe.get("default-texture").getGFXTexture()),this._descriptorSet.update();var r=new Zs;if(!(r=this._createQuadInputAssembler()).quadIB||!r.quadVB||!r.quadIA)return!1;this._quadIB=r.quadIB,this._quadVBOffscreen=r.quadVB,this._quadIAOffscreen=r.quadIA;var s=this._createQuadInputAssembler();if(!s.quadIB||!s.quadVB||!s.quadIA)return!1;if(this._quadVBOnscreen=s.quadVB,this._quadIAOnscreen=s.quadIA,!this._gbufferRenderPass){var n=new G;n.format=O.RGBA16F,n.loadOp=k.CLEAR,n.storeOp=V.STORE;var a=new G;a.format=O.RGBA16F,a.loadOp=k.CLEAR,a.storeOp=V.STORE;var o=new G;o.format=O.RGBA16F,o.loadOp=k.CLEAR,o.storeOp=V.STORE;var h=new z;h.format=O.DEPTH_STENCIL,h.depthLoadOp=k.CLEAR,h.depthStoreOp=V.STORE,h.stencilLoadOp=k.CLEAR,h.stencilStoreOp=V.STORE;var u=new X([n,a,o],h);this._gbufferRenderPass=t.createRenderPass(u)}if(!this._lightingRenderPass){var l=new G;l.format=O.RGBA8,l.loadOp=k.CLEAR,l.storeOp=V.STORE,l.barrier=t.getGeneralBarrier(new Q(q.NONE,q.COLOR_ATTACHMENT_WRITE));var d=new z;d.format=O.DEPTH_STENCIL,d.depthLoadOp=k.LOAD,d.depthStoreOp=V.DISCARD,d.stencilLoadOp=k.LOAD,d.stencilStoreOp=V.DISCARD,l.barrier=t.getGeneralBarrier(new Q(q.DEPTH_STENCIL_ATTACHMENT_WRITE,q.DEPTH_STENCIL_ATTACHMENT_WRITE));var c=new X([l],d);this._lightingRenderPass=t.createRenderPass(c)}return this._width=e.width,this._height=e.height,this._generateDeferredRenderData(),!0},i._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(Tt.BINDING).destroy(),this._descriptorSet.getBuffer(wt.BINDING).destroy(),this._descriptorSet.getBuffer(At.BINDING).destroy(),this._descriptorSet.getTexture(bt).destroy(),this._descriptorSet.getTexture(Ft).destroy())},i._destroyDeferredData=function(){var e=this._pipelineRenderData;if(e){e.gbufferFrameBuffer&&e.gbufferFrameBuffer.destroy(),e.outputFrameBuffer&&e.outputFrameBuffer.destroy(),e.outputDepth&&e.outputDepth.destroy();for(var t=0;t<e.gbufferRenderTargets.length;t++)e.gbufferRenderTargets[t].destroy();e.gbufferRenderTargets.length=0;for(var i=0;i<e.outputRenderTargets.length;i++)e.outputRenderTargets[i].destroy();e.outputRenderTargets.length=0,this._destroyBloomData()}this._pipelineRenderData=null},i._ensureEnoughSize=function(e){for(var t=this._width,i=this._height,r=0;r<e.length;++r){var s=e[r].window;t=Math.max(s.width,t),i=Math.max(s.height,i)}t===this._width&&i===this._height||(this._width=t,this._height=i,this._destroyDeferredData(),this._generateDeferredRenderData())},i._generateDeferredRenderData=function(){for(var e=this,t=this.device,i=this._pipelineRenderData=new Uo,r=this.pipelineSceneData,s=0;s<3;++s)i.gbufferRenderTargets.push(t.createTexture(new E(T.TEX2D,A.COLOR_ATTACHMENT|A.SAMPLED,O.RGBA16F,this._width*r.shadingScale,this._height*r.shadingScale)));i.outputDepth=t.createTexture(new E(T.TEX2D,A.DEPTH_STENCIL_ATTACHMENT|A.SAMPLED,O.DEPTH_STENCIL,this._width*r.shadingScale,this._height*r.shadingScale)),i.gbufferFrameBuffer=t.createFramebuffer(new Y(this._gbufferRenderPass,i.gbufferRenderTargets,i.outputDepth)),i.outputRenderTargets.push(t.createTexture(new E(T.TEX2D,A.COLOR_ATTACHMENT|A.SAMPLED,O.RGBA16F,this._width*r.shadingScale,this._height*r.shadingScale))),i.outputFrameBuffer=t.createFramebuffer(new Y(this._lightingRenderPass,i.outputRenderTargets,null)),i.sampler=this.globalDSManager.pointSampler,this.on(or.ATTACHMENT_SCALE_CAHNGED,(function(t){i.sampler=t<1?e.globalDSManager.pointSampler:e.globalDSManager.linearSampler,i.gbufferFrameBuffer=e.newFramebufferByRatio(i.gbufferFrameBuffer),i.gbufferFrameBuffer=e.newFramebufferByRatio(i.outputFrameBuffer)}))},t}($s),Lo=a((No=Co).prototype,"renderTextures",[Do,Fe,Bo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Po=No))||Po));function Go(){var e=new oo;return e.initialize({flows:[]}),e}var zo=new m("Scheduler"),Vo=function(e,t,i,r){this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=e,this.priority=t,this.paused=i,this.markedForDeletion=r};Vo.get=function(e,t,i,r){var s=Vo._listEntries.pop();return s?(s.target=e,s.priority=t,s.paused=i,s.markedForDeletion=r):s=new Vo(e,t,i,r),s},Vo.put=function(e){Vo._listEntries.length<20&&(e.target=null,Vo._listEntries.push(e))},Vo._listEntries=[];var Wo=function(e,t,i,r){this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=e,this.entry=t,this.target=i,this.callback=r};Wo.get=function(e,t,i,r){var s=Wo._hashUpdateEntries.pop();return s?(s.list=e,s.entry=t,s.target=i,s.callback=r):s=new Wo(e,t,i,r),s},Wo.put=function(e){Wo._hashUpdateEntries.length<20&&(e.list=e.entry=e.target=e.callback=null,Wo._hashUpdateEntries.push(e))},Wo._hashUpdateEntries=[];var ko=function(e,t,i,r,s,n){this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=e,this.target=t,this.timerIndex=i,this.currentTimer=r,this.currentTimerSalvaged=s,this.paused=n};ko.get=function(e,t,i,r,s,n){var a=ko._hashTimerEntries.pop();return a?(a.timers=e,a.target=t,a.timerIndex=i,a.currentTimer=r,a.currentTimerSalvaged=s,a.paused=n):a=new ko(e,t,i,r,s,n),a},ko.put=function(e){ko._hashTimerEntries.length<20&&(e.timers=e.target=e.currentTimer=null,ko._hashTimerEntries.push(e))},ko._hashTimerEntries=[];var Qo=function(){function e(){this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}var i=e.prototype;return i.initWithCallback=function(e,i,r,s,n,a){return this._lock=!1,this._scheduler=e,this._target=r,this._callback=i,this._elapsed=-1,this._interval=s,this._delay=a,this._useDelay=this._delay>0,this._repeat=n,this._runForever=this._repeat===t.macro.REPEAT_FOREVER,!0},i.getInterval=function(){return this._interval},i.setInterval=function(e){this._interval=e},i.update=function(e){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=e,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))},i.getCallback=function(){return this._callback},i.trigger=function(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)},i.cancel=function(){this._scheduler.unschedule(this._callback,this._target)},e}();Qo._timers=[],Qo.get=function(){return Qo._timers.pop()||new Qo},Qo.put=function(e){Qo._timers.length<20&&!e._lock&&(e._scheduler=e._target=e._callback=null,Qo._timers.push(e))};var qo,Xo=e("i",function(e){function i(){var t;return(t=e.call(this)||this)._timeScale=void 0,t._updatesNegList=void 0,t._updates0List=void 0,t._updatesPosList=void 0,t._hashForUpdates=void 0,t._hashForTimers=void 0,t._currentTarget=void 0,t._currentTargetSalvaged=void 0,t._updateHashLocked=void 0,t._arrayForTimers=void 0,t._timeScale=1,t._updatesNegList=[],t._updates0List=[],t._updatesPosList=[],t._hashForUpdates=g(!0),t._hashForTimers=g(!0),t._currentTarget=null,t._currentTargetSalvaged=!1,t._updateHashLocked=!1,t._arrayForTimers=[],t}s(i,e),i.enableForTarget=function(e){var t=!1;(e.uuid||e.id)&&(t=!0),t||(e.__instanceId?p(1513):e.id=zo.getNewId())};var n=i.prototype;return n.setTimeScale=function(e){this._timeScale=e},n.getTimeScale=function(){return this._timeScale},n.update=function(e){var t,i,r,s,n;for(this._updateHashLocked=!0,1!==this._timeScale&&(e*=this._timeScale),t=0,r=(i=this._updatesNegList).length;t<r;t++)(s=i[t]).paused||s.markedForDeletion||s.target.update(e);for(t=0,r=(i=this._updates0List).length;t<r;t++)(s=i[t]).paused||s.markedForDeletion||s.target.update(e);for(t=0,r=(i=this._updatesPosList).length;t<r;t++)(s=i[t]).paused||s.markedForDeletion||s.target.update(e);var a=this._arrayForTimers;for(t=0;t<a.length;t++){if(n=a[t],this._currentTarget=n,this._currentTargetSalvaged=!1,!n.paused)for(n.timerIndex=0;n.timerIndex<n.timers.length;++n.timerIndex)n.currentTimer=n.timers[n.timerIndex],n.currentTimerSalvaged=!1,n.currentTimer.update(e),n.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--t)}for(t=0,i=this._updatesNegList;t<i.length;)(s=i[t]).markedForDeletion?this._removeUpdateFromHash(s):t++;for(t=0,i=this._updates0List;t<i.length;)(s=i[t]).markedForDeletion?this._removeUpdateFromHash(s):t++;for(t=0,i=this._updatesPosList;t<i.length;)(s=i[t]).markedForDeletion?this._removeUpdateFromHash(s):t++;this._updateHashLocked=!1,this._currentTarget=null},n.schedule=function(e,i,s,n,a,o){if("function"!=typeof e){var h=e;e=i,i=h}3!==arguments.length&&4!==arguments.length&&5!==arguments.length||(o=!!n,n=t.macro.REPEAT_FOREVER,a=0),_(i,1502);var u=i.uuid||i.id;if(u){var l,d,c=this._hashForTimers[u];if(c?c.paused!==o&&p(1511):(c=ko.get(null,i,0,null,null,o),this._arrayForTimers.push(c),this._hashForTimers[u]=c),null==c.timers)c.timers=[];else for(d=0;d<c.timers.length;++d)if((l=c.timers[d])&&e===l._callback)return f(1507,l.getInterval(),s),void(l._interval=s);(l=Qo.get()).initWithCallback(this,e,i,s,n,a),c.timers.push(l),this._currentTarget===c&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}else r(1510)},n.scheduleUpdate=function(e,t,i){var s=e.uuid||e.id;if(s){var n=this._hashForUpdates[s];if(n&&n.entry){if(n.entry.priority===t)return n.entry.markedForDeletion=!1,void(n.entry.paused=i);if(this._updateHashLocked)return f(1506),n.entry.markedForDeletion=!1,void(n.entry.paused=i);this.unscheduleUpdate(e)}var a,o=Vo.get(e,t,i,!1);0===t?(a=this._updates0List,this._appendIn(a,o)):(a=t<0?this._updatesNegList:this._updatesPosList,this._priorityIn(a,o,t)),this._hashForUpdates[s]=Wo.get(a,o,e,null)}else r(1510)},n.unschedule=function(e,t){if(t&&e){var i=t.uuid||t.id;if(i){var s=this._hashForTimers[i];if(s)for(var n=s.timers,a=0,o=n.length;a<o;a++){var h=n[a];if(e===h._callback)return h!==s.currentTimer||s.currentTimerSalvaged||(s.currentTimerSalvaged=!0),n.splice(a,1),Qo.put(h),s.timerIndex>=a&&s.timerIndex--,void(0===n.length&&(this._currentTarget===s?this._currentTargetSalvaged=!0:this._removeHashElement(s)))}}else r(1510)}},n.unscheduleUpdate=function(e){if(e){var t=e.uuid||e.id;if(t){var i=this._hashForUpdates[t];i&&(this._updateHashLocked?i.entry.markedForDeletion=!0:this._removeUpdateFromHash(i.entry))}else r(1510)}},n.unscheduleAllForTarget=function(e){if(e){var t=e.uuid||e.id;if(t){var i=this._hashForTimers[t];if(i){var s=i.timers;s.indexOf(i.currentTimer)>-1&&!i.currentTimerSalvaged&&(i.currentTimerSalvaged=!0);for(var n=0,a=s.length;n<a;n++)Qo.put(s[n]);s.length=0,this._currentTarget===i?this._currentTargetSalvaged=!0:this._removeHashElement(i)}this.unscheduleUpdate(e)}else r(1510)}},n.unscheduleAll=function(){this.unscheduleAllWithMinPriority(ke.Priority.SCHEDULER)},n.unscheduleAllWithMinPriority=function(e){var t,i,r,s=this._arrayForTimers;for(t=s.length-1;t>=0;t--)i=s[t],this.unscheduleAllForTarget(i.target);var n=0;if(e<0)for(t=0;t<this._updatesNegList.length;)n=this._updatesNegList.length,(r=this._updatesNegList[t])&&r.priority>=e&&this.unscheduleUpdate(r.target),n===this._updatesNegList.length&&t++;if(e<=0)for(t=0;t<this._updates0List.length;)n=this._updates0List.length,(r=this._updates0List[t])&&this.unscheduleUpdate(r.target),n===this._updates0List.length&&t++;for(t=0;t<this._updatesPosList.length;)n=this._updatesPosList.length,(r=this._updatesPosList[t])&&r.priority>=e&&this.unscheduleUpdate(r.target),n===this._updatesPosList.length&&t++},n.isScheduled=function(e,t){_(e,1508),_(t,1509);var i=t.uuid||t.id;if(!i)return r(1510),!1;var s=this._hashForTimers[i];if(!s)return!1;if(null==s.timers)return!1;for(var n=s.timers,a=0;a<n.length;++a)if(e===n[a]._callback)return!0;return!1},n.pauseAllTargets=function(){return this.pauseAllTargetsWithMinPriority(ke.Priority.SCHEDULER)},n.pauseAllTargetsWithMinPriority=function(e){var t,i,r,s,n=[],a=this._arrayForTimers;for(i=0,r=a.length;i<r;i++)(t=a[i])&&(t.paused=!0,n.push(t.target));if(e<0)for(i=0;i<this._updatesNegList.length;i++)(s=this._updatesNegList[i])&&s.priority>=e&&(s.paused=!0,n.push(s.target));if(e<=0)for(i=0;i<this._updates0List.length;i++)(s=this._updates0List[i])&&(s.paused=!0,n.push(s.target));for(i=0;i<this._updatesPosList.length;i++)(s=this._updatesPosList[i])&&s.priority>=e&&(s.paused=!0,n.push(s.target));return n},n.resumeTargets=function(e){if(e)for(var t=0;t<e.length;t++)this.resumeTarget(e[t])},n.pauseTarget=function(e){_(e,1503);var t=e.uuid||e.id;if(t){var i=this._hashForTimers[t];i&&(i.paused=!0);var s=this._hashForUpdates[t];s&&(s.entry.paused=!0)}else r(1510)},n.resumeTarget=function(e){_(e,1504);var t=e.uuid||e.id;if(t){var i=this._hashForTimers[t];i&&(i.paused=!1);var s=this._hashForUpdates[t];s&&(s.entry.paused=!1)}else r(1510)},n.isTargetPaused=function(e){_(e,1505);var t=e.uuid||e.id;if(!t)return r(1510),!1;var i=this._hashForTimers[t];if(i)return i.paused;var s=this._hashForUpdates[t];return!!s&&s.entry.paused},n._removeHashElement=function(e){var t=e.target.uuid||e.target.id;delete this._hashForTimers[t];for(var i=this._arrayForTimers,r=0,s=i.length;r<s;r++)if(i[r]===e){i.splice(r,1);break}ko.put(e)},n._removeUpdateFromHash=function(e){var t=e.target.uuid||e.target.id,i=this._hashForUpdates[t];if(i){for(var r=i.list,s=i.entry,n=0,a=r.length;n<a;n++)if(r[n]===s){r.splice(n,1);break}delete this._hashForUpdates[t],Vo.put(s),Wo.put(i)}},n._priorityIn=function(e,t,i){for(var r=0;r<e.length;r++)if(i<e[r].priority)return void e.splice(r,0,t);e.push(t)},n._appendIn=function(e,t){e.push(t)},i}(ke));Xo.ID="scheduler",t.Scheduler=Xo;var jo=((qo={})[he.PORTRAIT]=K.IDENTITY,qo[he.LANDSCAPE_RIGHT]=K.ROTATE_90,qo[he.PORTRAIT_UPSIDE_DOWN]=K.ROTATE_180,qo[he.LANDSCAPE_LEFT]=K.ROTATE_270,qo),Yo=function(){function e(){this._title="",this._width=1,this._height=1,this._swapchain=null,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._cameras=[],this._hasOnScreenAttachments=!1,this._hasOffScreenAttachments=!1,this._framebuffer=null,this._device=null}e.registerCreateFunc=function(t){t._createWindowFun=function(t){return new e(t)}};var t=e.prototype;return t.initialize=function(e,t){if(void 0!==t.title&&(this._title=t.title),void 0!==t.swapchain&&(this._swapchain=t.swapchain),this._width=t.width,this._height=t.height,this._device=e,this._renderPass=e.createRenderPass(t.renderPassInfo),t.swapchain)this._swapchain=t.swapchain,this._colorTextures.push(t.swapchain.colorTexture),this._depthStencilTexture=t.swapchain.depthStencilTexture;else{for(var i=0;i<t.renderPassInfo.colorAttachments.length;i++)this._colorTextures.push(e.createTexture(new E(T.TEX2D,A.COLOR_ATTACHMENT|A.SAMPLED|A.TRANSFER_SRC,t.renderPassInfo.colorAttachments[i].format,this._width,this._height)));t.renderPassInfo.depthStencilAttachment.format!==O.UNKNOWN&&(this._depthStencilTexture=e.createTexture(new E(T.TEX2D,A.DEPTH_STENCIL_ATTACHMENT|A.SAMPLED,t.renderPassInfo.depthStencilAttachment.format,this._width,this._height)),this._hasOffScreenAttachments=!0)}return this._framebuffer=e.createFramebuffer(new Y(this._renderPass,this._colorTextures,this._depthStencilTexture)),!0},t.destroy=function(){this.clearCameras(),this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer=null),this._depthStencilTexture&&(this._depthStencilTexture.destroy(),this._depthStencilTexture=null);for(var e=0;e<this._colorTextures.length;e++){var t=this._colorTextures[e];t&&t.destroy()}this._colorTextures.length=0,this._device=null},t.resize=function(e,t){if(this._swapchain)this._swapchain.resize(e,t,jo[xt.orientation]),this._width=this._swapchain.width,this._height=this._swapchain.height;else{for(var i=0;i<this._colorTextures.length;i++)this._colorTextures[i].resize(e,t);this._depthStencilTexture&&this._depthStencilTexture.resize(e,t),this._width=e,this._height=t}this.framebuffer&&(this.framebuffer.destroy(),this._framebuffer=this._device.createFramebuffer(new Y(this._renderPass,this._colorTextures,this._depthStencilTexture)));for(var r,s=n(this._cameras);!(r=s()).done;)r.value.resize(e,t)},t.extractRenderCameras=function(e){for(var t=0;t<this._cameras.length;t++){var i=this._cameras[t];i.enabled&&(i.update(),e.push(i))}},t.attachCamera=function(e){for(var t=0;t<this._cameras.length;t++)if(this._cameras[t]===e)return;this._cameras.push(e),this.sortCameras()},t.detachCamera=function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return void this._cameras.splice(t,1)},t.clearCameras=function(){this._cameras.length=0},t.sortCameras=function(){this._cameras.sort((function(e,t){return e.priority-t.priority}))},i(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"swapchain",get:function(){return this._swapchain}},{key:"framebuffer",get:function(){return this._framebuffer}},{key:"cameras",get:function(){return this._cameras}}]),e}(),Ko=e("e",function(){function e(e){var i=this;this._createSceneFun=null,this._createWindowFun=null,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._usesCustomPipeline=!0,this._pipeline=null,this._pipelineEvent=null,this._classicPipeline=null,this._customPipeline=null,this._batcher=null,this._dataPoolMgr=void 0,this._scenes=[],this._modelPools=new Map,this._cameraPool=null,this._lightPools=new Map,this._debugView=new Hi,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._useDeferredPipeline=!1,this._fixedFPSFrameTime=0,this._cumulativeTime=0,this._frameTime=0,this._device=e,this._dataPoolMgr=t.internal.DataPoolManager&&new t.internal.DataPoolManager(e),fi.registerCreateFunc(this),Yo.registerCreateFunc(this),this._cameraPool=new x((function(){return new Ne(i._device)}),4,(function(e){return e.destroy()}))}var r=e.prototype;return r.initialize=function(){var e,t=dt.swapchain,i=new G;i.format=t.colorTexture.format;var r=new z;r.format=t.depthStencilTexture.format,r.depthStoreOp=V.DISCARD,r.stencilStoreOp=V.DISCARD;var s=new X([i],r);this._mainWindow=this.createWindow({title:"rootMainWindow",width:t.width,height:t.height,renderPassInfo:s,swapchain:t}),this._curWindow=this._mainWindow;var n=S.querySettings(v.Category.ANIMATION,"customJointTextureLayouts")||[];null===(e=this._dataPoolMgr)||void 0===e||e.jointTexturePool.registerCustomTextureLayouts(n),this._resizeMaxJointForDS()},r.destroy=function(){this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null,this._pipelineEvent=null),this._batcher&&(this._batcher.destroy(),this._batcher=null),this._curWindow=null,this._mainWindow=null,this.dataPoolManager.clear()},r.resize=function(e,t){for(var i,r=n(this._windows);!(i=r()).done;){var s=i.value;s.swapchain&&s.resize(e,t)}},r.setRenderPipeline=function(e){e instanceof Ho&&(this._useDeferredPipeline=!0);var i=!1;if(e||(e=Go(),i=!0),this._useDeferredPipeline&&this.device.hasFeature(R.COMPUTE_SHADER)||(e.clusterEnabled=!1),e.bloomEnabled=!1,this.usesCustomPipeline&&t.internal.createCustomPipeline?(this._customPipeline=t.internal.createCustomPipeline(),i=!0,this._pipeline=this._customPipeline):(this._classicPipeline=e,this._pipeline=this._classicPipeline,this._pipelineEvent=this._classicPipeline,this._usesCustomPipeline=!1),!this._pipeline.activate(this._mainWindow.swapchain))return i&&this._pipeline.destroy(),this._classicPipeline=null,this._customPipeline=null,this._pipeline=null,this._pipelineEvent=null,!1;var r=t.director.getScene();return r&&r.globals.activate(),this.onGlobalPipelineStateChanged(),!(!this._batcher&&t.internal.Batcher2D&&(this._batcher=new t.internal.Batcher2D(this),!this._batcher.initialize())&&(this.destroy(),1))},r.onGlobalPipelineStateChanged=function(){for(var e=0;e<this._scenes.length;e++)this._scenes[e].onGlobalPipelineStateChanged();this._pipeline.onGlobalPipelineStateChanged()},r.activeWindow=function(e){this._curWindow=e},r.resetCumulativeTime=function(){this._cumulativeTime=0},r.frameMove=function(e){this._frameTime=e,++this._frameCount,this._cumulativeTime+=e,this._fpsTime+=e,this._fpsTime>1&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0);for(var i=0;i<this._scenes.length;++i)this._scenes[i].removeBatches();for(var r=this._windows,s=[],n=0;n<r.length;n++)r[n].extractRenderCameras(s);if(this._pipeline&&s.length>0){this._device.acquire([dt.swapchain]);var a=this._scenes,o=t.director.getTotalFrames();this._batcher&&(this._batcher.update(),this._batcher.uploadBuffers());for(var h=0;h<a.length;h++)a[h].update(o);t.director.emit(t.Director.EVENT_BEFORE_COMMIT),s.sort((function(e,t){return e.priority-t.priority}));for(var u=0;u<s.length;++u){var l;null===(l=s[u].geometryRenderer)||void 0===l||l.update()}this._pipeline.render(s),this._device.present()}this._batcher&&this._batcher.reset()},r.createWindow=function(e){var t=this._createWindowFun(this);return t.initialize(this.device,e),this._windows.push(t),t},r.destroyWindow=function(e){for(var t=0;t<this._windows.length;++t)if(this._windows[t]===e)return e.destroy(),void this._windows.splice(t,1)},r.destroyWindows=function(){for(var e,t=n(this._windows);!(e=t()).done;)e.value.destroy();this._windows.length=0},r.createScene=function(e){var t=this._createSceneFun(this);return t.initialize(e),this._scenes.push(t),t},r.destroyScene=function(e){for(var t=0;t<this._scenes.length;++t)if(this._scenes[t]===e)return e.destroy(),void this._scenes.splice(t,1)},r.destroyScenes=function(){for(var e,t=n(this._scenes);!(e=t()).done;)e.value.destroy();this._scenes.length=0},r.createModel=function(e){var t=this._modelPools.get(e);t||(this._modelPools.set(e,new x((function(){return new e}),10,(function(e){return e.destroy()}))),t=this._modelPools.get(e));var i=t.alloc();return i.initialize(),i},r.destroyModel=function(e){var t=this._modelPools.get(e.constructor);t?(t.free(e),e.scene&&e.scene.removeModel(e)):p(1300,e.constructor.name),e.destroy()},r.createCamera=function(){return this._cameraPool.alloc()},r.createLight=function(e){var t=this._lightPools.get(e);t||(this._lightPools.set(e,new x((function(){return new e}),4,(function(e){return e.destroy()}))),t=this._lightPools.get(e));var i=t.alloc();return i.initialize(),i},r.destroyLight=function(e){if(e.scene)switch(e.type){case Xt.DIRECTIONAL:e.scene.removeDirectionalLight(e);break;case Xt.SPHERE:e.scene.removeSphereLight(e);break;case Xt.SPOT:e.scene.removeSpotLight(e)}e.destroy()},r.recycleLight=function(e){var t=this._lightPools.get(e.constructor);if(t&&(t.free(e),e.scene))switch(e.type){case Xt.DIRECTIONAL:e.scene.removeDirectionalLight(e);break;case Xt.SPHERE:e.scene.removeSphereLight(e);break;case Xt.SPOT:e.scene.removeSpotLight(e)}},r._resizeMaxJointForDS=function(){var e=Math.floor((dt.gfxDevice.capabilities.maxVertexUniformVectors-38)/3);Ut(e=e<256?e:256)},i(e,[{key:"device",get:function(){return this._device}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"curWindow",get:function(){return this._curWindow},set:function(e){this._curWindow=e}},{key:"tempWindow",get:function(){return this._tempWindow},set:function(e){this._tempWindow=e}},{key:"windows",get:function(){return this._windows}},{key:"usesCustomPipeline",get:function(){return this._usesCustomPipeline&&""!==l.CUSTOM_PIPELINE_NAME}},{key:"pipeline",get:function(){return this._pipeline}},{key:"customPipeline",get:function(){return this._customPipeline}},{key:"pipelineEvent",get:function(){return this._pipelineEvent}},{key:"batcher2D",get:function(){return this._batcher}},{key:"scenes",get:function(){return this._scenes}},{key:"debugView",get:function(){return this._debugView}},{key:"cumulativeTime",get:function(){return this._cumulativeTime}},{key:"frameTime",get:function(){return this._frameTime}},{key:"frameCount",get:function(){return this._frameCount}},{key:"fps",get:function(){return this._fps}},{key:"fixedFPS",get:function(){return this._fixedFPS},set:function(e){e>0?(this._fixedFPS=e,this._fixedFPSFrameTime=1e3/e):this._fixedFPSFrameTime=0}},{key:"dataPoolManager",get:function(){return this._dataPoolMgr}},{key:"useDeferredPipeline",get:function(){return this._useDeferredPipeline}}]),e}());t.Root=Ko;var Jo=function(){function e(){this._allRenderers=[],this._dirtyRenderers=[],this._dirtyVersion=0}var t=e.prototype;return t.addRenderer=function(e){-1===e._internalId&&(e._internalId=this._allRenderers.length,this._allRenderers.push(e))},t.removeRenderer=function(e){if(-1!==e._internalId){var t=e._internalId;this._allRenderers[this._allRenderers.length-1]._internalId=t,w.array.fastRemoveAt(this._allRenderers,t),e._internalId=-1,e._dirtyVersion===this._dirtyVersion&&(w.array.fastRemove(this._dirtyRenderers,e),e._dirtyVersion=-1)}},t.markDirtyRenderer=function(e){e._dirtyVersion!==this._dirtyVersion&&-1!==e._internalId&&(this._dirtyRenderers.push(e),e._dirtyVersion=this._dirtyVersion)},t.updateAllDirtyRenderers=function(){for(var e=this._dirtyRenderers.length,t=this._dirtyRenderers,i=0;i<e;i++)t[i].updateRenderer();this._dirtyRenderers.length=0,this._dirtyVersion++},e}(),Zo=e("J",new Jo),$o=e("j",function(e){function n(){var t;return(t=e.call(this)||this)._compScheduler=void 0,t._nodeActivator=void 0,t._invalid=void 0,t._paused=void 0,t._root=void 0,t._loadingScene=void 0,t._scene=void 0,t._totalFrames=void 0,t._scheduler=void 0,t._systems=void 0,t._persistRootNodes={},t._invalid=!1,t._paused=!1,t._root=null,t._loadingScene="",t._scene=null,t._totalFrames=0,t._scheduler=new Xo,t._compScheduler=new Ye,t._nodeActivator=new Ke,t._systems=[],t}s(n,e);var a=n.prototype;return a.calculateDeltaTime=function(){},a.end=function(){var e=this;this.once(n.EVENT_END_FRAME,(function(){e.purgeDirector()}))},a.pause=function(){this._paused||(this._paused=!0)},a.purgeDirector=function(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),t.isValid(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),t.assetManager.releaseAll()},a.reset=function(){var e;for(var t in this.purgeDirector(),this._persistRootNodes)this.removePersistRootNode(this._persistRootNodes[t]);null===(e=this.getScene())||void 0===e||e.destroy(),this.emit(n.EVENT_RESET),this.startAnimation()},a.runSceneImmediate=function(e,i,r){var s=this;e instanceof Qe&&(e=e.scene),_(e instanceof qe,1216),e._load();for(var a=Object.keys(this._persistRootNodes).map((function(e){return s._persistRootNodes[e]})),o=0;o<a.length;o++){var h=a[o];h.emit(Xe.EventType.SCENE_CHANGED_FOR_PERSISTS,e.renderScene);var u=e.uuid===h._originalSceneId&&e.getChildByUuid(h.uuid);if(u){var l=u.getSiblingIndex();h.hideFlags&=~ue.Flags.DontSave,h.hideFlags|=ue.Flags.DontSave&u.hideFlags,u._destroyImmediate(),e.insertChild(h,l)}else h.hideFlags|=ue.Flags.DontSave,h.parent=e}var d=this._scene;t.isValid(d)&&d.destroy(),t.assetManager._releaseManager._autoRelease(d,e,this._persistRootNodes),this._scene=null,ue._deferredDestroy(),i&&i(),this.emit(n.EVENT_BEFORE_SCENE_LAUNCH,e),this._scene=e,e._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),r&&r(null,e),this.emit(n.EVENT_AFTER_SCENE_LAUNCH,e)},a.runScene=function(e,t,i){var r=this;e instanceof Qe&&(e=e.scene),_(e,1205),_(e instanceof qe,1216),this.once(n.EVENT_END_FRAME,(function(){r.runSceneImmediate(e,t,i)}))},a.loadScene=function(e,i,s){var a=this;if(this._loadingScene)return p(1208,e,this._loadingScene),!1;var o=t.assetManager.bundles.find((function(t){return!!t.getSceneInfo(e)}));return o?(this.emit(n.EVENT_BEFORE_SCENE_LOADING,e),this._loadingScene=e,console.time("LoadScene "+e),o.loadScene(e,(function(t,r){console.timeEnd("LoadScene "+e),a._loadingScene="",t?(y(t),i&&i(t)):a.runSceneImmediate(r,s,i)})),!0):(r(1209,e),!1)},a.preloadScene=function(e,i,r){var s=t.assetManager.bundles.find((function(t){return!!t.getSceneInfo(e)}));if(s)s.preloadScene(e,null,i,r);else{var n='Can not preload the scene "'+e+'" because it is not in the build settings.';r&&r(new Error(n)),y("preloadScene: "+n)}},a.resume=function(){this._paused&&(this._paused=!1)},a.getScene=function(){return this._scene},a.getDeltaTime=function(){return t.game.deltaTime},a.getTotalTime=function(){return t.game.totalTime},a.getCurrentTime=function(){return t.game.frameStartTime},a.getTotalFrames=function(){return this._totalFrames},a.isPaused=function(){return this._paused},a.getScheduler=function(){return this._scheduler},a.setScheduler=function(e){this._scheduler!==e&&(this.unregisterSystem(this._scheduler),this._scheduler=e,this.registerSystem(Xo.ID,e,200))},a.registerSystem=function(e,t,i){t.id=e,t.priority=i,this._systems.push(t),this._systems.sort(ke.sortByPriority)},a.unregisterSystem=function(e){w.array.fastRemove(this._systems,e),this._systems.sort(ke.sortByPriority)},a.getSystem=function(e){return this._systems.find((function(t){return t.id===e}))},a.getAnimationManager=function(){return this.getSystem(t.AnimationManager.ID)},a.startAnimation=function(){this._invalid=!1},a.stopAnimation=function(){this._invalid=!0},a.mainLoop=function(e){var i;i=t.game._calculateDT(e),this.tick(i)},a.tick=function(e){if(!this._invalid){if(this.emit(n.EVENT_BEGIN_FRAME),je._frameDispatchEvents(),!this._paused){this.emit(n.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(e);for(var t=0;t<this._systems.length;++t)this._systems[t].update(e);this._compScheduler.lateUpdatePhase(e),this.emit(n.EVENT_AFTER_UPDATE),ue._deferredDestroy();for(var i=0;i<this._systems.length;++i)this._systems[i].postUpdate(e)}this.emit(n.EVENT_BEFORE_DRAW),Zo.updateAllDirtyRenderers(),this._root.frameMove(e),this.emit(n.EVENT_AFTER_DRAW),Xe.resetHasChangedFlags(),Xe.clearNodeArray(),le.update(e),this.emit(n.EVENT_END_FRAME),this._totalFrames++}},a.init=function(){this._totalFrames=0,this._paused=!1,this.registerSystem(Xo.ID,this._scheduler,200),this._root=new Ko(dt.gfxDevice),this._root.initialize({});for(var e=0;e<this._systems.length;e++)this._systems[e].init();this.emit(n.EVENT_INIT)},a.addPersistRootNode=function(e){if(t.Node.isNode(e)&&e.uuid){var i=e.uuid;if(!this._persistRootNodes[i]){var r=this._scene;if(t.isValid(r))if(e.parent){if(!(e.parent instanceof qe))return void p(3801);if(e.parent!==r)return void p(3802);e._originalSceneId=r.uuid}else e.parent=r,e._originalSceneId=r.uuid;this._persistRootNodes[i]=e,e._persistNode=!0,t.assetManager._releaseManager._addPersistNodeRef(e)}}else p(3800)},a.removePersistRootNode=function(e){var i=e.uuid||"";e===this._persistRootNodes[i]&&(delete this._persistRootNodes[i],e._persistNode=!1,e._originalSceneId="",t.assetManager._releaseManager._removePersistNodeRef(e))},a.isPersistRootNode=function(e){return!!e._persistNode},i(n,[{key:"root",get:function(){return this._root}}]),n}(H));$o.EVENT_INIT="director_init",$o.EVENT_RESET="director_reset",$o.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",$o.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",$o.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",$o.EVENT_BEFORE_UPDATE="director_before_update",$o.EVENT_AFTER_UPDATE="director_after_update",$o.EVENT_BEFORE_DRAW="director_before_draw",$o.EVENT_AFTER_DRAW="director_after_draw",$o.EVENT_BEFORE_COMMIT="director_before_commit",$o.EVENT_BEFORE_PHYSICS="director_before_physics",$o.EVENT_AFTER_PHYSICS="director_after_physics",$o.EVENT_BEGIN_FRAME="director_begin_frame",$o.EVENT_END_FRAME="director_end_frame",$o.instance=void 0,t.Director=$o;var eh,th=e("k",$o.instance=t.director=new $o),ih=e("I",{topLeft:t.v2(0,0),topRight:t.v2(0,0),top:t.v2(0,0),bottomLeft:t.v2(0,0),bottomRight:t.v2(0,0),bottom:t.v2(0,0),center:t.v2(0,0),left:t.v2(0,0),right:t.v2(0,0),width:0,height:0,init:function(e){var t=this.width=e.width,i=this.height=e.height,r=e.x,s=e.y,n=s+i,a=r+t;this.topLeft.x=r,this.topLeft.y=n,this.topRight.x=a,this.topRight.y=n,this.top.x=r+t/2,this.top.y=n,this.bottomLeft.x=r,this.bottomLeft.y=s,this.bottomRight.x=a,this.bottomRight.y=s,this.bottom.x=r+t/2,this.bottom.y=s,this.center.x=r+t/2,this.center.y=s+i/2,this.left.x=r,this.left.y=s+i/2,this.right.x=a,this.right.y=s+i/2}});t.visibleRect=ih;var rh=new ht,sh=((eh={})[l.ORIENTATION_AUTO]=he.AUTO,eh[l.ORIENTATION_LANDSCAPE]=he.LANDSCAPE,eh[l.ORIENTATION_PORTRAIT]=he.PORTRAIT,eh),nh=e("V",function(e){function i(){var t;(t=e.call(this)||this)._designResolutionSize=void 0,t._scaleX=void 0,t._scaleY=void 0,t._viewportRect=void 0,t._visibleRect=void 0,t._autoFullScreen=void 0,t._retinaEnabled=void 0,t._resizeCallback=void 0,t._resolutionPolicy=void 0,t._rpExactFit=void 0,t._rpShowAll=void 0,t._rpNoBorder=void 0,t._rpFixedHeight=void 0,t._rpFixedWidth=void 0;var i=ah,r=oh;return t._designResolutionSize=new ht(0,0),t._scaleX=1,t._scaleY=1,t._viewportRect=new ut(0,0,0,0),t._visibleRect=new ut(0,0,0,0),t._autoFullScreen=!1,t._retinaEnabled=!1,t._resizeCallback=null,t._rpExactFit=new hh(i.EQUAL_TO_FRAME,r.EXACT_FIT),t._rpShowAll=new hh(i.EQUAL_TO_FRAME,r.SHOW_ALL),t._rpNoBorder=new hh(i.EQUAL_TO_FRAME,r.NO_BORDER),t._rpFixedHeight=new hh(i.EQUAL_TO_FRAME,r.FIXED_HEIGHT),t._rpFixedWidth=new hh(i.EQUAL_TO_FRAME,r.FIXED_WIDTH),t._resolutionPolicy=t._rpShowAll,t}s(i,e);var n=i.prototype;return n.init=function(){var e=Ht.windowSize,t=e.width,i=e.height;this._designResolutionSize.width=t,this._designResolutionSize.height=i,this._viewportRect.width=t,this._viewportRect.height=i,this._visibleRect.width=t,this._visibleRect.height=i,rh.width=this._visibleRect.width,rh.height=this._visibleRect.height,ih&&ih.init(this._visibleRect),this.resizeWithBrowserSize(!0);var r=S.querySettings(v.Category.SCREEN,"designResolution");r&&this.setDesignResolutionSize(Number(r.width),Number(r.height),r.policy||hh.FIXED_HEIGHT),xt.on("window-resize",this._updateAdaptResult,this),xt.on("orientation-change",this._updateAdaptResult,this),xt.on("fullscreen-change",this._updateAdaptResult,this)},n.resizeWithBrowserSize=function(e){xt.handleResizeEvent=e},n.setResizeCallback=function(e){"function"!=typeof e&&null!=e||(this._resizeCallback=e)},n.setOrientation=function(e){xt.orientation=sh[e]},n.adjustViewportMeta=function(){},n.enableRetina=function(e){this._retinaEnabled=!!e},n.isRetinaEnabled=function(){return this._retinaEnabled},n.enableAutoFullScreen=function(e){e!==this._autoFullScreen&&(this._autoFullScreen=e,e&&Ht.requestFullScreen().catch((function(){})))},n.isAutoFullScreenEnabled=function(){return this._autoFullScreen},n.setCanvasSize=function(e,t){xt.resolutionScale=1;var i=xt.devicePixelRatio,r=new ht(e*i,t*i);Ht.windowSize=r},n.getCanvasSize=function(){return Ht.windowSize},n.getFrameSize=function(){var e=xt.devicePixelRatio,t=Ht.windowSize;return t.width/=e,t.height/=e,t},n.setFrameSize=function(e,t){var i=xt.devicePixelRatio;Ht.windowSize=new ht(e*i,t*i)},n.getVisibleSize=function(){return new ht(this._visibleRect.width,this._visibleRect.height)},n.getVisibleSizeInPixel=function(){return new ht(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)},n.getVisibleOrigin=function(){return new ot(this._visibleRect.x,this._visibleRect.y)},n.getVisibleOriginInPixel=function(){return new ot(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)},n.getResolutionPolicy=function(){return this._resolutionPolicy},n._updateResolutionPolicy=function(e){if(e instanceof hh)this._resolutionPolicy=e;else{var t=hh;e===t.EXACT_FIT&&(this._resolutionPolicy=this._rpExactFit),e===t.SHOW_ALL&&(this._resolutionPolicy=this._rpShowAll),e===t.NO_BORDER&&(this._resolutionPolicy=this._rpNoBorder),e===t.FIXED_HEIGHT&&(this._resolutionPolicy=this._rpFixedHeight),e===t.FIXED_WIDTH&&(this._resolutionPolicy=this._rpFixedWidth)}},n.setResolutionPolicy=function(e){this._updateResolutionPolicy(e);var t=uh.getDesignResolutionSize();uh.setDesignResolutionSize(t.width,t.height,e)},n.setDesignResolutionSize=function(e,t,i){if(e>0&&t>0){this._updateResolutionPolicy(i);var s=this._resolutionPolicy;s&&s.preApply(this),this._designResolutionSize.width=e,this._designResolutionSize.height=t;var n=s.apply(this,this._designResolutionSize);if(n.scale&&2===n.scale.length&&(this._scaleX=n.scale[0],this._scaleY=n.scale[1]),n.viewport){var a=this._viewportRect,o=this._visibleRect,h=n.viewport;a.x=h.x,a.y=h.y,a.width=h.width,a.height=h.height,o.x=0,o.y=0,o.width=h.width/this._scaleX,o.height=h.height/this._scaleY}s.postApply(this),rh.width=this._visibleRect.width,rh.height=this._visibleRect.height,ih&&ih.init(this._visibleRect),this.emit("design-resolution-changed")}else r(2200)},n.getDesignResolutionSize=function(){return new ht(this._designResolutionSize.width,this._designResolutionSize.height)},n.setRealPixelResolution=function(e,t,i){this.setDesignResolutionSize(e,t,i)},n.getViewportRect=function(){return this._viewportRect},n.getScaleX=function(){return this._scaleX},n.getScaleY=function(){return this._scaleY},n.getDevicePixelRatio=function(){return xt.devicePixelRatio},n.convertToLocationInView=function(e,t,i,r){void 0===r&&(r=new ot);var s=xt.devicePixelRatio*(e-i.left),n=xt.devicePixelRatio*(i.top+i.height-t);return xt.isFrameRotated?(r.x=Ht.windowSize.width-n,r.y=s):(r.x=s,r.y=n),r},n._convertToUISpace=function(e){var t=this._viewportRect;e.x=(e.x-t.x)/this._scaleX,e.y=(e.y-t.y)/this._scaleY},n._updateAdaptResult=function(){var e;t.director.root.resize(Ht.windowSize.width,Ht.windowSize.height);var i=this._designResolutionSize.width,r=this._designResolutionSize.height;i>0&&this.setDesignResolutionSize(i,r,this._resolutionPolicy),this.emit("canvas-resize"),null===(e=this._resizeCallback)||void 0===e||e.call(this)},i}(de(ke)));nh.instance=void 0;var ah=function(){function e(){this.name="ContainerStrategy"}var i=e.prototype;return i.preApply=function(){},i.apply=function(){},i.postApply=function(){},i._setupCanvas=function(){var e=t.game.canvas;if(e){var i=Ht.windowSize;e.width=i.width,e.height=i.height}},e}();ah.EQUAL_TO_FRAME=void 0,ah.PROPORTION_TO_FRAME=void 0;var oh=function(){function e(){this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}var t=e.prototype;return t.preApply=function(){},t.apply=function(){return{scale:[1,1]}},t.postApply=function(){},t._buildResult=function(e,t,i,r,s,n){Math.abs(e-i)<2&&(i=e),Math.abs(t-r)<2&&(r=t);var a=new ut(Math.round((e-i)/2),Math.round((t-r)/2),i,r);return this._result.scale=[s,n],this._result.viewport=a,this._result},e}();oh.EXACT_FIT=void 0,oh.SHOW_ALL=void 0,oh.NO_BORDER=void 0,oh.FIXED_HEIGHT=void 0,oh.FIXED_WIDTH=void 0,function(){var e=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),s=0;s<i;s++)r[s]=arguments[s];return(t=e.call.apply(e,[this].concat(r))||this).name="EqualToFrame",t}return s(t,e),t.prototype.apply=function(){xt.isProportionalToFrame=!1,this._setupCanvas()},t}(ah),t=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),s=0;s<i;s++)r[s]=arguments[s];return(t=e.call.apply(e,[this].concat(r))||this).name="ProportionalToFrame",t}return s(t,e),t.prototype.apply=function(){xt.isProportionalToFrame=!0,this._setupCanvas()},t}(ah);ah.EQUAL_TO_FRAME=new e,ah.PROPORTION_TO_FRAME=new t;var i=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),s=0;s<i;s++)r[s]=arguments[s];return(t=e.call.apply(e,[this].concat(r))||this).name="ExactFit",t}return s(t,e),t.prototype.apply=function(e,t){var i=Ht.windowSize,r=i.width,s=i.height,n=r/t.width,a=s/t.height;return this._buildResult(r,s,r,s,n,a)},t}(oh),r=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),s=0;s<i;s++)r[s]=arguments[s];return(t=e.call.apply(e,[this].concat(r))||this).name="ShowAll",t}return s(t,e),t.prototype.apply=function(e,t){var i,r,s=Ht.windowSize,n=s.width,a=s.height,o=t.width,h=t.height,u=n/o,l=a/h,d=0;return u<l?(i=n,r=h*(d=u)):(i=o*(d=l),r=a),this._buildResult(n,a,i,r,d,d)},t}(oh),n=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),s=0;s<i;s++)r[s]=arguments[s];return(t=e.call.apply(e,[this].concat(r))||this).name="NoBorder",t}return s(t,e),t.prototype.apply=function(e,t){var i,r,s,n=Ht.windowSize,a=n.width,o=n.height,h=t.width,u=t.height,l=a/h,d=o/u;return l<d?(r=h*(i=d),s=o):(r=a,s=u*(i=l)),this._buildResult(a,o,r,s,i,i)},t}(oh),a=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),s=0;s<i;s++)r[s]=arguments[s];return(t=e.call.apply(e,[this].concat(r))||this).name="FixedHeight",t}return s(t,e),t.prototype.apply=function(e,t){var i=Ht.windowSize,r=i.width,s=i.height,n=s/t.height,a=r,o=s;return this._buildResult(r,s,a,o,n,n)},t}(oh),o=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),s=0;s<i;s++)r[s]=arguments[s];return(t=e.call.apply(e,[this].concat(r))||this).name="FixedWidth",t}return s(t,e),t.prototype.apply=function(e,t){var i=Ht.windowSize,r=i.width,s=i.height,n=r/t.width,a=r,o=s;return this._buildResult(r,s,a,o,n,n)},t}(oh);oh.EXACT_FIT=new i,oh.SHOW_ALL=new r,oh.NO_BORDER=new n,oh.FIXED_HEIGHT=new a,oh.FIXED_WIDTH=new o}();var hh=e("h",function(){function e(e,t){this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(e),this.setContentStrategy(t)}var t=e.prototype;return t.preApply=function(e){this._contentStrategy.preApply(e)},t.apply=function(e,t){return this._containerStrategy.apply(e,t),this._contentStrategy.apply(e,t)},t.postApply=function(e){this._contentStrategy.postApply(e)},t.setContainerStrategy=function(e){e instanceof ah&&(this._containerStrategy=e)},t.setContentStrategy=function(e){e instanceof oh&&(this._contentStrategy=e)},i(e,[{key:"canvasSize",get:function(){return Ht.windowSize}}]),e}());hh.EXACT_FIT=0,hh.NO_BORDER=1,hh.SHOW_ALL=2,hh.FIXED_HEIGHT=3,hh.FIXED_WIDTH=4,hh.UNKNOWN=5,hh.ContainerStrategy=ah,hh.ContentStrategy=oh,t.ResolutionPolicy=hh;var uh=e("v",nh.instance=t.view=new nh);th.registerSystem("view",uh,0),t.winSize=rh,lt(nh.prototype,"View.prototype",[{name:"isAntiAliasEnabled",suggest:"The API of Texture2d have been largely modified, no alternative"},{name:"enableAntiAlias",suggest:"The API of Texture2d have been largely modified, no alternative"}]),nt(nh.prototype,"View.prototype",[{name:"adjustViewportMeta"},{name:"enableAutoFullScreen",suggest:"use screen.requestFullScreen() instead."},{name:"isAutoFullScreenEnabled"},{name:"setCanvasSize",suggest:"setting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"getCanvasSize",suggest:"please use screen.windowSize instead."},{name:"getFrameSize",suggest:"getting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"setFrameSize",suggest:"setting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"getDevicePixelRatio",suggest:"use screen.devicePixelRatio instead."},{name:"convertToLocationInView"},{name:"enableRetina"},{name:"isRetinaEnabled"},{name:"setRealPixelResolution"}]),nt(t,"cc",[{name:"winSize",suggest:"please use view.getVisibleSize() instead."}]),nt(Gt,"sys",[{name:"capabilities",suggest:"please use sys.hasFeature() method instead."}]),it(Gt,"sys",["UNKNOWN","ENGLISH","CHINESE","FRENCH","ITALIAN","GERMAN","SPANISH","DUTCH","RUSSIAN","KOREAN","JAPANESE","HUNGARIAN","PORTUGUESE","ARABIC","NORWEGIAN","POLISH","TURKISH","UKRAINIAN","ROMANIAN","BULGARIAN"].map((function(e){return{name:"LANGUAGE_"+e,newName:e,target:Gt.Language,targetName:"sys.Language"}}))),it(Gt,"sys",["UNKNOWN","IOS","ANDROID","WINDOWS","LINUX","OSX"].map((function(e){return{name:"OS_"+e,newName:e,target:Gt.OS,targetName:"sys.OS"}}))),it(Gt,"sys",["UNKNOWN","WECHAT","ANDROID","IE","EDGE","QQ","MOBILE_QQ","UC","UCBS","BAIDU_APP","BAIDU","MAXTHON","OPERA","OUPENG","MIUI","FIREFOX","SAFARI","CHROME","LIEBAO","QZONE","SOUGOU","HUAWEI"].map((function(e){return{name:"BROWSER_TYPE_"+e,newName:e,target:Gt.BrowserType,targetName:"sys.BrowserType"}}))),it(Gt,"sys",[{name:"BROWSER_TYPE_360",newName:"BROWSER_360",target:Gt.BrowserType,targetName:"sys.BrowserType"}]),it(Gt,"sys",["UNKNOWN","EDITOR_PAGE","EDITOR_CORE","MOBILE_BROWSER","DESKTOP_BROWSER","WIN32","MACOS","IOS","ANDROID","OHOS","WECHAT_GAME","BAIDU_MINI_GAME","XIAOMI_QUICK_GAME","ALIPAY_MINI_GAME","BYTEDANCE_MINI_GAME","OPPO_MINI_GAME","VIVO_MINI_GAME","HUAWEI_QUICK_GAME","COCOSPLAY","LINKSURE_MINI_GAME","QTT_MINI_GAME"].map((function(e){return{name:e,target:Gt.Platform,targetName:"sys.Platform"}}))),it(Gt,"sys",[{name:"IPHONE",newName:"IOS",target:Gt.Platform,targetName:"sys.Platform"},{name:"IPAD",newName:"IOS",target:Gt.Platform,targetName:"sys.Platform"}]),lt(Gt,"sys",["LINUX","BLACKBERRY","NACL","EMSCRIPTEN","TIZEN","WINRT","WP8","QQ_PLAY","FB_PLAYABLE_ADS"].map((function(e){return{name:e}}))),it(Gt,"sys",[{name:"windowPixelResolution",target:Ht,targetName:"screen",newName:"windowSize"}]),nt(Ht,"screen",[{name:"autoFullScreen",suggest:"please use screen.requestFullScreen() instead."},{name:"disableAutoFullScreen"}])}}}));
