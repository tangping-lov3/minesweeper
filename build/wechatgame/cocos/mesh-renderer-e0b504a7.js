System.register(["./bits-b8bc8b22.js","./buffer-barrier-17698e09.js","./scene-asset-10397f71.js","./math-base-02e87bf8.js","./pipeline-state-manager-f4a950fe.js","./deprecated-dacf9914.js","./deprecated-8c84be32.js","./mesh-20100c2c.js"],(function(t){"use strict";var e,i,s,a,o,n,h,r,l,d,u,p,c,_,m,g,f,b,S,w,y,M,v,B,O,P,I,R;return{setters:[function(t){e=t.F,i=t.E,s=t.A,a=t.G,o=t.q,n=t.l,h=t.Q,r=t.H,l=t.I},function(){},function(t){d=t.a$,u=t.b7,p=t.b0,c=t.bR,_=t.bS,m=t.at,g=t.aM,f=t.aK,b=t.bW,S=t.b1,w=t.bT,y=t.bX,M=t.bU,v=t.bP,B=t.b2,O=t.bV},function(t){P=t.c},function(){},function(t){I=t.a},function(){},function(t){R=t.M}],execute:function(){var z,C,W,N,k,D,j,F,L,U,T,x,A,E,H,V,G,q,K,Q,X,$,J,Y,Z,tt,et,it,st,at,ot,nt,ht,rt,lt,dt,ut,pt,ct,_t,mt,gt=t("a",function(t){function i(){for(var e,i=arguments.length,s=new Array(i),a=0;a<i;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))||this)._morphRenderingInstance=null,e._usedMaterials=new Set,e}e(i,t);var s=i.prototype;return s.getMacroPatches=function(e){var i=t.prototype.getMacroPatches.call(this,e);if(this._morphRenderingInstance){var s=this._morphRenderingInstance.requiredPatches(e);if(s)return s.concat(null!=i?i:[])}return i},s.initSubModel=function(e,i,s){return t.prototype.initSubModel.call(this,e,i,this._launderMaterial(s))},s.destroy=function(){t.prototype.destroy.call(this),this._morphRenderingInstance=null},s.setSubModelMaterial=function(e,i){return t.prototype.setSubModelMaterial.call(this,e,this._launderMaterial(i))},s.setMorphRendering=function(t){this._morphRenderingInstance=t},s._updateLocalDescriptors=function(e,i){t.prototype._updateLocalDescriptors.call(this,e,i),this._morphRenderingInstance&&this._morphRenderingInstance.adaptPipelineState(e,i)},s._launderMaterial=function(t){return t},i}(I)),ft=i({OFF:0,ON:1}),bt=i({OFF:0,ON:1}),St=(z=d("cc.ModelLightmapSettings"),C=O("_recieveShadow"),z((T=function(){function t(){r(this,"texture",k,this),r(this,"uvParam",D,this),r(this,"_bakeable",j,this),r(this,"_castShadow",F,this),r(this,"_receiveShadow",L,this),r(this,"_lightmapSize",U,this)}return s(t,[{key:"bakeable",get:function(){return this._bakeable},set:function(t){this._bakeable=t}},{key:"castShadow",get:function(){return this._castShadow},set:function(t){this._castShadow=t}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(t){this._receiveShadow=t}},{key:"lightmapSize",get:function(){return this._lightmapSize},set:function(t){this._lightmapSize=t}}]),t}(),k=a((N=T).prototype,"texture",[S],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),D=a(N.prototype,"uvParam",[S],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new P}}),j=a(N.prototype,"_bakeable",[S],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),F=a(N.prototype,"_castShadow",[S],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),L=a(N.prototype,"_receiveShadow",[C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),U=a(N.prototype,"_lightmapSize",[S],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),a(N.prototype,"bakeable",[u],Object.getOwnPropertyDescriptor(N.prototype,"bakeable"),N.prototype),a(N.prototype,"castShadow",[u],Object.getOwnPropertyDescriptor(N.prototype,"castShadow"),N.prototype),a(N.prototype,"receiveShadow",[u],Object.getOwnPropertyDescriptor(N.prototype,"receiveShadow"),N.prototype),a(N.prototype,"lightmapSize",[u],Object.getOwnPropertyDescriptor(N.prototype,"lightmapSize"),N.prototype),W=N))||W);t("M",(x=d("cc.MeshRenderer"),A=w(),E=y(100),H=M(),V=p(o),G=v(),q=c({group:{name:"DynamicShadowSettings",displayOrder:0}}),K=p(o),Q=v(),X=c({group:{name:"DynamicShadowSettings",displayOrder:1}}),$=p(ft),J=v(),Y=c({group:{name:"DynamicShadowSettings",displayOrder:2}}),Z=p(bt),tt=v(),et=c({group:{name:"DynamicShadowSettings",displayOrder:3}}),it=p(R),st=v(),at=B(),x(ot=A(ot=E(ot=H(ot=_((mt=_t=function(t){function i(){var e;return e=t.call(this)||this,r(e,"lightmapSettings",ht,l(e)),r(e,"_mesh",rt,l(e)),r(e,"_shadowCastingMode",lt,l(e)),r(e,"_shadowReceivingMode",dt,l(e)),r(e,"_shadowBias",ut,l(e)),r(e,"_shadowNormalBias",pt,l(e)),e._subMeshShapesWeights=[],e._modelType=void 0,e._model=null,e._morphInstance=null,r(e,"_enableMorph",ct,l(e)),e._modelType=I,e}e(i,t);var a=i.prototype;return a.onLoad=function(){this._mesh&&this._mesh.initialize(),this._validateShapeWeights()||this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow(),this._updateShadowBias(),this._updateShadowNormalBias()},a.onRestore=function(){this._updateModels(),this.enabledInHierarchy&&this._attachToScene(),this._updateCastShadow(),this._updateReceiveShadow(),this._updateShadowBias(),this._updateShadowNormalBias()},a.onEnable=function(){t.prototype.onEnable.call(this),this._model||this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow(),this._updateShadowBias(),this._updateShadowNormalBias(),this._onUpdateLocalShadowBias(),this._attachToScene()},a.onDisable=function(){this._model&&this._detachFromScene()},a.onDestroy=function(){this._model&&(n.director.root.destroyModel(this._model),this._model=null,this._models.length=0),this._morphInstance&&this._morphInstance.destroy()},a.onGeometryChanged=function(){if(this._model&&this._mesh){var t=this._mesh.struct;this._model.createBoundingShape(t.minPosition,t.maxPosition),this._model.updateWorldBound(),this._model.onGeometryChanged()}},a.getWeight=function(t,e){var i=this._subMeshShapesWeights;h(t<i.length);var s=this._subMeshShapesWeights[t];return h(e<s.length),s[e]},a.setWeights=function(t,e){var i=this._subMeshShapesWeights;e>=i.length||i[e].length===t.length&&(i[e]=t.slice(0),this._uploadSubMeshShapesWeights(e))},a.setWeight=function(t,e,i){var s=this._subMeshShapesWeights;if(!(e>=s.length)){var a=s[e];i>=a.length||(a[i]=t,this._uploadSubMeshShapesWeights(e))}},a.setInstancedAttribute=function(t,e){if(this.model)for(var i=this.model.subModels,s=0;s<i.length;s++)for(var a=i[s].instancedAttributeBlock,o=a.attributes,n=a.views,h=0;h<o.length;h++)if(o[h].name===t){n[h].set(e);break}},a._updateLightmap=function(t,e,i,s,a){this.lightmapSettings.texture=t,this.lightmapSettings.uvParam.x=e,this.lightmapSettings.uvParam.y=i,this.lightmapSettings.uvParam.z=s,this.lightmapSettings.uvParam.w=a,this._onUpdateLightingmap()},a._updateModels=function(){if(this.enabledInHierarchy){var t=this._model;if(t?(t.destroy(),t.initialize(),t.node=t.transform=this.node):this._createModel(),this._model){if(this._mesh){var e=this._mesh.struct;this._model.createBoundingShape(e.minPosition,e.maxPosition)}this._model.initLightingmap(this.lightmapSettings.texture,this.lightmapSettings.uvParam),this._updateModelParams(),this._onUpdateLightingmap(),this._onUpdateLocalShadowBias()}}},a._createModel=function(){var t=this._morphInstance&&this._modelType===I?gt:this._modelType,e=this._model=n.director.root.createModel(t);e.visFlags=this.visibility,e.node=e.transform=this.node,this._models.length=0,this._models.push(this._model),this._morphInstance&&e instanceof gt&&e.setMorphRendering(this._morphInstance)},a._attachToScene=function(){if(this.node.scene&&this._model){var t=this._getRenderScene();null!==this._model.scene&&this._detachFromScene(),t.addModel(this._model)}},a._detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},a._updateModelParams=function(){if(this._mesh&&this._model){this.node.hasChangedFlags|=m.POSITION,this._model.transform.hasChangedFlags|=m.POSITION,this._model.isDynamicBatching=this._isBatchingEnabled();var t=this._mesh?this._mesh.renderingSubMeshes.length:0,e=this._mesh.renderingSubMeshes;if(e)for(var i=0;i<t;++i){var s=this.getRenderMaterial(i);s&&!s.isValid&&(s=null);var a=e[i];a&&this._model.initSubModel(i,a,s||this._getBuiltinMaterial())}this._model.enabled=!0}},a._onUpdateLightingmap=function(){null!==this.model&&this.model.updateLightingmap(this.lightmapSettings.texture,this.lightmapSettings.uvParam),this.setInstancedAttribute("a_lightingMapUVParam",[this.lightmapSettings.uvParam.x,this.lightmapSettings.uvParam.y,this.lightmapSettings.uvParam.z,this.lightmapSettings.uvParam.w])},a._onUpdateLocalShadowBias=function(){null!==this.model&&this.model.updateLocalShadowBias(),this.setInstancedAttribute("a_localShadowBias",[this._shadowBias,this._shadowNormalBias])},a._onMaterialModified=function(t,e){this._model&&this._model.inited&&this._onRebuildPSO(t,e||this._getBuiltinMaterial())},a._onRebuildPSO=function(t,e){this._model&&this._model.inited&&(this._model.isDynamicBatching=this._isBatchingEnabled(),this._model.setSubModelMaterial(t,e),this._onUpdateLightingmap(),this._onUpdateLocalShadowBias())},a._onMeshChanged=function(){},a._clearMaterials=function(){if(this._model)for(var t=this._model.subModels,e=0;e<t.length;++e)this._onMaterialModified(e,null)},a._getBuiltinMaterial=function(){return g.get("missing-material")},a._onVisibilityChange=function(t){this._model&&(this._model.visFlags=t)},a._updateShadowBias=function(){this._model&&(this._model.shadowBias=this._shadowBias)},a._updateShadowNormalBias=function(){this._model&&(this._model.shadowNormalBias=this._shadowNormalBias)},a._updateCastShadow=function(){this._model&&(this._shadowCastingMode===ft.OFF?this._model.castShadow=!1:(h(this._shadowCastingMode===ft.ON,"ShadowCastingMode "+this._shadowCastingMode+" is not supported."),this._model.castShadow=!0))},a._updateReceiveShadow=function(){this._model&&(this._shadowReceivingMode===bt.OFF?this._model.receiveShadow=!1:this._model.receiveShadow=!0)},a._isBatchingEnabled=function(){for(var t=0;t<this._materials.length;++t){var e=this._materials[t];if(e)for(var i=0;i<e.passes.length;++i)if(e.passes[i].batchingScheme)return!0}return!1},a._watchMorphInMesh=function(){if(this._morphInstance&&(this._morphInstance.destroy(),this._morphInstance=null),this._enableMorph&&this._mesh&&this._mesh.struct.morph&&this._mesh.morphRendering){this._morphInstance=this._mesh.morphRendering.createInstance();for(var t=this._mesh.struct.primitives.length,e=0;e<t;++e)this._uploadSubMeshShapesWeights(e);this._model&&this._model instanceof gt&&this._model.setMorphRendering(this._morphInstance)}},a._initSubMeshShapesWeights=function(){var t=this._mesh;if(this._subMeshShapesWeights.length=0,t){var e=t.struct.morph;if(e){var i=e.weights;this._subMeshShapesWeights=e.subMeshMorphs.map((function(t){return t?t.weights?t.weights.slice(0):i?(h(i.length===t.targets.length),i.slice(0)):new Array(t.targets.length).fill(0):[]}))}}},a._validateShapeWeights=function(){var t=this._mesh,e=this._subMeshShapesWeights;if(!t||!t.struct.morph)return 0===e.length;var i=t.struct.morph;return i.subMeshMorphs.length===e.length&&e.every((function(t,e){var s,a,o=t.length;return(null!==(s=null===(a=i.subMeshMorphs[e])||void 0===a?void 0:a.targets.length)&&void 0!==s?s:0)===o}))},a._uploadSubMeshShapesWeights=function(t){var e;null===(e=this._morphInstance)||void 0===e||e.setWeights(t,this._subMeshShapesWeights[t])},s(i,[{key:"shadowBias",get:function(){return this._shadowBias},set:function(t){this._shadowBias=t,this._updateShadowBias(),this._onUpdateLocalShadowBias()}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(t){this._shadowNormalBias=t,this._updateShadowNormalBias(),this._onUpdateLocalShadowBias()}},{key:"shadowCastingMode",get:function(){return this._shadowCastingMode},set:function(t){this._shadowCastingMode=t,this._updateCastShadow()}},{key:"receiveShadow",get:function(){return this._shadowReceivingMode},set:function(t){this._shadowReceivingMode=t,this._updateReceiveShadow()}},{key:"mesh",get:function(){return this._mesh},set:function(t){var e=this._mesh,i=this._mesh=t;null==i||i.initialize(),this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._onMeshChanged(e),this._updateModels(),this.enabledInHierarchy&&this._attachToScene(),this._updateCastShadow(),this._updateReceiveShadow()}},{key:"model",get:function(){return this._model}},{key:"enableMorph",get:function(){return this._enableMorph},set:function(t){this._enableMorph=t}}]),i}(f),_t.ShadowCastingMode=ft,_t.ShadowReceivingMode=bt,ht=a((nt=mt).prototype,"lightmapSettings",[S,u,b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new St}}),rt=a(nt.prototype,"_mesh",[S],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lt=a(nt.prototype,"_shadowCastingMode",[S],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ft.OFF}}),dt=a(nt.prototype,"_shadowReceivingMode",[S],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bt.ON}}),ut=a(nt.prototype,"_shadowBias",[S],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),pt=a(nt.prototype,"_shadowNormalBias",[S],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),a(nt.prototype,"shadowBias",[V,G,q,b],Object.getOwnPropertyDescriptor(nt.prototype,"shadowBias"),nt.prototype),a(nt.prototype,"shadowNormalBias",[K,Q,X,b],Object.getOwnPropertyDescriptor(nt.prototype,"shadowNormalBias"),nt.prototype),a(nt.prototype,"shadowCastingMode",[$,J,Y,b],Object.getOwnPropertyDescriptor(nt.prototype,"shadowCastingMode"),nt.prototype),a(nt.prototype,"receiveShadow",[Z,tt,et,b],Object.getOwnPropertyDescriptor(nt.prototype,"receiveShadow"),nt.prototype),a(nt.prototype,"mesh",[it,st],Object.getOwnPropertyDescriptor(nt.prototype,"mesh"),nt.prototype),a(nt.prototype,"enableMorph",[at,b],Object.getOwnPropertyDescriptor(nt.prototype,"enableMorph"),nt.prototype),ct=a(nt.prototype,"_enableMorph",[S],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ot=nt))||ot)||ot)||ot)||ot)||ot))}}}));
