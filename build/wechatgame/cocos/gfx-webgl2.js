System.register(["./bits-b8bc8b22.js","./buffer-barrier-17698e09.js"],(function(e){"use strict";var t,r,s,a,i,n,u,_,l,c,f,o,R,h,E,A,S,T,g,d,B,C,p,m,x,G,P,b,F,I,O,D,M,v,L,y,U,N,w,H,X,k,V,K,W,z,Y,q,Z,j,Q,J,$,ee,te,re,se,ae,ie,ne,ue,_e,le,ce,fe,oe,Re,he,Ee,Ae,Se,Te,ge,de,Be,Ce,pe;return{setters:[function(e){t=e.F,r=e.A,s=e.f,a=e.e,i=e.t,n=e.ap,u=e.d,_=e.w,l=e.y,c=e.J,f=e.i,o=e.l},function(e){R=e.aU,h=e.aV,E=e.D,A=e.a0,S=e.aQ,T=e.ae,g=e.g,d=e.e,B=e.h,C=e.aT,p=e.aZ,m=e.l,x=e.c,G=e.L,P=e.s,b=e.G,F=e.H,I=e.j,O=e.b0,D=e.b1,M=e.a1,v=e.$,L=e.b2,y=e.m,U=e.am,N=e.T,w=e.C,H=e.t,X=e.B,k=e.I,V=e.N,K=e.a,W=e.b5,z=e.b6,Y=e.aW,q=e.b7,Z=e.b8,j=e.be,Q=e.bf,J=e.bg,$=e.bh,ee=e.bi,te=e.a7,re=e.b9,se=e.ba,ae=e.bc,ie=e.aY,ne=e.a_,ue=e.ah,_e=e.i,le=e.bj,ce=e.bt,fe=e.bu,oe=e.a6,Re=e.b4,he=e.A,Ee=e.aL,Ae=e.Q,Se=e.aK,Te=e.F,ge=e.k,de=e.bk,Be=e.bl,Ce=e.bD,pe=e.b3}],execute:function(){var me,xe=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuDescriptorSet=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){this._layout=e.layout;var t=e.layout.gpuDescriptorSetLayout,r=t.bindings,s=t.descriptorIndices,a=t.descriptorCount;this._buffers=Array(a).fill(null),this._textures=Array(a).fill(null),this._samplers=Array(a).fill(null);var i=[];this._gpuDescriptorSet={gpuDescriptors:i,descriptorIndices:s};for(var n=0;n<r.length;++n)for(var u=r[n],_=0;_<u.count;_++)i.push({type:u.descriptorType,gpuBuffer:null,gpuTextureView:null,gpuSampler:null})},a.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},a.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var e=this._gpuDescriptorSet.gpuDescriptors,t=0;t<e.length;++t)e[t].type&R?this._buffers[t]&&(e[t].gpuBuffer=this._buffers[t].gpuBuffer):e[t].type&h&&(this._textures[t]&&(e[t].gpuTextureView=this._textures[t].gpuTextureView),this._samplers[t]&&(e[t].gpuSampler=this._samplers[t].gpuSampler));this._isDirty=!1}},r(s,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),s}(E);!function(e){e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",e[e.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",e[e.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",e[e.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",e[e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",e[e.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",e[e.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",e[e.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",e[e.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(me||(me={}));var Ge=function(){function e(){}return e.setInstance=function(t){e._instance=t},r(e,null,[{key:"instance",get:function(){return e._instance}}]),e}();Ge._instance=null;var Pe=[10497,33648,33071,33071],be=new Float32Array(4);function Fe(e,t){switch(e){case x.R8:return t.UNSIGNED_BYTE;case x.R8SN:return t.BYTE;case x.R8UI:return t.UNSIGNED_BYTE;case x.R8I:return t.BYTE;case x.R16F:return t.HALF_FLOAT;case x.R16UI:return t.UNSIGNED_SHORT;case x.R16I:return t.SHORT;case x.R32F:return t.FLOAT;case x.R32UI:return t.UNSIGNED_INT;case x.R32I:return t.INT;case x.RG8:return t.UNSIGNED_BYTE;case x.RG8SN:return t.BYTE;case x.RG8UI:return t.UNSIGNED_BYTE;case x.RG8I:return t.BYTE;case x.RG16F:return t.HALF_FLOAT;case x.RG16UI:return t.UNSIGNED_SHORT;case x.RG16I:return t.SHORT;case x.RG32F:return t.FLOAT;case x.RG32UI:return t.UNSIGNED_INT;case x.RG32I:return t.INT;case x.RGB8:case x.SRGB8:return t.UNSIGNED_BYTE;case x.RGB8SN:return t.BYTE;case x.RGB8UI:return t.UNSIGNED_BYTE;case x.RGB8I:return t.BYTE;case x.RGB16F:return t.HALF_FLOAT;case x.RGB16UI:return t.UNSIGNED_SHORT;case x.RGB16I:return t.SHORT;case x.RGB32F:return t.FLOAT;case x.RGB32UI:return t.UNSIGNED_INT;case x.RGB32I:return t.INT;case x.BGRA8:case x.RGBA8:case x.SRGB8_A8:return t.UNSIGNED_BYTE;case x.RGBA8SN:return t.BYTE;case x.RGBA8UI:return t.UNSIGNED_BYTE;case x.RGBA8I:return t.BYTE;case x.RGBA16F:return t.HALF_FLOAT;case x.RGBA16UI:return t.UNSIGNED_SHORT;case x.RGBA16I:return t.SHORT;case x.RGBA32F:return t.FLOAT;case x.RGBA32UI:return t.UNSIGNED_INT;case x.RGBA32I:return t.INT;case x.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case x.R11G11B10F:return t.UNSIGNED_INT_10F_11F_11F_REV;case x.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case x.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case x.RGB10A2:case x.RGB10A2UI:return t.UNSIGNED_INT_2_10_10_10_REV;case x.RGB9E5:case x.DEPTH:return t.FLOAT;case x.DEPTH_STENCIL:return t.UNSIGNED_INT_24_8;case x.BC1:case x.BC1_SRGB:case x.BC2:case x.BC2_SRGB:case x.BC3:case x.BC3_SRGB:case x.BC4:return t.UNSIGNED_BYTE;case x.BC4_SNORM:return t.BYTE;case x.BC5:return t.UNSIGNED_BYTE;case x.BC5_SNORM:return t.BYTE;case x.BC6H_SF16:case x.BC6H_UF16:return t.FLOAT;case x.BC7:case x.BC7_SRGB:case x.ETC_RGB8:case x.ETC2_RGB8:case x.ETC2_SRGB8:case x.ETC2_RGB8_A1:case x.ETC2_SRGB8_A1:case x.EAC_R11:return t.UNSIGNED_BYTE;case x.EAC_R11SN:return t.BYTE;case x.EAC_RG11:return t.UNSIGNED_BYTE;case x.EAC_RG11SN:return t.BYTE;case x.PVRTC_RGB2:case x.PVRTC_RGBA2:case x.PVRTC_RGB4:case x.PVRTC_RGBA4:case x.PVRTC2_2BPP:case x.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case x.ASTC_RGBA_4X4:case x.ASTC_RGBA_5X4:case x.ASTC_RGBA_5X5:case x.ASTC_RGBA_6X5:case x.ASTC_RGBA_6X6:case x.ASTC_RGBA_8X5:case x.ASTC_RGBA_8X6:case x.ASTC_RGBA_8X8:case x.ASTC_RGBA_10X5:case x.ASTC_RGBA_10X6:case x.ASTC_RGBA_10X8:case x.ASTC_RGBA_10X10:case x.ASTC_RGBA_12X10:case x.ASTC_RGBA_12X12:case x.ASTC_SRGBA_4X4:case x.ASTC_SRGBA_5X4:case x.ASTC_SRGBA_5X5:case x.ASTC_SRGBA_6X5:case x.ASTC_SRGBA_6X6:case x.ASTC_SRGBA_8X5:case x.ASTC_SRGBA_8X6:case x.ASTC_SRGBA_8X8:case x.ASTC_SRGBA_10X5:case x.ASTC_SRGBA_10X6:case x.ASTC_SRGBA_10X8:case x.ASTC_SRGBA_10X10:case x.ASTC_SRGBA_12X10:case x.ASTC_SRGBA_12X12:default:return t.UNSIGNED_BYTE}}function Ie(e,t){switch(e){case N.BOOL:return t.BOOL;case N.BOOL2:return t.BOOL_VEC2;case N.BOOL3:return t.BOOL_VEC3;case N.BOOL4:return t.BOOL_VEC4;case N.INT:return t.INT;case N.INT2:return t.INT_VEC2;case N.INT3:return t.INT_VEC3;case N.INT4:return t.INT_VEC4;case N.UINT:return t.UNSIGNED_INT;case N.FLOAT:return t.FLOAT;case N.FLOAT2:return t.FLOAT_VEC2;case N.FLOAT3:return t.FLOAT_VEC3;case N.FLOAT4:return t.FLOAT_VEC4;case N.MAT2:return t.FLOAT_MAT2;case N.MAT2X3:return t.FLOAT_MAT2x3;case N.MAT2X4:return t.FLOAT_MAT2x4;case N.MAT3X2:return t.FLOAT_MAT3x2;case N.MAT3:return t.FLOAT_MAT3;case N.MAT3X4:return t.FLOAT_MAT3x4;case N.MAT4X2:return t.FLOAT_MAT4x2;case N.MAT4X3:return t.FLOAT_MAT4x3;case N.MAT4:return t.FLOAT_MAT4;case N.SAMPLER2D:return t.SAMPLER_2D;case N.SAMPLER2D_ARRAY:return t.SAMPLER_2D_ARRAY;case N.SAMPLER3D:return t.SAMPLER_3D;case N.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),N.UNKNOWN}}function Oe(e,t){switch(e){case t.BOOL:return N.BOOL;case t.BOOL_VEC2:return N.BOOL2;case t.BOOL_VEC3:return N.BOOL3;case t.BOOL_VEC4:return N.BOOL4;case t.INT:return N.INT;case t.INT_VEC2:return N.INT2;case t.INT_VEC3:return N.INT3;case t.INT_VEC4:return N.INT4;case t.UNSIGNED_INT:return N.UINT;case t.UNSIGNED_INT_VEC2:return N.UINT2;case t.UNSIGNED_INT_VEC3:return N.UINT3;case t.UNSIGNED_INT_VEC4:return N.UINT4;case t.FLOAT:return N.FLOAT;case t.FLOAT_VEC2:return N.FLOAT2;case t.FLOAT_VEC3:return N.FLOAT3;case t.FLOAT_VEC4:return N.FLOAT4;case t.FLOAT_MAT2:return N.MAT2;case t.FLOAT_MAT2x3:return N.MAT2X3;case t.FLOAT_MAT2x4:return N.MAT2X4;case t.FLOAT_MAT3x2:return N.MAT3X2;case t.FLOAT_MAT3:return N.MAT3;case t.FLOAT_MAT3x4:return N.MAT3X4;case t.FLOAT_MAT4x2:return N.MAT4X2;case t.FLOAT_MAT4x3:return N.MAT4X3;case t.FLOAT_MAT4:return N.MAT4;case t.SAMPLER_2D:return N.SAMPLER2D;case t.SAMPLER_2D_ARRAY:return N.SAMPLER2D_ARRAY;case t.SAMPLER_3D:return N.SAMPLER3D;case t.SAMPLER_CUBE:return N.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),N.UNKNOWN}}function De(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:return 4;case t.UNSIGNED_INT_VEC2:return 8;case t.UNSIGNED_INT_VEC3:return 12;case t.UNSIGNED_INT_VEC4:return 16;case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT2x3:return 24;case t.FLOAT_MAT2x4:return 32;case t.FLOAT_MAT3x2:return 24;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT3x4:return 48;case t.FLOAT_MAT4x2:return 32;case t.FLOAT_MAT4x3:return 48;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_2D_ARRAY:case t.SAMPLER_2D_ARRAY_SHADOW:case t.SAMPLER_3D:case t.SAMPLER_CUBE:case t.INT_SAMPLER_2D:case t.INT_SAMPLER_2D_ARRAY:case t.INT_SAMPLER_3D:case t.INT_SAMPLER_CUBE:case t.UNSIGNED_INT_SAMPLER_2D:case t.UNSIGNED_INT_SAMPLER_2D_ARRAY:case t.UNSIGNED_INT_SAMPLER_3D:case t.UNSIGNED_INT_SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function Me(e,t){switch(e){case t.FLOAT_MAT2:case t.FLOAT_MAT2x3:case t.FLOAT_MAT2x4:return 2;case t.FLOAT_MAT3x2:case t.FLOAT_MAT3:case t.FLOAT_MAT3x4:return 3;case t.FLOAT_MAT4x2:case t.FLOAT_MAT4x3:case t.FLOAT_MAT4:return 4;default:return 1}}var ve,Le=[512,513,514,515,516,517,518,519],ye=[0,7680,7681,7682,7683,5386,34055,34056],Ue=[32774,32778,32779,32775,32776],Ne=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.COUNT=6]="COUNT"}(ve||(ve={}));var we=function(e){this.cmdType=void 0,this.refCount=0,this.cmdType=e},He=function(e){function r(){var t;return(t=e.call(this,ve.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,t.gpuFramebuffer=null,t.renderArea=new A,t.clearColors=[],t.clearDepth=1,t.clearStencil=0,t}return t(r,e),r.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},r}(we),Xe=function(e){function r(){var t;return(t=e.call(this,ve.BIND_STATES)||this).gpuPipelineState=null,t.gpuInputAssembler=null,t.gpuDescriptorSets=[],t.dynamicOffsets=[],t.dynamicStates=new S,t}return t(r,e),r.prototype.clear=function(){this.gpuPipelineState=null,this.gpuInputAssembler=null,this.gpuDescriptorSets.length=0,this.dynamicOffsets.length=0},r}(we),ke=function(e){function r(){var t;return(t=e.call(this,ve.DRAW)||this).drawInfo=new T,t}return t(r,e),r.prototype.clear=function(){},r}(we),Ve=function(e){function r(){var t;return(t=e.call(this,ve.UPDATE_BUFFER)||this).gpuBuffer=null,t.buffer=null,t.offset=0,t.size=0,t}return t(r,e),r.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},r}(we),Ke=function(e){function r(){var t;return(t=e.call(this,ve.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,t.buffers=[],t.regions=[],t}return t(r,e),r.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},r}(we),We=function(){function e(){this.cmds=new w(1),this.beginRenderPassCmds=new w(1),this.bindStatesCmds=new w(1),this.drawCmds=new w(1),this.updateBufferCmds=new w(1),this.copyBufferToTextureCmds=new w(1)}return e.prototype.clearCmds=function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()},e}();function ze(e,t,r,s,a){if(t.usage&d.INDIRECT){t.indirects.clearDraws();for(var i=r.drawInfos,n=0;n<i.length;++n)t.indirects.setDrawInfo(s+n,i[n])}else{var u=r,_=e.gl,l=e.stateCache;switch(t.glTarget){case _.ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(_.bindVertexArray(null),l.glVAO=null),Ze.gpuInputAssembler=null,l.glArrayBuffer!==t.glBuffer&&(_.bindBuffer(_.ARRAY_BUFFER,t.glBuffer),l.glArrayBuffer=t.glBuffer),a===u.byteLength?_.bufferSubData(t.glTarget,s,u):_.bufferSubData(t.glTarget,s,u.slice(0,a));break;case _.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(_.bindVertexArray(null),l.glVAO=null),Ze.gpuInputAssembler=null,l.glElementArrayBuffer!==t.glBuffer&&(_.bindBuffer(_.ELEMENT_ARRAY_BUFFER,t.glBuffer),l.glElementArrayBuffer=t.glBuffer),a===u.byteLength?_.bufferSubData(t.glTarget,s,u):_.bufferSubData(t.glTarget,s,u.slice(0,a));break;case _.UNIFORM_BUFFER:l.glUniformBuffer!==t.glBuffer&&(_.bindBuffer(_.UNIFORM_BUFFER,t.glBuffer),l.glUniformBuffer=t.glBuffer),a===u.byteLength?_.bufferSubData(t.glTarget,s,u):_.bufferSubData(t.glTarget,s,new Float32Array(u,0,a/4));break;default:console.error("Unsupported BufferType, update buffer failed.")}}}function Ye(e,t){var r=e.gl;t.glInternalFmt=function(e,t){switch(e){case x.A8:return t.ALPHA;case x.L8:return t.LUMINANCE;case x.LA8:return t.LUMINANCE_ALPHA;case x.R8:return t.R8;case x.R8SN:return t.R8_SNORM;case x.R8UI:return t.R8UI;case x.R8I:return t.R8I;case x.RG8:return t.RG8;case x.RG8SN:return t.RG8_SNORM;case x.RG8UI:return t.RG8UI;case x.RG8I:return t.RG8I;case x.RGB8:return t.RGB8;case x.RGB8SN:return t.RGB8_SNORM;case x.RGB8UI:return t.RGB8UI;case x.RGB8I:return t.RGB8I;case x.BGRA8:case x.RGBA8:return t.RGBA8;case x.RGBA8SN:return t.RGBA8_SNORM;case x.RGBA8UI:return t.RGBA8UI;case x.RGBA8I:return t.RGBA8I;case x.R16I:return t.R16I;case x.R16UI:return t.R16UI;case x.R16F:return t.R16F;case x.RG16I:return t.RG16I;case x.RG16UI:return t.RG16UI;case x.RG16F:return t.RG16F;case x.RGB16I:return t.RGB16I;case x.RGB16UI:return t.RGB16UI;case x.RGB16F:return t.RGB16F;case x.RGBA16I:return t.RGBA16I;case x.RGBA16UI:return t.RGBA16UI;case x.RGBA16F:return t.RGBA16F;case x.R32I:return t.R32I;case x.R32UI:return t.R32UI;case x.R32F:return t.R32F;case x.RG32I:return t.RG32I;case x.RG32UI:return t.RG32UI;case x.RG32F:return t.RG32F;case x.RGB32I:return t.RGB32I;case x.RGB32UI:return t.RGB32UI;case x.RGB32F:return t.RGB32F;case x.RGBA32I:return t.RGBA32I;case x.RGBA32UI:return t.RGBA32UI;case x.RGBA32F:return t.RGBA32F;case x.R5G6B5:return t.RGB565;case x.RGB5A1:return t.RGB5_A1;case x.RGBA4:return t.RGBA4;case x.SRGB8:return t.SRGB8;case x.SRGB8_A8:return t.SRGB8_ALPHA8;case x.RGB10A2:return t.RGB10_A2;case x.RGB10A2UI:return t.RGB10_A2UI;case x.R11G11B10F:return t.R11F_G11F_B10F;case x.DEPTH:return t.DEPTH_COMPONENT32F;case x.DEPTH_STENCIL:return t.DEPTH24_STENCIL8;case x.BC1:return me.COMPRESSED_RGB_S3TC_DXT1_EXT;case x.BC1_ALPHA:return me.COMPRESSED_RGBA_S3TC_DXT1_EXT;case x.BC1_SRGB:return me.COMPRESSED_SRGB_S3TC_DXT1_EXT;case x.BC1_SRGB_ALPHA:return me.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case x.BC2:return me.COMPRESSED_RGBA_S3TC_DXT3_EXT;case x.BC2_SRGB:return me.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case x.BC3:return me.COMPRESSED_RGBA_S3TC_DXT5_EXT;case x.BC3_SRGB:return me.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case x.ETC_RGB8:return me.COMPRESSED_RGB_ETC1_WEBGL;case x.ETC2_RGB8:return me.COMPRESSED_RGB8_ETC2;case x.ETC2_SRGB8:return me.COMPRESSED_SRGB8_ETC2;case x.ETC2_RGB8_A1:return me.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case x.ETC2_SRGB8_A1:return me.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case x.ETC2_RGBA8:return me.COMPRESSED_RGBA8_ETC2_EAC;case x.ETC2_SRGB8_A8:return me.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case x.EAC_R11:return me.COMPRESSED_R11_EAC;case x.EAC_R11SN:return me.COMPRESSED_SIGNED_R11_EAC;case x.EAC_RG11:return me.COMPRESSED_RG11_EAC;case x.EAC_RG11SN:return me.COMPRESSED_SIGNED_RG11_EAC;case x.PVRTC_RGB2:return me.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case x.PVRTC_RGBA2:return me.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case x.PVRTC_RGB4:return me.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case x.PVRTC_RGBA4:return me.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case x.ASTC_RGBA_4X4:return me.COMPRESSED_RGBA_ASTC_4x4_KHR;case x.ASTC_RGBA_5X4:return me.COMPRESSED_RGBA_ASTC_5x4_KHR;case x.ASTC_RGBA_5X5:return me.COMPRESSED_RGBA_ASTC_5x5_KHR;case x.ASTC_RGBA_6X5:return me.COMPRESSED_RGBA_ASTC_6x5_KHR;case x.ASTC_RGBA_6X6:return me.COMPRESSED_RGBA_ASTC_6x6_KHR;case x.ASTC_RGBA_8X5:return me.COMPRESSED_RGBA_ASTC_8x5_KHR;case x.ASTC_RGBA_8X6:return me.COMPRESSED_RGBA_ASTC_8x6_KHR;case x.ASTC_RGBA_8X8:return me.COMPRESSED_RGBA_ASTC_8x8_KHR;case x.ASTC_RGBA_10X5:return me.COMPRESSED_RGBA_ASTC_10x5_KHR;case x.ASTC_RGBA_10X6:return me.COMPRESSED_RGBA_ASTC_10x6_KHR;case x.ASTC_RGBA_10X8:return me.COMPRESSED_RGBA_ASTC_10x8_KHR;case x.ASTC_RGBA_10X10:return me.COMPRESSED_RGBA_ASTC_10x10_KHR;case x.ASTC_RGBA_12X10:return me.COMPRESSED_RGBA_ASTC_12x10_KHR;case x.ASTC_RGBA_12X12:return me.COMPRESSED_RGBA_ASTC_12x12_KHR;case x.ASTC_SRGBA_4X4:return me.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case x.ASTC_SRGBA_5X4:return me.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case x.ASTC_SRGBA_5X5:return me.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case x.ASTC_SRGBA_6X5:return me.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case x.ASTC_SRGBA_6X6:return me.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case x.ASTC_SRGBA_8X5:return me.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case x.ASTC_SRGBA_8X6:return me.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case x.ASTC_SRGBA_8X8:return me.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case x.ASTC_SRGBA_10X5:return me.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case x.ASTC_SRGBA_10X6:return me.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case x.ASTC_SRGBA_10X8:return me.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case x.ASTC_SRGBA_10X10:return me.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case x.ASTC_SRGBA_12X10:return me.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case x.ASTC_SRGBA_12X12:return me.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),t.RGBA}}(t.format,r),t.glFormat=function(e,t){switch(e){case x.A8:return t.ALPHA;case x.L8:return t.LUMINANCE;case x.LA8:return t.LUMINANCE_ALPHA;case x.R8:case x.R8SN:return t.RED;case x.R8UI:case x.R8I:return t.RED;case x.RG8:case x.RG8SN:case x.RG8UI:case x.RG8I:return t.RG;case x.RGB8:case x.RGB8SN:case x.RGB8UI:case x.RGB8I:return t.RGB;case x.BGRA8:case x.RGBA8:case x.RGBA8SN:case x.RGBA8UI:case x.RGBA8I:return t.RGBA;case x.R16UI:case x.R16I:case x.R16F:return t.RED;case x.RG16UI:case x.RG16I:case x.RG16F:return t.RG;case x.RGB16UI:case x.RGB16I:case x.RGB16F:return t.RGB;case x.RGBA16UI:case x.RGBA16I:case x.RGBA16F:return t.RGBA;case x.R32UI:case x.R32I:case x.R32F:return t.RED;case x.RG32UI:case x.RG32I:case x.RG32F:return t.RG;case x.RGB32UI:case x.RGB32I:case x.RGB32F:return t.RGB;case x.RGBA32UI:case x.RGBA32I:case x.RGBA32F:case x.RGB10A2:return t.RGBA;case x.R11G11B10F:case x.R5G6B5:return t.RGB;case x.RGB5A1:case x.RGBA4:return t.RGBA;case x.SRGB8:return t.RGB;case x.SRGB8_A8:return t.RGBA;case x.DEPTH:return t.DEPTH_COMPONENT;case x.DEPTH_STENCIL:return t.DEPTH_STENCIL;case x.BC1:return me.COMPRESSED_RGB_S3TC_DXT1_EXT;case x.BC1_ALPHA:return me.COMPRESSED_RGBA_S3TC_DXT1_EXT;case x.BC1_SRGB:return me.COMPRESSED_SRGB_S3TC_DXT1_EXT;case x.BC1_SRGB_ALPHA:return me.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case x.BC2:return me.COMPRESSED_RGBA_S3TC_DXT3_EXT;case x.BC2_SRGB:return me.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case x.BC3:return me.COMPRESSED_RGBA_S3TC_DXT5_EXT;case x.BC3_SRGB:return me.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case x.ETC_RGB8:return me.COMPRESSED_RGB_ETC1_WEBGL;case x.ETC2_RGB8:return me.COMPRESSED_RGB8_ETC2;case x.ETC2_SRGB8:return me.COMPRESSED_SRGB8_ETC2;case x.ETC2_RGB8_A1:return me.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case x.ETC2_SRGB8_A1:return me.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case x.ETC2_RGBA8:return me.COMPRESSED_RGBA8_ETC2_EAC;case x.ETC2_SRGB8_A8:return me.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case x.EAC_R11:return me.COMPRESSED_R11_EAC;case x.EAC_R11SN:return me.COMPRESSED_SIGNED_R11_EAC;case x.EAC_RG11:return me.COMPRESSED_RG11_EAC;case x.EAC_RG11SN:return me.COMPRESSED_SIGNED_RG11_EAC;case x.PVRTC_RGB2:return me.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case x.PVRTC_RGBA2:return me.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case x.PVRTC_RGB4:return me.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case x.PVRTC_RGBA4:return me.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case x.ASTC_RGBA_4X4:return me.COMPRESSED_RGBA_ASTC_4x4_KHR;case x.ASTC_RGBA_5X4:return me.COMPRESSED_RGBA_ASTC_5x4_KHR;case x.ASTC_RGBA_5X5:return me.COMPRESSED_RGBA_ASTC_5x5_KHR;case x.ASTC_RGBA_6X5:return me.COMPRESSED_RGBA_ASTC_6x5_KHR;case x.ASTC_RGBA_6X6:return me.COMPRESSED_RGBA_ASTC_6x6_KHR;case x.ASTC_RGBA_8X5:return me.COMPRESSED_RGBA_ASTC_8x5_KHR;case x.ASTC_RGBA_8X6:return me.COMPRESSED_RGBA_ASTC_8x6_KHR;case x.ASTC_RGBA_8X8:return me.COMPRESSED_RGBA_ASTC_8x8_KHR;case x.ASTC_RGBA_10X5:return me.COMPRESSED_RGBA_ASTC_10x5_KHR;case x.ASTC_RGBA_10X6:return me.COMPRESSED_RGBA_ASTC_10x6_KHR;case x.ASTC_RGBA_10X8:return me.COMPRESSED_RGBA_ASTC_10x8_KHR;case x.ASTC_RGBA_10X10:return me.COMPRESSED_RGBA_ASTC_10x10_KHR;case x.ASTC_RGBA_12X10:return me.COMPRESSED_RGBA_ASTC_12x10_KHR;case x.ASTC_RGBA_12X12:return me.COMPRESSED_RGBA_ASTC_12x12_KHR;case x.ASTC_SRGBA_4X4:return me.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case x.ASTC_SRGBA_5X4:return me.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case x.ASTC_SRGBA_5X5:return me.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case x.ASTC_SRGBA_6X5:return me.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case x.ASTC_SRGBA_6X6:return me.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case x.ASTC_SRGBA_8X5:return me.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case x.ASTC_SRGBA_8X6:return me.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case x.ASTC_SRGBA_8X8:return me.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case x.ASTC_SRGBA_10X5:return me.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case x.ASTC_SRGBA_10X6:return me.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case x.ASTC_SRGBA_10X8:return me.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case x.ASTC_SRGBA_10X10:return me.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case x.ASTC_SRGBA_12X10:return me.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case x.ASTC_SRGBA_12X12:return me.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),t.RGBA}}(t.format,r),t.glType=Fe(t.format,r);var a=t.width,i=t.height;switch(t.type){case B.TEX2D:if(t.glTarget=r.TEXTURE_2D,t.isSwapchainTexture)break;var n=Math.max(a,i);if(n>e.capabilities.maxTextureSize&&s(9100,n,e.capabilities.maxTextureSize),t.samples===m.ONE){if(t.glTexture=r.createTexture(),t.size>0){var u=e.stateCache.glTexUnits[e.stateCache.texUnit];if(u.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_2D,t.glTexture),u.glTexture=t.glTexture),C[t.format].isCompressed)for(var _=0;_<t.mipLevel;++_){var l=p(t.format,a,i,1),c=new Uint8Array(l);r.compressedTexImage2D(r.TEXTURE_2D,_,t.glInternalFmt,a,i,0,c),a=Math.max(1,a>>1),i=Math.max(1,i>>1)}else r.texStorage2D(r.TEXTURE_2D,t.mipLevel,t.glInternalFmt,a,i)}}else t.glRenderbuffer=r.createRenderbuffer(),t.size>0&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(r.bindRenderbuffer(r.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),r.renderbufferStorageMultisample(r.RENDERBUFFER,t.samples,t.glInternalFmt,t.width,t.height));break;case B.CUBE:t.glTarget=r.TEXTURE_CUBE_MAP;var f=Math.max(a,i);if(f>e.capabilities.maxCubeMapTextureSize&&s(9100,f,e.capabilities.maxTextureSize),t.glTexture=r.createTexture(),t.size>0){var o=e.stateCache.glTexUnits[e.stateCache.texUnit];if(o.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_CUBE_MAP,t.glTexture),o.glTexture=t.glTexture),C[t.format].isCompressed)for(var R=0;R<t.mipLevel;++R){for(var h=p(t.format,a,i,1),E=new Uint8Array(h),A=0;A<6;++A)r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+A,R,t.glInternalFmt,a,i,0,E);a=Math.max(1,a>>1),i=Math.max(1,i>>1)}else r.texStorage2D(r.TEXTURE_CUBE_MAP,t.mipLevel,t.glInternalFmt,a,i)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=B.TEX2D,t.glTarget=r.TEXTURE_2D}}function qe(e,t){var r=e.gl;if(t.glTexture){var s=e.stateCache.glTexUnits,a=e.stateCache.texUnit;r.deleteTexture(t.glTexture);for(var i=0;i<s.length;++i)s[i].glTexture===t.glTexture&&(r.activeTexture(r.TEXTURE0+i),a=i,r.bindTexture(t.glTarget,null),s[i].glTexture=null);e.stateCache.texUnit=a,t.glTexture=null}if(t.glRenderbuffer){var n=e.stateCache.glRenderbuffer;r.deleteRenderbuffer(t.glRenderbuffer),n===t.glRenderbuffer&&(r.bindRenderbuffer(r.RENDERBUFFER,null),n=null),t.glRenderbuffer=null}}var Ze={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0,invalidateAttachments:[]};function je(e,t,r,s,a,i,n){var u=e.gl,_=e.stateCache,l=0;if(r&&t){_.glFramebuffer!==r.glFramebuffer&&(u.bindFramebuffer(u.FRAMEBUFFER,r.glFramebuffer),_.glFramebuffer=r.glFramebuffer),_.viewport.left===s.x&&_.viewport.top===s.y&&_.viewport.width===s.width&&_.viewport.height===s.height||(u.viewport(s.x,s.y,s.width,s.height),_.viewport.left=s.x,_.viewport.top=s.y,_.viewport.width=s.width,_.viewport.height=s.height),_.scissorRect.x===s.x&&_.scissorRect.y===s.y&&_.scissorRect.width===s.width&&_.scissorRect.height===s.height||(u.scissor(s.x,s.y,s.width,s.height),_.scissorRect.x=s.x,_.scissorRect.y=s.y,_.scissorRect.width=s.width,_.scissorRect.height=s.height),Ze.invalidateAttachments.length=0;for(var c=0;c<a.length;++c){var f=t.colorAttachments[c];if(f.format!==x.UNKNOWN)switch(f.loadOp){case G.LOAD:break;case G.CLEAR:if(_.bs.targets[0].blendColorMask!==P.ALL&&u.colorMask(!0,!0,!0,!0),r.isOffscreen)be[0]=a[c].x,be[1]=a[c].y,be[2]=a[c].z,be[3]=a[c].w,u.clearBufferfv(u.COLOR,c,be);else{var o=a[0];u.clearColor(o.x,o.y,o.z,o.w),l|=u.COLOR_BUFFER_BIT}break;case G.DISCARD:Ze.invalidateAttachments.push(u.COLOR_ATTACHMENT0+c)}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==x.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case G.LOAD:break;case G.CLEAR:_.dss.depthWrite||u.depthMask(!0),u.clearDepth(i),l|=u.DEPTH_BUFFER_BIT;break;case G.DISCARD:Ze.invalidateAttachments.push(u.DEPTH_ATTACHMENT)}if(C[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case G.LOAD:break;case G.CLEAR:_.dss.stencilWriteMaskFront||u.stencilMaskSeparate(u.FRONT,65535),_.dss.stencilWriteMaskBack||u.stencilMaskSeparate(u.BACK,65535),u.clearStencil(n),l|=u.STENCIL_BUFFER_BIT;break;case G.DISCARD:Ze.invalidateAttachments.push(u.STENCIL_ATTACHMENT)}}if(r.glFramebuffer&&Ze.invalidateAttachments.length&&u.invalidateFramebuffer(u.FRAMEBUFFER,Ze.invalidateAttachments),l&&u.clear(l),l&u.COLOR_BUFFER_BIT){var R=_.bs.targets[0].blendColorMask;if(R!==P.ALL){var h=(R&P.R)!==P.NONE,E=(R&P.G)!==P.NONE,A=(R&P.B)!==P.NONE,S=(R&P.A)!==P.NONE;u.colorMask(h,E,A,S)}}l&u.DEPTH_BUFFER_BIT&&!_.dss.depthWrite&&u.depthMask(!1),l&u.STENCIL_BUFFER_BIT&&(_.dss.stencilWriteMaskFront||u.stencilMaskSeparate(u.FRONT,0),_.dss.stencilWriteMaskBack||u.stencilMaskSeparate(u.BACK,0))}}function Qe(e,t,r,s,i,n){var u=e.gl,_=e.stateCache,l=t&&t.gpuShader,c=!1;if(t&&Ze.gpuPipelineState!==t){if(Ze.gpuPipelineState=t,Ze.glPrimitive=t.glPrimitive,l){var f=l.glProgram;_.glProgram!==f&&(u.useProgram(f),_.glProgram=f,c=!0)}var o=t.rs;if(o){if(_.rs.cullMode!==o.cullMode){switch(o.cullMode){case b.NONE:u.disable(u.CULL_FACE);break;case b.FRONT:u.enable(u.CULL_FACE),u.cullFace(u.FRONT);break;case b.BACK:u.enable(u.CULL_FACE),u.cullFace(u.BACK)}e.stateCache.rs.cullMode=o.cullMode}var R=o.isFrontFaceCCW;e.stateCache.rs.isFrontFaceCCW!==R&&(u.frontFace(R?u.CCW:u.CW),e.stateCache.rs.isFrontFaceCCW=R),e.stateCache.rs.depthBias===o.depthBias&&e.stateCache.rs.depthBiasSlop===o.depthBiasSlop||(u.polygonOffset(o.depthBias,o.depthBiasSlop),e.stateCache.rs.depthBias=o.depthBias,e.stateCache.rs.depthBiasSlop=o.depthBiasSlop),e.stateCache.rs.lineWidth!==o.lineWidth&&(u.lineWidth(o.lineWidth),e.stateCache.rs.lineWidth=o.lineWidth)}var h=t.dss;h&&(_.dss.depthTest!==h.depthTest&&(h.depthTest?u.enable(u.DEPTH_TEST):u.disable(u.DEPTH_TEST),_.dss.depthTest=h.depthTest),_.dss.depthWrite!==h.depthWrite&&(u.depthMask(h.depthWrite),_.dss.depthWrite=h.depthWrite),_.dss.depthFunc!==h.depthFunc&&(u.depthFunc(Le[h.depthFunc]),_.dss.depthFunc=h.depthFunc),_.dss.stencilTestFront===h.stencilTestFront&&_.dss.stencilTestBack===h.stencilTestBack||(h.stencilTestFront||h.stencilTestBack?u.enable(u.STENCIL_TEST):u.disable(u.STENCIL_TEST),_.dss.stencilTestFront=h.stencilTestFront,_.dss.stencilTestBack=h.stencilTestBack),_.dss.stencilFuncFront===h.stencilFuncFront&&_.dss.stencilRefFront===h.stencilRefFront&&_.dss.stencilReadMaskFront===h.stencilReadMaskFront||(u.stencilFuncSeparate(u.FRONT,Le[h.stencilFuncFront],h.stencilRefFront,h.stencilReadMaskFront),_.dss.stencilFuncFront=h.stencilFuncFront,_.dss.stencilRefFront=h.stencilRefFront,_.dss.stencilReadMaskFront=h.stencilReadMaskFront),_.dss.stencilFailOpFront===h.stencilFailOpFront&&_.dss.stencilZFailOpFront===h.stencilZFailOpFront&&_.dss.stencilPassOpFront===h.stencilPassOpFront||(u.stencilOpSeparate(u.FRONT,ye[h.stencilFailOpFront],ye[h.stencilZFailOpFront],ye[h.stencilPassOpFront]),_.dss.stencilFailOpFront=h.stencilFailOpFront,_.dss.stencilZFailOpFront=h.stencilZFailOpFront,_.dss.stencilPassOpFront=h.stencilPassOpFront),_.dss.stencilWriteMaskFront!==h.stencilWriteMaskFront&&(u.stencilMaskSeparate(u.FRONT,h.stencilWriteMaskFront),_.dss.stencilWriteMaskFront=h.stencilWriteMaskFront),_.dss.stencilFuncBack===h.stencilFuncBack&&_.dss.stencilRefBack===h.stencilRefBack&&_.dss.stencilReadMaskBack===h.stencilReadMaskBack||(u.stencilFuncSeparate(u.BACK,Le[h.stencilFuncBack],h.stencilRefBack,h.stencilReadMaskBack),_.dss.stencilFuncBack=h.stencilFuncBack,_.dss.stencilRefBack=h.stencilRefBack,_.dss.stencilReadMaskBack=h.stencilReadMaskBack),_.dss.stencilFailOpBack===h.stencilFailOpBack&&_.dss.stencilZFailOpBack===h.stencilZFailOpBack&&_.dss.stencilPassOpBack===h.stencilPassOpBack||(u.stencilOpSeparate(u.BACK,ye[h.stencilFailOpBack],ye[h.stencilZFailOpBack],ye[h.stencilPassOpBack]),_.dss.stencilFailOpBack=h.stencilFailOpBack,_.dss.stencilZFailOpBack=h.stencilZFailOpBack,_.dss.stencilPassOpBack=h.stencilPassOpBack),_.dss.stencilWriteMaskBack!==h.stencilWriteMaskBack&&(u.stencilMaskSeparate(u.BACK,h.stencilWriteMaskBack),_.dss.stencilWriteMaskBack=h.stencilWriteMaskBack));var E=t.bs;if(E){_.bs.isA2C!==E.isA2C&&(E.isA2C?u.enable(u.SAMPLE_ALPHA_TO_COVERAGE):u.disable(u.SAMPLE_ALPHA_TO_COVERAGE),_.bs.isA2C=E.isA2C),_.bs.blendColor.x===E.blendColor.x&&_.bs.blendColor.y===E.blendColor.y&&_.bs.blendColor.z===E.blendColor.z&&_.bs.blendColor.w===E.blendColor.w||(u.blendColor(E.blendColor.x,E.blendColor.y,E.blendColor.z,E.blendColor.w),_.bs.blendColor.x=E.blendColor.x,_.bs.blendColor.y=E.blendColor.y,_.bs.blendColor.z=E.blendColor.z,_.bs.blendColor.w=E.blendColor.w);var A=E.targets[0],S=_.bs.targets[0];S.blend!==A.blend&&(A.blend?u.enable(u.BLEND):u.disable(u.BLEND),S.blend=A.blend),S.blendEq===A.blendEq&&S.blendAlphaEq===A.blendAlphaEq||(u.blendEquationSeparate(Ue[A.blendEq],Ue[A.blendAlphaEq]),S.blendEq=A.blendEq,S.blendAlphaEq=A.blendAlphaEq),S.blendSrc===A.blendSrc&&S.blendDst===A.blendDst&&S.blendSrcAlpha===A.blendSrcAlpha&&S.blendDstAlpha===A.blendDstAlpha||(u.blendFuncSeparate(Ne[A.blendSrc],Ne[A.blendDst],Ne[A.blendSrcAlpha],Ne[A.blendDstAlpha]),S.blendSrc=A.blendSrc,S.blendDst=A.blendDst,S.blendSrcAlpha=A.blendSrcAlpha,S.blendDstAlpha=A.blendDstAlpha),S.blendColorMask!==A.blendColorMask&&(u.colorMask((A.blendColorMask&P.R)!==P.NONE,(A.blendColorMask&P.G)!==P.NONE,(A.blendColorMask&P.B)!==P.NONE,(A.blendColorMask&P.A)!==P.NONE),S.blendColorMask=A.blendColorMask)}}if(t&&t.gpuPipelineLayout&&l){for(var T=l.glBlocks.length,g=t.gpuPipelineLayout.dynamicOffsetIndices,d=0;d<T;d++){var B=l.glBlocks[d],C=s[B.set],p=C&&C.descriptorIndices[B.binding],m=p>=0&&C.gpuDescriptors[p];if(m&&m.gpuBuffer){var x=g[B.set],G=x&&x[B.binding],I=m.gpuBuffer.glOffset;G>=0&&(I+=i[G]),_.glBindUBOs[B.glBinding]===m.gpuBuffer.glBuffer&&_.glBindUBOOffsets[B.glBinding]===I||(I?u.bindBufferRange(u.UNIFORM_BUFFER,B.glBinding,m.gpuBuffer.glBuffer,I,m.gpuBuffer.size):u.bindBufferBase(u.UNIFORM_BUFFER,B.glBinding,m.gpuBuffer.glBuffer),_.glUniformBuffer=_.glBindUBOs[B.glBinding]=m.gpuBuffer.glBuffer,_.glBindUBOOffsets[B.glBinding]=I)}else a("Buffer binding '"+B.name+"' at set "+B.set+" binding "+B.binding+" is not bounded")}for(var O=l.glSamplerTextures.length,D=0;D<O;D++)for(var M=l.glSamplerTextures[D],v=s[M.set],L=v&&v.descriptorIndices[M.binding],y=L>=0&&v.gpuDescriptors[L],U=0;U<M.units.length;U++){var N=M.units[U],w=_.glTexUnits[N];if(y&&y.gpuTextureView&&y.gpuTextureView.gpuTexture&&y.gpuSampler){var H=y.gpuTextureView,X=H.gpuTexture,k=H.baseLevel,V=k+H.levelCount;if(X.size>0){w.glTexture!==X.glTexture&&(_.texUnit!==N&&(u.activeTexture(u.TEXTURE0+N),_.texUnit=N),X.glTexture?u.bindTexture(X.glTarget,X.glTexture):u.bindTexture(X.glTarget,e.nullTex2D.gpuTexture.glTexture),w.glTexture=X.glTexture);var K=y.gpuSampler.getGLSampler(e,k,V);_.glSamplerUnits[N]!==K&&(u.bindSampler(N,K),_.glSamplerUnits[N]=K)}y=v.gpuDescriptors[++L]}else a("Sampler binding '"+M.name+"' at set "+M.set+" binding "+M.binding+" index "+U+" is not bounded")}}if(r&&l&&(c||Ze.gpuInputAssembler!==r))if(Ze.gpuInputAssembler=r,e.extensions.useVAO){var W=r.glVAOs.get(l.glProgram);if(!W){var z;W=u.createVertexArray(),r.glVAOs.set(l.glProgram,W),u.bindVertexArray(W),u.bindBuffer(u.ARRAY_BUFFER,null),u.bindBuffer(u.ELEMENT_ARRAY_BUFFER,null),_.glArrayBuffer=null,_.glElementArrayBuffer=null;for(var Y=0;Y<l.glInputs.length;Y++){var q=l.glInputs[Y];z=null;for(var Z=0;Z<r.glAttribs.length;Z++){var j=r.glAttribs[Z];if(j.name===q.name){z=j;break}}if(z){_.glArrayBuffer!==z.glBuffer&&(u.bindBuffer(u.ARRAY_BUFFER,z.glBuffer),_.glArrayBuffer=z.glBuffer);for(var Q=0;Q<z.componentCount;++Q){var J=q.glLoc+Q,$=z.offset+z.size*Q;u.enableVertexAttribArray(J),_.glCurrentAttribLocs[J]=!0,u.vertexAttribPointer(J,z.count,z.glType,z.isNormalized,z.stride,$),u.vertexAttribDivisor(J,z.isInstanced?1:0)}}}var ee=r.gpuIndexBuffer;ee&&u.bindBuffer(u.ELEMENT_ARRAY_BUFFER,ee.glBuffer),u.bindVertexArray(null),u.bindBuffer(u.ARRAY_BUFFER,null),u.bindBuffer(u.ELEMENT_ARRAY_BUFFER,null),_.glArrayBuffer=null,_.glElementArrayBuffer=null}_.glVAO!==W&&(u.bindVertexArray(W),_.glVAO=W)}else{for(var te=0;te<e.capabilities.maxVertexAttributes;++te)_.glCurrentAttribLocs[te]=!1;for(var re=0;re<l.glInputs.length;re++){for(var se=l.glInputs[re],ae=null,ie=0;ie<r.glAttribs.length;ie++){var ne=r.glAttribs[ie];if(ne.name===se.name){ae=ne;break}}if(ae){_.glArrayBuffer!==ae.glBuffer&&(u.bindBuffer(u.ARRAY_BUFFER,ae.glBuffer),_.glArrayBuffer=ae.glBuffer);for(var ue=0;ue<ae.componentCount;++ue){var _e=se.glLoc+ue,le=ae.offset+ae.size*ue;!_.glEnabledAttribLocs[_e]&&_e>=0&&(u.enableVertexAttribArray(_e),_.glEnabledAttribLocs[_e]=!0),_.glCurrentAttribLocs[_e]=!0,u.vertexAttribPointer(_e,ae.count,ae.glType,ae.isNormalized,ae.stride,le),u.vertexAttribDivisor(_e,ae.isInstanced?1:0)}}}var ce=r.gpuIndexBuffer;ce&&_.glElementArrayBuffer!==ce.glBuffer&&(u.bindBuffer(u.ELEMENT_ARRAY_BUFFER,ce.glBuffer),_.glElementArrayBuffer=ce.glBuffer);for(var fe=0;fe<e.capabilities.maxVertexAttributes;++fe)_.glEnabledAttribLocs[fe]!==_.glCurrentAttribLocs[fe]&&(u.disableVertexAttribArray(fe),_.glEnabledAttribLocs[fe]=!1)}if(t&&t.dynamicStates.length)for(var oe=t.dynamicStates.length,Re=0;Re<oe;Re++)switch(t.dynamicStates[Re]){case F.LINE_WIDTH:_.rs.lineWidth!==n.lineWidth&&(u.lineWidth(n.lineWidth),_.rs.lineWidth=n.lineWidth);break;case F.DEPTH_BIAS:_.rs.depthBias===n.depthBiasConstant&&_.rs.depthBiasSlop===n.depthBiasSlope||(u.polygonOffset(n.depthBiasConstant,n.depthBiasSlope),_.rs.depthBias=n.depthBiasConstant,_.rs.depthBiasSlop=n.depthBiasSlope);break;case F.BLEND_CONSTANTS:var he=n.blendConstant;_.bs.blendColor.x===he.x&&_.bs.blendColor.y===he.y&&_.bs.blendColor.z===he.z&&_.bs.blendColor.w===he.w||(u.blendColor(he.x,he.y,he.z,he.w),_.bs.blendColor.copy(he));break;case F.STENCIL_WRITE_MASK:var Ee=n.stencilStatesFront,Ae=n.stencilStatesBack;_.dss.stencilWriteMaskFront!==Ee.writeMask&&(u.stencilMaskSeparate(u.FRONT,Ee.writeMask),_.dss.stencilWriteMaskFront=Ee.writeMask),_.dss.stencilWriteMaskBack!==Ae.writeMask&&(u.stencilMaskSeparate(u.BACK,Ae.writeMask),_.dss.stencilWriteMaskBack=Ae.writeMask);break;case F.STENCIL_COMPARE_MASK:var Se=n.stencilStatesFront,Te=n.stencilStatesBack;_.dss.stencilRefFront===Se.reference&&_.dss.stencilReadMaskFront===Se.compareMask||(u.stencilFuncSeparate(u.FRONT,Le[_.dss.stencilFuncFront],Se.reference,Se.compareMask),_.dss.stencilRefFront=Se.reference,_.dss.stencilReadMaskFront=Se.compareMask),_.dss.stencilRefBack===Te.reference&&_.dss.stencilReadMaskBack===Te.compareMask||(u.stencilFuncSeparate(u.BACK,Le[_.dss.stencilFuncBack],Te.reference,Te.compareMask),_.dss.stencilRefBack=Te.reference,_.dss.stencilReadMaskBack=Te.compareMask)}}function Je(e,t){var r=e.gl,s=Ze.gpuInputAssembler,a=Ze.glPrimitive,i=e.extensions.WEBGL_multi_draw;if(s){var n=s.gpuIndexBuffer;if(s.gpuIndirectBuffer){var u=s.gpuIndirectBuffer.indirects;if(u.drawByIndex){for(var _=0;_<u.drawCount;_++)u.byteOffsets[_]=u.offsets[_]*n.stride;if(i)u.instancedDraw?i.multiDrawElementsInstancedWEBGL(a,u.counts,0,s.glIndexType,u.byteOffsets,0,u.instances,0,u.drawCount):i.multiDrawElementsWEBGL(a,u.counts,0,s.glIndexType,u.byteOffsets,0,u.drawCount);else for(var l=0;l<u.drawCount;l++)u.instances[l]?r.drawElementsInstanced(a,u.counts[l],s.glIndexType,u.byteOffsets[l],u.instances[l]):r.drawElements(a,u.counts[l],s.glIndexType,u.byteOffsets[l])}else if(i)u.instancedDraw?i.multiDrawArraysInstancedWEBGL(a,u.offsets,0,u.counts,0,u.instances,0,u.drawCount):i.multiDrawArraysWEBGL(a,u.offsets,0,u.counts,0,u.drawCount);else for(var c=0;c<u.drawCount;c++)u.instances[c]?r.drawArraysInstanced(a,u.offsets[c],u.counts[c],u.instances[c]):r.drawArrays(a,u.offsets[c],u.counts[c])}else if(t.instanceCount)if(n){if(t.indexCount>0){var f=t.firstIndex*n.stride;r.drawElementsInstanced(a,t.indexCount,s.glIndexType,f,t.instanceCount)}}else t.vertexCount>0&&r.drawArraysInstanced(a,t.firstVertex,t.vertexCount,t.instanceCount);else if(n){if(t.indexCount>0){var o=t.firstIndex*n.stride;r.drawElements(a,t.indexCount,s.glIndexType,o)}}else t.vertexCount>0&&r.drawArrays(a,t.firstVertex,t.vertexCount)}}var $e=new Array(ve.COUNT);function et(e,t){$e.fill(0);for(var r=0;r<t.cmds.length;++r){var s=t.cmds.array[r],a=$e[s]++;switch(s){case ve.BEGIN_RENDER_PASS:var i=t.beginRenderPassCmds.array[a];je(e,i.gpuRenderPass,i.gpuFramebuffer,i.renderArea,i.clearColors,i.clearDepth,i.clearStencil);break;case ve.BIND_STATES:var n=t.bindStatesCmds.array[a];Qe(e,n.gpuPipelineState,n.gpuInputAssembler,n.gpuDescriptorSets,n.dynamicOffsets,n.dynamicStates);break;case ve.DRAW:Je(e,t.drawCmds.array[a].drawInfo);break;case ve.UPDATE_BUFFER:var u=t.updateBufferCmds.array[a];ze(e,u.gpuBuffer,u.buffer,u.offset,u.size);break;case ve.COPY_BUFFER_TO_TEXTURE:var _=t.copyBufferToTextureCmds.array[a];st(e,_.buffers,_.gpuTexture,_.regions)}}}var tt=new Uint8Array(1);function rt(e,t,r,s,a){var i=D(t).height,n=p(t,a.width,a.height,a.depth),u=p(t,s.width,1,1),_=p(t,s.width,s.height,1),l=p(t,a.width,1,1),c=O(C[t]);tt.byteLength<n&&(tt=new Uint8Array(n));for(var f=0,o=r,R=0;R<a.depth;R++){o=r+_*R;for(var h=0;h<a.height;h+=i)tt.subarray(f,f+l).set(new Uint8Array(e.buffer,e.byteOffset+o,l)),f+=l,o+=u}return new c(tt.buffer)}function st(e,t,r,s){var a=e.gl,i=e.stateCache.glTexUnits[e.stateCache.texUnit];i.glTexture!==r.glTexture&&(a.bindTexture(r.glTarget,r.glTexture),i.glTexture=r.glTexture);var n=0,u=0,_=C[r.format],l=O(_),c=_.isCompressed,f=D(r.format),o=new M,R=new v,h=new M;switch(r.glTarget){case a.TEXTURE_2D:for(var E=0;E<s.length;E++){var A=s[E],S=A.texSubres.mipLevel;R.x=0===A.texOffset.x?0:L(A.texOffset.x,f.width),R.y=0===A.texOffset.y?0:L(A.texOffset.y,f.height),o.width=A.texExtent.width<f.width?A.texExtent.width:L(A.texExtent.width,f.width),o.height=A.texExtent.height<f.height?A.texExtent.width:L(A.texExtent.height,f.height),h.width=A.buffStride>0?A.buffStride:o.width,h.height=A.buffTexHeight>0?A.buffTexHeight:o.height;var T,g=A.texExtent.width+R.x===r.width>>S?A.texExtent.width:o.width,d=A.texExtent.height+R.y===r.height>>S?A.texExtent.height:o.height,B=t[n++];T=h.width===o.width&&h.height===o.height?new l(B.buffer,B.byteOffset+A.buffOffset):rt(B,r.format,A.buffOffset,h,o),c?r.glInternalFmt!==me.COMPRESSED_RGB_ETC1_WEBGL?a.compressedTexSubImage2D(a.TEXTURE_2D,S,R.x,R.y,g,d,r.glFormat,T):a.compressedTexImage2D(a.TEXTURE_2D,S,r.glInternalFmt,g,d,0,T):a.texSubImage2D(a.TEXTURE_2D,S,R.x,R.y,g,d,r.glFormat,r.glType,T)}break;case a.TEXTURE_2D_ARRAY:for(var p=0;p<s.length;p++){var m=s[p],x=m.texSubres.mipLevel;R.x=0===m.texOffset.x?0:L(m.texOffset.x,f.width),R.y=0===m.texOffset.y?0:L(m.texOffset.y,f.height),o.width=m.texExtent.width<f.width?m.texExtent.width:L(m.texExtent.width,f.width),o.height=m.texExtent.height<f.height?m.texExtent.width:L(m.texExtent.height,f.height),o.depth=1,h.width=m.buffStride>0?m.buffStride:o.width,h.height=m.buffTexHeight>0?m.buffTexHeight:o.height;var G=m.texExtent.width+R.x===r.width>>x?m.texExtent.width:o.width,P=m.texExtent.height+R.y===r.height>>x?m.texExtent.height:o.height,b=m.texSubres.baseArrayLayer+m.texSubres.layerCount;for(u=m.texSubres.baseArrayLayer;u<b;++u){R.z=u;var F,y=t[n++];F=h.width===o.width&&h.height===o.height?new l(y.buffer,y.byteOffset+m.buffOffset):rt(y,r.format,m.buffOffset,h,o),c?r.glInternalFmt!==me.COMPRESSED_RGB_ETC1_WEBGL?a.compressedTexSubImage3D(a.TEXTURE_2D_ARRAY,x,R.x,R.y,R.z,G,P,o.depth,r.glFormat,F):a.compressedTexImage3D(a.TEXTURE_2D_ARRAY,x,r.glInternalFmt,G,P,o.depth,0,F):a.texSubImage3D(a.TEXTURE_2D_ARRAY,x,R.x,R.y,R.z,G,P,o.depth,r.glFormat,r.glType,F)}}break;case a.TEXTURE_3D:for(var U=0;U<s.length;U++){var N=s[U],w=N.texSubres.mipLevel;R.x=0===N.texOffset.x?0:L(N.texOffset.x,f.width),R.y=0===N.texOffset.y?0:L(N.texOffset.y,f.height),R.z=N.texOffset.z,o.width=N.texExtent.width<f.width?N.texExtent.width:L(N.texExtent.width,f.width),o.height=N.texExtent.height<f.height?N.texExtent.width:L(N.texExtent.height,f.height),o.depth=N.texExtent.depth,h.width=N.buffStride>0?N.buffStride:o.width,h.height=N.buffTexHeight>0?N.buffTexHeight:o.height;var H,X=N.texExtent.width+R.x===r.width>>w?N.texExtent.width:o.width,k=N.texExtent.height+R.y===r.height>>w?N.texExtent.height:o.height,V=t[n++];H=h.width===o.width&&h.height===o.height?new l(V.buffer,V.byteOffset+N.buffOffset):rt(V,r.format,N.buffOffset,h,o),c?r.glInternalFmt!==me.COMPRESSED_RGB_ETC1_WEBGL?a.compressedTexSubImage3D(a.TEXTURE_2D_ARRAY,w,R.x,R.y,R.z,X,k,o.depth,r.glFormat,H):a.compressedTexImage3D(a.TEXTURE_2D_ARRAY,w,r.glInternalFmt,X,k,o.depth,0,H):a.texSubImage3D(a.TEXTURE_2D_ARRAY,w,R.x,R.y,R.z,X,k,o.depth,r.glFormat,r.glType,H)}break;case a.TEXTURE_CUBE_MAP:for(var K=0;K<s.length;K++){var W=s[K],z=W.texSubres.mipLevel;R.x=0===W.texOffset.x?0:L(W.texOffset.x,f.width),R.y=0===W.texOffset.y?0:L(W.texOffset.y,f.height),o.width=W.texExtent.width<f.width?W.texExtent.width:L(W.texExtent.width,f.width),o.height=W.texExtent.height<f.height?W.texExtent.width:L(W.texExtent.height,f.height),h.width=W.buffStride>0?W.buffStride:o.width,h.height=W.buffTexHeight>0?W.buffTexHeight:o.height;var Y=W.texExtent.width+R.x===r.width>>z?W.texExtent.width:o.width,q=W.texExtent.height+R.y===r.height>>z?W.texExtent.height:o.height,Z=W.texSubres.baseArrayLayer+W.texSubres.layerCount;for(u=W.texSubres.baseArrayLayer;u<Z;++u){var j,Q=t[n++];j=h.width===o.width&&h.height===o.height?new l(Q.buffer,Q.byteOffset+W.buffOffset):rt(Q,r.format,W.buffOffset,h,o),c?r.glInternalFmt!==me.COMPRESSED_RGB_ETC1_WEBGL?a.compressedTexSubImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+u,z,R.x,R.y,Y,q,r.glFormat,j):a.compressedTexImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+u,z,r.glInternalFmt,Y,q,0,j):a.texSubImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+u,z,R.x,R.y,Y,q,r.glFormat,r.glType,j)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}r.flags&I.GEN_MIPMAP&&a.generateMipmap(r.glTarget)}var at=function(){function e(){this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}var t=e.prototype;return t.clearDraws=function(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1},t.setDrawInfo=function(e,t){this._ensureCapacity(e),this.drawByIndex=t.indexCount>0,this.instancedDraw=!!t.instanceCount,this.drawCount=Math.max(e+1,this.drawCount),this.drawByIndex?(this.counts[e]=t.indexCount,this.offsets[e]=t.firstIndex):(this.counts[e]=t.vertexCount,this.offsets[e]=t.firstVertex),this.instances[e]=Math.max(1,t.instanceCount)},t._ensureCapacity=function(e){if(!(this._capacity>e)){this._capacity=n(e);var t=new Int32Array(this._capacity),r=new Int32Array(this._capacity),s=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),t.set(this.counts),r.set(this.offsets),s.set(this.instances),this.counts=t,this.offsets=r,this.instances=s}},e}(),it=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuBuffer=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){if("buffer"in e){this._isBufferView=!0;var t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:t.gpuBuffer.indirects,glTarget:t.gpuBuffer.glTarget,glBuffer:t.gpuBuffer.glBuffer,glOffset:e.offset}}else this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=e.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:new at,glTarget:0,glBuffer:null,glOffset:0},function(e,t){var r=e.gl,s=e.stateCache,a=t.memUsage&g.HOST?r.DYNAMIC_DRAW:r.STATIC_DRAW;if(t.usage&d.VERTEX){t.glTarget=r.ARRAY_BUFFER;var i=r.createBuffer();i&&(t.glBuffer=i,t.size>0&&(e.extensions.useVAO&&s.glVAO&&(r.bindVertexArray(null),s.glVAO=null),Ze.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(r.bindBuffer(r.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),r.bufferData(r.ARRAY_BUFFER,t.size,a),r.bindBuffer(r.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&d.INDEX){t.glTarget=r.ELEMENT_ARRAY_BUFFER;var n=r.createBuffer();n&&(t.glBuffer=n,t.size>0&&(e.extensions.useVAO&&s.glVAO&&(r.bindVertexArray(null),s.glVAO=null),Ze.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),r.bufferData(r.ELEMENT_ARRAY_BUFFER,t.size,a),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else if(t.usage&d.UNIFORM){t.glTarget=r.UNIFORM_BUFFER;var u=r.createBuffer();u&&t.size>0&&(t.glBuffer=u,e.stateCache.glUniformBuffer!==t.glBuffer&&(r.bindBuffer(r.UNIFORM_BUFFER,t.glBuffer),e.stateCache.glUniformBuffer=t.glBuffer),r.bufferData(r.UNIFORM_BUFFER,t.size,a),r.bindBuffer(r.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null)}else t.usage&d.INDIRECT||t.usage&d.TRANSFER_DST||t.usage&d.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=r.NONE}(Ge.instance,this._gpuBuffer),Ge.instance.memoryStatus.bufferSize+=this._size},a.destroy=function(){this._gpuBuffer&&(this._isBufferView||(function(e,t){var r=e.gl,s=e.stateCache;if(t.glBuffer){switch(t.glTarget){case r.ARRAY_BUFFER:e.extensions.useVAO&&s.glVAO&&(r.bindVertexArray(null),e.stateCache.glVAO=null),Ze.gpuInputAssembler=null,r.bindBuffer(r.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null;break;case r.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&s.glVAO&&(r.bindVertexArray(null),e.stateCache.glVAO=null),Ze.gpuInputAssembler=null,r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null;break;case r.UNIFORM_BUFFER:r.bindBuffer(r.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null}r.deleteBuffer(t.glBuffer),t.glBuffer=null}}(Ge.instance,this._gpuBuffer),Ge.instance.memoryStatus.bufferSize-=this._size),this._gpuBuffer=null)},a.resize=function(e){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var t,r,s,a,i,n=this._size;n!==e&&(this._size=e,this._count=this._size/this._stride,this._gpuBuffer&&(this._gpuBuffer.size=e,e>0&&(t=Ge.instance,r=this._gpuBuffer,s=t.gl,a=t.stateCache,i=r.memUsage&g.HOST?s.DYNAMIC_DRAW:s.STATIC_DRAW,r.usage&d.VERTEX?(t.extensions.useVAO&&a.glVAO&&(s.bindVertexArray(null),a.glVAO=null),Ze.gpuInputAssembler=null,a.glArrayBuffer!==r.glBuffer&&s.bindBuffer(s.ARRAY_BUFFER,r.glBuffer),r.buffer?s.bufferData(s.ARRAY_BUFFER,r.buffer,i):s.bufferData(s.ARRAY_BUFFER,r.size,i),s.bindBuffer(s.ARRAY_BUFFER,null),a.glArrayBuffer=null):r.usage&d.INDEX?(t.extensions.useVAO&&a.glVAO&&(s.bindVertexArray(null),a.glVAO=null),Ze.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==r.glBuffer&&s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,r.glBuffer),r.buffer?s.bufferData(s.ELEMENT_ARRAY_BUFFER,r.buffer,i):s.bufferData(s.ELEMENT_ARRAY_BUFFER,r.size,i),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null):r.usage&d.UNIFORM?(t.stateCache.glUniformBuffer!==r.glBuffer&&s.bindBuffer(s.UNIFORM_BUFFER,r.glBuffer),s.bufferData(s.UNIFORM_BUFFER,r.size,i),s.bindBuffer(s.UNIFORM_BUFFER,null),t.stateCache.glUniformBuffer=null):(r.usage&d.INDIRECT||r.usage&d.TRANSFER_DST||r.usage&d.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),r.glTarget=s.NONE),Ge.instance.memoryStatus.bufferSize-=n,Ge.instance.memoryStatus.bufferSize+=e)))}},a.update=function(e,t){var r;this._isBufferView?console.warn("cannot update through buffer views!"):(r=void 0!==t?t:this._usage&d.INDIRECT?0:e.byteLength,ze(Ge.instance,this._gpuBuffer,e,0,r))},r(s,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}}]),s}(X),nt=function(){function e(e,t){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new w(t);for(var r=0;r<t;++r)this._frees[r]=new e;this._freeIdx=t-1}var t=e.prototype;return t.alloc=function(e){if(this._freeIdx<0){var t=2*this._frees.length,r=this._frees;this._frees=new Array(t);for(var s=t-r.length,a=0;a<s;++a)this._frees[a]=new e;for(var i=s,n=0;i<t;++i,++n)this._frees[i]=r[n];this._freeIdx+=s}var u=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++u.refCount,u},t.free=function(e){0==--e.refCount&&this._freeCmds.push(e)},t.freeCmds=function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])},t.release=function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()},e}(),ut=function(){function e(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new nt(He,1),this.bindStatesCmdPool=new nt(Xe,1),this.drawCmdPool=new nt(ke,1),this.updateBufferCmdPool=new nt(Ve,1),this.copyBufferToTextureCmdPool=new nt(Ke,1)}var t=e.prototype;return t.clearCmds=function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()},t.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()},e}(),_t=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this).cmdPackage=new We,t._cmdAllocator=new ut,t._isInRenderPass=!1,t._curGPUPipelineState=null,t._curGPUDescriptorSets=[],t._curGPUInputAssembler=null,t._curDynamicOffsets=Array(8).fill(0),t._curDynamicStates=new S,t._isStateInvalied=!1,t}t(r,e);var s=r.prototype;return s.initialize=function(e){this._type=e.type,this._queue=e.queue;for(var t=Ge.instance.bindingMappings.blockOffsets.length,r=0;r<t;r++)this._curGPUDescriptorSets.push(null)},s.destroy=function(){this._cmdAllocator.clearCmds(this.cmdPackage)},s.begin=function(){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},s.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},s.beginRenderPass=function(e,t,r,s,a,i){var n=this._cmdAllocator.beginRenderPassCmdPool.alloc(He);n.gpuRenderPass=e.gpuRenderPass,n.gpuFramebuffer=t.gpuFramebuffer,n.renderArea.copy(r);for(var u=0;u<s.length;++u)n.clearColors[u]=s[u];n.clearDepth=a,n.clearStencil=i,this.cmdPackage.beginRenderPassCmds.push(n),this.cmdPackage.cmds.push(ve.BEGIN_RENDER_PASS),this._isInRenderPass=!0},s.endRenderPass=function(){this._isInRenderPass=!1},s.bindPipelineState=function(e){var t=e.gpuPipelineState;t!==this._curGPUPipelineState&&(this._curGPUPipelineState=t,this._isStateInvalied=!0)},s.bindDescriptorSet=function(e,t,r){var s=t.gpuDescriptorSet;if(s!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=s,this._isStateInvalied=!0),r){var a,i=null===(a=this._curGPUPipelineState)||void 0===a?void 0:a.gpuPipelineLayout;if(i){for(var n=this._curDynamicOffsets,u=i.dynamicOffsetOffsets[e],_=0;_<r.length;_++)n[u+_]=r[_];this._isStateInvalied=!0}}},s.bindInputAssembler=function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0},s.setViewport=function(e){var t=this._curDynamicStates.viewport;t.left===e.left&&t.top===e.top&&t.width===e.width&&t.height===e.height&&t.minDepth===e.minDepth&&t.maxDepth===e.maxDepth||(t.left=e.left,t.top=e.top,t.width=e.width,t.height=e.height,t.minDepth=e.minDepth,t.maxDepth=e.maxDepth,this._isStateInvalied=!0)},s.setScissor=function(e){var t=this._curDynamicStates.scissor;t.x===e.x&&t.y===e.y&&t.width===e.width&&t.height===e.height||(t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,this._isStateInvalied=!0)},s.setLineWidth=function(e){this._curDynamicStates.lineWidth!==e&&(this._curDynamicStates.lineWidth=e,this._isStateInvalied=!0)},s.setDepthBias=function(e,t,r){var s=this._curDynamicStates;s.depthBiasConstant===e&&s.depthBiasClamp===t&&s.depthBiasSlope===r||(s.depthBiasConstant=e,s.depthBiasClamp=t,s.depthBiasSlope=r,this._isStateInvalied=!0)},s.setBlendConstants=function(e){var t=this._curDynamicStates.blendConstant;t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w||(t.copy(e),this._isStateInvalied=!0)},s.setDepthBound=function(e,t){var r=this._curDynamicStates;r.depthMinBounds===e&&r.depthMaxBounds===t||(r.depthMinBounds=e,r.depthMaxBounds=t,this._isStateInvalied=!0)},s.setStencilWriteMask=function(e,t){var r=this._curDynamicStates.stencilStatesFront,s=this._curDynamicStates.stencilStatesBack;e&k.FRONT&&r.writeMask!==t&&(r.writeMask=t,this._isStateInvalied=!0),e&k.BACK&&s.writeMask!==t&&(s.writeMask=t,this._isStateInvalied=!0)},s.setStencilCompareMask=function(e,t,r){var s=this._curDynamicStates.stencilStatesFront,a=this._curDynamicStates.stencilStatesBack;e&k.FRONT&&(s.compareMask===r&&s.reference===t||(s.reference=t,s.compareMask=r,this._isStateInvalied=!0)),e&k.BACK&&(a.compareMask===r&&a.reference===t||(a.reference=t,a.compareMask=r,this._isStateInvalied=!0))},s.draw=function(e){if(this._type===V.PRIMARY&&this._isInRenderPass||this._type===V.SECONDARY){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e,r=this._cmdAllocator.drawCmdPool.alloc(ke);r.drawInfo.copy(t),this.cmdPackage.drawCmds.push(r),this.cmdPackage.cmds.push(ve.DRAW),++this._numDrawCalls,this._numInstances+=t.instanceCount;var s=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=s/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(s-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},s.updateBuffer=function(e,t,r){if(this._type===V.PRIMARY&&!this._isInRenderPass||this._type===V.SECONDARY){var s=e.gpuBuffer;if(s){var a,i=this._cmdAllocator.updateBufferCmdPool.alloc(Ve),n=0;e.usage&d.INDIRECT||(n=void 0!==r?r:t.byteLength),a=t,i.gpuBuffer=s,i.buffer=a,i.offset=0,i.size=n,this.cmdPackage.updateBufferCmds.push(i),this.cmdPackage.cmds.push(ve.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")},s.copyBuffersToTexture=function(e,t,r){if(this._type===V.PRIMARY&&!this._isInRenderPass||this._type===V.SECONDARY){var s=t.gpuTexture;if(s){var a=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(Ke);a.gpuTexture=s,a.regions=r,a.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(a),this.cmdPackage.cmds.push(ve.COPY_BUFFER_TO_TEXTURE)}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},s.execute=function(e,t){for(var r=0;r<t;++r){for(var s=e[r],a=0;a<s.cmdPackage.beginRenderPassCmds.length;++a){var i=s.cmdPackage.beginRenderPassCmds.array[a];++i.refCount,this.cmdPackage.beginRenderPassCmds.push(i)}for(var n=0;n<s.cmdPackage.bindStatesCmds.length;++n){var u=s.cmdPackage.bindStatesCmds.array[n];++u.refCount,this.cmdPackage.bindStatesCmds.push(u)}for(var _=0;_<s.cmdPackage.drawCmds.length;++_){var l=s.cmdPackage.drawCmds.array[_];++l.refCount,this.cmdPackage.drawCmds.push(l)}for(var c=0;c<s.cmdPackage.updateBufferCmds.length;++c){var f=s.cmdPackage.updateBufferCmds.array[c];++f.refCount,this.cmdPackage.updateBufferCmds.push(f)}for(var o=0;o<s.cmdPackage.copyBufferToTextureCmds.length;++o){var R=s.cmdPackage.copyBufferToTextureCmds.array[o];++R.refCount,this.cmdPackage.copyBufferToTextureCmds.push(R)}this.cmdPackage.cmds.concat(s.cmdPackage.cmds.array),this._numDrawCalls+=s._numDrawCalls,this._numInstances+=s._numInstances,this._numTris+=s._numTris}},s.pipelineBarrier=function(){},s.bindStates=function(){var e=this._cmdAllocator.bindStatesCmdPool.alloc(Xe);e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets),e.gpuInputAssembler=this._curGPUInputAssembler,e.dynamicStates=this._curDynamicStates,this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(ve.BIND_STATES),this._isStateInvalied=!1},r}(K),lt=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuFramebuffer=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null;for(var t=[],r=0;r<e.colorTextures.length;r++){var s=e.colorTextures[r];s&&t.push(s.gpuTextureView)}var a=null;e.depthStencilTexture&&(a=e.depthStencilTexture.gpuTextureView);var i=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorViews:t,gpuDepthStencilView:a,glFramebuffer:null,isOffscreen:!0,get width(){return this.isOffscreen?i:this.gpuColorViews.length>0?this.gpuColorViews[0].gpuTexture.width:this.gpuDepthStencilView.gpuTexture.width},set width(e){i=e},get height(){return this.isOffscreen?i:this.gpuColorViews.length>0?this.gpuColorViews[0].gpuTexture.height:this.gpuDepthStencilView.gpuTexture.height},set height(e){}},function(e,t){for(var r=0;r<t.gpuColorViews.length;++r)if(t.gpuColorViews[r].gpuTexture.isSwapchainTexture)return void(t.isOffscreen=!1);var s=e.gl,a=[],i=s.createFramebuffer();if(i){t.glFramebuffer=i,e.stateCache.glFramebuffer!==t.glFramebuffer&&s.bindFramebuffer(s.FRAMEBUFFER,t.glFramebuffer);for(var n=0;n<t.gpuColorViews.length;++n){var u=t.gpuColorViews[n],_=u.gpuTexture;_&&(_.glTexture?s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0+n,_.glTarget,_.glTexture,u.baseLevel):s.framebufferRenderbuffer(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0+n,s.RENDERBUFFER,_.glRenderbuffer),a.push(s.COLOR_ATTACHMENT0+n),t.width=Math.min(t.width,_.width>>u.baseLevel),t.height=Math.min(t.height,_.height>>u.baseLevel))}var l=t.gpuDepthStencilView;if(l){var c=l.gpuTexture,f=C[c.format].hasStencil?s.DEPTH_STENCIL_ATTACHMENT:s.DEPTH_ATTACHMENT;c.glTexture?s.framebufferTexture2D(s.FRAMEBUFFER,f,c.glTarget,c.glTexture,t.gpuDepthStencilView.baseLevel):s.framebufferRenderbuffer(s.FRAMEBUFFER,f,s.RENDERBUFFER,c.glRenderbuffer),t.width=Math.min(t.width,c.width>>l.baseLevel),t.height=Math.min(t.height,c.height>>l.baseLevel)}s.drawBuffers(a);var o=s.checkFramebufferStatus(s.FRAMEBUFFER);if(o!==s.FRAMEBUFFER_COMPLETE)switch(o){case s.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case s.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case s.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case s.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}e.stateCache.glFramebuffer!==t.glFramebuffer&&s.bindFramebuffer(s.FRAMEBUFFER,e.stateCache.glFramebuffer)}}(Ge.instance,this._gpuFramebuffer)},a.destroy=function(){var e,t;this._gpuFramebuffer&&(e=Ge.instance,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),e.stateCache.glFramebuffer===t.glFramebuffer&&(e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,null),e.stateCache.glFramebuffer=null),t.glFramebuffer=null),this._gpuFramebuffer=null)},r(s,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),s}(W),ct=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuInputAssembler=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){if(0!==e.vertexBuffers.length){if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,e.indexBuffer)this._indexBuffer=e.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{var t=this._vertexBuffers[0];this._drawInfo.vertexCount=t.size/t.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;for(var r=new Array(e.vertexBuffers.length),s=0;s<e.vertexBuffers.length;++s){var a=e.vertexBuffers[s];a.gpuBuffer&&(r[s]=a.gpuBuffer)}var i=null,n=0;if(e.indexBuffer&&(i=e.indexBuffer.gpuBuffer))switch(i.stride){case 1:n=5121;break;case 2:n=5123;break;case 4:n=5125;break;default:console.error("Illegal index buffer stride.")}var u=null;e.indirectBuffer&&(u=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:r,gpuIndexBuffer:i,gpuIndirectBuffer:u,glAttribs:[],glIndexType:n,glVAOs:new Map},function(e,t){var r=e.gl;t.glAttribs=new Array(t.attributes.length);for(var s=[0,0,0,0,0,0,0,0],a=0;a<t.attributes.length;++a){var i=t.attributes[a],n=void 0!==i.stream?i.stream:0,u=t.gpuVertexBuffers[n],_=Fe(i.format,r),l=C[i.format].size;t.glAttribs[a]={name:i.name,glBuffer:u.glBuffer,glType:_,size:l,count:C[i.format].count,stride:u.stride,componentCount:Me(_,r),isNormalized:void 0!==i.isNormalized&&i.isNormalized,isInstanced:void 0!==i.isInstanced&&i.isInstanced,offset:s[n]},s[n]+=l}}(Ge.instance,this._gpuInputAssembler)}else console.error("InputAssemblerInfo.vertexBuffers is null.")},a.destroy=function(){var e=Ge.instance;this._gpuInputAssembler&&e.extensions.useVAO&&function(e,t){for(var r=t.glVAOs.values(),s=r.next(),a=e.gl,i=e.stateCache.glVAO;!s.done;)a.deleteVertexArray(s.value),i===s.value&&(a.bindVertexArray(null),i=null),s=r.next();e.stateCache.glVAO=i,t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null},r(s,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),s}(z),ft=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuDescriptorSetLayout=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){Array.prototype.push.apply(this._bindings,e.bindings);for(var t=0,r=-1,s=[],a=0;a<this._bindings.length;a++){var i=this._bindings[a];s.push(t),t+=i.count,i.binding>r&&(r=i.binding)}this._bindingIndices=Array(r+1).fill(-1);for(var n=this._descriptorIndices=Array(r+1).fill(-1),u=0;u<this._bindings.length;u++){var _=this._bindings[u];this._bindingIndices[_.binding]=u,n[_.binding]=s[u]}for(var l=[],c=0;c<this._bindings.length;c++){var f=this._bindings[c];if(f.descriptorType&Y)for(var o=0;o<f.count;o++)l.push(f.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:l,descriptorIndices:n,descriptorCount:t}},a.destroy=function(){this._bindings.length=0},r(s,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),s}(q),ot=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuPipelineLayout=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);for(var t=[],r=[],s=0,a=[],i=0;i<this._setLayouts.length;i++){for(var n=this._setLayouts[i],u=n.gpuDescriptorSetLayout.dynamicBindings,_=Array(n.bindingIndices.length).fill(-1),l=0;l<u.length;l++){var c=u[l];_[c]<0&&(_[c]=s+l)}r.push(n.gpuDescriptorSetLayout),t.push(_),a.push(s),s+=u.length}this._gpuPipelineLayout={gpuSetLayouts:r,dynamicOffsetIndices:t,dynamicOffsetCount:s,dynamicOffsetOffsets:a}},a.destroy=function(){this._setLayouts.length=0},r(s,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),s}(Z),Rt=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],ht=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuPipelineState=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout;var t=this._bs;if(e.blendState){var r=e.blendState,s=r.targets;s&&s.forEach((function(e,r){t.setTarget(r,e)})),void 0!==r.isA2C&&(t.isA2C=r.isA2C),void 0!==r.isIndepend&&(t.isIndepend=r.isIndepend),void 0!==r.blendColor&&(t.blendColor=r.blendColor)}Object.assign(this._rs,e.rasterizerState),Object.assign(this._dss,e.depthStencilState),this._is=e.inputState,this._renderPass=e.renderPass,this._dynamicStates=e.dynamicStates;for(var a=[],i=0;i<31;i++)this._dynamicStates&1<<i&&a.push(1<<i);this._gpuPipelineState={glPrimitive:Rt[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:a}},a.destroy=function(){this._gpuPipelineState=null},r(s,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),s}(j),Et=function(e){function r(){return e.apply(this,arguments)||this}t(r,e);var s=r.prototype;return s.beginRenderPass=function(e,t,r,s,a,i){je(Ge.instance,e.gpuRenderPass,t.gpuFramebuffer,r,s,a,i),this._isInRenderPass=!0},s.draw=function(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e;Je(Ge.instance,t),++this._numDrawCalls,this._numInstances+=t.instanceCount;var r=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=r/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(r-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},s.setViewport=function(e){var t=Ge.instance,r=t.stateCache,s=t.gl;r.viewport.left===e.left&&r.viewport.top===e.top&&r.viewport.width===e.width&&r.viewport.height===e.height||(s.viewport(e.left,e.top,e.width,e.height),r.viewport.left=e.left,r.viewport.top=e.top,r.viewport.width=e.width,r.viewport.height=e.height)},s.setScissor=function(e){var t=Ge.instance,r=t.stateCache,s=t.gl;r.scissorRect.x===e.x&&r.scissorRect.y===e.y&&r.scissorRect.width===e.width&&r.scissorRect.height===e.height||(s.scissor(e.x,e.y,e.width,e.height),r.scissorRect.x=e.x,r.scissorRect.y=e.y,r.scissorRect.width=e.width,r.scissorRect.height=e.height)},s.updateBuffer=function(e,t,r){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var s,a=e.gpuBuffer;a&&(s=void 0!==r?r:e.usage&d.INDIRECT?0:t.byteLength,ze(Ge.instance,a,t,0,s))}},s.copyBuffersToTexture=function(e,t,r){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var s=t.gpuTexture;s&&st(Ge.instance,e,s,r)}},s.execute=function(e,t){for(var r=0;r<t;++r){var s=e[r];et(Ge.instance,s.cmdPackage),this._numDrawCalls+=s._numDrawCalls,this._numInstances+=s._numInstances,this._numTris+=s._numTris}},s.bindStates=function(){Qe(Ge.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1},r}(_t),At=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this).numDrawCalls=0,t.numInstances=0,t.numTris=0,t}t(r,e);var s=r.prototype;return s.initialize=function(e){this._type=e.type},s.destroy=function(){},s.submit=function(e){for(var t=0;t<e.length;t++){var r=e[t];this.numDrawCalls+=r.numDrawCalls,this.numInstances+=r.numInstances,this.numTris+=r.numTris}},s.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},r}(Q),St=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuRenderPass=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,this._subpasses=e.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()},a.destroy=function(){this._gpuRenderPass=null},r(s,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),s}(J),Tt=function(e){function s(t,r){var s,a,i,n;return(s=e.call(this,t,r)||this)._gpuSampler=null,s._gpuSampler={glSamplers:new Map,minFilter:s._info.minFilter,magFilter:s._info.magFilter,mipFilter:s._info.mipFilter,addressU:s._info.addressU,addressV:s._info.addressV,addressW:s._info.addressW,glMinFilter:0,glMagFilter:0,glWrapS:0,glWrapT:0,glWrapR:0,getGLSampler:function(e,t,r){var s=e.gl,a=t<<16|r;if(!this.glSamplers.has(a)){var i=s.createSampler();i&&(this.glSamplers.set(a,i),s.samplerParameteri(i,s.TEXTURE_MIN_FILTER,this.glMinFilter),s.samplerParameteri(i,s.TEXTURE_MAG_FILTER,this.glMagFilter),s.samplerParameteri(i,s.TEXTURE_WRAP_S,this.glWrapS),s.samplerParameteri(i,s.TEXTURE_WRAP_T,this.glWrapT),s.samplerParameteri(i,s.TEXTURE_WRAP_R,this.glWrapR),s.samplerParameterf(i,s.TEXTURE_MIN_LOD,t),s.samplerParameterf(i,s.TEXTURE_MAX_LOD,r))}return this.glSamplers.get(a)}},a=Ge.instance,i=s._gpuSampler,n=a.gl,i.minFilter===y.LINEAR||i.minFilter===y.ANISOTROPIC?i.mipFilter===y.LINEAR||i.mipFilter===y.ANISOTROPIC?i.glMinFilter=n.LINEAR_MIPMAP_LINEAR:i.mipFilter===y.POINT?i.glMinFilter=n.LINEAR_MIPMAP_NEAREST:i.glMinFilter=n.LINEAR:i.mipFilter===y.LINEAR||i.mipFilter===y.ANISOTROPIC?i.glMinFilter=n.NEAREST_MIPMAP_LINEAR:i.mipFilter===y.POINT?i.glMinFilter=n.NEAREST_MIPMAP_NEAREST:i.glMinFilter=n.NEAREST,i.magFilter===y.LINEAR||i.magFilter===y.ANISOTROPIC?i.glMagFilter=n.LINEAR:i.glMagFilter=n.NEAREST,i.glWrapS=Pe[i.addressU],i.glWrapT=Pe[i.addressV],i.glWrapR=Pe[i.addressW],s}return t(s,e),s.prototype.destroy=function(){this._gpuSampler&&(function(e,t){for(var r=e.gl,s=t.glSamplers.values().next();!s.done;){r.deleteSampler(s.value);for(var a=e.stateCache.glSamplerUnits,i=0;i<a.length;++i)a[i]===s.value&&(r.bindSampler(i,null),a[i]=null)}t.glSamplers.clear()}(Ge.instance,this._gpuSampler),this._gpuSampler=null)},r(s,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),s}($),gt=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuShader=null,t}t(s,e);var n=s.prototype;return n.initialize=function(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name,blocks:e.blocks.slice(),samplerTextures:e.samplerTextures.slice(),subpassInputs:e.subpassInputs.slice(),gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var t=0;t<e.stages.length;++t){var r=e.stages[t];this._gpuShader.gpuStages[t]={type:r.stage,source:r.source,glShader:null}}},n.destroy=function(){var e,t;this._gpuShader&&(e=Ge.instance,(t=this._gpuShader).glProgram&&(e.gl.deleteProgram(t.glProgram),e.stateCache.glProgram===t.glProgram&&(e.gl.useProgram(null),e.stateCache.glProgram=null),t.glProgram=null),this._gpuShader=null)},r(s,[{key:"gpuShader",get:function(){return null===this._gpuShader.glProgram&&function(e,t){for(var r=e.gl,s=function(e){var s=t.gpuStages[e],a=0,i="",n=1;switch(s.type){case H.VERTEX:i="VertexShader",a=r.VERTEX_SHADER;break;case H.FRAGMENT:i="FragmentShader",a=r.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var u=r.createShader(a);if(u&&(s.glShader=u,r.shaderSource(s.glShader,"#version 300 es\n"+s.source),r.compileShader(s.glShader),!r.getShaderParameter(s.glShader,r.COMPILE_STATUS))){console.error(i+" in '"+t.name+"' compilation failed."),console.error("Shader source dump:",s.source.replace(/^|\n/g,(function(){return"\n"+n+++" "}))),console.error(r.getShaderInfoLog(s.glShader));for(var _=0;_<t.gpuStages.length;_++){var l=t.gpuStages[e];l.glShader&&(r.deleteShader(l.glShader),l.glShader=null)}return{v:void 0}}},n=0;n<t.gpuStages.length;n++){var u=s(n);if("object"==typeof u)return u.v}var _=r.createProgram();if(_){t.glProgram=_;for(var l=0;l<t.gpuStages.length;l++){var c=t.gpuStages[l];r.attachShader(t.glProgram,c.glShader)}r.linkProgram(t.glProgram);for(var f=0;f<t.gpuStages.length;f++){var o=t.gpuStages[f];o.glShader&&(r.detachShader(t.glProgram,o.glShader),r.deleteShader(o.glShader),o.glShader=null)}if(!r.getProgramParameter(t.glProgram,r.LINK_STATUS))return console.error("Failed to link shader '"+t.name+"'."),void console.error(r.getProgramInfoLog(t.glProgram));i("Shader '"+t.name+"' compilation succeeded.");var R=r.getProgramParameter(t.glProgram,r.ACTIVE_ATTRIBUTES);t.glInputs=new Array(R);for(var h=0;h<R;++h){var E=r.getActiveAttrib(t.glProgram,h);if(E){var A,S=E.name.indexOf("[");A=-1!==S?E.name.substr(0,S):E.name;var T=r.getAttribLocation(t.glProgram,A),g=Oe(E.type,r),d=De(E.type,r);t.glInputs[h]={name:A,type:g,stride:d,count:E.size,size:d*E.size,glType:E.type,glLoc:T}}}var B,C,p,m,x=r.getProgramParameter(t.glProgram,r.ACTIVE_UNIFORM_BLOCKS);if(x){t.glBlocks=new Array(x);for(var G=0;G<x;++G){var P=(B=r.getActiveUniformBlockName(t.glProgram,G)).indexOf("[");-1!==P&&(B=B.substr(0,P)),m=null;for(var b=0;b<t.blocks.length;b++)if(t.blocks[b].name===B){m=t.blocks[b];break}if(m){C=G,p=r.getActiveUniformBlockParameter(t.glProgram,C,r.UNIFORM_BLOCK_DATA_SIZE);var F=m.binding+(e.bindingMappings.blockOffsets[m.set]||0);r.uniformBlockBinding(t.glProgram,C,F),t.glBlocks[G]={set:m.set,binding:m.binding,idx:C,name:B,size:p,glBinding:F}}else a("Block '"+B+"' does not bound")}}for(var I=0;I<t.subpassInputs.length;++I){var O=t.subpassInputs[I];t.samplerTextures.push(new U(O.set,O.binding,O.name,N.SAMPLER2D,O.count))}if(t.samplerTextures.length>0){t.glSamplerTextures=new Array(t.samplerTextures.length);for(var D=0;D<t.samplerTextures.length;++D){var M=t.samplerTextures[D];t.glSamplerTextures[D]={set:M.set,binding:M.binding,name:M.name,type:M.type,count:M.count,units:[],glUnits:null,glType:Ie(M.type,r),glLoc:null}}}for(var v=[],L=[],y=e.stateCache.texUnitCacheMap,w=0,X=0;X<t.blocks.length;++X)t.blocks[X].set===e.bindingMappings.flexibleSet&&w++;for(var k=0,V=0;V<t.samplerTextures.length;++V){var K=t.samplerTextures[V],W=r.getUniformLocation(t.glProgram,K.name);if(W&&-1!==W.id&&(v.push(t.glSamplerTextures[V]),L.push(W)),void 0===y[K.name]){var z=K.binding+e.bindingMappings.samplerTextureOffsets[K.set]+k;K.set===e.bindingMappings.flexibleSet&&(z-=w),y[K.name]=z%e.capabilities.maxTextureUnits,k+=K.count-1}}if(v.length){for(var Y=[],q=0;q<v.length;++q){var Z=v[q],j=y[Z.name];if(void 0!==j){Z.glLoc=L[q];for(var Q=0;Q<Z.count;++Q){for(;Y[j];)j=(j+1)%e.capabilities.maxTextureUnits;Z.units.push(j),Y[j]=!0}}}for(var J=0,$=0;$<v.length;++$){var ee=v[$];if(!ee.glLoc){for(ee.glLoc=L[$];Y[J];)J++;for(var te=0;te<ee.count;++te){for(;Y[J];)J=(J+1)%e.capabilities.maxTextureUnits;void 0===y[ee.name]&&(y[ee.name]=J),ee.units.push(J),Y[J]=!0}}}e.stateCache.glProgram!==t.glProgram&&r.useProgram(t.glProgram);for(var re=0;re<v.length;re++){var se=v[re];se.glUnits=new Int32Array(se.units),r.uniform1iv(se.glLoc,se.glUnits)}e.stateCache.glProgram!==t.glProgram&&r.useProgram(e.stateCache.glProgram)}t.glSamplerTextures=v}}(Ge.instance,this._gpuShader),this._gpuShader}}]),s}(ee),dt=function(){function e(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glUniformBuffer=null,this.glBindUBOs=[],this.glBindUBOOffsets=[],this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glSamplerUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.glReadFramebuffer=null,this.viewport=new te,this.scissorRect=new A(0,0,0,0),this.rs=new re,this.dss=new se,this.bs=new ae,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return e.prototype.initialize=function(e,t,r){for(var s=0;s<e;++s)this.glTexUnits.push({glTexture:null});this.glSamplerUnits.length=e,this.glSamplerUnits.fill(null),this.glBindUBOs.length=t,this.glBindUBOs.fill(null),this.glBindUBOOffsets.length=t,this.glBindUBOOffsets.fill(0),this.glEnabledAttribLocs.length=r,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=r,this.glCurrentAttribLocs.fill(!1)},e}(),Bt=function(e){function a(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuTexture=null,t._gpuTextureView=null,t}t(a,e);var i=a.prototype;return i.initialize=function(e,t){var r=e,s=e;if("texture"in e&&(r=s.texture.info,this._isTextureView=!0),this._info.copy(r),this._isPowerOf2=ie(this._info.width)&&ie(this._info.height),this._size=ne(this._info.format,this.width,this.height,this.depth,this._info.levelCount)*this._info.layerCount,this._isTextureView){var a;if(this._viewInfo.copy(s),this._gpuTexture=s.texture._gpuTexture,(null===(a=this._gpuTexture)||void 0===a?void 0:a.format)!==r.format)return void console.log("GPU memory alias is not supported");this._gpuTextureView={gpuTexture:this._gpuTexture,type:s.type,format:s.format,baseLevel:s.baseLevel,levelCount:s.levelCount}}else this._gpuTexture={type:r.type,format:r.format,usage:r.usage,width:r.width,height:r.height,depth:r.depth,size:this._size,arrayLayer:r.layerCount,mipLevel:r.levelCount,samples:r.samples,flags:r.flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:t||!1},Ye(Ge.instance,this._gpuTexture),Ge.instance.memoryStatus.textureSize+=this._size,this._viewInfo.texture=this,this._viewInfo.type=e.type,this._viewInfo.format=e.format,this._viewInfo.baseLevel=0,this._viewInfo.levelCount=e.levelCount,this._viewInfo.baseLayer=0,this._viewInfo.layerCount=e.layerCount,this._gpuTextureView={gpuTexture:this._gpuTexture,type:this._viewInfo.type,format:this._viewInfo.format,baseLevel:this._viewInfo.baseLevel,levelCount:this._viewInfo.levelCount}},i.destroy=function(){!this._isTextureView&&this._gpuTexture&&(qe(Ge.instance,this._gpuTexture),Ge.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)},i.resize=function(e,t){if(this._info.width!==e||this._info.height!==t){this._info.levelCount===a.getLevelCount(this._info.width,this._info.height)?this._info.levelCount=a.getLevelCount(e,t):this._info.levelCount>1&&(this._info.levelCount=Math.min(this._info.levelCount,a.getLevelCount(e,t)));var r=this._size;this._info.width=e,this._info.height=t,this._size=ne(this._info.format,this.width,this.height,this.depth,this._info.levelCount)*this._info.layerCount,!this._isTextureView&&this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=t,this._gpuTexture.size=this._size,function(e,t){if(t.size){var r=e.gl,a=t.width,i=t.height;switch(t.type){case B.TEX2D:t.glTarget=r.TEXTURE_2D;var n=Math.max(a,i);if(n>e.capabilities.maxTextureSize&&s(9100,n,e.capabilities.maxTextureSize),t.samples===m.ONE){var u=e.stateCache.glTexUnits[e.stateCache.texUnit];if(u.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_2D,t.glTexture),u.glTexture=t.glTexture),C[t.format].isCompressed)for(var _=0;_<t.mipLevel;++_){var l=p(t.format,a,i,1),c=new Uint8Array(l);r.compressedTexImage2D(r.TEXTURE_2D,_,t.glInternalFmt,a,i,0,c),a=Math.max(1,a>>1),i=Math.max(1,i>>1)}else qe(e,t),Ye(e,t)}else t.glRenderbuffer&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(r.bindRenderbuffer(r.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),r.renderbufferStorageMultisample(r.RENDERBUFFER,t.samples,t.glInternalFmt,t.width,t.height));break;case B.CUBE:t.type=B.CUBE,t.glTarget=r.TEXTURE_CUBE_MAP;var f=Math.max(a,i);f>e.capabilities.maxCubeMapTextureSize&&s(9100,f,e.capabilities.maxTextureSize);var o=e.stateCache.glTexUnits[e.stateCache.texUnit];if(o.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_CUBE_MAP,t.glTexture),o.glTexture=t.glTexture),C[t.format].isCompressed)for(var R=0;R<6;++R){a=t.width,i=t.height;for(var h=0;h<t.mipLevel;++h){var E=p(t.format,a,i,1),A=new Uint8Array(E);r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+R,h,t.glInternalFmt,a,i,0,A),a=Math.max(1,a>>1),i=Math.max(1,i>>1)}}else qe(e,t),Ye(e,t);break;default:console.error("Unsupported TextureType, create texture failed."),t.type=B.TEX2D,t.glTarget=r.TEXTURE_2D}}}(Ge.instance,this._gpuTexture),Ge.instance.memoryStatus.textureSize-=r,Ge.instance.memoryStatus.textureSize+=this._size)}},i.initAsSwapchainTexture=function(e){var t=new ue;t.format=e.format,t.usage=C[e.format].hasDepth?_e.DEPTH_STENCIL_ATTACHMENT:_e.COLOR_ATTACHMENT,t.width=e.width,t.height=e.height,this.initialize(t,!0)},r(a,[{key:"gpuTexture",get:function(){return this._gpuTexture}},{key:"gpuTextureView",get:function(){return this._gpuTextureView}}]),a}(le),Ct="webglcontextlost";function pt(e,t){for(var r=["","WEBKIT_","MOZ_"],s=0;s<r.length;++s){var a=e.getExtension(r[s]+t);if(a)return a}return null}function mt(e){var t={EXT_texture_filter_anisotropic:pt(e,"EXT_texture_filter_anisotropic"),EXT_color_buffer_half_float:pt(e,"EXT_color_buffer_half_float"),EXT_color_buffer_float:pt(e,"EXT_color_buffer_float"),WEBGL_compressed_texture_etc1:pt(e,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:pt(e,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:pt(e,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_astc:pt(e,"WEBGL_compressed_texture_astc"),WEBGL_compressed_texture_s3tc:pt(e,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:pt(e,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:pt(e,"WEBGL_debug_shaders"),WEBGL_lose_context:pt(e,"WEBGL_lose_context"),WEBGL_debug_renderer_info:pt(e,"WEBGL_debug_renderer_info"),OES_texture_half_float_linear:pt(e,"OES_texture_half_float_linear"),OES_texture_float_linear:pt(e,"OES_texture_float_linear"),WEBGL_multi_draw:null,useVAO:!0};return ce.os!==fe.ANDROID&&ce.os!==fe.IOS&&(t.WEBGL_multi_draw=pt(e,"WEBGL_multi_draw")),t}var xt=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this).stateCache=new dt,t.nullTex2D=null,t.nullTexCube=null,t._canvas=null,t._webGL2ContextLostHandler=null,t._extensions=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){this._canvas=e.windowHandle,this._webGL2ContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(Ct,this._onWebGLContextLost);var t=Ge.instance.gl;this.stateCache.initialize(Ge.instance.capabilities.maxTextureUnits,Ge.instance.capabilities.maxUniformBufferBindings,Ge.instance.capabilities.maxVertexAttributes),this._extensions=mt(t),function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.bindFramebuffer(e.FRAMEBUFFER,null),e.enable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}(t);var r=x.RGBA8,s=x.DEPTH_STENCIL,a=t.getParameter(t.DEPTH_BITS),i=t.getParameter(t.STENCIL_BITS);a&&i?s=x.DEPTH_STENCIL:a&&(s=x.DEPTH),this._colorTexture=new Bt,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:r,width:e.width,height:e.height}),this._depthStencilTexture=new Bt,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:s,width:e.width,height:e.height}),this.nullTex2D=Ge.instance.createTexture(new ue(B.TEX2D,_e.SAMPLED,x.RGBA8,2,2,I.NONE)),this.nullTexCube=Ge.instance.createTexture(new ue(B.CUBE,_e.SAMPLED,x.RGBA8,2,2,I.NONE,6));var n=new oe;n.texExtent.width=2,n.texExtent.height=2;var u=new Uint8Array(this.nullTex2D.size);u.fill(0),Ge.instance.copyBuffersToTexture([u],this.nullTex2D,[n]),n.texSubres.layerCount=6,Ge.instance.copyBuffersToTexture([u,u,u,u,u,u],this.nullTexCube,[n])},a.destroy=function(){this._canvas&&this._webGL2ContextLostHandler&&(this._canvas.removeEventListener(Ct,this._webGL2ContextLostHandler),this._webGL2ContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._extensions=null,this._canvas=null},a.resize=function(e,t){this._colorTexture.width===e&&this._colorTexture.height===t||(i("Resizing swapchain: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._colorTexture.resize(e,t),this._depthStencilTexture.resize(e,t))},a._onWebGLContextLost=function(e){u(11e3),_(e)},r(s,[{key:"extensions",get:function(){return this._extensions}}]),s}(Re),Gt=e("WebGL2Device",function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._swapchain=null,t._context=null,t._bindingMappings=null,t._textureExclusive=new Array(x.COUNT),t}t(s,e);var a=s.prototype;return a.initialize=function(e){Ge.setInstance(this),this._gfxAPI=he.WEBGL2;var t=this._bindingMappingInfo=e.bindingMappingInfo,r=[],s=[],a=t.setIndices[0];r[a]=0,s[a]=0;for(var n=1;n<t.setIndices.length;++n){var u=t.setIndices[n],_=t.setIndices[n-1];r[u]=t.maxBlockCounts[_]+r[_],s[u]=t.maxSamplerTextureCounts[_]+s[_]}for(var o=0;o<t.setIndices.length;++o){var R=t.setIndices[o];s[R]-=t.maxBlockCounts[R]}this._bindingMappings={blockOffsets:r,samplerTextureOffsets:s,flexibleSet:t.setIndices[t.setIndices.length-1]};var h=this._context=function(e){var t=null;try{var r={alpha:l.ENABLE_TRANSPARENT_CANVAS,antialias:c||l.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};t=e.getContext("webgl2",r)}catch(e){return null}return t}(pe.canvas);if(!h)return console.error("This device does not support WebGL."),!1;this._queue=this.createQueue(new Ee(Ae.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new Se(this._queue)),this._caps.maxVertexAttributes=h.getParameter(h.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=h.getParameter(h.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=h.getParameter(h.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=h.getParameter(h.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=h.getParameter(h.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxUniformBufferBindings=h.getParameter(h.MAX_UNIFORM_BUFFER_BINDINGS),this._caps.maxUniformBlockSize=h.getParameter(h.MAX_UNIFORM_BLOCK_SIZE),this._caps.maxTextureSize=h.getParameter(h.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=h.getParameter(h.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.uboOffsetAlignment=h.getParameter(h.UNIFORM_BUFFER_OFFSET_ALIGNMENT);var E=h.getSupportedExtensions(),A="";if(E)for(var S,T=f(E);!(S=T()).done;)A+=S.value+" ";var g=mt(h);g.WEBGL_debug_renderer_info?(this._renderer=h.getParameter(g.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=h.getParameter(g.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=h.getParameter(h.RENDERER),this._vendor=h.getParameter(h.VENDOR));var d=h.getParameter(h.VERSION);this._features.fill(!1),this.initFormatFeatures(g),this._features[Te.ELEMENT_INDEX_UINT]=!0,this._features[Te.INSTANCED_ARRAYS]=!0,this._features[Te.MULTIPLE_RENDER_TARGETS]=!0,this._features[Te.BLEND_MINMAX]=!0;var B="";return this.getFormatFeatures(x.ETC_RGB8)&&(B+="etc1 "),this.getFormatFeatures(x.ETC2_RGB8)&&(B+="etc2 "),this.getFormatFeatures(x.BC1)&&(B+="dxt "),this.getFormatFeatures(x.PVRTC_RGB2)&&(B+="pvrtc "),this.getFormatFeatures(x.ASTC_RGBA_4X4)&&(B+="astc "),i("WebGL2 device initialized."),i("RENDERER: "+this._renderer),i("VENDOR: "+this._vendor),i("VERSION: "+d),i("COMPRESSED_FORMAT: "+B),i("EXTENSIONS: "+A),!0},a.destroy=function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null);for(var e=this._samplers.values(),t=e.next();!t.done;)t.value.destroy(),t=e.next();this._swapchain=null},a.flushCommands=function(){},a.acquire=function(){},a.present=function(){var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()},a.initFormatFeatures=function(e){this._formatFeatures.fill(ge.NONE),this._textureExclusive.fill(!0);var t=ge.RENDER_TARGET|ge.SAMPLED_TEXTURE|ge.STORAGE_TEXTURE|ge.LINEAR_FILTER|ge.VERTEX_ATTRIBUTE;this._formatFeatures[x.R8]=t,this._formatFeatures[x.RG8]=t,this._formatFeatures[x.RGB8]=t,this._formatFeatures[x.RGBA8]=t,t=ge.RENDER_TARGET|ge.SAMPLED_TEXTURE|ge.STORAGE_TEXTURE|ge.LINEAR_FILTER,this._formatFeatures[x.R8SN]=t,this._formatFeatures[x.RG8SN]=t,this._formatFeatures[x.RGB8SN]=t,this._formatFeatures[x.RGBA8SN]=t,this._formatFeatures[x.R5G6B5]=t,this._formatFeatures[x.RGBA4]=t,this._formatFeatures[x.RGB5A1]=t,this._formatFeatures[x.RGB10A2]=t,this._formatFeatures[x.SRGB8]=t,this._formatFeatures[x.SRGB8_A8]=t,this._formatFeatures[x.R11G11B10F]=t,this._formatFeatures[x.RGB9E5]=t,this._formatFeatures[x.DEPTH]=t,this._formatFeatures[x.DEPTH_STENCIL]=t,this._formatFeatures[x.RGB10A2UI]=ge.RENDER_TARGET|ge.STORAGE_TEXTURE|ge.SAMPLED_TEXTURE|ge.LINEAR_FILTER,t=ge.RENDER_TARGET|ge.SAMPLED_TEXTURE|ge.STORAGE_TEXTURE|ge.VERTEX_ATTRIBUTE,this._formatFeatures[x.R16F]=t,this._formatFeatures[x.RG16F]=t,this._formatFeatures[x.RGB16F]=t,this._formatFeatures[x.RGBA16F]=t,t=ge.STORAGE_TEXTURE|ge.SAMPLED_TEXTURE|ge.VERTEX_ATTRIBUTE,this._formatFeatures[x.R32F]=t,this._formatFeatures[x.RG32F]=t,this._formatFeatures[x.RGB32F]=t,this._formatFeatures[x.RGBA32F]=t,this._formatFeatures[x.RGB10A2UI]=ge.RENDER_TARGET|ge.STORAGE_TEXTURE|ge.SAMPLED_TEXTURE|ge.LINEAR_FILTER,t=ge.RENDER_TARGET|ge.STORAGE_TEXTURE|ge.SAMPLED_TEXTURE|ge.LINEAR_FILTER|ge.VERTEX_ATTRIBUTE,this._formatFeatures[x.R8I]=t,this._formatFeatures[x.R8UI]=t,this._formatFeatures[x.R16I]=t,this._formatFeatures[x.R16UI]=t,this._formatFeatures[x.R32I]=t,this._formatFeatures[x.R32UI]=t,this._formatFeatures[x.RG8I]=t,this._formatFeatures[x.RG8UI]=t,this._formatFeatures[x.RG16I]=t,this._formatFeatures[x.RG16UI]=t,this._formatFeatures[x.RG32I]=t,this._formatFeatures[x.RG32UI]=t,this._formatFeatures[x.RGB8I]=t,this._formatFeatures[x.RGB8UI]=t,this._formatFeatures[x.RGB16I]=t,this._formatFeatures[x.RGB16UI]=t,this._formatFeatures[x.RGB32I]=t,this._formatFeatures[x.RGB32UI]=t,this._formatFeatures[x.RGBA8I]=t,this._formatFeatures[x.RGBA8UI]=t,this._formatFeatures[x.RGBA16I]=t,this._formatFeatures[x.RGBA16UI]=t,this._formatFeatures[x.RGBA32I]=t,this._formatFeatures[x.RGBA32UI]=t,this._textureExclusive[x.R8]=!1,this._textureExclusive[x.RG8]=!1,this._textureExclusive[x.RGB8]=!1,this._textureExclusive[x.R5G6B5]=!1,this._textureExclusive[x.RGBA4]=!1,this._textureExclusive[x.RGB5A1]=!1,this._textureExclusive[x.RGBA8]=!1,this._textureExclusive[x.RGB10A2]=!1,this._textureExclusive[x.RGB10A2UI]=!1,this._textureExclusive[x.SRGB8_A8]=!1,this._textureExclusive[x.R8I]=!1,this._textureExclusive[x.R8UI]=!1,this._textureExclusive[x.R16I]=!1,this._textureExclusive[x.R16UI]=!1,this._textureExclusive[x.R32I]=!1,this._textureExclusive[x.R32UI]=!1,this._textureExclusive[x.RG8I]=!1,this._textureExclusive[x.RG8UI]=!1,this._textureExclusive[x.RG16I]=!1,this._textureExclusive[x.RG16UI]=!1,this._textureExclusive[x.RG32I]=!1,this._textureExclusive[x.RG32UI]=!1,this._textureExclusive[x.RGBA8I]=!1,this._textureExclusive[x.RGBA8UI]=!1,this._textureExclusive[x.RGBA16I]=!1,this._textureExclusive[x.RGBA16UI]=!1,this._textureExclusive[x.RGBA32I]=!1,this._textureExclusive[x.RGBA32UI]=!1,this._textureExclusive[x.DEPTH]=!1,this._textureExclusive[x.DEPTH_STENCIL]=!1,e.EXT_color_buffer_float&&(this._formatFeatures[x.R32F]|=ge.RENDER_TARGET,this._formatFeatures[x.RG32F]|=ge.RENDER_TARGET,this._formatFeatures[x.RGBA32F]|=ge.RENDER_TARGET,this._textureExclusive[x.R32F]=!1,this._textureExclusive[x.RG32F]=!1,this._textureExclusive[x.RGBA32F]=!1),e.EXT_color_buffer_half_float&&(this._textureExclusive[x.R16F]=!1,this._textureExclusive[x.RG16F]=!1,this._textureExclusive[x.RGBA16F]=!1),e.OES_texture_float_linear&&(this._formatFeatures[x.RGB32F]|=ge.LINEAR_FILTER,this._formatFeatures[x.RGBA32F]|=ge.LINEAR_FILTER,this._formatFeatures[x.R32F]|=ge.LINEAR_FILTER,this._formatFeatures[x.RG32F]|=ge.LINEAR_FILTER),e.OES_texture_half_float_linear&&(this._formatFeatures[x.RGB16F]|=ge.LINEAR_FILTER,this._formatFeatures[x.RGBA16F]|=ge.LINEAR_FILTER,this._formatFeatures[x.R16F]|=ge.LINEAR_FILTER,this._formatFeatures[x.RG16F]|=ge.LINEAR_FILTER);var r=ge.SAMPLED_TEXTURE|ge.LINEAR_FILTER;e.WEBGL_compressed_texture_etc1&&(this._formatFeatures[x.ETC_RGB8]=r),e.WEBGL_compressed_texture_etc&&(this._formatFeatures[x.ETC2_RGB8]=r,this._formatFeatures[x.ETC2_RGBA8]=r,this._formatFeatures[x.ETC2_SRGB8]=r,this._formatFeatures[x.ETC2_SRGB8_A8]=r,this._formatFeatures[x.ETC2_RGB8_A1]=r,this._formatFeatures[x.ETC2_SRGB8_A1]=r),e.WEBGL_compressed_texture_s3tc&&(this._formatFeatures[x.BC1]=r,this._formatFeatures[x.BC1_ALPHA]=r,this._formatFeatures[x.BC1_SRGB]=r,this._formatFeatures[x.BC1_SRGB_ALPHA]=r,this._formatFeatures[x.BC2]=r,this._formatFeatures[x.BC2_SRGB]=r,this._formatFeatures[x.BC3]=r,this._formatFeatures[x.BC3_SRGB]=r),e.WEBGL_compressed_texture_pvrtc&&(this._formatFeatures[x.PVRTC_RGB2]=r,this._formatFeatures[x.PVRTC_RGBA2]=r,this._formatFeatures[x.PVRTC_RGB4]=r,this._formatFeatures[x.PVRTC_RGBA4]=r),e.WEBGL_compressed_texture_astc&&(this._formatFeatures[x.ASTC_RGBA_4X4]=r,this._formatFeatures[x.ASTC_RGBA_5X4]=r,this._formatFeatures[x.ASTC_RGBA_5X5]=r,this._formatFeatures[x.ASTC_RGBA_6X5]=r,this._formatFeatures[x.ASTC_RGBA_6X6]=r,this._formatFeatures[x.ASTC_RGBA_8X5]=r,this._formatFeatures[x.ASTC_RGBA_8X6]=r,this._formatFeatures[x.ASTC_RGBA_8X8]=r,this._formatFeatures[x.ASTC_RGBA_10X5]=r,this._formatFeatures[x.ASTC_RGBA_10X6]=r,this._formatFeatures[x.ASTC_RGBA_10X8]=r,this._formatFeatures[x.ASTC_RGBA_10X10]=r,this._formatFeatures[x.ASTC_RGBA_12X10]=r,this._formatFeatures[x.ASTC_RGBA_12X12]=r,this._formatFeatures[x.ASTC_SRGBA_4X4]=r,this._formatFeatures[x.ASTC_SRGBA_5X4]=r,this._formatFeatures[x.ASTC_SRGBA_5X5]=r,this._formatFeatures[x.ASTC_SRGBA_6X5]=r,this._formatFeatures[x.ASTC_SRGBA_6X6]=r,this._formatFeatures[x.ASTC_SRGBA_8X5]=r,this._formatFeatures[x.ASTC_SRGBA_8X6]=r,this._formatFeatures[x.ASTC_SRGBA_8X8]=r,this._formatFeatures[x.ASTC_SRGBA_10X5]=r,this._formatFeatures[x.ASTC_SRGBA_10X6]=r,this._formatFeatures[x.ASTC_SRGBA_10X8]=r,this._formatFeatures[x.ASTC_SRGBA_10X10]=r,this._formatFeatures[x.ASTC_SRGBA_12X10]=r,this._formatFeatures[x.ASTC_SRGBA_12X12]=r)},a.createCommandBuffer=function(e){var t=new(e.type===V.PRIMARY?Et:_t);return t.initialize(e),t},a.createSwapchain=function(e){var t=new xt;return this._swapchain=t,t.initialize(e),t},a.createBuffer=function(e){var t=new it;return t.initialize(e),t},a.createTexture=function(e){var t=new Bt;return t.initialize(e),t},a.createDescriptorSet=function(e){var t=new xe;return t.initialize(e),t},a.createShader=function(e){var t=new gt;return t.initialize(e),t},a.createInputAssembler=function(e){var t=new ct;return t.initialize(e),t},a.createRenderPass=function(e){var t=new St;return t.initialize(e),t},a.createFramebuffer=function(e){var t=new lt;return t.initialize(e),t},a.createDescriptorSetLayout=function(e){var t=new ft;return t.initialize(e),t},a.createPipelineLayout=function(e){var t=new ot;return t.initialize(e),t},a.createPipelineState=function(e){var t=new ht;return t.initialize(e),t},a.createQueue=function(e){var t=new At;return t.initialize(e),t},a.getSampler=function(e){var t=$.computeHash(e);return this._samplers.has(t)||this._samplers.set(t,new Tt(e,t)),this._samplers.get(t)},a.getSwapchains=function(){return[this._swapchain]},a.getGeneralBarrier=function(e){var t=de.computeHash(e);return this._generalBarrierss.has(t)||this._generalBarrierss.set(t,new de(e,t)),this._generalBarrierss.get(t)},a.getTextureBarrier=function(e){var t=Be.computeHash(e);return this._textureBarriers.has(t)||this._textureBarriers.set(t,new Be(e,t)),this._textureBarriers.get(t)},a.getBufferBarrier=function(e){var t=Ce.computeHash(e);return this._bufferBarriers.has(t)||this._bufferBarriers.set(t,new Ce(e,t)),this._bufferBarriers.get(t)},a.copyBuffersToTexture=function(e,t,r){st(this,e,t.gpuTexture,r)},a.copyTextureToBuffers=function(e,t,r){!function(e,t,r,s){var a=e.gl,i=e.stateCache,n=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,n);var u=0,_=0,l=1,c=1;switch(t.glTarget){case a.TEXTURE_2D:for(var f=0;f<s.length;f++){var o=s[f];a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,t.glTarget,t.glTexture,o.texSubres.mipLevel),u=o.texOffset.x,_=o.texOffset.y,l=o.texExtent.width,c=o.texExtent.height,a.readPixels(u,_,l,c,t.glFormat,t.glType,r[f])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}a.bindFramebuffer(a.FRAMEBUFFER,null),i.glFramebuffer=null,a.deleteFramebuffer(n)}(this,e.gpuTexture,t,r)},a.copyTexImagesToTexture=function(e,t,r){!function(e,t,r,s){var a=e.gl,i=e.stateCache.glTexUnits[e.stateCache.texUnit];i.glTexture!==r.glTexture&&(a.bindTexture(r.glTarget,r.glTexture),i.glTexture=r.glTexture);var n=0,u=0;switch(r.glTarget){case a.TEXTURE_2D:for(var _=0;_<s.length;_++){var l=s[_];a.texSubImage2D(a.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,r.glFormat,r.glType,t[n++])}break;case a.TEXTURE_CUBE_MAP:for(var c=0;c<s.length;c++){var f=s[c],o=f.texSubres.baseArrayLayer+f.texSubres.layerCount;for(u=f.texSubres.baseArrayLayer;u<o;++u)a.texSubImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+u,f.texSubres.mipLevel,f.texOffset.x,f.texOffset.y,r.glFormat,r.glType,t[n++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}r.flags&I.GEN_MIPMAP&&a.generateMipmap(r.glTarget)}(this,e,t.gpuTexture,r)},r(s,[{key:"gl",get:function(){return this._context}},{key:"extensions",get:function(){return this._swapchain.extensions}},{key:"stateCache",get:function(){return this._swapchain.stateCache}},{key:"nullTex2D",get:function(){return this._swapchain.nullTex2D}},{key:"nullTexCube",get:function(){return this._swapchain.nullTexCube}},{key:"textureExclusive",get:function(){return this._textureExclusive}},{key:"bindingMappings",get:function(){return this._bindingMappings}}]),s}(pe));o.WebGL2Device=Gt}}}));
