System.register(["./bits-b8bc8b22.js","./buffer-barrier-17698e09.js","./scene-asset-10397f71.js","./math-base-02e87bf8.js","./pipeline-state-manager-f4a950fe.js","./deprecated-dacf9914.js","./game-1e6d0834.js"],(function(e){"use strict";var a,t,r,n,s,i,o,d,l,u,c,m,g,R,E,p,f,h,N,T,A,v,w,S,_,C,L,D,P,O,b,y,I,M,U,F,G,H,x,V,B,W,j,z,Q,k,q,Y,J,X,K,Z,$,ee,ae,te,re,ne,se,ie,oe,de,le,ue,ce,me,ge,Re,Ee,pe,fe,he,Ne,Te,Ae,ve,we,Se,_e,Ce,Le,De,Pe,Oe,be,ye,Ie,Me,Ue,Fe,Ge,He,xe,Ve,Be,We,je,ze,Qe,ke,qe,Ye,Je,Xe,Ke,Ze,$e,ea,aa,ta,ra,na,sa,ia,oa,da,la,ua,ca;return{setters:[function(e){a=e.k,t=e.l,r=e.A,n=e.x,s=e.y,i=e.F,o=e.i},function(e){d=e.L,l=e.u,u=e.U,c=e.a8,m=e.c,g=e.a7,R=e.a0},function(e){E=e.bc,p=e.bd,f=e.b4,h=e.be,N=e.bf,T=e.bg,A=e.bh,v=e.b3,w=e.aZ,S=e.bi,_=e.bj,C=e.a_,L=e.bk,D=e.bl,P=e.bm,O=e.bn,b=e.bo,y=e.bp,I=e.bq,M=e.br,U=e.bs,F=e.bt,G=e.bu,H=e.bv,x=e.bw,V=e.bx,B=e.aF,W=e.ak,j=e.e,z=e.am,Q=e.by,k=e.bz,q=e.bA,Y=e.bB,J=e.bC,X=e.bD,K=e.c,Z=e.al,$=e.bE,ee=e.bF,ae=e.a2,te=e.bG,re=e.bH,ne=e.bI,se=e.bJ,ie=e.bK,oe=e.d,de=e.b,le=e.r,ue=e.q,ce=e.S,me=e.b9,ge=e.ad},function(e){Re=e.V,Ee=e.v,pe=e.a,fe=e.b,he=e.c,Ne=e.d,Te=e.Q,Ae=e.q,ve=e.M,we=e.e,Se=e.m,_e=e.A,Ce=e.S,Le=e.s,De=e.R,Pe=e.r,Oe=e.C,be=e.f,ye=e.E,Ie=e.g,Me=e.h,Ue=e.i,Fe=e.j,Ge=e.l,He=e.t,xe=e.k,Ve=e.n,Be=e.o,We=e.p,je=e.u,ze=e.w,Qe=e.x,ke=e.y,qe=e.z,Ye=e.B,Je=e.D,Xe=e.F,Ke=e.G,Ze=e.H,$e=e.I,ea=e.J,aa=e.L,ta=e.N,ra=e.O},function(e){na=e.r},function(e){sa=e.i,ia=e.S,oa=e.e,da=e.j,la=e.k,ua=e.L},function(e){ca=e.g}],execute:function(){e({a:xa,b:Va,c:Wa,d:Qa,e:ka,f:void 0,q:function(e){switch(e){case Sa.PER_INSTANCE:return"PER_INSTANCE";case Sa.PER_BATCH:return"PER_BATCH";case Sa.PER_QUEUE:return"PER_QUEUE";case Sa.PER_PASS:return"PER_PASS";case Sa.COUNT:return"COUNT";default:return""}},v:Ya});var ma=Object.freeze({__proto__:null,bits:a,Vec2:Re,v2:Ee,Vec3:pe,v3:fe,Vec4:he,v4:Ne,Quat:Te,quat:Ae,Mat3:ve,Mat4:we,mat4:Se,AffineTransform:_e,Size:Ce,size:Le,Rect:De,rect:Pe,Color:Oe,color:be,EPSILON:ye,equals:Ie,approx:Me,clamp:Ue,clamp01:Fe,lerp:Ge,toRadian:He,toDegree:xe,random:Ve,randomRange:Be,randomRangeInt:We,pseudoRandom:je,pseudoRandomRange:ze,pseudoRandomRangeInt:Qe,nextPow2:ke,repeat:qe,pingPong:Ye,inverseLerp:Je,absMaxComponent:Xe,absMax:Ke,enumerableProps:Ze,MATH_FLOAT_ARRAY:$e,MathBase:ea});e("m",ma);var ga=Object.freeze({__proto__:null,distance:E,enums:p,intersect:f,Line:h,Plane:N,Ray:T,Triangle:A,Sphere:v,AABB:w,OBB:S,Capsule:_,Frustum:C,Keyframe:L,AnimationCurve:D,get SplineMode(){return P},Spline:O,get ERaycastMode(){return b},line:y,plane:I,ray:M,triangle:U,sphere:F,aabb:G,obb:H,capsule:x,frustum:V});e("g",ga);var Ra={};aa(Ra,"vmath",[{name:"vec2",newName:"Vec2",target:ma,targetName:"math"},{name:"vec3",newName:"Vec3",target:ma,targetName:"math"},{name:"vec4",newName:"Vec4",target:ma,targetName:"math"},{name:"quat",newName:"Quat",target:ma,targetName:"math"},{name:"mat3",newName:"Mat3",target:ma,targetName:"math"},{name:"mat4",newName:"Mat4",target:ma,targetName:"math"},{name:"color4",newName:"Color",target:ma,targetName:"math"},{name:"rect",newName:"Rect",target:ma,targetName:"math"},{name:"approx",newName:"approx",target:ma,targetName:"math"},{name:"EPSILON",newName:"EPSILON",target:ma,targetName:"math"},{name:"equals",newName:"equals",target:ma,targetName:"math"},{name:"clamp",newName:"clamp",target:ma,targetName:"math"},{name:"clamp01",newName:"clamp01",target:ma,targetName:"math"},{name:"lerp",newName:"lerp",target:ma,targetName:"math"},{name:"toRadian",newName:"toRadian",target:ma,targetName:"math"},{name:"toDegree",newName:"toDegree",target:ma,targetName:"math"},{name:"random",newName:"random",target:ma,targetName:"math"},{name:"randomRange",newName:"randomRange",target:ma,targetName:"math"},{name:"randomRangeInt",newName:"randomRangeInt",target:ma,targetName:"math"},{name:"pseudoRandom",newName:"pseudoRandom",target:ma,targetName:"math"},{name:"pseudoRandomRangeInt",newName:"pseudoRandomRangeInt",target:ma,targetName:"math"},{name:"nextPow2",newName:"nextPow2",target:ma,targetName:"math"},{name:"repeat",newName:"repeat",target:ma,targetName:"math"},{name:"pingPong",newName:"pingPong",target:ma,targetName:"math"},{name:"inverseLerp",newName:"inverseLerp",target:ma,targetName:"math"}]),t.vmath=Ra,aa(sa.prototype,"Scheduler.prototype",[{name:"enableForTarget",newName:"enableForTarget",target:sa,targetName:"Scheduler"}]),aa(sa,"Scheduler",[{name:"PRIORITY_SYSTEM",newName:"System.Priority.SCHEDULER",customGetter:function(){return B.Priority.SCHEDULER}}]),ta(sa,"Scheduler",[{name:"PRIORITY_NON_SYSTEM",suggest:"Use enum` System.Priority` instead"}]),aa(ia.prototype,"SubModel.prototype",[{name:"subMeshData",newName:"subMesh"}]),ta(ia.prototype,"SubModel.prototype",[{name:"getSubModel",suggest:"Use `subModels[i]` instead"},{name:"subModelNum",suggest:"Use `subModels.length` instead"}]),aa(oa.prototype,"Root.prototype",[{name:"ui",newName:"batcher2D"}]),ra(ca,"game",[{name:"collisionMatrix"},{name:"groupList"}]),ra(da.prototype,"director",[{name:"calculateDeltaTime"},{name:"getDeltaTime",suggest:"Use game.deltaTime instead"},{name:"getTotalTime",suggest:"Use game.totalTime instead"},{name:"getCurrentTime",suggest:"Use game.frameStartTime instead"}]),ta(da.prototype,"director",[{name:"setAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getRunningScene",suggest:"please use getScene instead"},{name:"setDepthTest",suggest:"please use camera API instead"},{name:"setClearColor",suggest:"please use camera API instead"},{name:"getWinSize",suggest:"please use view.getVisibleSize instead"},{name:"getWinSizeInPixels"},{name:"purgeCachedData",suggest:"please use assetManager.releaseAll instead"},{name:"convertToGL"},{name:"convertToUI"}]);var Ea=[".png",".jpg",".bmp",".jpeg",".gif",".ico",".tiff",".webp",".image",".pvr",".pkm",".astc"],pa=[".mp3",".ogg",".wav",".m4a"];function fa(){return!0}var ha={transformURL:function(e){var a=se(e);if(!a)return e;var t=ie.find((function(e){return!!e.getAssetInfo(a)}));if(!t)return e;var r,n=t.getAssetInfo(a);if(!(r=e.startsWith(t.base+t.config.nativeBase)?n.nativeVer||"":n.ver||"")||-1!==e.indexOf(r))return e;var s=!1;if(".ttf"===j(e)&&(s=!0),s){var i=oe(e),o=de(e);e=i+"."+r+"/"+o}else e=e.replace(/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,})/,(function(e){return e+"."+r}));return e}},Na=e("C",function(){function e(){this._autoReleaseSetting=Object.create(null),this._parseLoadResArgs=ee}var a=e.prototype;return a.load=function(e,a,t){void 0===t&&void 0!==a&&(t=a,a=null);for(var r=Array.isArray(e)?e:[e],n=0;n<r.length;n++){var s=r[n];"string"==typeof s?r[n]={url:s,__isNative__:!0}:(s.type&&(s.ext="."+s.type,s.type=void 0),s.url&&(s.__isNative__=!0))}var i=[],o=[];W.loadAny(r,null,(function(e,t,r){r.content&&(Ea.includes(r.ext)?i.push(r.content):pa.includes(r.ext)&&o.push(r.content)),a&&a(e,t,r)}),(function(e,a){var n=null;if(!e){a=Array.isArray(a)?a:[a];for(var s=function(e){var t=a[e];if(!(t instanceof ae)){var n=t,s=r[e].url;i.includes(n)?te.create(s,t,".png",{},(function(t,r){n=a[e]=r})):o.includes(n)&&te.create(s,t,".mp3",{},(function(t,r){n=a[e]=r})),Q.add(s,n)}},d=0;d<a.length;d++)s(d);if(a.length>1){var l=Object.create(null);a.forEach((function(e){l[e._uuid]=e})),n={isCompleted:fa,_map:l}}else n=a[0]}t&&t(e,n)}))},a.getXMLHttpRequest=function(){return new XMLHttpRequest},a.getItem=function(e){return W.assets.has(e)?{content:W.assets.get(e)}:null},a.loadRes=function(e,a,t,r){var n=this._parseLoadResArgs(a,t,r),s=n.type,i=n.onProgress,o=n.onComplete,d=j(e);d&&!z.getInfoWithPath(e,s)&&(e=e.slice(0,-d.length)),z.load(e,s,i,o)},a.loadResArray=function(e,a,t,r){var n=this._parseLoadResArgs(a,t,r),s=n.type,i=n.onProgress,o=n.onComplete;e.forEach((function(a,t){var r=j(a);r&&!z.getInfoWithPath(a,s)&&(e[t]=a.slice(0,-r.length))})),z.load(e,s,i,o)},a.loadResDir=function(e,a,t,r){var n=this._parseLoadResArgs(a,t,r),s=n.type,i=n.onProgress,o=n.onComplete;z.loadDir(e,s,i,(function(a,t){var r=[];a||(r=z.getDirWithPath(e,s).map((function(e){return e.path}))),o&&o(a,t,r)}))},a.getRes=function(e,a){return Q.has(e)?Q.get(e):z.get(e,a)},a.getResCount=function(){return Q.count},a.getDependsRecursively=function(e){if(!e)return[];var a="string"==typeof e?e:e._uuid;return k.getDepsRecursively(a).concat([a])},a.addDownloadHandlers=function(e){var a=Object.create(null),t=function(t){var r=e[t];a["."+t]=function(e,a,t){r({url:e},t)}};for(var r in e)t(r);q.register(a)},a.addLoadHandlers=function(e){var a=Object.create(null),t=function(t){var r=e[t];a["."+t]=function(e,a,t){r({content:e},t)}};for(var r in e)t(r);Y.register(a)},a.release=function(e){if(Array.isArray(e))for(var a=0;a<e.length;a++){var t=e[a];"string"==typeof t&&(t=Q.get(t)),W.releaseAsset(t)}else e&&("string"==typeof e&&(e=Q.get(e)),W.releaseAsset(e))},a.releaseAsset=function(e){W.releaseAsset(e)},a.releaseRes=function(e,a){z.release(e,a)},a.releaseAll=function(){W.releaseAll(),Q.clear()},a.removeItem=function(e){return!!Q.remove(e)},a.setAutoRelease=function(e,a){"object"==typeof e&&(e=e._uuid),this._autoReleaseSetting[e]=!!a},a.setAutoReleaseRecursively=function(e,a){"object"==typeof e&&(e=e._uuid),a=!!a,this._autoReleaseSetting[e]=a;for(var t=k.getDepsRecursively(e),r=0;r<t.length;r++)this._autoReleaseSetting[t[r]]=a},a.isAutoRelease=function(e){return"object"==typeof e&&(e=e._uuid),!!this._autoReleaseSetting[e]},r(e,[{key:"onProgress",set:function(e){re(e)}},{key:"_cache",get:function(){if(Q instanceof ne)return Q._map;var e={};return Q.forEach((function(a,t){e[t]=a})),e}},{key:"md5Pipe",get:function(){return ha}},{key:"downloader",get:function(){return q}},{key:"loader",get:function(){return W.parser}}]),e}()),Ta=e("l",new Na),Aa=e("A",{init:function(e){e.importBase=e.libraryPath,e.nativeBase=e.rawAssetsBase,W.init(e),e.rawAssets&&z.init({base:"",deps:[],scenes:{},redirect:[],debug:!0,packs:{},types:[],versions:{import:[],native:[]},name:J.RESOURCES,importBase:e.importBase,nativeBase:e.nativeBase,paths:e.rawAssets.assets,uuids:Object.keys(e.rawAssets.assets),extensionMap:{}})},loadAsset:function(e,a){W.loadAny(e,a)}}),va=e("u",{});aa(va,"url",[{name:"normalize",target:W.utils,targetName:"assetManager.utils",newName:"normalize"},{name:"raw",targetName:"Asset.prototype",newName:"nativeUrl",customFunction:function(e){return e.startsWith("resources/")?X({path:K(e.substr(10)),bundle:J.RESOURCES,__isNative__:!0,ext:j(e)}):""}}]),ta(Aa,"AssetLibrary",[{name:"getLibUrlNoExt",suggest:"AssetLibrary.getLibUrlNoExt was removed, if you want to transform url, please use assetManager.utils.getUrlWithUuid instead"},{name:"queryAssetInfo",suggest:"AssetLibrary.queryAssetInfo was removed"}]),ta(Ta,"loader",[{name:"releaseResDir",suggest:"loader.releaseResDir was removed, please use assetManager.releaseAsset instead"},{name:"flowInDeps",suggest:"loader.flowInDeps was removed"},{name:"assetLoader",suggest:"loader.assetLoader was removed, assetLoader and md5Pipe were merged into assetManager.transformPipeline"}]),aa(t,"cc",[{name:"loader",newName:"assetManager",logTimes:1,customGetter:function(){return Ta}},{name:"AssetLibrary",newName:"assetManager",logTimes:1,customGetter:function(){return Aa}},{name:"Pipeline",target:Z,targetName:"AssetManager",newName:"Pipeline",logTimes:1},{name:"url",targetName:"assetManager",newName:"utils",logTimes:1,customGetter:function(){return va}}]),ta(t,"cc",[{name:"LoadingItems",suggest:n(1400,"LoadingItems","AssetManager.Task")}]),aa(s,"macro",[{name:"DOWNLOAD_MAX_CONCURRENT",target:q,targetName:"assetManager.downloader",newName:"maxConcurrency"}]),aa(la,"director",[{name:"_getSceneUuid",targetName:"assetManager.main",newName:"getSceneInfo",customFunction:function(e){var a;return W.main?null===(a=W.main.getSceneInfo(e))||void 0===a?void 0:a.uuid:""}}]),aa(ca,"game",[{name:"_sceneInfos",targetName:"assetManager.main",newName:"getSceneInfo",customGetter:function(){var e=[];return W.main&&W.main.config.scenes.forEach((function(a){e.push(a)})),e}}]);var wa=$._autoRelease;$._autoRelease=function(e,a,t){wa.call($,e,a,t);for(var r=Ta._autoReleaseSetting,n=Object.keys(r),s=0;s<n.length;s++){var i=n[s];if(!0===r[i]){var o=Q.get(i);o&&$.tryRelease(o)}}};var Sa=e("U",{PER_INSTANCE:0,PER_BATCH:1,PER_QUEUE:2,PER_PASS:3,COUNT:4});e("P",{CONSTANTS:0,CBV:1,UAV:2,SRV:3,TABLE:4,SSV:5});var _a,Ca,La,Da,Pa=e("i",{MANAGED:0,MEMORYLESS:1,PERSISTENT:2,EXTERNAL:3,BACKBUFFER:4}),Oa=e("Q",{NONE:0,RENDER_OPAQUE:1,RENDER_CUTOUT:2,RENDER_TRANSPARENT:3}),ba=(e("R",{BUFFER:0,TEXTURE1D:1,TEXTURE2D:2,TEXTURE3D:3}),e("h",{NONE:0,UNIFORM:1,INDIRECT:2,STORAGE:4,SAMPLED:8,COLOR_ATTACHMENT:16,DEPTH_STENCIL_ATTACHMENT:32,INPUT_ATTACHMENT:64}),e("T",{SYNC:0,ASYNC:1}),e("S",{NONE:0,OPAQUE_OBJECT:1,CUTOUT_OBJECT:2,TRANSPARENT_OBJECT:4,SHADOW_CASTER:8,UI:16,DEFAULT_LIGHTING:32,VOLUMETRIC_LIGHTING:64,CLUSTERED_LIGHTING:128,PLANAR_SHADOW:256,GEOMETRY:512,PROFILER:1024,ALL:4294967295})),ya=(e("t",{NONE:0,DEFAULT:1,CLUSTERED:2}),e("o",{RENDER_TARGET:0,DEPTH_STENCIL:1})),Ia=e("p",{READ:0,READ_WRITE:1,WRITE:2}),Ma=function(e,a,t,r,n,s,i){void 0===e&&(e=""),void 0===a&&(a=Ia.WRITE),void 0===t&&(t=ya.RENDER_TARGET),void 0===r&&(r=d.LOAD),void 0===n&&(n=l.STORE),void 0===s&&(s=u.ALL),void 0===i&&(i=new c),this.slotName=void 0,this.accessType=void 0,this.attachmentType=void 0,this.loadOp=void 0,this.storeOp=void 0,this.clearFlags=void 0,this.clearColor=void 0,this.slotName=e,this.accessType=a,this.attachmentType=t,this.loadOp=r,this.storeOp=n,this.clearFlags=s,this.clearColor=i},Ua=function(){this.name="",this.accessType=Ia.READ,this.clearFlags=u.NONE,this.clearColor=new c,this.clearValueType=0},Fa=e("L",(function(e,a){void 0===e&&(e=null),void 0===a&&(a=0),this.light=void 0,this.level=void 0,this.light=e,this.level=a})),Ga=function(){},Ha=(i((function(){return Da.apply(this,arguments)||this}),Da=Ga),i((function(){return La.apply(this,arguments)||this}),La=Ga),i((function(){return Ca.apply(this,arguments)||this}),Ca=Ga),i((function(){return _a.apply(this,arguments)||this}),_a=Ga),e("M",(function(){})),e("s",(function(){})),e("n",(function(){})),e("j",(function(){})),e("k",(function(){})),e("r",(function(){})),e("w",function(e){function a(){return e.apply(this,arguments)||this}return i(a,e),a}((function(){}))),function(){});function xa(e,a,t,r,n){void 0===r&&(r=null),void 0===n&&(n=0);var s=new R,i=e.viewport,o=a,d=t;if(s.x=i.x*o,s.y=i.y*d,s.width=i.width*o,s.height=i.height*d,r)switch(r.type){case ua.DIRECTIONAL:var l=r;l.shadowFixedArea||l.csmLevel===le.LEVEL_1?(s.x=0,s.y=0,s.width=o,s.height=d):(s.x=n%2*.5*o,s.y=.5*(1-Math.floor(n/2))*d,s.width=.5*o,s.height=.5*d);break;case ua.SPOT:s.x=0,s.y=0,s.width=o,s.height=d}return s}function Va(e,a,t,r,n,s,i){var o=a.device,R=e;if(!a.containsResource(R)){var E=na(o)?m.R32F:m.RGBA8;a.addRenderTarget(R,E,s,i,Pa.MANAGED),a.addDepthStencil(R+"Depth",m.DEPTH_STENCIL,s,i,Pa.MANAGED)}var p=a.addRasterPass(s,i,"default",e);p.addRasterView(R,new Ma("_",Ia.WRITE,ya.RENDER_TARGET,d.CLEAR,l.STORE,u.COLOR,new c(1,1,1,t.clearColor.w))),p.addRasterView(R+"Depth",new Ma("_",Ia.WRITE,ya.DEPTH_STENCIL,d.CLEAR,l.DISCARD,u.DEPTH_STENCIL,new c(t.clearDepth,t.clearStencil,0,0)));var f=xa(t,s,i,r,n);p.setViewport(new g(f.x,f.y,f.width,f.height)),p.addQueue(Oa.RENDER_OPAQUE).addSceneOfCamera(t,new Fa(r,n),ba.SHADOW_CASTER)}var Ba=function(){this.shadowEnabled=!1,this.mainLightShadowNames=new Array,this.spotLightShadowNames=new Array};function Wa(e,a,t){var r=t,n=r.pipelineSceneData.shadows,s=t.pipelineSceneData.validPunctualLights,i=new Ba,o=t.pipelineSceneData.shadows;if(!n.enabled||n.type!==ue.ShadowMap)return i;i.shadowEnabled=!0;for(var d=[],l=0,u=0;l<n.maxReceived&&u<s.length;){var c=s[u];c.type===ua.SPOT&&c.shadowEnabled&&(d.push(c),l++),u++}var m=a.scene.mainLight,g=o.size.x,R=o.size.y;if(m&&m.shadowEnabled)if(i.mainLightShadowNames[0]="MainLightShadow"+e,m.shadowFixedArea)Va(i.mainLightShadowNames[0],t,a,m,0,g,R);else for(var E=r.pipelineSceneData.csmSupported?m.csmLevel:1,p=0;p<E;p++)i.mainLightShadowNames[p]="MainLightShadow"+e,Va(i.mainLightShadowNames[p],t,a,m,p,g,R);for(var f=0;f<d.length;f++){var h=d[f],N="SpotLightShadow"+f.toString()+e;i.spotLightShadowNames[f]=N,Va(N,t,a,h,0,g,R)}return i}var ja,za=[];function Qa(e){return za.includes(e)||za.push(e),za.indexOf(e)}function ka(e,a){var t=d.CLEAR;return e&u.COLOR||a!==ya.RENDER_TARGET||(t=e&ce?d.DISCARD:d.LOAD),(e&u.DEPTH_STENCIL)!==u.DEPTH_STENCIL&&a===ya.DEPTH_STENCIL&&(e&u.DEPTH||(t=d.LOAD),e&u.STENCIL||(t=d.LOAD)),t}e("F",function(e){function a(){return e.apply(this,arguments)||this}return i(a,e),a.prototype.setup=function(e,a){for(var t=0;t<e.length;t++){var r=e[t];if(null!==r.scene){Ya(a,r);var n=Qa(r),s="Camera"+n,i=Wa(s,r,a),d=r.window.width,u=r.window.height,g="dsForwardPassColor"+s,R="dsForwardPassDS"+s;a.containsResource(g)||(a.addRenderTexture(g,m.RGBA8,d,u,r.window),a.addDepthStencil(R,m.DEPTH_STENCIL,d,u,Pa.MANAGED));for(var E,p=a.addRasterPass(d,u,"default","CameraForwardPass"+n),f=o(i.mainLightShadowNames);!(E=f()).done;){var h=E.value;if(a.containsResource(h)){var N=new Ua;p.addComputeView(h,N)}}for(var T,A=o(i.spotLightShadowNames);!(T=A()).done;){var v=T.value;if(a.containsResource(v)){var w=new Ua;p.addComputeView(v,w)}}var S=new Ma("_",Ia.WRITE,ya.RENDER_TARGET,ka(r.clearFlag,ya.RENDER_TARGET),l.STORE,r.clearFlag,new c(r.clearColor.x,r.clearColor.y,r.clearColor.z,r.clearColor.w)),_=new Ma("_",Ia.WRITE,ya.DEPTH_STENCIL,ka(r.clearFlag,ya.DEPTH_STENCIL),l.STORE,r.clearFlag,new c(r.clearDepth,r.clearStencil,0,0));p.addRasterView(g,S),p.addRasterView(R,_),p.addQueue(Oa.RENDER_OPAQUE).addSceneOfCamera(r,new Fa,ba.OPAQUE_OBJECT|ba.PLANAR_SHADOW|ba.CUTOUT_OBJECT|ba.PLANAR_SHADOW|ba.DEFAULT_LIGHTING),p.addQueue(Oa.RENDER_TRANSPARENT).addSceneOfCamera(r,new Fa,ba.TRANSPARENT_OBJECT|ba.UI|ba.GEOMETRY|ba.PROFILER)}}},a}(Ha)),function(e){e[e.NONE=0]="NONE",e[e.FXAA=1]="FXAA"}(ja||(ja=e("f",{})));var qa=function(){this._deferredLightingMaterial=void 0,this._deferredPostMaterial=void 0,this._antiAliasing=ja.NONE,this._deferredLightingMaterial=new ge,this._deferredLightingMaterial.name="builtin-deferred-material",this._deferredLightingMaterial.initialize({effectName:"pipeline/deferred-lighting",defines:{CC_RECEIVE_SHADOW:1}});for(var e=0;e<this._deferredLightingMaterial.passes.length;++e)this._deferredLightingMaterial.passes[e].tryCompile();this._deferredPostMaterial=new ge,this._deferredPostMaterial.name="builtin-post-process-material",s.ENABLE_ANTIALIAS_FXAA&&(this._antiAliasing=ja.FXAA),this._deferredPostMaterial.initialize({effectName:"pipeline/post-process",defines:{ANTIALIAS_TYPE:this._antiAliasing}});for(var a=0;a<this._deferredPostMaterial.passes.length;++a)this._deferredPostMaterial.passes[a].tryCompile()};function Ya(e,a){var t=e.pipelineSceneData.validPunctualLights;t.length=0;for(var r=v.create(0,0,0,1),n=a.scene.spotLights,s=0;s<n.length;s++){var i=n[s];i.baked||(v.set(r,i.position.x,i.position.y,i.position.z,i.range),f.sphereFrustum(r,a.frustum)&&t.push(i))}for(var o=a.scene.sphereLights,d=0;d<o.length;d++){var l=o[d];l.baked||(v.set(r,l.position.x,l.position.y,l.position.z,l.range),f.sphereFrustum(r,a.frustum)&&t.push(l))}}e("D",function(e){function a(){for(var a,t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n];return(a=e.call.apply(e,[this].concat(r))||this)._deferredData=new qa,a}return i(a,e),a.prototype.setup=function(e,a){for(var t=0;t<e.length;++t){var r=e[t];if(r.scene){Ya(a,r);var n=Qa(r),s=Wa("Camera"+n,r,a),i=r.window.width,g=r.window.height,R="dsDeferredPassColorCamera",E="deferredGbufferPassNormal",p="deferredGbufferPassEmissive",f="dsDeferredPassDSCamera";if(!a.containsResource(R)){var h=m.RGBA16F;a.addRenderTarget(R,h,i,g,Pa.MANAGED),a.addRenderTarget(E,h,i,g,Pa.MANAGED),a.addRenderTarget(p,h,i,g,Pa.MANAGED),a.addDepthStencil(f,m.DEPTH_STENCIL,i,g,Pa.MANAGED)}var N=a.addRasterPass(i,g,"Geometry","CameraGbufferPass"+n),T=new c(0,0,0,0);r.clearFlag&u.COLOR&&(a.pipelineSceneData.isHDR?me(T,r.clearColor):(T.x=r.clearColor.x,T.y=r.clearColor.y,T.z=r.clearColor.z));var A=new Ma("_",Ia.WRITE,ya.RENDER_TARGET,d.CLEAR,l.STORE,r.clearFlag,T),v=new Ma("_",Ia.WRITE,ya.RENDER_TARGET,d.CLEAR,l.STORE,r.clearFlag,new c(0,0,0,0)),w=new Ma("_",Ia.WRITE,ya.RENDER_TARGET,d.CLEAR,l.STORE,r.clearFlag,new c(0,0,0,0)),S=new Ma("_",Ia.WRITE,ya.DEPTH_STENCIL,d.CLEAR,l.STORE,r.clearFlag,new c(r.clearDepth,r.clearStencil,0,0));N.addRasterView(R,A),N.addRasterView(E,v),N.addRasterView(p,w),N.addRasterView(f,S),N.addQueue(Oa.RENDER_OPAQUE).addSceneOfCamera(r,new Fa,ba.OPAQUE_OBJECT|ba.CUTOUT_OBJECT);var _="deferredLightingPassRTName";a.containsResource(_)||(a.addRenderTarget(_,m.RGBA8,i,g,Pa.MANAGED),a.addDepthStencil("deferredLightingPassDS",m.DEPTH_STENCIL,i,g,Pa.MANAGED));for(var C,L=a.addRasterPass(i,g,"Lighting","CameraLightingPass"+n),D=o(s.mainLightShadowNames);!(C=D()).done;){var P=C.value;if(a.containsResource(P)){var O=new Ua;L.addComputeView(P,O)}}for(var b,y=o(s.spotLightShadowNames);!(b=y()).done;){var I=b.value;if(a.containsResource(I)){var M=new Ua;L.addComputeView(I,M)}}if(a.containsResource(R)){var U=new Ua;U.name="gbuffer_albedoMap",L.addComputeView(R,U);var F=new Ua;F.name="gbuffer_normalMap",L.addComputeView(E,F);var G=new Ua;G.name="gbuffer_emissiveMap",L.addComputeView(p,G);var H=new Ua;H.name="depth_stencil",L.addComputeView(f,H)}var x=new c(0,0,0,0);r.clearFlag&u.COLOR&&(x.x=r.clearColor.x,x.y=r.clearColor.y,x.z=r.clearColor.z),x.w=0;var V=new Ma("_",Ia.WRITE,ya.RENDER_TARGET,d.CLEAR,l.STORE,r.clearFlag,x);L.addRasterView(_,V),L.addQueue(Oa.RENDER_TRANSPARENT).addCameraQuad(r,this._deferredData._deferredLightingMaterial,ba.VOLUMETRIC_LIGHTING),L.addQueue(Oa.RENDER_TRANSPARENT).addSceneOfCamera(r,new Fa,ba.TRANSPARENT_OBJECT|ba.PLANAR_SHADOW|ba.GEOMETRY);var B="postprocessPassRTName"+n,W="postprocessPassDS"+n;a.containsResource(B)||(a.addRenderTexture(B,m.RGBA8,i,g,r.window),a.addDepthStencil(W,m.DEPTH_STENCIL,i,g,Pa.MANAGED));var j=a.addRasterPass(i,g,"Postprocess","CameraPostprocessPass"+n);if(a.containsResource(_)){var z=new Ua;z.name="outputResultMap",j.addComputeView(_,z)}var Q=new c(0,0,0,r.clearColor.w);r.clearFlag&u.COLOR&&(Q.x=r.clearColor.x,Q.y=r.clearColor.y,Q.z=r.clearColor.z);var k=new Ma("_",Ia.WRITE,ya.RENDER_TARGET,ka(r.clearFlag,ya.RENDER_TARGET),l.STORE,r.clearFlag,Q),q=new Ma("_",Ia.WRITE,ya.DEPTH_STENCIL,ka(r.clearFlag,ya.DEPTH_STENCIL),l.STORE,r.clearFlag,new c(r.clearDepth,r.clearStencil,0,0));j.addRasterView(B,k),j.addRasterView(W,q),j.addQueue(Oa.NONE).addFullscreenQuad(this._deferredData._deferredPostMaterial,ba.NONE),j.addQueue(Oa.RENDER_TRANSPARENT).addSceneOfCamera(r,new Fa,ba.UI|ba.PROFILER)}}},a}(Ha)),t.math=ma,t.geometry=ga}}}));
