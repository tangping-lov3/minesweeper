System.register(["./bits-b8bc8b22.js","./buffer-barrier-17698e09.js","./scene-asset-10397f71.js","./math-base-02e87bf8.js","./index-f2c2eec3.js","./pipeline-state-manager-f4a950fe.js","./deprecated-dacf9914.js","./deprecated-8c84be32.js","./touch-37ec7c16.js","./game-1e6d0834.js","./create-mesh-c5031db7.js","./mesh-20100c2c.js","./mesh-renderer-e0b504a7.js"],(function(t){"use strict";var e,i,s,a,r,h,n,o,c,_,u,f,d,l,m,v,g,p,E,w,D;return{setters:[function(t){e=t.A,i=t.F,s=t.z,a=t.S,r=t.l},function(t){h=t.ah,n=t.h,o=t.i,c=t.c,_=t.a6},function(t){u=t.a$,f=t.ao,d=t.ad,l=t.aF},function(t){m=t.U},function(){},function(t){v=t.d,g=t.c,p=t.a},function(t){E=t.k},function(){},function(){},function(){},function(t){w=t._},function(){},function(t){D=t.M}],execute:function(){var S,T=function(){function t(t,e,i){this._id=void 0,this._opts=void 0,this._accumStart=void 0,this._total=0,this._value=0,this._averageValue=0,this._accumValue=0,this._accumSamples=0,this._id=t,this._opts=e,this._accumStart=i}var i=t.prototype;return i.sample=function(t){this._average(this._value,t)},i.human=function(){var t=this._opts,e=t.average,i=t.isInteger,s=e?this._averageValue:this._value;return i?Math.round(s):Math.round(100*s)/100},i.alarm=function(){return this._opts.below&&this._value<this._opts.below||this._opts.over&&this._value>this._opts.over},i._average=function(t,e){if(void 0===e&&(e=0),this._opts.average){this._accumValue+=t,++this._accumSamples;var i=e;i-this._accumStart>=this._opts.average&&(this._averageValue=this._accumValue/this._accumSamples,this._accumValue=0,this._accumStart=i,this._accumSamples=0)}},e(t,[{key:"value",get:function(){return this._value},set:function(t){this._value=t}}]),t}(),N=u("cc.PerfCounter")(S=function(t){function e(e,i,s){var a;return(a=t.call(this,e,i,s)||this)._time=void 0,a._time=s,a}i(e,t);var s=e.prototype;return s.start=function(t){void 0===t&&(t=0),this._time=t},s.end=function(t){void 0===t&&(t=0),this._value=t-this._time,this._average(this._value)},s.tick=function(){this.end(),this.start()},s.frame=function(t){var e=t,i=e-this._time;this._total++,i>(this._opts.average||1e3)&&(this._value=1e3*this._total/i,this._total=0,this._time=e,this._average(this._value))},e}(T))||S,x="0123456789. ",R=500,F={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,".":10},b={fps:{desc:"Framerate (FPS)",below:30,average:R,isInteger:!0},draws:{desc:"Draw call",isInteger:!0},frame:{desc:"Frame time (ms)",min:0,max:50,average:R},instances:{desc:"Instance Count",isInteger:!0},tricount:{desc:"Triangle",isInteger:!0},logic:{desc:"Game Logic (ms)",min:0,max:50,average:R,color:"#080"},physics:{desc:"Physics (ms)",min:0,max:50,average:R},render:{desc:"Renderer (ms)",min:0,max:50,average:R,color:"#f90"},textureMemory:{desc:"GFX Texture Mem(M)"},bufferMemory:{desc:"GFX Buffer Mem(M)"}},P=t("Profiler",function(t){function e(){var e;return(e=t.call(this)||this)._stats=null,e._showFPS=!1,e._rootNode=null,e._device=null,e._swapchain=null,e._pipeline=null,e._meshRenderer=null,e._canvas=null,e._ctx=null,e._texture=null,e._region=new _,e._canvasArr=[],e._regionArr=[e._region],e.digitsData=null,e.offsetData=null,e.pass=null,e._canvasDone=!1,e._statsDone=!1,e._inited=!1,e._lineHeight=256/(Object.keys(b).length+1),e._wordHeight=0,e._eachNumWidth=0,e._totalLines=0,e.lastTime=0,e._canvas=document.createElement("canvas"),e._ctx=e._canvas.getContext("2d"),e._canvasArr.push(e._canvas),e}i(e,t);var u=e.prototype;return u.init=function(){s.querySettings(a.Category.PROFILING,"showFPS")?this.showStats():this.hideStats()},u.isShowingStats=function(){return this._showFPS},u.hideStats=function(){this._showFPS&&(this._rootNode&&(this._rootNode.active=!1),r.director.off(r.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),r.director.off(r.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),r.director.off(r.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),r.director.off(r.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),r.director.off(r.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),r.director.off(r.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!1,E.root.pipeline.profiler=null,r.game.config.showFPS=!1)},u.showStats=function(){if(!this._showFPS){if(!this._device){var t=r.director.root;this._device=v.gfxDevice,this._swapchain=t.mainWindow.swapchain,this._pipeline=t.pipeline}this.generateCanvas(),this.generateStats(),r.game.once(r.Game.EVENT_ENGINE_INITED,this.generateNode,this),r.game.on(r.Game.EVENT_RESTART,this.generateNode,this),this._rootNode&&(this._rootNode.active=!0),r.director.on(r.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),r.director.on(r.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),r.director.on(r.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),r.director.on(r.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),r.director.on(r.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),r.director.on(r.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!0,this._canvasDone=!0,this._statsDone=!0,r.game.config.showFPS=!0}},u.generateCanvas=function(){if(!this._canvasDone){this._ctx&&this._canvas&&(this._canvas.width=256,this._canvas.height=256,this._canvas.style.width=""+this._canvas.width,this._canvas.style.height=""+this._canvas.height,this._ctx.font="23px Arial",this._ctx.textBaseline="top",this._ctx.fillStyle="#fff",this._texture=this._device.createTexture(new h(n.TEX2D,o.SAMPLED|o.TRANSFER_DST,c.RGBA8,256,256)),this._region.texExtent.width=256,this._region.texExtent.height=256)}},u.generateStats=function(){if(!this._statsDone&&this._ctx&&this._canvas){this._stats=null;var t=performance.now();this._ctx.textAlign="left";var e=0;for(var i in b){var s=b[i];this._ctx.fillText(s.desc,0,e*this._lineHeight),s.counter=new N(i,s,t),e++}this._totalLines=e,this._wordHeight=this._totalLines*this._lineHeight/this._canvas.height;for(var a=0;a<x.length;++a){var r=this._ctx.measureText(x[a]).width;this._eachNumWidth=Math.max(this._eachNumWidth,r)}for(var h=0;h<x.length;++h)this._ctx.fillText(x[h],h*this._eachNumWidth,this._totalLines*this._lineHeight);this._eachNumWidth/=this._canvas.width,this._stats=b,this._canvasArr[0]=this._canvas,this._device.copyTexImagesToTexture(this._canvasArr,this._texture,this._regionArr)}},u.generateNode=function(){if(!this._rootNode||!this._rootNode.isValid){this._rootNode=new f("PROFILER_NODE"),this._rootNode._objFlags=r.Object.Flags.DontSave|r.Object.Flags.HideInHierarchy,r.game.addPersistRootNode(this._rootNode);var t=new f("Profiler_Root");t.parent=this._rootNode;for(var e=.4,i=e/this._totalLines,s=e/this._wordHeight,a=i/23,h=this._eachNumWidth*this._canvas.width*a,n=[0,e,0,s,e,0,s,0,0,0,0,0],o=[0,2,1,0,3,2],c=[0,0,-1,0,1,0,-1,0,1,this._wordHeight,-1,0,0,this._wordHeight,-1,0],_=0,u=0;u<this._totalLines;u++)for(var l=0;l<8;l++){n.push(s+l*h,e-u*i,0),n.push(s+(l+1)*h,e-u*i,0),n.push(s+(l+1)*h,e-(u+1)*i,0),n.push(s+l*h,e-(u+1)*i,0),_=4*(8*u+l+1),o.push(0+_,2+_,1+_,0+_,3+_,2+_);var m=8*u+l,v=Math.floor(m/4),p=m-4*v;c.push(0,this._wordHeight,v,p),c.push(this._eachNumWidth,this._wordHeight,v,p),c.push(this._eachNumWidth,1,v,p),c.push(0,1,v,p)}this._meshRenderer=t.addComponent(D),this._meshRenderer.mesh=w({positions:n,indices:o,colors:c});var E=new d;E.initialize({effectName:"util/profiler"});var S=this.pass=E.passes[0],T=S.getBinding("mainTexture"),N=S.getBinding("digits"),x=S.getBinding("offset");S.bindTexture(T,this._texture),this.digitsData=S.blocks[N],this.offsetData=S.blocks[x],this.offsetData[3]=-1,this._meshRenderer.material=E,this._meshRenderer.node.layer=g.Enum.PROFILER,this._inited=!0}},u.beforeUpdate=function(){if(this._stats){var t=performance.now();this._stats.frame.counter.start(t),this._stats.logic.counter.start(t)}},u.afterUpdate=function(){if(this._stats){var t=performance.now();r.director.isPaused()?this._stats.frame.counter.start(t):this._stats.logic.counter.end(t)}},u.beforePhysics=function(){if(this._stats){var t=performance.now();this._stats.physics.counter.start(t)}},u.afterPhysics=function(){if(this._stats){var t=performance.now();this._stats.physics.counter.end(t)}},u.beforeDraw=function(){if(this._stats&&this._inited){var t=this._swapchain.surfaceTransform,e=this._device.capabilities.clipSpaceSignY;if(t!==this.offsetData[3]){var i=m[t],s=-.9,a=-.9*e;p.isXR&&(s=-.5,a=-.5*e),this.offsetData[0]=s*i[0]+a*i[2],this.offsetData[1]=s*i[1]+a*i[3],this.offsetData[2]=this._eachNumWidth,this.offsetData[3]=t}this.pass._rootBufferDirty=!0,this._meshRenderer.model?E.root.pipeline.profiler=this._meshRenderer.model:E.root.pipeline.profiler=null;var r=performance.now();this._stats.render.counter.start(r)}},u.afterDraw=function(){if(this._stats&&this._inited){var t=performance.now();if(this._stats.frame.counter.end(t),this._stats.fps.counter.frame(t),this._stats.render.counter.end(t),!(t-this.lastTime<R)){this.lastTime=t;var e=this._device;this._stats.draws.counter.value=e.numDrawCalls,this._stats.instances.counter.value=e.numInstances,this._stats.bufferMemory.counter.value=e.memoryStatus.bufferSize/1048576,this._stats.textureMemory.counter.value=e.memoryStatus.textureSize/1048576,this._stats.tricount.counter.value=e.numTris;var i=0,s=this.digitsData;for(var a in this._stats){var r=this._stats[a];r.counter.sample(t);for(var h=r.counter.human().toString(),n=7;n>=0;n--){var o=8*i+n,c=h[h.length-(8-n)],_=F[c];void 0===_&&(_=11),s[o]=_}i++}}}},e}(l)),y=t("profiler",new P);E.registerSystem("profiler",y,0),r.profiler=y}}}));
