System.register(["./bits-b8bc8b22.js","./buffer-barrier-17698e09.js"],(function(e){"use strict";var t,r,s,a,i,n,u,l,_,o,c,f,h,E,T,g,d,R,A,S,p,C,B,m,x,b,P,F,v,G,O,y,I,D,L,M,N,w,U,k,X,H,V,W,z,K,Y,j,q,Z,Q,J,$,ee,te,re,se,ae,ie,ne,ue,le,_e,oe,ce,fe,he,Ee,Te,ge,de,Re,Ae,Se,pe,Ce,Be,me;return{setters:[function(e){t=e.F,r=e.A,s=e.f,a=e.e,i=e.t,n=e.ap,u=e.d,l=e.w,_=e.y,o=e.J,c=e.i,f=e.l},function(e){h=e.aU,E=e.aV,T=e.D,g=e.a0,d=e.U,R=e.aQ,A=e.ae,S=e.g,p=e.e,C=e.h,B=e.aT,m=e.aZ,x=e.c,b=e.L,P=e.s,F=e.G,v=e.H,G=e.j,O=e.b0,y=e.b1,I=e.a1,D=e.$,L=e.b2,M=e.am,N=e.T,w=e.C,U=e.t,k=e.B,X=e.I,H=e.N,V=e.a,W=e.b5,z=e.b6,K=e.aW,Y=e.b7,j=e.b8,q=e.be,Z=e.bf,Q=e.bg,J=e.m,$=e.bh,ee=e.bi,te=e.a7,re=e.b9,se=e.ba,ae=e.bc,ie=e.aY,ne=e.a_,ue=e.ah,le=e.i,_e=e.bj,oe=e.bt,ce=e.bu,fe=e.bG,he=e.a6,Ee=e.b4,Te=e.A,ge=e.aL,de=e.Q,Re=e.aK,Ae=e.F,Se=e.k,pe=e.bk,Ce=e.bl,Be=e.bD,me=e.b3}],execute:function(){var xe,be=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuDescriptorSet=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){this._layout=e.layout;var t=e.layout.gpuDescriptorSetLayout,r=t.bindings,s=t.descriptorIndices,a=t.descriptorCount;this._buffers=Array(a).fill(null),this._textures=Array(a).fill(null),this._samplers=Array(a).fill(null);var i=[];this._gpuDescriptorSet={gpuDescriptors:i,descriptorIndices:s};for(var n=0;n<r.length;++n)for(var u=r[n],l=0;l<u.count;l++)i.push({type:u.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})},a.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},a.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var e=this._gpuDescriptorSet.gpuDescriptors,t=0;t<e.length;++t)if(e[t].type&h){var r=this._buffers[t];r&&(e[t].gpuBuffer=r.gpuBuffer||r.gpuBufferView)}else e[t].type&E&&(this._textures[t]&&(e[t].gpuTexture=this._textures[t].gpuTexture),this._samplers[t]&&(e[t].gpuSampler=this._samplers[t].gpuSampler));this._isDirty=!1}},r(s,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),s}(T);!function(e){e[e.RGBA16F_EXT=34842]="RGBA16F_EXT",e[e.RGB16F_EXT=34843]="RGB16F_EXT",e[e.RGBA32F_EXT=34836]="RGBA32F_EXT",e[e.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",e[e.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",e[e.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",e[e.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",e[e.SRGB_EXT=35904]="SRGB_EXT",e[e.SRGB_ALPHA_EXT=35906]="SRGB_ALPHA_EXT",e[e.SRGB8_ALPHA8_EXT=35907]="SRGB8_ALPHA8_EXT",e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",e[e.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",e[e.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",e[e.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",e[e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",e[e.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",e[e.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",e[e.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",e[e.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(xe||(xe={}));var Pe=function(){function e(){}return e.setInstance=function(t){e._instance=t},r(e,null,[{key:"instance",get:function(){return e._instance}}]),e}();function Fe(e,t){switch(e){case x.R8:return t.UNSIGNED_BYTE;case x.R8SN:return t.BYTE;case x.R8UI:return t.UNSIGNED_BYTE;case x.R8I:return t.BYTE;case x.R16F:return xe.HALF_FLOAT_OES;case x.R16UI:return t.UNSIGNED_SHORT;case x.R16I:return t.SHORT;case x.R32F:return t.FLOAT;case x.R32UI:return t.UNSIGNED_INT;case x.R32I:return t.INT;case x.RG8:return t.UNSIGNED_BYTE;case x.RG8SN:return t.BYTE;case x.RG8UI:return t.UNSIGNED_BYTE;case x.RG8I:return t.BYTE;case x.RG16F:return xe.HALF_FLOAT_OES;case x.RG16UI:return t.UNSIGNED_SHORT;case x.RG16I:return t.SHORT;case x.RG32F:return t.FLOAT;case x.RG32UI:return t.UNSIGNED_INT;case x.RG32I:return t.INT;case x.RGB8:case x.SRGB8:return t.UNSIGNED_BYTE;case x.RGB8SN:return t.BYTE;case x.RGB8UI:return t.UNSIGNED_BYTE;case x.RGB8I:return t.BYTE;case x.RGB16F:return xe.HALF_FLOAT_OES;case x.RGB16UI:return t.UNSIGNED_SHORT;case x.RGB16I:return t.SHORT;case x.RGB32F:return t.FLOAT;case x.RGB32UI:return t.UNSIGNED_INT;case x.RGB32I:return t.INT;case x.BGRA8:case x.RGBA8:case x.SRGB8_A8:return t.UNSIGNED_BYTE;case x.RGBA8SN:return t.BYTE;case x.RGBA8UI:return t.UNSIGNED_BYTE;case x.RGBA8I:return t.BYTE;case x.RGBA16F:return xe.HALF_FLOAT_OES;case x.RGBA16UI:return t.UNSIGNED_SHORT;case x.RGBA16I:return t.SHORT;case x.RGBA32F:return t.FLOAT;case x.RGBA32UI:return t.UNSIGNED_INT;case x.RGBA32I:return t.INT;case x.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case x.R11G11B10F:return t.FLOAT;case x.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case x.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case x.RGB10A2:return t.UNSIGNED_BYTE;case x.RGB10A2UI:return t.UNSIGNED_INT;case x.RGB9E5:return t.UNSIGNED_BYTE;case x.DEPTH:return t.UNSIGNED_INT;case x.DEPTH_STENCIL:return xe.UNSIGNED_INT_24_8_WEBGL;case x.BC1:case x.BC1_SRGB:case x.BC2:case x.BC2_SRGB:case x.BC3:case x.BC3_SRGB:case x.BC4:return t.UNSIGNED_BYTE;case x.BC4_SNORM:return t.BYTE;case x.BC5:return t.UNSIGNED_BYTE;case x.BC5_SNORM:return t.BYTE;case x.BC6H_SF16:case x.BC6H_UF16:return t.FLOAT;case x.BC7:case x.BC7_SRGB:case x.ETC_RGB8:case x.ETC2_RGB8:case x.ETC2_SRGB8:case x.ETC2_RGB8_A1:case x.ETC2_SRGB8_A1:case x.EAC_R11:return t.UNSIGNED_BYTE;case x.EAC_R11SN:return t.BYTE;case x.EAC_RG11:return t.UNSIGNED_BYTE;case x.EAC_RG11SN:return t.BYTE;case x.PVRTC_RGB2:case x.PVRTC_RGBA2:case x.PVRTC_RGB4:case x.PVRTC_RGBA4:case x.PVRTC2_2BPP:case x.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case x.ASTC_RGBA_4X4:case x.ASTC_RGBA_5X4:case x.ASTC_RGBA_5X5:case x.ASTC_RGBA_6X5:case x.ASTC_RGBA_6X6:case x.ASTC_RGBA_8X5:case x.ASTC_RGBA_8X6:case x.ASTC_RGBA_8X8:case x.ASTC_RGBA_10X5:case x.ASTC_RGBA_10X6:case x.ASTC_RGBA_10X8:case x.ASTC_RGBA_10X10:case x.ASTC_RGBA_12X10:case x.ASTC_RGBA_12X12:case x.ASTC_SRGBA_4X4:case x.ASTC_SRGBA_5X4:case x.ASTC_SRGBA_5X5:case x.ASTC_SRGBA_6X5:case x.ASTC_SRGBA_6X6:case x.ASTC_SRGBA_8X5:case x.ASTC_SRGBA_8X6:case x.ASTC_SRGBA_8X8:case x.ASTC_SRGBA_10X5:case x.ASTC_SRGBA_10X6:case x.ASTC_SRGBA_10X8:case x.ASTC_SRGBA_10X10:case x.ASTC_SRGBA_12X10:case x.ASTC_SRGBA_12X12:default:return t.UNSIGNED_BYTE}}function ve(e,t){switch(e){case N.BOOL:return t.BOOL;case N.BOOL2:return t.BOOL_VEC2;case N.BOOL3:return t.BOOL_VEC3;case N.BOOL4:return t.BOOL_VEC4;case N.INT:return t.INT;case N.INT2:return t.INT_VEC2;case N.INT3:return t.INT_VEC3;case N.INT4:return t.INT_VEC4;case N.UINT:return t.UNSIGNED_INT;case N.FLOAT:return t.FLOAT;case N.FLOAT2:return t.FLOAT_VEC2;case N.FLOAT3:return t.FLOAT_VEC3;case N.FLOAT4:return t.FLOAT_VEC4;case N.MAT2:return t.FLOAT_MAT2;case N.MAT3:return t.FLOAT_MAT3;case N.MAT4:return t.FLOAT_MAT4;case N.SAMPLER2D:return t.SAMPLER_2D;case N.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),N.UNKNOWN}}function Ge(e){switch(e){case N.BOOL:case N.BOOL2:case N.BOOL3:case N.BOOL4:case N.INT:case N.INT2:case N.INT3:case N.INT4:case N.UINT:return Int32Array;case N.FLOAT:case N.FLOAT2:case N.FLOAT3:case N.FLOAT4:case N.MAT2:case N.MAT3:case N.MAT4:return Float32Array;default:return console.error("Unsupported GLType, convert to TypedArrayConstructor failed."),Float32Array}}function Oe(e,t){switch(e){case t.BOOL:return N.BOOL;case t.BOOL_VEC2:return N.BOOL2;case t.BOOL_VEC3:return N.BOOL3;case t.BOOL_VEC4:return N.BOOL4;case t.INT:return N.INT;case t.INT_VEC2:return N.INT2;case t.INT_VEC3:return N.INT3;case t.INT_VEC4:return N.INT4;case t.UNSIGNED_INT:return N.UINT;case t.FLOAT:return N.FLOAT;case t.FLOAT_VEC2:return N.FLOAT2;case t.FLOAT_VEC3:return N.FLOAT3;case t.FLOAT_VEC4:return N.FLOAT4;case t.FLOAT_MAT2:return N.MAT2;case t.FLOAT_MAT3:return N.MAT3;case t.FLOAT_MAT4:return N.MAT4;case t.SAMPLER_2D:return N.SAMPLER2D;case t.SAMPLER_CUBE:return N.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),N.UNKNOWN}}function ye(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function Ie(e,t){switch(e){case t.FLOAT_MAT2:return 2;case t.FLOAT_MAT3:return 3;case t.FLOAT_MAT4:return 4;default:return 1}}Pe._instance=null;var De,Le=[512,513,514,515,516,517,518,519],Me=[0,7680,7681,7682,7683,5386,34055,34056],Ne=[32774,32778,32779,32775,32776],we=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.COUNT=6]="COUNT"}(De||(De={}));var Ue=function(e){this.cmdType=void 0,this.refCount=0,this.cmdType=e},ke=function(e){function r(){var t;return(t=e.call(this,De.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,t.gpuFramebuffer=null,t.renderArea=new g,t.clearFlag=d.NONE,t.clearColors=[],t.clearDepth=1,t.clearStencil=0,t}return t(r,e),r.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},r}(Ue),Xe=function(e){function r(){var t;return(t=e.call(this,De.BIND_STATES)||this).gpuPipelineState=null,t.gpuInputAssembler=null,t.gpuDescriptorSets=[],t.dynamicOffsets=[],t.dynamicStates=new R,t}return t(r,e),r.prototype.clear=function(){this.gpuPipelineState=null,this.gpuDescriptorSets.length=0,this.gpuInputAssembler=null,this.dynamicOffsets.length=0},r}(Ue),He=function(e){function r(){var t;return(t=e.call(this,De.DRAW)||this).drawInfo=new A,t}return t(r,e),r.prototype.clear=function(){},r}(Ue),Ve=function(e){function r(){var t;return(t=e.call(this,De.UPDATE_BUFFER)||this).gpuBuffer=null,t.buffer=null,t.offset=0,t.size=0,t}return t(r,e),r.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},r}(Ue),We=function(e){function r(){var t;return(t=e.call(this,De.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,t.buffers=[],t.regions=[],t}return t(r,e),r.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},r}(Ue),ze=function(){function e(){this.cmds=new w(1),this.beginRenderPassCmds=new w(1),this.bindStatesCmds=new w(1),this.drawCmds=new w(1),this.updateBufferCmds=new w(1),this.copyBufferToTextureCmds=new w(1)}return e.prototype.clearCmds=function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()},e}();function Ke(e,t,r,s,a){if(t.usage&p.UNIFORM)ArrayBuffer.isView(r)?t.vf32.set(r,s/Float32Array.BYTES_PER_ELEMENT):t.vf32.set(new Float32Array(r),s/Float32Array.BYTES_PER_ELEMENT);else if(t.usage&p.INDIRECT){t.indirects.clearDraws();for(var i=r.drawInfos,n=0;n<i.length;++n)t.indirects.setDrawInfo(s+n,i[n])}else{var u=r,l=e.gl,_=e.stateCache;switch(t.glTarget){case l.ARRAY_BUFFER:e.extensions.useVAO&&_.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),_.glVAO=null),Ye.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(l.bindBuffer(l.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer);break;case l.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&_.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),_.glVAO=null),Ye.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer);break;default:return void console.error("Unsupported BufferType, update buffer failed.")}a===u.byteLength?l.bufferSubData(t.glTarget,s,u):l.bufferSubData(t.glTarget,s,u.slice(0,a))}}var Ye={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0},je=new g;function qe(e,t,r,s,a,i,n){var u=e.gl,l=e.stateCache,_=0;if(r&&(je.x=s.x<<r.lodLevel,je.y=s.y<<r.lodLevel,je.width=s.width<<r.lodLevel,je.height=s.height<<r.lodLevel),r&&t){l.glFramebuffer!==r.glFramebuffer&&(u.bindFramebuffer(u.FRAMEBUFFER,r.glFramebuffer),l.glFramebuffer=r.glFramebuffer),l.viewport.left===je.x&&l.viewport.top===je.y&&l.viewport.width===je.width&&l.viewport.height===je.height||(u.viewport(je.x,je.y,je.width,je.height),l.viewport.left=je.x,l.viewport.top=je.y,l.viewport.width=je.width,l.viewport.height=je.height),l.scissorRect.x===je.x&&l.scissorRect.y===je.y&&l.scissorRect.width===je.width&&l.scissorRect.height===je.height||(u.scissor(je.x,je.y,je.width,je.height),l.scissorRect.x=je.x,l.scissorRect.y=je.y,l.scissorRect.width=je.width,l.scissorRect.height=je.height);var o=a.length;e.extensions.WEBGL_draw_buffers||(o=1);for(var c=0;c<o;++c){var f=t.colorAttachments[c];if(f.format!==x.UNKNOWN)switch(f.loadOp){case b.LOAD:break;case b.CLEAR:l.bs.targets[0].blendColorMask!==P.ALL&&u.colorMask(!0,!0,!0,!0);var h=a[0];u.clearColor(h.x,h.y,h.z,h.w),_|=u.COLOR_BUFFER_BIT;break;case b.DISCARD:}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==x.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case b.LOAD:break;case b.CLEAR:l.dss.depthWrite||u.depthMask(!0),u.clearDepth(i),_|=u.DEPTH_BUFFER_BIT;break;case b.DISCARD:}if(B[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case b.LOAD:break;case b.CLEAR:l.dss.stencilWriteMaskFront||u.stencilMaskSeparate(u.FRONT,65535),l.dss.stencilWriteMaskBack||u.stencilMaskSeparate(u.BACK,65535),u.clearStencil(n),_|=u.STENCIL_BUFFER_BIT;break;case b.DISCARD:}}if(_&&u.clear(_),_&u.COLOR_BUFFER_BIT){var E=l.bs.targets[0].blendColorMask;if(E!==P.ALL){var T=(E&P.R)!==P.NONE,g=(E&P.G)!==P.NONE,d=(E&P.B)!==P.NONE,R=(E&P.A)!==P.NONE;u.colorMask(T,g,d,R)}}_&u.DEPTH_BUFFER_BIT&&!l.dss.depthWrite&&u.depthMask(!1),_&u.STENCIL_BUFFER_BIT&&(l.dss.stencilWriteMaskFront||u.stencilMaskSeparate(u.FRONT,0),l.dss.stencilWriteMaskBack||u.stencilMaskSeparate(u.BACK,0))}}function Ze(e,t,r,s,i,n){var u,l,_,o=e.gl,c=e.stateCache,f=t&&t.gpuShader,h=!1;if(t&&Ye.gpuPipelineState!==t){if(Ye.gpuPipelineState=t,Ye.glPrimitive=t.glPrimitive,t.gpuShader){var E=t.gpuShader.glProgram;c.glProgram!==E&&(o.useProgram(E),c.glProgram=E,h=!0)}var T=t.rs;if(T){if(c.rs.cullMode!==T.cullMode){switch(T.cullMode){case F.NONE:o.disable(o.CULL_FACE);break;case F.FRONT:o.enable(o.CULL_FACE),o.cullFace(o.FRONT);break;case F.BACK:o.enable(o.CULL_FACE),o.cullFace(o.BACK)}c.rs.cullMode=T.cullMode}var g=T.isFrontFaceCCW;c.rs.isFrontFaceCCW!==g&&(o.frontFace(g?o.CCW:o.CW),c.rs.isFrontFaceCCW=g),c.rs.depthBias===T.depthBias&&c.rs.depthBiasSlop===T.depthBiasSlop||(o.polygonOffset(T.depthBias,T.depthBiasSlop),c.rs.depthBias=T.depthBias,c.rs.depthBiasSlop=T.depthBiasSlop),c.rs.lineWidth!==T.lineWidth&&(o.lineWidth(T.lineWidth),c.rs.lineWidth=T.lineWidth)}var d=t.dss;d&&(c.dss.depthTest!==d.depthTest&&(d.depthTest?o.enable(o.DEPTH_TEST):o.disable(o.DEPTH_TEST),c.dss.depthTest=d.depthTest),c.dss.depthWrite!==d.depthWrite&&(o.depthMask(d.depthWrite),c.dss.depthWrite=d.depthWrite),c.dss.depthFunc!==d.depthFunc&&(o.depthFunc(Le[d.depthFunc]),c.dss.depthFunc=d.depthFunc),c.dss.stencilTestFront===d.stencilTestFront&&c.dss.stencilTestBack===d.stencilTestBack||(d.stencilTestFront||d.stencilTestBack?o.enable(o.STENCIL_TEST):o.disable(o.STENCIL_TEST),c.dss.stencilTestFront=d.stencilTestFront,c.dss.stencilTestBack=d.stencilTestBack),c.dss.stencilFuncFront===d.stencilFuncFront&&c.dss.stencilRefFront===d.stencilRefFront&&c.dss.stencilReadMaskFront===d.stencilReadMaskFront||(o.stencilFuncSeparate(o.FRONT,Le[d.stencilFuncFront],d.stencilRefFront,d.stencilReadMaskFront),c.dss.stencilFuncFront=d.stencilFuncFront,c.dss.stencilRefFront=d.stencilRefFront,c.dss.stencilReadMaskFront=d.stencilReadMaskFront),c.dss.stencilFailOpFront===d.stencilFailOpFront&&c.dss.stencilZFailOpFront===d.stencilZFailOpFront&&c.dss.stencilPassOpFront===d.stencilPassOpFront||(o.stencilOpSeparate(o.FRONT,Me[d.stencilFailOpFront],Me[d.stencilZFailOpFront],Me[d.stencilPassOpFront]),c.dss.stencilFailOpFront=d.stencilFailOpFront,c.dss.stencilZFailOpFront=d.stencilZFailOpFront,c.dss.stencilPassOpFront=d.stencilPassOpFront),c.dss.stencilWriteMaskFront!==d.stencilWriteMaskFront&&(o.stencilMaskSeparate(o.FRONT,d.stencilWriteMaskFront),c.dss.stencilWriteMaskFront=d.stencilWriteMaskFront),c.dss.stencilFuncBack===d.stencilFuncBack&&c.dss.stencilRefBack===d.stencilRefBack&&c.dss.stencilReadMaskBack===d.stencilReadMaskBack||(o.stencilFuncSeparate(o.BACK,Le[d.stencilFuncBack],d.stencilRefBack,d.stencilReadMaskBack),c.dss.stencilFuncBack=d.stencilFuncBack,c.dss.stencilRefBack=d.stencilRefBack,c.dss.stencilReadMaskBack=d.stencilReadMaskBack),c.dss.stencilFailOpBack===d.stencilFailOpBack&&c.dss.stencilZFailOpBack===d.stencilZFailOpBack&&c.dss.stencilPassOpBack===d.stencilPassOpBack||(o.stencilOpSeparate(o.BACK,Me[d.stencilFailOpBack],Me[d.stencilZFailOpBack],Me[d.stencilPassOpBack]),c.dss.stencilFailOpBack=d.stencilFailOpBack,c.dss.stencilZFailOpBack=d.stencilZFailOpBack,c.dss.stencilPassOpBack=d.stencilPassOpBack),c.dss.stencilWriteMaskBack!==d.stencilWriteMaskBack&&(o.stencilMaskSeparate(o.BACK,d.stencilWriteMaskBack),c.dss.stencilWriteMaskBack=d.stencilWriteMaskBack));var R=t.bs;if(R){c.bs.isA2C!==R.isA2C&&(R.isA2C?o.enable(o.SAMPLE_ALPHA_TO_COVERAGE):o.disable(o.SAMPLE_ALPHA_TO_COVERAGE),c.bs.isA2C=R.isA2C),c.bs.blendColor.x===R.blendColor.x&&c.bs.blendColor.y===R.blendColor.y&&c.bs.blendColor.z===R.blendColor.z&&c.bs.blendColor.w===R.blendColor.w||(o.blendColor(R.blendColor.x,R.blendColor.y,R.blendColor.z,R.blendColor.w),c.bs.blendColor.x=R.blendColor.x,c.bs.blendColor.y=R.blendColor.y,c.bs.blendColor.z=R.blendColor.z,c.bs.blendColor.w=R.blendColor.w);var A=R.targets[0],S=c.bs.targets[0];S.blend!==A.blend&&(A.blend?o.enable(o.BLEND):o.disable(o.BLEND),S.blend=A.blend),S.blendEq===A.blendEq&&S.blendAlphaEq===A.blendAlphaEq||(o.blendEquationSeparate(Ne[A.blendEq],Ne[A.blendAlphaEq]),S.blendEq=A.blendEq,S.blendAlphaEq=A.blendAlphaEq),S.blendSrc===A.blendSrc&&S.blendDst===A.blendDst&&S.blendSrcAlpha===A.blendSrcAlpha&&S.blendDstAlpha===A.blendDstAlpha||(o.blendFuncSeparate(we[A.blendSrc],we[A.blendDst],we[A.blendSrcAlpha],we[A.blendDstAlpha]),S.blendSrc=A.blendSrc,S.blendDst=A.blendDst,S.blendSrcAlpha=A.blendSrcAlpha,S.blendDstAlpha=A.blendDstAlpha),S.blendColorMask!==A.blendColorMask&&(o.colorMask((A.blendColorMask&P.R)!==P.NONE,(A.blendColorMask&P.G)!==P.NONE,(A.blendColorMask&P.B)!==P.NONE,(A.blendColorMask&P.A)!==P.NONE),S.blendColorMask=A.blendColorMask)}}if(t&&t.gpuPipelineLayout&&f){for(var p=f.glBlocks.length,C=t.gpuPipelineLayout.dynamicOffsetIndices,B=0;B<p;B++){var m=f.glBlocks[B],x=s[m.set],b=x&&x.descriptorIndices[m.binding],G=b>=0&&x.gpuDescriptors[b],O=null,y=0;if(G&&G.gpuBuffer){var I=G.gpuBuffer,D=C[m.set],L=D&&D[m.binding];L>=0&&(y=i[L]),"vf32"in I?O=I.vf32:(y+=I.offset,O=I.gpuBuffer.vf32),y>>=2}if(O)for(var M=m.glActiveUniforms.length,N=0;N<M;N++){var w=m.glActiveUniforms[N];switch(w.glType){case o.BOOL:case o.INT:for(var U=0;U<w.array.length;++U){var k=w.offset+y+U;if(O[k]!==w.array[U]){for(var X=U,H=k;X<w.array.length;++X,++H)w.array[X]=O[H];o.uniform1iv(w.glLoc,w.array);break}}break;case o.BOOL_VEC2:case o.INT_VEC2:for(var V=0;V<w.array.length;++V){var W=w.offset+y+V;if(O[W]!==w.array[V]){for(var z=V,K=W;z<w.array.length;++z,++K)w.array[z]=O[K];o.uniform2iv(w.glLoc,w.array);break}}break;case o.BOOL_VEC3:case o.INT_VEC3:for(var Y=0;Y<w.array.length;++Y){var j=w.offset+y+Y;if(O[j]!==w.array[Y]){for(var q=Y,Z=j;q<w.array.length;++q,++Z)w.array[q]=O[Z];o.uniform3iv(w.glLoc,w.array);break}}break;case o.BOOL_VEC4:case o.INT_VEC4:for(var Q=0;Q<w.array.length;++Q){var J=w.offset+y+Q;if(O[J]!==w.array[Q]){for(var $=Q,ee=J;$<w.array.length;++$,++ee)w.array[$]=O[ee];o.uniform4iv(w.glLoc,w.array);break}}break;case o.FLOAT:for(var te=0;te<w.array.length;++te){var re=w.offset+y+te;if(O[re]!==w.array[te]){for(var se=te,ae=re;se<w.array.length;++se,++ae)w.array[se]=O[ae];o.uniform1fv(w.glLoc,w.array);break}}break;case o.FLOAT_VEC2:for(var ie=0;ie<w.array.length;++ie){var ne=w.offset+y+ie;if(O[ne]!==w.array[ie]){for(var ue=ie,le=ne;ue<w.array.length;++ue,++le)w.array[ue]=O[le];o.uniform2fv(w.glLoc,w.array);break}}break;case o.FLOAT_VEC3:for(var _e=0;_e<w.array.length;++_e){var oe=w.offset+y+_e;if(O[oe]!==w.array[_e]){for(var ce=_e,fe=oe;ce<w.array.length;++ce,++fe)w.array[ce]=O[fe];o.uniform3fv(w.glLoc,w.array);break}}break;case o.FLOAT_VEC4:for(var he=0;he<w.array.length;++he){var Ee=w.offset+y+he;if(O[Ee]!==w.array[he]){for(var Te=he,ge=Ee;Te<w.array.length;++Te,++ge)w.array[Te]=O[ge];o.uniform4fv(w.glLoc,w.array);break}}break;case o.FLOAT_MAT2:for(var de=0;de<w.array.length;++de){var Re=w.offset+y+de;if(O[Re]!==w.array[de]){for(var Ae=de,Se=Re;Ae<w.array.length;++Ae,++Se)w.array[Ae]=O[Se];o.uniformMatrix2fv(w.glLoc,!1,w.array);break}}break;case o.FLOAT_MAT3:for(var pe=0;pe<w.array.length;++pe){var Ce=w.offset+y+pe;if(O[Ce]!==w.array[pe]){for(var Be=pe,me=Ce;Be<w.array.length;++Be,++me)w.array[Be]=O[me];o.uniformMatrix3fv(w.glLoc,!1,w.array);break}}break;case o.FLOAT_MAT4:for(var xe=0;xe<w.array.length;++xe){var be=w.offset+y+xe;if(O[be]!==w.array[xe]){for(var Pe=xe,Fe=be;Pe<w.array.length;++Pe,++Fe)w.array[Pe]=O[Fe];o.uniformMatrix4fv(w.glLoc,!1,w.array);break}}}}else a("Buffer binding '"+m.name+"' at set "+m.set+" binding "+m.binding+" is not bounded")}for(var ve=f.glSamplerTextures.length,Ge=0;Ge<ve;Ge++)for(var Oe=f.glSamplerTextures[Ge],ye=s[Oe.set],Ie=ye&&ye.descriptorIndices[Oe.binding],De=Ie>=0&&ye.gpuDescriptors[Ie],Ue=Oe.units.length,ke=0;ke<Ue;ke++){var Xe=Oe.units[ke];if(De&&De.gpuSampler){if(De.gpuTexture&&De.gpuTexture.size>0){var He=De.gpuTexture,Ve=c.glTexUnits[Xe];Ve.glTexture!==He.glTexture&&(c.texUnit!==Xe&&(o.activeTexture(o.TEXTURE0+Xe),c.texUnit=Xe),He.glTexture?o.bindTexture(He.glTarget,He.glTexture):o.bindTexture(He.glTarget,e.nullTex2D.gpuTexture.glTexture),Ve.glTexture=He.glTexture);var We=De.gpuSampler;He.isPowerOf2?(u=We.glWrapS,l=We.glWrapT):(u=o.CLAMP_TO_EDGE,l=o.CLAMP_TO_EDGE),_=He.isPowerOf2?He.mipLevel<=1&&(We.glMinFilter===o.LINEAR_MIPMAP_NEAREST||We.glMinFilter===o.LINEAR_MIPMAP_LINEAR)?o.LINEAR:We.glMinFilter:We.glMinFilter===o.LINEAR||We.glMinFilter===o.LINEAR_MIPMAP_NEAREST||We.glMinFilter===o.LINEAR_MIPMAP_LINEAR?o.LINEAR:o.NEAREST,He.glWrapS!==u&&(c.texUnit!==Xe&&(o.activeTexture(o.TEXTURE0+Xe),c.texUnit=Xe),o.texParameteri(He.glTarget,o.TEXTURE_WRAP_S,u),He.glWrapS=u),He.glWrapT!==l&&(c.texUnit!==Xe&&(o.activeTexture(o.TEXTURE0+Xe),c.texUnit=Xe),o.texParameteri(He.glTarget,o.TEXTURE_WRAP_T,l),He.glWrapT=l),He.glMinFilter!==_&&(c.texUnit!==Xe&&(o.activeTexture(o.TEXTURE0+Xe),c.texUnit=Xe),o.texParameteri(He.glTarget,o.TEXTURE_MIN_FILTER,_),He.glMinFilter=_),He.glMagFilter!==We.glMagFilter&&(c.texUnit!==Xe&&(o.activeTexture(o.TEXTURE0+Xe),c.texUnit=Xe),o.texParameteri(He.glTarget,o.TEXTURE_MAG_FILTER,We.glMagFilter),He.glMagFilter=We.glMagFilter)}De=ye.gpuDescriptors[++Ie]}else a("Sampler binding '"+Oe.name+"' at set "+Oe.set+" binding "+Oe.binding+" index "+ke+" is not bounded")}}if(r&&f&&(h||Ye.gpuInputAssembler!==r)){Ye.gpuInputAssembler=r;var ze=e.extensions.ANGLE_instanced_arrays;if(e.extensions.useVAO){var Ke=e.extensions.OES_vertex_array_object,je=r.glVAOs.get(f.glProgram);if(!je){var qe;je=Ke.createVertexArrayOES(),r.glVAOs.set(f.glProgram,je),Ke.bindVertexArrayOES(je),o.bindBuffer(o.ARRAY_BUFFER,null),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,null),c.glArrayBuffer=null,c.glElementArrayBuffer=null;for(var Ze=f.glInputs.length,Qe=0;Qe<Ze;Qe++){var Je=f.glInputs[Qe];qe=null;for(var $e=r.glAttribs.length,et=0;et<$e;et++){var tt=r.glAttribs[et];if(tt.name===Je.name){qe=tt;break}}if(qe){c.glArrayBuffer!==qe.glBuffer&&(o.bindBuffer(o.ARRAY_BUFFER,qe.glBuffer),c.glArrayBuffer=qe.glBuffer);for(var rt=0;rt<qe.componentCount;++rt){var st=Je.glLoc+rt,at=qe.offset+qe.size*rt;o.enableVertexAttribArray(st),c.glCurrentAttribLocs[st]=!0,o.vertexAttribPointer(st,qe.count,qe.glType,qe.isNormalized,qe.stride,at),ze&&ze.vertexAttribDivisorANGLE(st,qe.isInstanced?1:0)}}}var it=r.gpuIndexBuffer;it&&o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,it.glBuffer),Ke.bindVertexArrayOES(null),o.bindBuffer(o.ARRAY_BUFFER,null),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,null),c.glArrayBuffer=null,c.glElementArrayBuffer=null}c.glVAO!==je&&(Ke.bindVertexArrayOES(je),c.glVAO=je)}else{for(var nt=0;nt<e.capabilities.maxVertexAttributes;++nt)c.glCurrentAttribLocs[nt]=!1;for(var ut=f.glInputs.length,lt=0;lt<ut;lt++){for(var _t=f.glInputs[lt],ot=null,ct=r.glAttribs.length,ft=0;ft<ct;ft++){var ht=r.glAttribs[ft];if(ht.name===_t.name){ot=ht;break}}if(ot){c.glArrayBuffer!==ot.glBuffer&&(o.bindBuffer(o.ARRAY_BUFFER,ot.glBuffer),c.glArrayBuffer=ot.glBuffer);for(var Et=0;Et<ot.componentCount;++Et){var Tt=_t.glLoc+Et,gt=ot.offset+ot.size*Et;!c.glEnabledAttribLocs[Tt]&&Tt>=0&&(o.enableVertexAttribArray(Tt),c.glEnabledAttribLocs[Tt]=!0),c.glCurrentAttribLocs[Tt]=!0,o.vertexAttribPointer(Tt,ot.count,ot.glType,ot.isNormalized,ot.stride,gt),ze&&ze.vertexAttribDivisorANGLE(Tt,ot.isInstanced?1:0)}}}var dt=r.gpuIndexBuffer;dt&&c.glElementArrayBuffer!==dt.glBuffer&&(o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,dt.glBuffer),c.glElementArrayBuffer=dt.glBuffer);for(var Rt=0;Rt<e.capabilities.maxVertexAttributes;++Rt)c.glEnabledAttribLocs[Rt]!==c.glCurrentAttribLocs[Rt]&&(o.disableVertexAttribArray(Rt),c.glEnabledAttribLocs[Rt]=!1)}}if(t&&t.dynamicStates.length)for(var At=t.dynamicStates.length,St=0;St<At;St++)switch(t.dynamicStates[St]){case v.LINE_WIDTH:c.rs.lineWidth!==n.lineWidth&&(o.lineWidth(n.lineWidth),c.rs.lineWidth=n.lineWidth);break;case v.DEPTH_BIAS:c.rs.depthBias===n.depthBiasConstant&&c.rs.depthBiasSlop===n.depthBiasSlope||(o.polygonOffset(n.depthBiasConstant,n.depthBiasSlope),c.rs.depthBias=n.depthBiasConstant,c.rs.depthBiasSlop=n.depthBiasSlope);break;case v.BLEND_CONSTANTS:var pt=n.blendConstant;c.bs.blendColor.x===pt.x&&c.bs.blendColor.y===pt.y&&c.bs.blendColor.z===pt.z&&c.bs.blendColor.w===pt.w||(o.blendColor(pt.x,pt.y,pt.z,pt.w),c.bs.blendColor.copy(pt));break;case v.STENCIL_WRITE_MASK:var Ct=n.stencilStatesFront,Bt=n.stencilStatesBack;c.dss.stencilWriteMaskFront!==Ct.writeMask&&(o.stencilMaskSeparate(o.FRONT,Ct.writeMask),c.dss.stencilWriteMaskFront=Ct.writeMask),c.dss.stencilWriteMaskBack!==Bt.writeMask&&(o.stencilMaskSeparate(o.BACK,Bt.writeMask),c.dss.stencilWriteMaskBack=Bt.writeMask);break;case v.STENCIL_COMPARE_MASK:var mt=n.stencilStatesFront,xt=n.stencilStatesBack;c.dss.stencilRefFront===mt.reference&&c.dss.stencilReadMaskFront===mt.compareMask||(o.stencilFuncSeparate(o.FRONT,Le[c.dss.stencilFuncFront],mt.reference,mt.compareMask),c.dss.stencilRefFront=mt.reference,c.dss.stencilReadMaskFront=mt.compareMask),c.dss.stencilRefBack===xt.reference&&c.dss.stencilReadMaskBack===xt.compareMask||(o.stencilFuncSeparate(o.BACK,Le[c.dss.stencilFuncBack],xt.reference,xt.compareMask),c.dss.stencilRefBack=xt.reference,c.dss.stencilReadMaskBack=xt.compareMask)}}function Qe(e,t){var r=e.gl,s=e.extensions,a=s.ANGLE_instanced_arrays,i=s.WEBGL_multi_draw,n=Ye.gpuInputAssembler,u=Ye.glPrimitive;if(n){var l=n.gpuIndexBuffer;if(n.gpuIndirectBuffer){var _=n.gpuIndirectBuffer.indirects;if(_.drawByIndex){for(var o=0;o<_.drawCount;o++)_.byteOffsets[o]=_.offsets[o]*l.stride;if(i)_.instancedDraw?i.multiDrawElementsInstancedWEBGL(u,_.counts,0,n.glIndexType,_.byteOffsets,0,_.instances,0,_.drawCount):i.multiDrawElementsWEBGL(u,_.counts,0,n.glIndexType,_.byteOffsets,0,_.drawCount);else for(var c=0;c<_.drawCount;c++)_.instances[c]&&a?a.drawElementsInstancedANGLE(u,_.counts[c],n.glIndexType,_.byteOffsets[c],_.instances[c]):r.drawElements(u,_.counts[c],n.glIndexType,_.byteOffsets[c])}else if(i)_.instancedDraw?i.multiDrawArraysInstancedWEBGL(u,_.offsets,0,_.counts,0,_.instances,0,_.drawCount):i.multiDrawArraysWEBGL(u,_.offsets,0,_.counts,0,_.drawCount);else for(var f=0;f<_.drawCount;f++)_.instances[f]&&a?a.drawArraysInstancedANGLE(u,_.offsets[f],_.counts[f],_.instances[f]):r.drawArrays(u,_.offsets[f],_.counts[f])}else if(t.instanceCount&&a)if(l){if(t.indexCount>0){var h=t.firstIndex*l.stride;a.drawElementsInstancedANGLE(u,t.indexCount,n.glIndexType,h,t.instanceCount)}}else t.vertexCount>0&&a.drawArraysInstancedANGLE(u,t.firstVertex,t.vertexCount,t.instanceCount);else if(l){if(t.indexCount>0){var E=t.firstIndex*l.stride;r.drawElements(u,t.indexCount,n.glIndexType,E)}}else t.vertexCount>0&&r.drawArrays(u,t.firstVertex,t.vertexCount)}}var Je=new Array(De.COUNT);function $e(e,t){Je.fill(0);for(var r=0;r<t.cmds.length;++r){var s=t.cmds.array[r],a=Je[s]++;switch(s){case De.BEGIN_RENDER_PASS:var i=t.beginRenderPassCmds.array[a];qe(e,i.gpuRenderPass,i.gpuFramebuffer,i.renderArea,i.clearColors,i.clearDepth,i.clearStencil);break;case De.BIND_STATES:var n=t.bindStatesCmds.array[a];Ze(e,n.gpuPipelineState,n.gpuInputAssembler,n.gpuDescriptorSets,n.dynamicOffsets,n.dynamicStates);break;case De.DRAW:Qe(e,t.drawCmds.array[a].drawInfo);break;case De.UPDATE_BUFFER:var u=t.updateBufferCmds.array[a];Ke(e,u.gpuBuffer,u.buffer,u.offset,u.size);break;case De.COPY_BUFFER_TO_TEXTURE:var l=t.copyBufferToTextureCmds.array[a];rt(e,l.buffers,l.gpuTexture,l.regions)}}}var et=new Uint8Array(1);function tt(e,t,r,s,a){var i=y(t).height,n=m(t,a.width,a.height,a.depth),u=m(t,s.width,1,1),l=m(t,s.width,s.height,1),_=m(t,a.width,1,1),o=O(B[t]);et.byteLength<n&&(et=new Uint8Array(n));for(var c=0,f=r,h=0;h<a.depth;h++){f=r+l*h;for(var E=0;E<a.height;E+=i)et.subarray(c,c+_).set(new Uint8Array(e.buffer,e.byteOffset+f,_)),c+=_,f+=u}return new o(et.buffer)}function rt(e,t,r,s){var a=e.gl,i=e.stateCache.glTexUnits[e.stateCache.texUnit];i.glTexture!==r.glTexture&&(a.bindTexture(r.glTarget,r.glTexture),i.glTexture=r.glTexture);var n=0,u=0,l=B[r.format],_=O(l),o=l.isCompressed,c=y(r.format),f=new I,h=new D,E=new I;switch(r.glTarget){case a.TEXTURE_2D:for(var T=0;T<s.length;T++){var g=s[T],d=g.texSubres.mipLevel;h.x=0===g.texOffset.x?0:L(g.texOffset.x,c.width),h.y=0===g.texOffset.y?0:L(g.texOffset.y,c.height),f.width=g.texExtent.width<c.width?g.texExtent.width:L(g.texExtent.width,c.width),f.height=g.texExtent.height<c.height?g.texExtent.width:L(g.texExtent.height,c.height),E.width=g.buffStride>0?g.buffStride:f.width,E.height=g.buffTexHeight>0?g.buffTexHeight:f.height;var R,A=g.texExtent.width+h.x===r.width>>d?g.texExtent.width:f.width,S=g.texExtent.height+h.y===r.height>>d?g.texExtent.height:f.height,p=t[n++];R=E.width===f.width&&E.height===f.height?new _(p.buffer,p.byteOffset+g.buffOffset):tt(p,r.format,g.buffOffset,E,f),o?r.glInternalFmt===xe.COMPRESSED_RGB_ETC1_WEBGL||e.extensions.noCompressedTexSubImage2D?a.compressedTexImage2D(a.TEXTURE_2D,d,r.glInternalFmt,A,S,0,R):a.compressedTexSubImage2D(a.TEXTURE_2D,d,h.x,h.y,A,S,r.glFormat,R):a.texSubImage2D(a.TEXTURE_2D,d,h.x,h.y,A,S,r.glFormat,r.glType,R)}break;case a.TEXTURE_CUBE_MAP:for(var C=0;C<s.length;C++){var m=s[C],x=m.texSubres.mipLevel;h.x=0===m.texOffset.x?0:L(m.texOffset.x,c.width),h.y=0===m.texOffset.y?0:L(m.texOffset.y,c.height),f.width=m.texExtent.width<c.width?m.texExtent.width:L(m.texExtent.width,c.width),f.height=m.texExtent.height<c.height?m.texExtent.width:L(m.texExtent.height,c.height),E.width=m.buffStride>0?m.buffStride:f.width,E.height=m.buffTexHeight>0?m.buffTexHeight:f.height;var b=m.texExtent.width+h.x===r.width>>x?m.texExtent.width:f.width,P=m.texExtent.height+h.y===r.height>>x?m.texExtent.height:f.height,F=m.texSubres.baseArrayLayer+m.texSubres.layerCount;for(u=m.texSubres.baseArrayLayer;u<F;++u){var v,M=t[n++];v=E.width===f.width&&E.height===f.height?new _(M.buffer,M.byteOffset+m.buffOffset):tt(M,r.format,m.buffOffset,E,f),o?r.glInternalFmt===xe.COMPRESSED_RGB_ETC1_WEBGL||e.extensions.noCompressedTexSubImage2D?a.compressedTexImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+u,x,r.glInternalFmt,b,P,0,v):a.compressedTexSubImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+u,x,h.x,h.y,b,P,r.glFormat,v):a.texSubImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+u,x,h.x,h.y,b,P,r.glFormat,r.glType,v)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}r.flags&G.GEN_MIPMAP&&a.generateMipmap(r.glTarget)}var st=function(){function e(){this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}var t=e.prototype;return t.clearDraws=function(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1},t.setDrawInfo=function(e,t){this._ensureCapacity(e),this.drawByIndex=t.indexCount>0,this.instancedDraw=!!t.instanceCount,this.drawCount=Math.max(e+1,this.drawCount),this.drawByIndex?(this.counts[e]=t.indexCount,this.offsets[e]=t.firstIndex):(this.counts[e]=t.vertexCount,this.offsets[e]=t.firstVertex),this.instances[e]=Math.max(1,t.instanceCount)},t._ensureCapacity=function(e){if(!(this._capacity>e)){this._capacity=n(e);var t=new Int32Array(this._capacity),r=new Int32Array(this._capacity),s=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),t.set(this.counts),r.set(this.offsets),s.set(this.instances),this.counts=t,this.offsets=r,this.instances=s}},e}(),at=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuBuffer=null,t._gpuBufferView=null,t._uniformBuffer=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){if("buffer"in e){this._isBufferView=!0;var t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBufferView={gpuBuffer:t.gpuBuffer,offset:e.offset,range:e.range}}else this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=e.flags,this._usage&p.UNIFORM&&this._size>0&&(this._uniformBuffer=new Uint8Array(this._size)),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,vf32:null,indirects:new st,glTarget:0,glBuffer:null},this._usage&p.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),function(e,t){var r=e.gl,s=e.stateCache,a=t.memUsage&S.HOST?r.DYNAMIC_DRAW:r.STATIC_DRAW;if(t.usage&p.VERTEX){t.glTarget=r.ARRAY_BUFFER;var i=r.createBuffer();i&&(t.glBuffer=i,t.size>0&&(e.extensions.useVAO&&s.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),s.glVAO=null),Ye.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(r.bindBuffer(r.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),r.bufferData(r.ARRAY_BUFFER,t.size,a),r.bindBuffer(r.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&p.INDEX){t.glTarget=r.ELEMENT_ARRAY_BUFFER;var n=r.createBuffer();n&&(t.glBuffer=n,t.size>0&&(e.extensions.useVAO&&s.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),s.glVAO=null),Ye.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),r.bufferData(r.ELEMENT_ARRAY_BUFFER,t.size,a),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else t.usage&p.UNIFORM?(t.glTarget=r.NONE,t.buffer&&(t.vf32=new Float32Array(t.buffer.buffer))):(t.usage&p.INDIRECT||t.usage&p.TRANSFER_DST||t.usage&p.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=r.NONE)}(Pe.instance,this._gpuBuffer),Pe.instance.memoryStatus.bufferSize+=this._size},a.destroy=function(){this._gpuBuffer&&(function(e,t){var r=e.gl,s=e.stateCache;if(t.glBuffer){switch(t.glTarget){case r.ARRAY_BUFFER:e.extensions.useVAO&&s.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),e.stateCache.glVAO=null),Ye.gpuInputAssembler=null,r.bindBuffer(r.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null;break;case r.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&s.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),e.stateCache.glVAO=null),Ye.gpuInputAssembler=null,r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null}r.deleteBuffer(t.glBuffer),t.glBuffer=null}}(Pe.instance,this._gpuBuffer),Pe.instance.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._gpuBufferView&&(this._gpuBufferView=null)},a.resize=function(e){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var t,r,s,a,i,n=this._size;n!==e&&(this._size=e,this._count=this._size/this._stride,this._uniformBuffer&&(this._uniformBuffer=new Uint8Array(e)),this._gpuBuffer&&(this._uniformBuffer&&(this._gpuBuffer.buffer=this._uniformBuffer),this._gpuBuffer.size=e,e>0&&(t=Pe.instance,r=this._gpuBuffer,s=t.gl,a=t.stateCache,i=r.memUsage&S.HOST?s.DYNAMIC_DRAW:s.STATIC_DRAW,r.usage&p.VERTEX?(t.extensions.useVAO&&a.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),a.glVAO=null),Ye.gpuInputAssembler=null,t.stateCache.glArrayBuffer!==r.glBuffer&&s.bindBuffer(s.ARRAY_BUFFER,r.glBuffer),r.buffer?s.bufferData(s.ARRAY_BUFFER,r.buffer,i):s.bufferData(s.ARRAY_BUFFER,r.size,i),s.bindBuffer(s.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null):r.usage&p.INDEX?(t.extensions.useVAO&&a.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),a.glVAO=null),Ye.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==r.glBuffer&&s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,r.glBuffer),r.buffer?s.bufferData(s.ELEMENT_ARRAY_BUFFER,r.buffer,i):s.bufferData(s.ELEMENT_ARRAY_BUFFER,r.size,i),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null):r.usage&p.UNIFORM?r.buffer&&(r.vf32=new Float32Array(r.buffer.buffer)):(r.usage&p.INDIRECT||r.usage&p.TRANSFER_DST||r.usage&p.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),r.glTarget=s.NONE),Pe.instance.memoryStatus.bufferSize-=n,Pe.instance.memoryStatus.bufferSize+=e)))}},a.update=function(e,t){var r;this._isBufferView?console.warn("cannot update through buffer views!"):(r=void 0!==t?t:this._usage&p.INDIRECT?0:e.byteLength,Ke(Pe.instance,this._gpuBuffer,e,0,r))},r(s,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}},{key:"gpuBufferView",get:function(){return this._gpuBufferView}}]),s}(k),it=function(){function e(e,t){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new w(t);for(var r=0;r<t;++r)this._frees[r]=new e;this._freeIdx=t-1}var t=e.prototype;return t.alloc=function(e){if(this._freeIdx<0){var t=2*this._frees.length,r=this._frees;this._frees=new Array(t);for(var s=t-r.length,a=0;a<s;++a)this._frees[a]=new e;for(var i=s,n=0;i<t;++i,++n)this._frees[i]=r[n];this._freeIdx+=s}var u=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++u.refCount,u},t.free=function(e){0==--e.refCount&&this._freeCmds.push(e)},t.freeCmds=function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])},t.release=function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()},e}(),nt=function(){function e(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new it(ke,1),this.bindStatesCmdPool=new it(Xe,1),this.drawCmdPool=new it(He,1),this.updateBufferCmdPool=new it(Ve,1),this.copyBufferToTextureCmdPool=new it(We,1)}var t=e.prototype;return t.clearCmds=function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()},t.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()},e}(),ut=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this).cmdPackage=new ze,t._cmdAllocator=new nt,t._isInRenderPass=!1,t._curGPUPipelineState=null,t._curGPUInputAssembler=null,t._curGPUDescriptorSets=[],t._curDynamicOffsets=Array(8).fill(0),t._curDynamicStates=new R,t._isStateInvalied=!1,t}t(r,e);var s=r.prototype;return s.initialize=function(e){this._type=e.type,this._queue=e.queue;for(var t=Pe.instance.bindingMappings.blockOffsets.length,r=0;r<t;r++)this._curGPUDescriptorSets.push(null)},s.destroy=function(){this._cmdAllocator.clearCmds(this.cmdPackage)},s.begin=function(){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},s.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},s.beginRenderPass=function(e,t,r,s,a,i){var n=this._cmdAllocator.beginRenderPassCmdPool.alloc(ke);n.gpuRenderPass=e.gpuRenderPass,n.gpuFramebuffer=t.gpuFramebuffer,n.renderArea.copy(r),n.clearColors.length=s.length;for(var u=0;u<s.length;++u)n.clearColors[u]=s[u];n.clearDepth=a,n.clearStencil=i,this.cmdPackage.beginRenderPassCmds.push(n),this.cmdPackage.cmds.push(De.BEGIN_RENDER_PASS),this._isInRenderPass=!0},s.endRenderPass=function(){this._isInRenderPass=!1},s.bindPipelineState=function(e){var t=e.gpuPipelineState;t!==this._curGPUPipelineState&&(this._curGPUPipelineState=t,this._isStateInvalied=!0)},s.bindDescriptorSet=function(e,t,r){var s=t.gpuDescriptorSet;if(s!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=s,this._isStateInvalied=!0),r){var a,i=null===(a=this._curGPUPipelineState)||void 0===a?void 0:a.gpuPipelineLayout;if(i){for(var n=this._curDynamicOffsets,u=i.dynamicOffsetOffsets[e],l=0;l<r.length;l++)n[u+l]=r[l];this._isStateInvalied=!0}}},s.bindInputAssembler=function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0},s.setViewport=function(e){var t=this._curDynamicStates.viewport;t.left===e.left&&t.top===e.top&&t.width===e.width&&t.height===e.height&&t.minDepth===e.minDepth&&t.maxDepth===e.maxDepth||(t.left=e.left,t.top=e.top,t.width=e.width,t.height=e.height,t.minDepth=e.minDepth,t.maxDepth=e.maxDepth,this._isStateInvalied=!0)},s.setScissor=function(e){var t=this._curDynamicStates.scissor;t.x===e.x&&t.y===e.y&&t.width===e.width&&t.height===e.height||(t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,this._isStateInvalied=!0)},s.setLineWidth=function(e){this._curDynamicStates.lineWidth!==e&&(this._curDynamicStates.lineWidth=e,this._isStateInvalied=!0)},s.setDepthBias=function(e,t,r){var s=this._curDynamicStates;s.depthBiasConstant===e&&s.depthBiasClamp===t&&s.depthBiasSlope===r||(s.depthBiasConstant=e,s.depthBiasClamp=t,s.depthBiasSlope=r,this._isStateInvalied=!0)},s.setBlendConstants=function(e){var t=this._curDynamicStates.blendConstant;t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w||(t.copy(e),this._isStateInvalied=!0)},s.setDepthBound=function(e,t){var r=this._curDynamicStates;r.depthMinBounds===e&&r.depthMaxBounds===t||(r.depthMinBounds=e,r.depthMaxBounds=t,this._isStateInvalied=!0)},s.setStencilWriteMask=function(e,t){var r=this._curDynamicStates.stencilStatesFront,s=this._curDynamicStates.stencilStatesBack;e&X.FRONT&&r.writeMask!==t&&(r.writeMask=t,this._isStateInvalied=!0),e&X.BACK&&s.writeMask!==t&&(s.writeMask=t,this._isStateInvalied=!0)},s.setStencilCompareMask=function(e,t,r){var s=this._curDynamicStates.stencilStatesFront,a=this._curDynamicStates.stencilStatesBack;e&X.FRONT&&(s.compareMask===r&&s.reference===t||(s.reference=t,s.compareMask=r,this._isStateInvalied=!0)),e&X.BACK&&(a.compareMask===r&&a.reference===t||(a.reference=t,a.compareMask=r,this._isStateInvalied=!0))},s.draw=function(e){if(this._type===H.PRIMARY&&this._isInRenderPass||this._type===H.SECONDARY){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e,r=this._cmdAllocator.drawCmdPool.alloc(He);r.drawInfo.copy(t),this.cmdPackage.drawCmds.push(r),this.cmdPackage.cmds.push(De.DRAW),++this._numDrawCalls,this._numInstances+=t.instanceCount;var s=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=s/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(s-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},s.updateBuffer=function(e,t,r){if(this._type===H.PRIMARY&&!this._isInRenderPass||this._type===H.SECONDARY){var s=e.gpuBuffer;if(s){var a,i=this._cmdAllocator.updateBufferCmdPool.alloc(Ve),n=0;e.usage&p.INDIRECT||(n=void 0!==r?r:t.byteLength),a=t,i.gpuBuffer=s,i.buffer=a,i.offset=0,i.size=n,this.cmdPackage.updateBufferCmds.push(i),this.cmdPackage.cmds.push(De.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")},s.copyBuffersToTexture=function(e,t,r){if(this._type===H.PRIMARY&&!this._isInRenderPass||this._type===H.SECONDARY){var s=t.gpuTexture;if(s){var a=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(We);a&&(a.gpuTexture=s,a.regions=r,a.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(a),this.cmdPackage.cmds.push(De.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},s.execute=function(e,t){for(var r=0;r<t;++r){for(var s=e[r],a=0;a<s.cmdPackage.beginRenderPassCmds.length;++a){var i=s.cmdPackage.beginRenderPassCmds.array[a];++i.refCount,this.cmdPackage.beginRenderPassCmds.push(i)}for(var n=0;n<s.cmdPackage.bindStatesCmds.length;++n){var u=s.cmdPackage.bindStatesCmds.array[n];++u.refCount,this.cmdPackage.bindStatesCmds.push(u)}for(var l=0;l<s.cmdPackage.drawCmds.length;++l){var _=s.cmdPackage.drawCmds.array[l];++_.refCount,this.cmdPackage.drawCmds.push(_)}for(var o=0;o<s.cmdPackage.updateBufferCmds.length;++o){var c=s.cmdPackage.updateBufferCmds.array[o];++c.refCount,this.cmdPackage.updateBufferCmds.push(c)}for(var f=0;f<s.cmdPackage.copyBufferToTextureCmds.length;++f){var h=s.cmdPackage.copyBufferToTextureCmds.array[f];++h.refCount,this.cmdPackage.copyBufferToTextureCmds.push(h)}this.cmdPackage.cmds.concat(s.cmdPackage.cmds.array),this._numDrawCalls+=s._numDrawCalls,this._numInstances+=s._numInstances,this._numTris+=s._numTris}},s.pipelineBarrier=function(){},s.bindStates=function(){var e=this._cmdAllocator.bindStatesCmdPool.alloc(Xe);e&&(e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets),e.gpuInputAssembler=this._curGPUInputAssembler,e.dynamicStates.copy(this._curDynamicStates),this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(De.BIND_STATES),this._isStateInvalied=!1)},r}(V),lt=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuFramebuffer=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null;for(var t=0,r=[],s=0;s<e.colorTextures.length;++s){var a=e.colorTextures[s];a&&(r.push(a.gpuTexture),t=a.lodLevel)}var i=null;e.depthStencilTexture&&(i=e.depthStencilTexture.gpuTexture,t=e.depthStencilTexture.lodLevel);var n=Number.MAX_SAFE_INTEGER,u=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorTextures:r,gpuDepthStencilTexture:i,glFramebuffer:null,isOffscreen:!0,get width(){return this.isOffscreen?n:this.gpuColorTextures[0].width},set width(e){n=e},get height(){return this.isOffscreen?u:this.gpuColorTextures[0].height},set height(e){u=e},lodLevel:t},function(e,t){for(var r=0;r<t.gpuColorTextures.length;++r)if(t.gpuColorTextures[r].isSwapchainTexture)return void(t.isOffscreen=!1);var s=e.gl,a=[],i=s.createFramebuffer();if(i){t.glFramebuffer=i,e.stateCache.glFramebuffer!==t.glFramebuffer&&s.bindFramebuffer(s.FRAMEBUFFER,t.glFramebuffer);for(var n=0;n<t.gpuColorTextures.length;++n){var u=t.gpuColorTextures[n];u&&(u.glTexture?s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0+n,u.glTarget,u.glTexture,0):s.framebufferRenderbuffer(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0+n,s.RENDERBUFFER,u.glRenderbuffer),a.push(s.COLOR_ATTACHMENT0+n),t.width=Math.min(t.width,u.width),t.height=Math.min(t.height,u.height))}var l=t.gpuDepthStencilTexture;if(l){var _=B[l.format].hasStencil?s.DEPTH_STENCIL_ATTACHMENT:s.DEPTH_ATTACHMENT;l.glTexture?s.framebufferTexture2D(s.FRAMEBUFFER,_,l.glTarget,l.glTexture,0):s.framebufferRenderbuffer(s.FRAMEBUFFER,_,s.RENDERBUFFER,l.glRenderbuffer),t.width=Math.min(t.width,l.width),t.height=Math.min(t.height,l.height)}e.extensions.WEBGL_draw_buffers&&e.extensions.WEBGL_draw_buffers.drawBuffersWEBGL(a);var o=s.checkFramebufferStatus(s.FRAMEBUFFER);if(o!==s.FRAMEBUFFER_COMPLETE)switch(o){case s.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case s.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case s.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case s.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}e.stateCache.glFramebuffer!==t.glFramebuffer&&s.bindFramebuffer(s.FRAMEBUFFER,e.stateCache.glFramebuffer)}}(Pe.instance,this._gpuFramebuffer)},a.destroy=function(){var e,t;this._gpuFramebuffer&&(e=Pe.instance,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),e.stateCache.glFramebuffer===t.glFramebuffer&&(e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,null),e.stateCache.glFramebuffer=null),t.glFramebuffer=null),this._gpuFramebuffer=null)},r(s,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),s}(W),_t=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuInputAssembler=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){if(0!==e.vertexBuffers.length){if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,e.indexBuffer)this._indexBuffer=e.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{var t=this._vertexBuffers[0];this._drawInfo.vertexCount=t.size/t.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;for(var r=new Array(e.vertexBuffers.length),s=0;s<e.vertexBuffers.length;++s){var a=e.vertexBuffers[s];a.gpuBuffer&&(r[s]=a.gpuBuffer)}var i=null,n=0;if(e.indexBuffer&&(i=e.indexBuffer.gpuBuffer))switch(i.stride){case 1:n=5121;break;case 2:n=5123;break;case 4:n=5125;break;default:console.error("Error index buffer stride.")}var u=null;e.indirectBuffer&&(u=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:r,gpuIndexBuffer:i,gpuIndirectBuffer:u,glAttribs:[],glIndexType:n,glVAOs:new Map},function(e,t){var r=e.gl;t.glAttribs=new Array(t.attributes.length);for(var s=[0,0,0,0,0,0,0,0],a=0;a<t.attributes.length;++a){var i=t.attributes[a],n=void 0!==i.stream?i.stream:0,u=t.gpuVertexBuffers[n],l=Fe(i.format,r),_=B[i.format].size;t.glAttribs[a]={name:i.name,glBuffer:u.glBuffer,glType:l,size:_,count:B[i.format].count,stride:u.stride,componentCount:Ie(l,r),isNormalized:void 0!==i.isNormalized&&i.isNormalized,isInstanced:void 0!==i.isInstanced&&i.isInstanced,offset:s[n]},s[n]+=_}}(Pe.instance,this._gpuInputAssembler)}else console.error("InputAssemblerInfo.vertexBuffers is null.")},a.destroy=function(){var e=Pe.instance;this._gpuInputAssembler&&e.extensions.useVAO&&function(e,t){for(var r=t.glVAOs.values(),s=r.next(),a=e.extensions.OES_vertex_array_object,i=e.stateCache.glVAO;!s.done;)a.deleteVertexArrayOES(s.value),i===s.value&&(a.bindVertexArrayOES(null),i=null),s=r.next();e.stateCache.glVAO=i,t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null},r(s,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),s}(z),ot=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuDescriptorSetLayout=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){Array.prototype.push.apply(this._bindings,e.bindings);for(var t=0,r=-1,s=[],a=0;a<this._bindings.length;a++){var i=this._bindings[a];s.push(t),t+=i.count,i.binding>r&&(r=i.binding)}this._bindingIndices=Array(r+1).fill(-1);for(var n=this._descriptorIndices=Array(r+1).fill(-1),u=0;u<this._bindings.length;u++){var l=this._bindings[u];this._bindingIndices[l.binding]=u,n[l.binding]=s[u]}for(var _=[],o=0;o<this._bindings.length;o++){var c=this._bindings[o];if(c.descriptorType&K)for(var f=0;f<c.count;f++)_.push(c.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:_,descriptorIndices:n,descriptorCount:t}},a.destroy=function(){this._bindings.length=0},r(s,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),s}(Y),ct=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuPipelineLayout=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);for(var t=[],r=[],s=0,a=[],i=0;i<this._setLayouts.length;i++){for(var n=this._setLayouts[i],u=n.gpuDescriptorSetLayout.dynamicBindings,l=Array(n.bindingIndices.length).fill(-1),_=0;_<u.length;_++){var o=u[_];l[o]<0&&(l[o]=s+_)}r.push(n.gpuDescriptorSetLayout),t.push(l),a.push(s),s+=u.length}this._gpuPipelineLayout={gpuSetLayouts:r,dynamicOffsetIndices:t,dynamicOffsetCount:s,dynamicOffsetOffsets:a}},a.destroy=function(){this._setLayouts.length=0},r(s,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),s}(j),ft=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],ht=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuPipelineState=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout;var t=this._bs;if(e.blendState){var r=e.blendState,s=r.targets;s&&s.forEach((function(e,r){t.setTarget(r,e)})),void 0!==r.isA2C&&(t.isA2C=r.isA2C),void 0!==r.isIndepend&&(t.isIndepend=r.isIndepend),void 0!==r.blendColor&&(t.blendColor=r.blendColor)}Object.assign(this._rs,e.rasterizerState),Object.assign(this._dss,e.depthStencilState),this._is=e.inputState,this._renderPass=e.renderPass,this._dynamicStates=e.dynamicStates;for(var a=[],i=0;i<31;i++)this._dynamicStates&1<<i&&a.push(1<<i);this._gpuPipelineState={glPrimitive:ft[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:a}},a.destroy=function(){this._gpuPipelineState=null},r(s,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),s}(q),Et=function(e){function r(){return e.apply(this,arguments)||this}t(r,e);var s=r.prototype;return s.beginRenderPass=function(e,t,r,s,a,i){qe(Pe.instance,e.gpuRenderPass,t.gpuFramebuffer,r,s,a,i),this._isInRenderPass=!0},s.draw=function(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e;Qe(Pe.instance,t),++this._numDrawCalls,this._numInstances+=t.instanceCount;var r=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=r/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(r-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},s.setViewport=function(e){var t=Pe.instance,r=t.stateCache,s=t.gl;r.viewport.left===e.left&&r.viewport.top===e.top&&r.viewport.width===e.width&&r.viewport.height===e.height||(s.viewport(e.left,e.top,e.width,e.height),r.viewport.left=e.left,r.viewport.top=e.top,r.viewport.width=e.width,r.viewport.height=e.height)},s.setScissor=function(e){var t=Pe.instance,r=t.stateCache,s=t.gl;r.scissorRect.x===e.x&&r.scissorRect.y===e.y&&r.scissorRect.width===e.width&&r.scissorRect.height===e.height||(s.scissor(e.x,e.y,e.width,e.height),r.scissorRect.x=e.x,r.scissorRect.y=e.y,r.scissorRect.width=e.width,r.scissorRect.height=e.height)},s.updateBuffer=function(e,t,r){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var s,a=e.gpuBuffer;a&&(s=void 0!==r?r:e.usage&p.INDIRECT?0:t.byteLength,Ke(Pe.instance,a,t,0,s))}},s.copyBuffersToTexture=function(e,t,r){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var s=t.gpuTexture;s&&rt(Pe.instance,e,s,r)}},s.execute=function(e,t){for(var r=0;r<t;++r){var s=e[r];$e(Pe.instance,s.cmdPackage),this._numDrawCalls+=s._numDrawCalls,this._numInstances+=s._numInstances,this._numTris+=s._numTris}},s.bindStates=function(){Ze(Pe.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1},r}(ut),Tt=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this).numDrawCalls=0,t.numInstances=0,t.numTris=0,t}t(r,e);var s=r.prototype;return s.initialize=function(e){this._type=e.type},s.destroy=function(){},s.submit=function(e){for(var t=e.length,r=0;r<t;r++){var s=e[r];this.numDrawCalls+=s.numDrawCalls,this.numInstances+=s.numInstances,this.numTris+=s.numTris}},s.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},r}(Z),gt=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuRenderPass=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,this._subpasses=e.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()},a.destroy=function(){this._gpuRenderPass=null},r(s,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),s}(Q),dt=[10497,33648,33071,33071],Rt=function(e){function s(t,r){var s;(s=e.call(this,t,r)||this)._gpuSampler=null;var a,i,n=s._info.minFilter,u=s._info.magFilter,l=s._info.mipFilter;a=n===J.LINEAR||n===J.ANISOTROPIC?l===J.LINEAR||l===J.ANISOTROPIC?9987:l===J.POINT?9985:9729:l===J.LINEAR||l===J.ANISOTROPIC?9986:l===J.POINT?9984:9728,i=u===J.LINEAR||u===J.ANISOTROPIC?9729:9728;var _=dt[s._info.addressU],o=dt[s._info.addressV],c=dt[s._info.addressW];return s._gpuSampler={glMinFilter:a,glMagFilter:i,glWrapS:_,glWrapT:o,glWrapR:c},s}return t(s,e),r(s,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),s}($),At=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuShader=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name,blocks:e.blocks.slice(),samplerTextures:e.samplerTextures.slice(),subpassInputs:e.subpassInputs.slice(),gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var t=0;t<e.stages.length;++t){var r=e.stages[t];this._gpuShader.gpuStages[t]={type:r.stage,source:r.source,glShader:null}}},a.destroy=function(){this._gpuShader&&(function(e,t){if(t.glProgram){var r=e.gl;if(!e.extensions.destroyShadersImmediately)for(var s=0;s<t.gpuStages.length;s++){var a=t.gpuStages[s];a.glShader&&(r.detachShader(t.glProgram,a.glShader),r.deleteShader(a.glShader),a.glShader=null)}r.deleteProgram(t.glProgram),e.stateCache.glProgram===t.glProgram&&(e.gl.useProgram(null),e.stateCache.glProgram=null),t.glProgram=null}}(Pe.instance,this._gpuShader),this._gpuShader=null)},r(s,[{key:"gpuShader",get:function(){return null===this._gpuShader.glProgram&&function(e,t){for(var r=e.gl,s=function(e){var s=t.gpuStages[e],a=0,i="",n=1;switch(s.type){case U.VERTEX:i="VertexShader",a=r.VERTEX_SHADER;break;case U.FRAGMENT:i="FragmentShader",a=r.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var u=r.createShader(a);if(u&&(s.glShader=u,r.shaderSource(s.glShader,s.source),r.compileShader(s.glShader),!r.getShaderParameter(s.glShader,r.COMPILE_STATUS))){console.error(i+" in '"+t.name+"' compilation failed."),console.error("Shader source dump:",s.source.replace(/^|\n/g,(function(){return"\n"+n+++" "}))),console.error(r.getShaderInfoLog(s.glShader));for(var l=0;l<t.gpuStages.length;l++){var _=t.gpuStages[e];_.glShader&&(r.deleteShader(_.glShader),_.glShader=null)}return{v:void 0}}},a=0;a<t.gpuStages.length;a++){var n=s(a);if("object"==typeof n)return n.v}var u=r.createProgram();if(u){t.glProgram=u;for(var l=0;l<t.gpuStages.length;l++){var _=t.gpuStages[l];r.attachShader(t.glProgram,_.glShader)}if(r.linkProgram(t.glProgram),e.extensions.destroyShadersImmediately)for(var o=0;o<t.gpuStages.length;o++){var c=t.gpuStages[o];c.glShader&&(r.detachShader(t.glProgram,c.glShader),r.deleteShader(c.glShader),c.glShader=null)}if(!r.getProgramParameter(t.glProgram,r.LINK_STATUS))return console.error("Failed to link shader '"+t.name+"'."),void console.error(r.getProgramInfoLog(t.glProgram));i("Shader '"+t.name+"' compilation succeeded.");var f=r.getProgramParameter(t.glProgram,r.ACTIVE_ATTRIBUTES);t.glInputs=new Array(f);for(var h=0;h<f;++h){var E=r.getActiveAttrib(t.glProgram,h);if(E){var T,g=E.name.indexOf("[");T=-1!==g?E.name.substr(0,g):E.name;var d=r.getAttribLocation(t.glProgram,T),R=Oe(E.type,r),A=ye(E.type,r);t.glInputs[h]={binding:d,name:T,type:R,stride:A,count:E.size,size:A*E.size,glType:E.type,glLoc:d}}}if(t.blocks.length>0){t.glBlocks=new Array(t.blocks.length);for(var S=0;S<t.blocks.length;++S){var p=t.blocks[S],C={set:p.set,binding:p.binding,name:p.name,size:0,glUniforms:new Array(p.members.length),glActiveUniforms:[]};t.glBlocks[S]=C;for(var B=0;B<p.members.length;++B){var m=p.members[B],x=ve(m.type,r),b=ye(x,r),P=b*m.count;C.glUniforms[B]={binding:-1,name:m.name,type:m.type,stride:b,count:m.count,size:P,offset:0,glType:x,glLoc:null,array:null}}}}for(var F=0;F<t.subpassInputs.length;++F){var v=t.subpassInputs[F];t.samplerTextures.push(new M(v.set,v.binding,v.name,N.SAMPLER2D,v.count))}if(t.samplerTextures.length>0){t.glSamplerTextures=new Array(t.samplerTextures.length);for(var G=0;G<t.samplerTextures.length;++G){var O=t.samplerTextures[G];t.glSamplerTextures[G]={set:O.set,binding:O.binding,name:O.name,type:O.type,count:O.count,units:[],glUnits:null,glType:ve(O.type,r),glLoc:null}}}for(var y=r.getProgramParameter(t.glProgram,r.ACTIVE_UNIFORMS),I=0;I<y;++I){var D=r.getActiveUniform(t.glProgram,I);if(D&&D.type!==r.SAMPLER_2D&&D.type!==r.SAMPLER_CUBE){var L=r.getUniformLocation(t.glProgram,D.name);if(e.extensions.isLocationActive(L)){var w,k=D.name.indexOf("[");w=-1!==k?D.name.substr(0,k):D.name;for(var X=0;X<t.glBlocks.length;X++)for(var H=t.glBlocks[X],V=0;V<H.glUniforms.length;V++){var W=H.glUniforms[V];if(W.name===w){W.glLoc=L,W.count=D.size,W.size=W.stride*W.count,W.array=new(Ge(W.type))(W.size/4),H.glActiveUniforms.push(W);break}}}}}for(var z=0;z<t.glBlocks.length;z++)for(var K=t.glBlocks[z],Y=0;Y<K.glUniforms.length;Y++){var j=K.glUniforms[Y];j.offset=K.size/4,K.size+=j.size}for(var q=[],Z=[],Q=e.bindingMappings,J=e.stateCache.texUnitCacheMap,$=0,ee=0;ee<t.blocks.length;++ee)t.blocks[ee].set===Q.flexibleSet&&$++;for(var te=0,re=0;re<t.samplerTextures.length;++re){var se=t.samplerTextures[re],ae=r.getUniformLocation(t.glProgram,se.name);if(e.extensions.isLocationActive(ae)&&(q.push(t.glSamplerTextures[re]),Z.push(ae)),void 0===J[se.name]){var ie=se.binding+Q.samplerTextureOffsets[se.set]+te;se.set===Q.flexibleSet&&(ie-=$),J[se.name]=ie%e.capabilities.maxTextureUnits,te+=se.count-1}}if(q.length){for(var ne=[],ue=0;ue<q.length;++ue){var le=q[ue],_e=J[le.name];if(void 0!==_e){le.glLoc=Z[ue];for(var oe=0;oe<le.count;++oe){for(;ne[_e];)_e=(_e+1)%e.capabilities.maxTextureUnits;le.units.push(_e),ne[_e]=!0}}}for(var ce=0,fe=0;fe<q.length;++fe){var he=q[fe];if(!e.extensions.isLocationActive(he.glLoc)){he.glLoc=Z[fe];for(var Ee=0;Ee<he.count;++Ee){for(;ne[ce];)ce=(ce+1)%e.capabilities.maxTextureUnits;void 0===J[he.name]&&(J[he.name]=ce),he.units.push(ce),ne[ce]=!0}}}e.stateCache.glProgram!==t.glProgram&&r.useProgram(t.glProgram);for(var Te=0;Te<q.length;Te++){var ge=q[Te];ge.glUnits=new Int32Array(ge.units),r.uniform1iv(ge.glLoc,ge.glUnits)}e.stateCache.glProgram!==t.glProgram&&r.useProgram(e.stateCache.glProgram)}for(var de=0;de<t.glBlocks.length;)t.glBlocks[de].glActiveUniforms.length?de++:(t.glBlocks[de]=t.glBlocks[t.glBlocks.length-1],t.glBlocks.length--);t.glSamplerTextures=q}}(Pe.instance,this._gpuShader),this._gpuShader}}]),s}(ee),St=function(){function e(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=new te,this.scissorRect=new g(0,0,0,0),this.rs=new re,this.dss=new se,this.bs=new ae,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return e.prototype.initialize=function(e,t){for(var r=0;r<e;++r)this.glTexUnits.push({glTexture:null});this.glEnabledAttribLocs.length=t,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=t,this.glCurrentAttribLocs.fill(!1)},e}(),pt=function(e){function a(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuTexture=null,t._lodLevel=0,t}t(a,e);var i=a.prototype;return i.initialize=function(e,t){var r=e,a=e;"texture"in e&&(r=a.texture.info,this._isTextureView=!0),this._info.copy(r),this._isPowerOf2=ie(this._info.width)&&ie(this._info.height),this._size=ne(this._info.format,this.width,this.height,this.depth,this._info.levelCount)*this._info.layerCount,this._isTextureView?(this._viewInfo.copy(a),this._lodLevel=a.baseLevel,this._gpuTexture=a.texture._gpuTexture):(this._gpuTexture={type:r.type,format:r.format,usage:r.usage,width:r.width,height:r.height,depth:r.depth,size:this._size,arrayLayer:r.layerCount,mipLevel:r.levelCount,samples:r.samples,flags:r.flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:t||!1},function(e,t){var r=e.gl;t.glFormat=t.glInternalFmt=function(e,t){switch(e){case x.A8:return t.ALPHA;case x.L8:return t.LUMINANCE;case x.LA8:return t.LUMINANCE_ALPHA;case x.RGB8:case x.RGB16F:case x.RGB32F:return t.RGB;case x.BGRA8:case x.RGBA8:case x.SRGB8_A8:case x.RGBA16F:case x.RGBA32F:return t.RGBA;case x.R5G6B5:return t.RGB;case x.RGB5A1:case x.RGBA4:return t.RGBA;case x.DEPTH:return t.DEPTH_COMPONENT;case x.DEPTH_STENCIL:return t.DEPTH_STENCIL;case x.BC1:return xe.COMPRESSED_RGB_S3TC_DXT1_EXT;case x.BC1_ALPHA:return xe.COMPRESSED_RGBA_S3TC_DXT1_EXT;case x.BC1_SRGB:return xe.COMPRESSED_SRGB_S3TC_DXT1_EXT;case x.BC1_SRGB_ALPHA:return xe.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case x.BC2:return xe.COMPRESSED_RGBA_S3TC_DXT3_EXT;case x.BC2_SRGB:return xe.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case x.BC3:return xe.COMPRESSED_RGBA_S3TC_DXT5_EXT;case x.BC3_SRGB:return xe.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case x.ETC_RGB8:return xe.COMPRESSED_RGB_ETC1_WEBGL;case x.ETC2_RGB8:return xe.COMPRESSED_RGB8_ETC2;case x.ETC2_SRGB8:return xe.COMPRESSED_SRGB8_ETC2;case x.ETC2_RGB8_A1:return xe.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case x.ETC2_SRGB8_A1:return xe.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case x.ETC2_RGBA8:return xe.COMPRESSED_RGBA8_ETC2_EAC;case x.ETC2_SRGB8_A8:return xe.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case x.EAC_R11:return xe.COMPRESSED_R11_EAC;case x.EAC_R11SN:return xe.COMPRESSED_SIGNED_R11_EAC;case x.EAC_RG11:return xe.COMPRESSED_RG11_EAC;case x.EAC_RG11SN:return xe.COMPRESSED_SIGNED_RG11_EAC;case x.PVRTC_RGB2:return xe.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case x.PVRTC_RGBA2:return xe.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case x.PVRTC_RGB4:return xe.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case x.PVRTC_RGBA4:return xe.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case x.ASTC_RGBA_4X4:return xe.COMPRESSED_RGBA_ASTC_4x4_KHR;case x.ASTC_RGBA_5X4:return xe.COMPRESSED_RGBA_ASTC_5x4_KHR;case x.ASTC_RGBA_5X5:return xe.COMPRESSED_RGBA_ASTC_5x5_KHR;case x.ASTC_RGBA_6X5:return xe.COMPRESSED_RGBA_ASTC_6x5_KHR;case x.ASTC_RGBA_6X6:return xe.COMPRESSED_RGBA_ASTC_6x6_KHR;case x.ASTC_RGBA_8X5:return xe.COMPRESSED_RGBA_ASTC_8x5_KHR;case x.ASTC_RGBA_8X6:return xe.COMPRESSED_RGBA_ASTC_8x6_KHR;case x.ASTC_RGBA_8X8:return xe.COMPRESSED_RGBA_ASTC_8x8_KHR;case x.ASTC_RGBA_10X5:return xe.COMPRESSED_RGBA_ASTC_10x5_KHR;case x.ASTC_RGBA_10X6:return xe.COMPRESSED_RGBA_ASTC_10x6_KHR;case x.ASTC_RGBA_10X8:return xe.COMPRESSED_RGBA_ASTC_10x8_KHR;case x.ASTC_RGBA_10X10:return xe.COMPRESSED_RGBA_ASTC_10x10_KHR;case x.ASTC_RGBA_12X10:return xe.COMPRESSED_RGBA_ASTC_12x10_KHR;case x.ASTC_RGBA_12X12:return xe.COMPRESSED_RGBA_ASTC_12x12_KHR;case x.ASTC_SRGBA_4X4:return xe.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case x.ASTC_SRGBA_5X4:return xe.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case x.ASTC_SRGBA_5X5:return xe.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case x.ASTC_SRGBA_6X5:return xe.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case x.ASTC_SRGBA_6X6:return xe.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case x.ASTC_SRGBA_8X5:return xe.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case x.ASTC_SRGBA_8X6:return xe.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case x.ASTC_SRGBA_8X8:return xe.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case x.ASTC_SRGBA_10X5:return xe.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case x.ASTC_SRGBA_10X6:return xe.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case x.ASTC_SRGBA_10X8:return xe.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case x.ASTC_SRGBA_10X10:return xe.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case x.ASTC_SRGBA_12X10:return xe.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case x.ASTC_SRGBA_12X12:return xe.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),t.RGBA}}(t.format,r),t.glType=Fe(t.format,r);var a=t.width,i=t.height;switch(t.type){case C.TEX2D:if(t.glTarget=r.TEXTURE_2D,t.isSwapchainTexture)break;var n=Math.max(a,i);if(n>e.capabilities.maxTextureSize&&s(9100,n,e.capabilities.maxTextureSize),e.textureExclusive[t.format]||e.extensions.WEBGL_depth_texture||!B[t.format].hasDepth){if(t.glTexture=r.createTexture(),t.size>0){var u=e.stateCache.glTexUnits[e.stateCache.texUnit];if(u.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_2D,t.glTexture),u.glTexture=t.glTexture),B[t.format].isCompressed)for(var l=0;l<t.mipLevel;++l){var _=m(t.format,a,i,1),o=new Uint8Array(_);r.compressedTexImage2D(r.TEXTURE_2D,l,t.glInternalFmt,a,i,0,o),a=Math.max(1,a>>1),i=Math.max(1,i>>1)}else for(var c=0;c<t.mipLevel;++c)r.texImage2D(r.TEXTURE_2D,c,t.glInternalFmt,a,i,0,t.glFormat,t.glType,null),a=Math.max(1,a>>1),i=Math.max(1,i>>1);t.isPowerOf2?(t.glWrapS=r.REPEAT,t.glWrapT=r.REPEAT):(t.glWrapS=r.CLAMP_TO_EDGE,t.glWrapT=r.CLAMP_TO_EDGE),t.glMinFilter=r.LINEAR,t.glMagFilter=r.LINEAR,r.texParameteri(t.glTarget,r.TEXTURE_WRAP_S,t.glWrapS),r.texParameteri(t.glTarget,r.TEXTURE_WRAP_T,t.glWrapT),r.texParameteri(t.glTarget,r.TEXTURE_MIN_FILTER,t.glMinFilter),r.texParameteri(t.glTarget,r.TEXTURE_MAG_FILTER,t.glMagFilter)}}else t.glInternalFmt=function(e,t){switch(e){case x.R5G6B5:return t.RGB565;case x.RGB5A1:return t.RGB5_A1;case x.RGBA4:return t.RGBA4;case x.RGBA16F:return xe.RGBA16F_EXT;case x.RGBA32F:return xe.RGBA32F_EXT;case x.SRGB8_A8:return xe.SRGB8_ALPHA8_EXT;case x.DEPTH:return t.DEPTH_COMPONENT16;case x.DEPTH_STENCIL:return t.DEPTH_STENCIL;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),t.RGBA}}(t.format,r),t.glRenderbuffer=r.createRenderbuffer(),t.size>0&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(r.bindRenderbuffer(r.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),r.renderbufferStorage(r.RENDERBUFFER,t.glInternalFmt,a,i));break;case C.CUBE:t.glTarget=r.TEXTURE_CUBE_MAP;var f=Math.max(a,i);if(f>e.capabilities.maxCubeMapTextureSize&&s(9100,f,e.capabilities.maxTextureSize),t.glTexture=r.createTexture(),t.size>0){var h=e.stateCache.glTexUnits[e.stateCache.texUnit];if(h.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_CUBE_MAP,t.glTexture),h.glTexture=t.glTexture),B[t.format].isCompressed)for(var E=0;E<6;++E){a=t.width,i=t.height;for(var T=0;T<t.mipLevel;++T){var g=m(t.format,a,i,1),d=new Uint8Array(g);r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+E,T,t.glInternalFmt,a,i,0,d),a=Math.max(1,a>>1),i=Math.max(1,i>>1)}}else for(var R=0;R<6;++R){a=t.width,i=t.height;for(var A=0;A<t.mipLevel;++A)r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+R,A,t.glInternalFmt,a,i,0,t.glFormat,t.glType,null),a=Math.max(1,a>>1),i=Math.max(1,i>>1)}t.isPowerOf2?(t.glWrapS=r.REPEAT,t.glWrapT=r.REPEAT):(t.glWrapS=r.CLAMP_TO_EDGE,t.glWrapT=r.CLAMP_TO_EDGE),t.glMinFilter=r.LINEAR,t.glMagFilter=r.LINEAR,r.texParameteri(t.glTarget,r.TEXTURE_WRAP_S,t.glWrapS),r.texParameteri(t.glTarget,r.TEXTURE_WRAP_T,t.glWrapT),r.texParameteri(t.glTarget,r.TEXTURE_MIN_FILTER,t.glMinFilter),r.texParameteri(t.glTarget,r.TEXTURE_MAG_FILTER,t.glMagFilter)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=C.TEX2D,t.glTarget=r.TEXTURE_2D}}(Pe.instance,this._gpuTexture),Pe.instance.memoryStatus.textureSize+=this._size,this._viewInfo.texture=this,this._viewInfo.type=e.type,this._viewInfo.format=e.format,this._viewInfo.baseLevel=0,this._viewInfo.levelCount=e.levelCount,this._viewInfo.baseLayer=0,this._viewInfo.layerCount=e.layerCount)},i.destroy=function(){!this._isTextureView&&this._gpuTexture&&(function(e,t){var r=e.gl;if(t.glTexture){var s=e.stateCache.glTexUnits,a=e.stateCache.texUnit;r.deleteTexture(t.glTexture);for(var i=0;i<s.length;i++)s[i].glTexture===t.glTexture&&(r.activeTexture(r.TEXTURE0+i),a=i,r.bindTexture(t.glTarget,null),s[i].glTexture=null);e.stateCache.texUnit=a,t.glTexture=null}if(t.glRenderbuffer){var n=e.stateCache.glRenderbuffer;r.deleteRenderbuffer(t.glRenderbuffer),n===t.glRenderbuffer&&(r.bindRenderbuffer(r.RENDERBUFFER,null),n=null),t.glRenderbuffer=null}}(Pe.instance,this._gpuTexture),Pe.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)},i.resize=function(e,t){if(this._info.width!==e||this._info.height!==t){this._info.levelCount===a.getLevelCount(this._info.width,this._info.height)?this._info.levelCount=a.getLevelCount(e,t):this._info.levelCount>1&&(this._info.levelCount=Math.min(this._info.levelCount,a.getLevelCount(e,t)));var r=this._size;this._info.width=e,this._info.height=t,this._size=ne(this._info.format,this.width,this.height,this.depth,this._info.levelCount)*this._info.layerCount,!this._isTextureView&&this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=t,this._gpuTexture.size=this._size,function(e,t){if(t.size){var r=e.gl,a=t.width,i=t.height;switch(t.type){case C.TEX2D:t.glTarget=r.TEXTURE_2D;var n=Math.max(a,i);if(n>e.capabilities.maxTextureSize&&s(9100,n,e.capabilities.maxTextureSize),t.glRenderbuffer)e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(r.bindRenderbuffer(r.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),r.renderbufferStorage(r.RENDERBUFFER,t.glInternalFmt,a,i);else if(t.glTexture){var u=e.stateCache.glTexUnits[e.stateCache.texUnit];if(u.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_2D,t.glTexture),u.glTexture=t.glTexture),B[t.format].isCompressed)for(var l=0;l<t.mipLevel;++l){var _=m(t.format,a,i,1),o=new Uint8Array(_);r.compressedTexImage2D(r.TEXTURE_2D,l,t.glInternalFmt,a,i,0,o),a=Math.max(1,a>>1),i=Math.max(1,i>>1)}else for(var c=0;c<t.mipLevel;++c)r.texImage2D(r.TEXTURE_2D,c,t.glInternalFmt,a,i,0,t.glFormat,t.glType,null),a=Math.max(1,a>>1),i=Math.max(1,i>>1)}break;case C.CUBE:t.glTarget=r.TEXTURE_CUBE_MAP;var f=Math.max(a,i);f>e.capabilities.maxCubeMapTextureSize&&s(9100,f,e.capabilities.maxTextureSize);var h=e.stateCache.glTexUnits[e.stateCache.texUnit];if(h.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_CUBE_MAP,t.glTexture),h.glTexture=t.glTexture),B[t.format].isCompressed)for(var E=0;E<6;++E){a=t.width,i=t.height;for(var T=0;T<t.mipLevel;++T){var g=m(t.format,a,i,1),d=new Uint8Array(g);r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+E,T,t.glInternalFmt,a,i,0,d),a=Math.max(1,a>>1),i=Math.max(1,i>>1)}}else for(var R=0;R<6;++R){a=t.width,i=t.height;for(var A=0;A<t.mipLevel;++A)r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+R,A,t.glInternalFmt,a,i,0,t.glFormat,t.glType,null),a=Math.max(1,a>>1),i=Math.max(1,i>>1)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=C.TEX2D,t.glTarget=r.TEXTURE_2D}}}(Pe.instance,this._gpuTexture),Pe.instance.memoryStatus.textureSize-=r,Pe.instance.memoryStatus.textureSize+=this._size)}},i.initAsSwapchainTexture=function(e){var t=new ue;t.format=e.format,t.usage=B[e.format].hasDepth?le.DEPTH_STENCIL_ATTACHMENT:le.COLOR_ATTACHMENT,t.width=e.width,t.height=e.height,this.initialize(t,!0)},r(a,[{key:"gpuTexture",get:function(){return this._gpuTexture}},{key:"lodLevel",get:function(){return this._lodLevel}}]),a}(_e),Ct="webglcontextlost";function Bt(e,t){for(var r=["","WEBKIT_","MOZ_"],s=0;s<r.length;++s){var a=e.getExtension(r[s]+t);if(a)return a}return null}function mt(e){var t={EXT_texture_filter_anisotropic:Bt(e,"EXT_texture_filter_anisotropic"),EXT_blend_minmax:Bt(e,"EXT_blend_minmax"),EXT_frag_depth:Bt(e,"EXT_frag_depth"),EXT_shader_texture_lod:Bt(e,"EXT_shader_texture_lod"),EXT_sRGB:Bt(e,"EXT_sRGB"),OES_vertex_array_object:Bt(e,"OES_vertex_array_object"),EXT_color_buffer_half_float:Bt(e,"EXT_color_buffer_half_float"),WEBGL_color_buffer_float:Bt(e,"WEBGL_color_buffer_float"),WEBGL_compressed_texture_etc1:Bt(e,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:Bt(e,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:Bt(e,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_s3tc:Bt(e,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:Bt(e,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:Bt(e,"WEBGL_debug_shaders"),WEBGL_draw_buffers:Bt(e,"WEBGL_draw_buffers"),WEBGL_lose_context:Bt(e,"WEBGL_lose_context"),WEBGL_depth_texture:Bt(e,"WEBGL_depth_texture"),OES_texture_half_float:Bt(e,"OES_texture_half_float"),OES_texture_half_float_linear:Bt(e,"OES_texture_half_float_linear"),OES_texture_float:Bt(e,"OES_texture_float"),OES_texture_float_linear:Bt(e,"OES_texture_float_linear"),OES_standard_derivatives:Bt(e,"OES_standard_derivatives"),OES_element_index_uint:Bt(e,"OES_element_index_uint"),ANGLE_instanced_arrays:Bt(e,"ANGLE_instanced_arrays"),WEBGL_debug_renderer_info:Bt(e,"WEBGL_debug_renderer_info"),WEBGL_multi_draw:null,WEBGL_compressed_texture_astc:null,destroyShadersImmediately:!0,noCompressedTexSubImage2D:!1,isLocationActive:function(e){return!!e},useVAO:!1};return oe.os===ce.IOS&&14===oe.osMainVersion&&oe.isBrowser||(t.WEBGL_compressed_texture_astc=Bt(e,"WEBGL_compressed_texture_astc")),oe.os!==ce.ANDROID&&oe.os!==ce.IOS&&(t.WEBGL_multi_draw=Bt(e,"WEBGL_multi_draw")),oe.browserType===fe.UC&&(t.ANGLE_instanced_arrays=null),(oe.os===ce.IOS&&oe.osMainVersion<=10||oe.os===ce.ANDROID)&&(t.destroyShadersImmediately=!1),t.isLocationActive=function(e){return!!e&&-1!==e.id},t.noCompressedTexSubImage2D=!0,t.OES_vertex_array_object&&(t.useVAO=!0),t}var xt=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this).stateCache=new St,t.cmdAllocator=new nt,t.nullTex2D=null,t.nullTexCube=null,t._canvas=null,t._webGLContextLostHandler=null,t._extensions=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){this._canvas=e.windowHandle,this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(Ct,this._onWebGLContextLost);var t=Pe.instance.gl;this.stateCache.initialize(Pe.instance.capabilities.maxTextureUnits,Pe.instance.capabilities.maxVertexAttributes),this._extensions=mt(t),function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.bindFramebuffer(e.FRAMEBUFFER,null),e.enable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.disable(e.POLYGON_OFFSET_FILL),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.depthRange(0,1),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}(t);var r=x.RGBA8,s=x.DEPTH_STENCIL,a=t.getParameter(t.DEPTH_BITS),i=t.getParameter(t.STENCIL_BITS);a&&i?s=x.DEPTH_STENCIL:a&&(s=x.DEPTH),this._colorTexture=new pt,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:r,width:e.width,height:e.height}),this._depthStencilTexture=new pt,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:s,width:e.width,height:e.height}),this.nullTex2D=Pe.instance.createTexture(new ue(C.TEX2D,le.SAMPLED,x.RGBA8,2,2,G.GEN_MIPMAP)),this.nullTexCube=Pe.instance.createTexture(new ue(C.CUBE,le.SAMPLED,x.RGBA8,2,2,G.GEN_MIPMAP,6));var n=new he;n.texExtent.width=2,n.texExtent.height=2;var u=new Uint8Array(this.nullTex2D.size);u.fill(0),Pe.instance.copyBuffersToTexture([u],this.nullTex2D,[n]),n.texSubres.layerCount=6,Pe.instance.copyBuffersToTexture([u,u,u,u,u,u],this.nullTexCube,[n])},a.destroy=function(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener(Ct,this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._extensions=null,this._canvas=null},a.resize=function(e,t){this._colorTexture.width===e&&this._colorTexture.height===t||(i("Resizing swapchain: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._colorTexture.resize(e,t),this._depthStencilTexture.resize(e,t))},a._onWebGLContextLost=function(e){u(11e3),l(e)},r(s,[{key:"extensions",get:function(){return this._extensions}}]),s}(Ee),bt=e("WebGLDevice",function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._swapchain=null,t._context=null,t._bindingMappings=null,t._textureExclusive=new Array(x.COUNT),t}t(s,e);var a=s.prototype;return a.initialize=function(e){Pe.setInstance(this),this._gfxAPI=Te.WEBGL;var t=this._bindingMappingInfo=e.bindingMappingInfo,r=[],s=[],a=t.setIndices[0];r[a]=0,s[a]=0;for(var n=1;n<t.setIndices.length;++n){var u=t.setIndices[n],l=t.setIndices[n-1];r[u]=t.maxBlockCounts[l]+r[l],s[u]=t.maxSamplerTextureCounts[l]+s[l]}for(var f=0;f<t.setIndices.length;++f){var h=t.setIndices[f];s[h]-=t.maxBlockCounts[h]}this._bindingMappings={blockOffsets:r,samplerTextureOffsets:s,flexibleSet:t.setIndices[t.setIndices.length-1]};var E=this._context=function(e){var t=null;try{var r={alpha:_.ENABLE_TRANSPARENT_CANVAS,antialias:o||_.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};t=e.getContext("webgl",r)}catch(e){return null}return t}(me.canvas);if(!E)return console.error("This device does not support WebGL."),!1;this._queue=this.createQueue(new ge(de.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new Re(this._queue)),this._caps.maxVertexAttributes=E.getParameter(E.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=E.getParameter(E.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=E.getParameter(E.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=E.getParameter(E.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=E.getParameter(E.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxTextureSize=E.getParameter(E.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=E.getParameter(E.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.maxUniformBufferBindings=16;var T=E.getSupportedExtensions(),g="";if(T)for(var d,R=c(T);!(d=R()).done;)g+=d.value+" ";var A=mt(E);A.WEBGL_debug_renderer_info?(this._renderer=E.getParameter(A.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=E.getParameter(A.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=E.getParameter(E.RENDERER),this._vendor=E.getParameter(E.VENDOR));var S=E.getParameter(E.VERSION);this._features.fill(!1),this.initFormatFeatures(A),A.EXT_blend_minmax&&(this._features[Ae.BLEND_MINMAX]=!0),A.OES_element_index_uint&&(this._features[Ae.ELEMENT_INDEX_UINT]=!0),A.ANGLE_instanced_arrays&&(this._features[Ae.INSTANCED_ARRAYS]=!0),A.WEBGL_draw_buffers&&(this._features[Ae.MULTIPLE_RENDER_TARGETS]=!0);var p="";return this.getFormatFeatures(x.ETC_RGB8)&&(p+="etc1 "),this.getFormatFeatures(x.ETC2_RGB8)&&(p+="etc2 "),this.getFormatFeatures(x.BC1)&&(p+="dxt "),this.getFormatFeatures(x.PVRTC_RGB2)&&(p+="pvrtc "),this.getFormatFeatures(x.ASTC_RGBA_4X4)&&(p+="astc "),i("WebGL device initialized."),i("RENDERER: "+this._renderer),i("VENDOR: "+this._vendor),i("VERSION: "+S),i("COMPRESSED_FORMAT: "+p),i("EXTENSIONS: "+g),!0},a.destroy=function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null),this._swapchain=null},a.flushCommands=function(){},a.acquire=function(){},a.present=function(){var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()},a.initFormatFeatures=function(e){this._formatFeatures.fill(Se.NONE),this._textureExclusive.fill(!0);var t=Se.RENDER_TARGET|Se.SAMPLED_TEXTURE|Se.LINEAR_FILTER;this._formatFeatures[x.RGB8]=t,this._formatFeatures[x.R5G6B5]=t,this._textureExclusive[x.R5G6B5]=!1,this._formatFeatures[x.RGBA8]=t,this._formatFeatures[x.RGBA4]=t,this._textureExclusive[x.RGBA4]=!1,this._formatFeatures[x.RGB5A1]=t,this._textureExclusive[x.RGB5A1]=!1,this._formatFeatures[x.DEPTH]=Se.RENDER_TARGET,this._textureExclusive[x.DEPTH]=!1,this._formatFeatures[x.DEPTH_STENCIL]=Se.RENDER_TARGET,this._textureExclusive[x.DEPTH_STENCIL]=!1,this._formatFeatures[x.R8I]|=Se.VERTEX_ATTRIBUTE,this._formatFeatures[x.RG8I]|=Se.VERTEX_ATTRIBUTE,this._formatFeatures[x.RGB8I]|=Se.VERTEX_ATTRIBUTE,this._formatFeatures[x.RGBA8I]|=Se.VERTEX_ATTRIBUTE,this._formatFeatures[x.R8UI]|=Se.VERTEX_ATTRIBUTE,this._formatFeatures[x.RG8UI]|=Se.VERTEX_ATTRIBUTE,this._formatFeatures[x.RGB8UI]|=Se.VERTEX_ATTRIBUTE,this._formatFeatures[x.RGBA8UI]|=Se.VERTEX_ATTRIBUTE,this._formatFeatures[x.R8I]|=Se.VERTEX_ATTRIBUTE,this._formatFeatures[x.RG8I]|=Se.VERTEX_ATTRIBUTE,this._formatFeatures[x.RGB8I]|=Se.VERTEX_ATTRIBUTE,this._formatFeatures[x.RGBA8I]|=Se.VERTEX_ATTRIBUTE,this._formatFeatures[x.R8UI]|=Se.VERTEX_ATTRIBUTE,this._formatFeatures[x.RG8UI]|=Se.VERTEX_ATTRIBUTE,this._formatFeatures[x.RGB8UI]|=Se.VERTEX_ATTRIBUTE,this._formatFeatures[x.RGBA8UI]|=Se.VERTEX_ATTRIBUTE,this._formatFeatures[x.R32F]|=Se.VERTEX_ATTRIBUTE,this._formatFeatures[x.RG32F]|=Se.VERTEX_ATTRIBUTE,this._formatFeatures[x.RGB32F]|=Se.VERTEX_ATTRIBUTE,this._formatFeatures[x.RGBA32F]|=Se.VERTEX_ATTRIBUTE,e.EXT_sRGB&&(this._formatFeatures[x.SRGB8]=t,this._formatFeatures[x.SRGB8_A8]=t,this._textureExclusive[x.SRGB8_A8]=!1),e.WEBGL_depth_texture&&(this._formatFeatures[x.DEPTH]|=t,this._formatFeatures[x.DEPTH_STENCIL]|=t),e.WEBGL_color_buffer_float&&(this._formatFeatures[x.RGB32F]|=Se.RENDER_TARGET,this._formatFeatures[x.RGBA32F]|=Se.RENDER_TARGET,this._textureExclusive[x.RGB32F]=!1,this._textureExclusive[x.RGBA32F]=!1),e.EXT_color_buffer_half_float&&(this._formatFeatures[x.RGB16F]|=Se.RENDER_TARGET,this._formatFeatures[x.RGBA16F]|=Se.RENDER_TARGET,this._textureExclusive[x.RGB16F]=!1,this._textureExclusive[x.RGBA16F]=!1),e.OES_texture_float&&(this._formatFeatures[x.RGB32F]|=Se.RENDER_TARGET|Se.SAMPLED_TEXTURE,this._formatFeatures[x.RGBA32F]|=Se.RENDER_TARGET|Se.SAMPLED_TEXTURE),e.OES_texture_half_float&&(this._formatFeatures[x.RGB16F]|=Se.RENDER_TARGET|Se.SAMPLED_TEXTURE,this._formatFeatures[x.RGBA16F]|=Se.RENDER_TARGET|Se.SAMPLED_TEXTURE),e.OES_texture_float_linear&&(this._formatFeatures[x.RGB32F]|=Se.LINEAR_FILTER,this._formatFeatures[x.RGBA32F]|=Se.LINEAR_FILTER),e.OES_texture_half_float_linear&&(this._formatFeatures[x.RGB16F]|=Se.LINEAR_FILTER,this._formatFeatures[x.RGBA16F]|=Se.LINEAR_FILTER);var r=Se.SAMPLED_TEXTURE|Se.LINEAR_FILTER;e.WEBGL_compressed_texture_etc1&&(this._formatFeatures[x.ETC_RGB8]=r),e.WEBGL_compressed_texture_etc&&(this._formatFeatures[x.ETC2_RGB8]=r,this._formatFeatures[x.ETC2_RGBA8]=r,this._formatFeatures[x.ETC2_SRGB8]=r,this._formatFeatures[x.ETC2_SRGB8_A8]=r,this._formatFeatures[x.ETC2_RGB8_A1]=r,this._formatFeatures[x.ETC2_SRGB8_A1]=r),e.WEBGL_compressed_texture_s3tc&&(this._formatFeatures[x.BC1]=r,this._formatFeatures[x.BC1_ALPHA]=r,this._formatFeatures[x.BC1_SRGB]=r,this._formatFeatures[x.BC1_SRGB_ALPHA]=r,this._formatFeatures[x.BC2]=r,this._formatFeatures[x.BC2_SRGB]=r,this._formatFeatures[x.BC3]=r,this._formatFeatures[x.BC3_SRGB]=r),e.WEBGL_compressed_texture_pvrtc&&(this._formatFeatures[x.PVRTC_RGB2]|=r,this._formatFeatures[x.PVRTC_RGBA2]|=r,this._formatFeatures[x.PVRTC_RGB4]|=r,this._formatFeatures[x.PVRTC_RGBA4]|=r),e.WEBGL_compressed_texture_astc&&(this._formatFeatures[x.ASTC_RGBA_4X4]|=r,this._formatFeatures[x.ASTC_RGBA_5X4]|=r,this._formatFeatures[x.ASTC_RGBA_5X5]|=r,this._formatFeatures[x.ASTC_RGBA_6X5]|=r,this._formatFeatures[x.ASTC_RGBA_6X6]|=r,this._formatFeatures[x.ASTC_RGBA_8X5]|=r,this._formatFeatures[x.ASTC_RGBA_8X6]|=r,this._formatFeatures[x.ASTC_RGBA_8X8]|=r,this._formatFeatures[x.ASTC_RGBA_10X5]|=r,this._formatFeatures[x.ASTC_RGBA_10X6]|=r,this._formatFeatures[x.ASTC_RGBA_10X8]|=r,this._formatFeatures[x.ASTC_RGBA_10X10]|=r,this._formatFeatures[x.ASTC_RGBA_12X10]|=r,this._formatFeatures[x.ASTC_RGBA_12X12]|=r,this._formatFeatures[x.ASTC_SRGBA_4X4]|=r,this._formatFeatures[x.ASTC_SRGBA_5X4]|=r,this._formatFeatures[x.ASTC_SRGBA_5X5]|=r,this._formatFeatures[x.ASTC_SRGBA_6X5]|=r,this._formatFeatures[x.ASTC_SRGBA_6X6]|=r,this._formatFeatures[x.ASTC_SRGBA_8X5]|=r,this._formatFeatures[x.ASTC_SRGBA_8X6]|=r,this._formatFeatures[x.ASTC_SRGBA_8X8]|=r,this._formatFeatures[x.ASTC_SRGBA_10X5]|=r,this._formatFeatures[x.ASTC_SRGBA_10X6]|=r,this._formatFeatures[x.ASTC_SRGBA_10X8]|=r,this._formatFeatures[x.ASTC_SRGBA_10X10]|=r,this._formatFeatures[x.ASTC_SRGBA_12X10]|=r,this._formatFeatures[x.ASTC_SRGBA_12X12]|=r)},a.createCommandBuffer=function(e){var t=new(e.type===H.PRIMARY?Et:ut);return t.initialize(e),t},a.createSwapchain=function(e){var t=new xt;return this._swapchain=t,t.initialize(e),t},a.createBuffer=function(e){var t=new at;return t.initialize(e),t},a.createTexture=function(e){var t=new pt;return t.initialize(e),t},a.createDescriptorSet=function(e){var t=new be;return t.initialize(e),t},a.createShader=function(e){var t=new At;return t.initialize(e),t},a.createInputAssembler=function(e){var t=new _t;return t.initialize(e),t},a.createRenderPass=function(e){var t=new gt;return t.initialize(e),t},a.createFramebuffer=function(e){var t=new lt;return t.initialize(e),t},a.createDescriptorSetLayout=function(e){var t=new ot;return t.initialize(e),t},a.createPipelineLayout=function(e){var t=new ct;return t.initialize(e),t},a.createPipelineState=function(e){var t=new ht;return t.initialize(e),t},a.createQueue=function(e){var t=new Tt;return t.initialize(e),t},a.getSampler=function(e){var t=$.computeHash(e);return this._samplers.has(t)||this._samplers.set(t,new Rt(e,t)),this._samplers.get(t)},a.getSwapchains=function(){return[this._swapchain]},a.getGeneralBarrier=function(e){var t=pe.computeHash(e);return this._generalBarrierss.has(t)||this._generalBarrierss.set(t,new pe(e,t)),this._generalBarrierss.get(t)},a.getTextureBarrier=function(e){var t=Ce.computeHash(e);return this._textureBarriers.has(t)||this._textureBarriers.set(t,new Ce(e,t)),this._textureBarriers.get(t)},a.getBufferBarrier=function(e){var t=Be.computeHash(e);return this._bufferBarriers.has(t)||this._bufferBarriers.set(t,new Be(e,t)),this._bufferBarriers.get(t)},a.copyBuffersToTexture=function(e,t,r){rt(this,e,t.gpuTexture,r)},a.copyTextureToBuffers=function(e,t,r){!function(e,t,r,s){var a=e.gl,i=e.stateCache,n=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,n);var u=0,l=0,_=1,o=1;switch(t.glTarget){case a.TEXTURE_2D:for(var c=0;c<s.length;c++){var f=s[c];a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,t.glTarget,t.glTexture,f.texSubres.mipLevel),u=f.texOffset.x,l=f.texOffset.y,_=f.texExtent.width,o=f.texExtent.height,a.readPixels(u,l,_,o,t.glFormat,t.glType,r[c])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}a.bindFramebuffer(a.FRAMEBUFFER,null),i.glFramebuffer=null,a.deleteFramebuffer(n)}(this,e.gpuTexture,t,r)},a.copyTexImagesToTexture=function(e,t,r){!function(e,t,r,s){var a=e.gl,i=e.stateCache.glTexUnits[e.stateCache.texUnit];i.glTexture!==r.glTexture&&(a.bindTexture(r.glTarget,r.glTexture),i.glTexture=r.glTexture);var n=0,u=0;switch(r.glTarget){case a.TEXTURE_2D:for(var l=0;l<s.length;l++){var _=s[l];a.texSubImage2D(a.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,r.glFormat,r.glType,t[n++])}break;case a.TEXTURE_CUBE_MAP:for(var o=0;o<s.length;o++){var c=s[o],f=c.texSubres.baseArrayLayer+c.texSubres.layerCount;for(u=c.texSubres.baseArrayLayer;u<f;++u)a.texSubImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+u,c.texSubres.mipLevel,c.texOffset.x,c.texOffset.y,r.glFormat,r.glType,t[n++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}r.flags&G.GEN_MIPMAP&&r.isPowerOf2&&a.generateMipmap(r.glTarget)}(this,e,t.gpuTexture,r)},r(s,[{key:"gl",get:function(){return this._context}},{key:"extensions",get:function(){return this._swapchain.extensions}},{key:"stateCache",get:function(){return this._swapchain.stateCache}},{key:"nullTex2D",get:function(){return this._swapchain.nullTex2D}},{key:"nullTexCube",get:function(){return this._swapchain.nullTexCube}},{key:"textureExclusive",get:function(){return this._textureExclusive}},{key:"bindingMappings",get:function(){return this._bindingMappings}}]),s}(me));f.WebGLDevice=bt}}}));
